
# 请你优先从参考文件夹`通用状态栏框架开发参考用文件\AIStudioAPP版-通用状态栏框架(UI参考)`**使用 PowerShell 命令直接复制css文件**，再做路径修改，而不是从头写

## 实现逻辑可以参考`通用状态栏框架开发参考用文件\酒馆助手脚本-可视化表格-V12.60.json`(怎么在聊天界面添加状态栏), `通用状态栏框架开发参考用文件\酒馆助手脚本-模块化InitVar生成器_v0.2.1.0-stage2-final (1).json`(简单弹窗+世界书处理+注册按钮+热重载), `通用状态栏框架开发参考用文件\酒馆助手脚本-神话再临·数据库.json`(复杂弹窗+世界书处理+第二ai api调用)

---

## 任务

我正在将先前在模拟环境中开发的多文件“通用状态栏框架”脚本，迁移到 TavernHelper 的官方 VSCode 开发模板中，以连接到真实的 SillyTavern 环境。
所有先前文件被我放在`通用状态栏框架开发参考用文件\AIStudioAPP版-通用状态栏框架(UI参考)`（下称`UI参考`），你被允许创建新文件和文件夹，也可以**用 PowerShell 命令直接复制文件夹和文件**，但暂时不要删掉`UI参考`的任何文件。
迁移后项目应该是脚本 + 设置面板模式（你**必须完整阅读**`src\通用状态栏框架\开发总纲(在AI Studio构建时).md`），而不再是在模拟环境的完整应用模式。mockTavernService应该被换成真实的TavernHelper API。
你可以通过用 chrome-devtools-mcp 来访问酒馆网页，访问前请先打开酒馆。

## 上下文

1. **开发总纲**: `src\通用状态栏框架\开发总纲(在AI Studio构建时).md`包含项目的核心架构和设计准则。
2. **模拟代码**: `UI参考`的代码大多是为了在 Google AI Studio Build mode 环境跑通而写的 Mock/模拟逻辑。

## 你的行动

请执行以下步骤：

1. **进度评估**: 完整阅读`UI参考`，对比当前代码与总纲，列出已完成/尚缺失/做错(特别是UI)/没做完/不完善/偏离总纲的东西。
2. **规划步骤**: 包括但**不限于**构思一个清晰的文件夹结构、复制哪些`UI参考`的文件到哪些新文件夹、修改什么路径、在酒馆的`#extensionsMenu`（入口是`#extensionsMenuButton`/`qr--button menu_button interactable`，不是`#extensions-settings-button`"扩展"按钮）中添加`通用状态栏管理器`按钮、绝对避免emoji/占位符、怎么换成真实的TavernHelper API、怎么做到"即插即用"……
3. **执行迁移**（复制文件，避免从头写）。

请先输出评估报告，确认无误后再开始修改代码。

---

## **《通用状态栏框架》- 开发总纲**

项目类型: 一个高度可定制、支持多人的“通用状态栏框架”，作为 SillyTavern 的前端扩展运行。（脚本模式：用 jQuery 向酒馆页面注入 DOM?；"即插即用"，不需要额外导入世界书，世界书由脚本自动创建管理，隐藏AI输出的正则也由脚本管理）
核心理念: 定义驱动 (Definition-Driven)。系统的所有行为，包括数据解析、状态栏渲染、管理器UI渲染，都由用户在管理器中配置的“定义”来驱动，而非脚本硬编码。
美学风格: 现代、简洁、专业，信息清晰。内置完善且视觉效果优雅的深色和浅色主题（所有UI组件都应该可切换，包括自定义渲染样式）。所有UI基于统一的基础组件库构建，确保风格一致，并允许用户通过“样式工坊”进行深度定制。（模块可以有自己独立的、少量的CSS，但仅用于其特有的布局和样式，覆盖或补充基础组件库。）

---

### **一、 核心界面设计 (2大独立模块)**

需完整设计并实现以下2个独立但互相关联的界面模块：

#### A. 状态栏本体 (In-Chat UI)

- 功能: 嵌入在聊天消息中，作为信息的核心展示窗口。
- 核心要求:
  1. 完全可定制渲染:
      - 条目外观: 渲染逻辑必须由用户在“样式工坊”中定义的“样式单元”驱动。（状态栏的外观不固定，由用户应用的HTML+css模板动态生成）
      - 布局排版: 用户必须能在“布局编排器”中，通过可视化拖拽的方式，完全自定义状态栏内所有条目的位置、排列和尺寸。
  2. 默认模板: 提供多个设计精良的默认样式单元和布局方案，作为用户自定义的起点。
  3. 多角色切换: 提供一个横向滚动的Tab栏来切换所有“在场” (`isPresent: true`) 角色的状态。
  4. 高级交互性:
      - 支持在样式单元的HTML模板中定义可点击元素。
      - 在“定义工作室”中，允许为条目关联“交互类型”（如填入输入框、发送聊天、触发自定义脚本）。
      - 脚本运行时会根据定义，为可点击元素动态绑定相应事件。
  5. 折叠/展开: 每个由布局编排器创建的“区块”或“类别”应支持独立的折叠和展开，并记忆其状态。

#### B. 管理器本体 (Manager UI)

- 功能: 系统的总配置中心和数据编辑器，以弹窗形式呈现。
- 核心要求: 包含以下五大功能模块，所有模块都需提供帮助指引（点击问号图标弹出浮窗）。务必追求高端、良好的现代化视图。

  1. **数据中心 (Data Center)**
      - 功能: 全功能的实时编辑器，用于增、删、改所有角色的状态数据。
      - UI改进:
        - 明确区分“共享数据”和“角色数据”的编辑区。
        - 编辑角色数据时，在角色名旁清晰地显示其唯一的 `char_id`。
        - 新增条目时，提供一个基于“定义工作室”中该分类下所有已定义`key`的智能推荐的输入框。
      - 交互: 实现标签双击编辑、带“x”按钮的标签删除、行级删除按钮、区级新增按钮等全功能交互。
      - 保存机制: 所有编辑在UI上即时生效（暂存模式），通过一个全局“保存”按钮一次性写入SST。
      - 提供UI控件（如眼睛图标）以手动切换角色的 `isPresent` 状态。

  2. **定义工作室 (Definition Studio)**
      - 功能: 全局的“条目字典”，用于创建和管理所有分类和数据条目的结构和元数据。支持导入/导出。
      - UI:
        - 分类列表: 允许用户CRUD（增删改查）数据类别（如`CV`, `CP`），并设定其为“共享”或“角色”属性。
        - 条目列表: 展示所有已定义的条目，按类别分组。提供CRUD操作。
        - 属性编辑器:
          - `key`: 唯一键。
          - `name`: 显示名。
          - `category`: 从用户创建的分类列表中选择。
          - `icon`: 集成图标库（如Font Awesome/Lucide）的选择器，带搜索。（现在选择器显示的图标好像很少？）
          - 【修改】`entry_type`（原`data_type`，改名以更贴合原意）: 基础数据类型选择，只提供两个基础数据类型，直接存成更清晰易读的**对象**。
            - 单体 (`Single`)：用于描述一个单一实体。其所有`parts`共同构成一个不可分割的整体。
            - 列表 (`List`)：用于描述一组可独立增删的、结构相同的实体。
          - 【修改】`parts`（`keys`, `labels`, `data_types`）: 根据`entry_type`动态生成。
            - 可增删，为每个结构指定名称`key`、UI文本标签`label`。
            - 【新增】可为每个结构指定**基础类型**`data_type`（文本、数字、布尔值）和**验证规则**（如数字范围，在后台生成Zod Schema，用于在AI更新数据时进行安全验证，防止AI返回错误类型或超出范围的数值，从而保护数据不被污染）。
          - `ui_type`: 下拉框，用于设置此条目的**默认渲染样式**，关联自“样式工坊”。
          - `separator`: 分隔符，`List`拥有额外分隔符`secondary_separator`
          - `interaction_type`: 下拉框，定义条目的交互行为（无、填入输入框、触发自定义脚本等）。
          - `format`: 文本框，根据以上信息自动生成，供AI识别。（如 `[角色^ST|天气::{天气}]`）
          - `description`: 文本框，用户填写，用于指导AI。（如 `简述主视角角色当前所在地的天气状况及温度`）
      - 功能按钮:
        - `注入世界书`: 将`format`和`description`组合后，更新或创建到世界书中。遵循“精确匹配优先”的查找逻辑。

      - 关于`entry_type`和`parts`的示例：
        - `Single`: 定义条目`HP值`，将`entry_type`设为`Single`，设置2个`part`，分别包含`key`为"current"和"max"，`label`为"当前值"和"最大值"，`data_type`为"number"和"number"。（`separator`为`@`）
          - 假设AI聊天时输出`[User^CV|HP值::50@100]`，脚本根据定义映射，数据存储结果:

            ```json
            "HP": {
                    "current": 50,
                    "max": 100
            }
            ```

      - `List`:
          - 例子1（简单版list）: 定义条目`背包`，将`entry_type`设为`List`，设置`part`的`key`和`label`分别为"item"和"物品"，`data_type`为"string"。（`separator`为`|`）
            - 假设AI聊天时输出`[User^CR|背包::苹果|面包]`，脚本根据定义映射，数据存储结果:

            ```json
            "背包": [
                { "item": "苹果" },
                { "item": "面包" }
            ]
            ```

          - 例子1（复杂版list）: 定义条目`技能`，将`entry_type`设为`List`，设置2个`part`，分别包含`key`为"skill"和"level"，`label`为"技能"和"等级"，`data_type`为"string"和"number"。（`separator`为`|`，`secondary_separator`为`@`）
            - 假设AI聊天时输出`[User^CR|技能::火球术@5|治愈术@7]`，脚本根据定义映射，数据存储结果:

              ```json
              "技能": [
                  { "skill": "火球术", "level": 5 },
                  { "skill": "治愈术", "level": 7 }
              ]
              ```

  3. **样式工坊 (Style Atelier)**
      - 功能: 创建可复用的“样式单元”和定制“全局主题”。存储在localStorage。支持导入/导出。
      - 样式单元 (Style Units):
        - 提供CRUD界面管理所有样式单元。
        - 提供内置的默认样式单元作为模板。
        - 编辑器提供“可视化GUI配置”和“手写代码配置”（填写HTML模板+局部CSS）。
        - HTML模板使用`{{placeholder}}`语法，占位符对应`parts`的`keys`（如`{{skill}}`）。可以有内置辅助占位符（如`{{progressbar}}`），但必须清晰说明（占位符参考）。
        - 提供一个带有可用类名和占位符参考的面板，**必须**是动态从CSS文件获取。
        - **必须**提供一个实时预览区域，即时反馈样式修改效果。
      - 全局主题 (Global Styles):
        - 提供一个CSS编辑器，允许用户定制状态栏容器、管理器弹窗、整体颜色主题等框架级元素的外观。（HTML模板的功能主要由布局编排器实现？但也可以提供？）
        - 同样提供可用CSS类名参考。（“可视化GUI配置”可能需要隐藏？）

  4. **布局编排器 (Layout Composer)**
      - 功能: 可视化地设计状态栏的布局。支持导入/导出。
      - UI:
        - 画布区域: 所见即所得的状态栏预览区。
        - 组件列表: 侧边栏，列出“定义工作室”中所有已定义的条目。
        - 元素检视: 侧边栏/浮窗，选中元素时支持精细调整参数。
      - 交互:
        - 支持从侧边栏拖拽条目到画布上。
        - 支持拖拽合并为行/列，自动均分布局。
        - 支持拖动调整手柄，手动设定宽高比例。
        - 所有布局调整实时预览。
      - 数据存储: 布局将被保存为一个JSON结构。

  5. **系统配置 (System & Config)**
      - 功能: 整合应用逻辑与系统级设置。
      - 子模块:
        - **预设配置 (Presets)**:
          - 功能: “主题应用者”，用于组合世界书、定义、样式和布局。支持导入/导出。
          - UI: 提供CRUD界面管理所有配置（如“魔法世界观”）。
          - 配置内容: 每个配置包含“条目列表”、“样式覆盖映射”和“布局选择”。
          - 交互: 在配置编辑器中，为每个条目提供“覆盖渲染样式”（覆盖该条目在其定义中设置的“默认样式”，默认选择“默认”）和“跳转到样式工坊/布局编排器的快捷按钮。
          - 应用逻辑: 提供“绑定到当前聊天”和“仅应用一次”功能。加载聊天时，脚本会自动应用绑定配置，覆写状态栏外观。
        - **快照设置 (Snapshot)**:
          - 提供开关以启用/禁用叙事生成器。
          - 允许用户创建和管理不同的叙事生成模板：提供CRUD操作；使用并提供`{{placeholder}}`；针对不同数据情况（共享数据、角色数据、User数据（还在考虑）、`user_modified: true`的数据）和数据变化类型可以定制不同模板；提供一个编写提示词的文本框作为AI对数据变更叙事风格的总指导（例如望AI把npc的表现写成无视/神化/怀疑`user_modified: true`数据的变化）；支持导入/导出。
          - 显示快照元信息和功能按钮。提供开关以启用/禁用快照元信息注入世界书发送。
        - **条目管理 (WorldbookManager)**：
          - 管理世界书条目，同样是通过一个“保存”按钮一次性写入。
        - **备份与迁移 (BackupManager)**：
          - 提供可多选的导出成json文件功能、（拖入）导入json文件功能、恢复出厂设置（重置所有数据到初始状态）功能。
        - **使用指南 (HelpGuide)**：
          - 帮助文件，写出所有模块和功能，引导用户使用本脚本。

---

#### **二、 核心后台逻辑 (The Engine)**

1. **数据模型 (SST)**:
    - 数据源: `chatVariables.statusBarCharacterData`。
    - 角色ID系统:
      - 必须实现角色唯一ID (`char_id`) 机制。SST中的角色数据必须以ID为键，ID格式为`char_{}`（用户角色固定ID为`char_user`），一般为AI生成，但也可由用户在数据中心添加角色时手动填写。
      - 在`chatVariables`中维护ID到最新角色名的映射表。
      - 所有UI渲染必须从SST中动态读取角色名。（除了用户角色`char_user`在SillyTavern中通过酒馆助手宏`{{substitudeMacros}}`获取真实persona名称）
    - 智能合并: 实现包含`source_id`裁决、用户修改优先、优先级降级三大原则的合并逻辑。
      - `source_id` 裁决: 每个数据项都有一个 `source_id` 属性，即它来源的消息楼层ID。只有当`Source.source_id >= Target.source_id`时，才允许更新。
      - 用户修改优先: 如果`Target`条目有一个 `user_modified: true` 的标志，必须无条件地阻止来自AI的任何更新。（这个现在感觉哪里不对，似乎不应该阻止来自AI的更新？初衷是发现AI可能会认为用户的修改是某种bug而修正，但现在应该可以通过快照元信息注入世界书发送，来对AI表明“这不是Bug，而是用户希望得到特殊体验而做的修改”）
      - 优先级降级: 当用户发送新消息时，遍历整个SST，将所有`user_modified: true`的条目重置为`false`，并将其`source_id`更新为当前最新消息的ID，使其可以被后续的AI消息再次更新。
    - 会话完整性: 实现“时间线收缩”检测与警告。
      - SST中需包含一个元数据字段 `_meta.message_count`，用于记录上次更新时的总消息数。
      - 每次数据更新前，比较当前的总消息数与记录的 `message_count`。如果当前消息数小于记录值，意味着聊天记录被删除或修改。
      - 此时通过 `toastr.warning` 弹出一个警告通知，提示用户数据可能不一致，并建议用户通过管理器进行检查。
    - `nil`值 (临时隐藏指令) 处理: 在状态栏渲染时隐藏，在管理器中可见以让用户手动恢复，作为AI误删风险的安全机制。

2. **AI交互**:
    - **双模式解析器**:
      - **Legacy 模式**: 解析自定义标签格式 (e.g., `[category|key::value]`)，用于兼容旧卡和简单场景。
      - **Patch 模式 (未来接洽MVU核心)**: 解析 **JSON Patch** (RFC 6902)。
          - AI 直接输出: `{"op": "add", "path": "/characters/char_001/inventory/-", "value": {"name": "草药"}}`
          - 脚本直接应用 Patch，无需正则提取。
    - 叙事生成器: 检测数据变化并根据用户选择的风格模板生成叙事文本。

3. **脚本生命周期**:
    - 必须实现基于唯一ID和全局信标的“单例所有权”机制，确保脚本热重载的稳定性。
      - 每个脚本实例在启动时生成一个**唯一ID**。
      - 使用 `top` 窗口上的一个全局对象来存储当前“所有者”实例的ID。
      - 新实例启动时，必须检查此全局对象。如果发现存在旧的“所有者”，新实例**必须**先调用一个全面的`cleanup`函数，彻底移除旧实例创建的所有UI元素（按钮、弹窗、样式）、事件监听器和定时器，然后再声明自己的所有权并执行初始化。

---

#### 其他注意点

**所有**模块和子模块都应该支持独立（全部、部分（多选）、单个）导入导出（且拥有对应入口，例如按钮）

未来可实现功能：

- 一键将用户自定义状态栏（一套配置好的包含定义、样式、布局的预设）生成成SillyTavern的正则替换脚本+世界书导出
- 定义工坊引入AI编写定义（用户输入要求）（需要第二api）
- 样式工坊引入AI编写样式（根据所选定义 & 用户输入要求）（需要第二api）
- 布局编排引入AI编写布局（根据所选定义 & 用户输入要求）（需要第二api）
- 配置预设引入AI一键编写完整配置（定义、样式、布局）（需要第二api）

---

#### UI要求 (关于UI，我的建议是**直接复用**`参考用-通用状态栏框架`的配色、布局、样式，因为我很满意旧文件的UI，不希望你偏离)

- 使用丰富的美学:设计应让用户第一眼就感到惊艳。使用现代网页设计的最佳实践(例如鲜艳的色彩、浅色深色模式切换、玻璃拟态和动态动画)来创造令人惊叹的第一印象。如果做不到这一点，是不可接受的。
- 优先考虑视觉卓越性:实施能让用户发出“WOW”惊叹并感觉极其高端的设计:
  - 避免使用通用颜色(纯红、蓝、绿)。使用精心挑选、和谐的调色板(例如HSL定制颜色、时尚的深色模式)。
  - 使用现代排版(例如Google Fonts中的 Inter、Roboto 或Outfit)，而不是浏览器默认字体。
  - 使用平滑的渐变，
  - 添加微妙的微交互动画以增强用户体验，
- 使用动态设计:感觉灵敏且生动的界面能鼓励交互。通过悬停效果和交互元素来实现这一点。特别是微交互动画，对于提高用户参与度非常有效。
- 高端设计。制作感觉高端且最先进的设计。避免创建简单的最小可行产品。
- 必须注意UI在不同屏幕大小下的舒适性，请将响应式设计纳入考虑。
- **尽可能不要使用emoji，而是使用美观、高级的ICON！例如Font Awesome/Lucide**
- 除了美术上的用法，否则App的界面、按钮、文本，应当全部显示中文。

#### 其他需注意的要求

- 样式(CSS):使用VanillaCSS以获得最大的灵活性和控制权。避免使用TailwindCSS，除非用户明确要求;在这种情况下，请先确认要使用哪个 TailwindCSS 版本。
- CSS类名使用BEM命名规范。
- 除非用户要求，否则默认绝不使用占位符。
- 进行性能优化
  - 标题标签:为每个页面包含正确、描述性的标题标签。
  - 元描述:添加引人注目且准确总结页面内容的元描述。
  - 标题结构:每页使用一个‘<h1>`，并保持正确的标题层级。
  - 语义化 HTML:使用适当的HTML5语义元素。
  - 唯一ID:确保所有交互元素具有唯一的、描述性的ID，以便进行浏览器测试。
  - 性能:通过优化确保快速的页面加载时间。
