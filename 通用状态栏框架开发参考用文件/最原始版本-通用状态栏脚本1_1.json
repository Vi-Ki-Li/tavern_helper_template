{
  "id": "fb7e915b-8c42-4ebd-8b9e-4f79aae2595d",
  "name": "通用状态栏脚本1.1",
  "content": "'use strict';\nconst lorebook_name = '[通用状态栏世界书]';\nconst status_tag = '<GeneralStatus>';\nconst status_regex = /<GeneralStatus>([\\s\\S]+?)<\\/GeneralStatus>/s;\n\n// 状态栏预设管理功能相关常量\nconst BUTTON_ID = 'status-bar-manager-button';\nconst BUTTON_ICON = 'fa-solid fa-sliders';\nconst BUTTON_TOOLTIP = '状态栏管理器';\nconst BUTTON_TEXT = '状态栏管理';\nconst POPUP_ID = 'status-bar-manager-popup';\nconst MAX_PRESETS = 10;\nconst PRESET_STORAGE_KEY = 'status_bar_presets';\nconst CHARACTER_DATA_STORAGE_KEY = 'status_bar_character_data'; // 添加角色数据本地存储键\n\n// 分类映射表，用于显示友好名称和图标\nconst CATEGORY_MAPPING = {\n  ST: { name: '场景与时间', icon: 'fa-clock' },\n  CP: { name: '角色档案', icon: 'fa-id-card' },\n  CR: { name: '角色资源与装备', icon: 'fa-sack-dollar' },\n  CV: { name: '角色状态值', icon: 'fa-heart-pulse' },\n  CS: { name: '特定状态描述', icon: 'fa-user-tag' },\n  RP: { name: '角色关系参数', icon: 'fa-handshake' }, // 添加RP映射\n  AE: { name: '行为与事件计数', icon: 'fa-list-check' },\n  WP: { name: '世界与剧情动态', icon: 'fa-globe' },\n  MI: { name: '元信息', icon: 'fa-brain' },\n};\n\n// 用于存储脚本选项\nvar option;\n(function (option_1) {\n  const default_option = {\n    dark_mode: false,\n    default_expanded: true,\n    init_delay: 0,\n    wp_triggerable: false, // 添加WP可触发设置\n  };\n\n  async function parse_option() {\n    const transformers = {\n      '白天/暗夜模式': value => ({ dark_mode: value }),\n      默认展开: value => ({ default_expanded: value }),\n      初始化延迟: (value, content) => ({ init_delay: content && !isNaN(Number(content)) ? Number(content) : 0 }),\n      WP可触发: value => ({ wp_triggerable: value }), // 处理WP可触发设置\n    };\n\n    return await getLorebookEntries(lorebook_name, { filter: { comment: '设置-' } })\n      .then(entries => {\n        console.log(\n          '[状态栏] 获取到设置条目:',\n          entries.map(e => `${e.comment} (enabled: ${e.enabled})`),\n        );\n        return entries.map(entry => ({\n          option: entry.comment.replace('设置-', ''),\n          value: entry.enabled,\n          content: entry.content,\n        }));\n      })\n      .then(entries => {\n        const result = entries.reduce(\n          (result, { option, value, content }) => {\n            const transformer = transformers[option];\n            if (transformer) {\n              const transformed = transformer(value, content);\n              console.log(`[状态栏] 解析设置: ${option} = ${JSON.stringify(transformed)}`);\n              return { ...result, ...transformed };\n            }\n            return result;\n          },\n          { ...default_option }, // 使用解构确保创建新对象\n        );\n        console.log('[状态栏] 最终设置:', result);\n        return result;\n      });\n  }\n\n  async function update() {\n    const old_option = option_1.option ? { ...option_1.option } : null;\n    option_1.option = await parse_option();\n\n    const changed = !old_option || !_.isEqual(option_1.option, old_option);\n    if (changed) {\n      console.log('[状态栏] 设置已更新:', option_1.option);\n\n      // 立即应用暗色模式设置\n      applyDarkMode(option_1.option.dark_mode);\n    }\n\n    return changed;\n  }\n\n  // 新增：专门用于应用暗色模式的函数\n  function applyDarkMode(isDarkMode) {\n    console.log(`[状态栏] 应用${isDarkMode ? '暗色' : '亮色'}模式`);\n    const $body = $('body', window.parent.document);\n\n    if (isDarkMode) {\n      $body.addClass('dark-mode');\n    } else {\n      $body.removeClass('dark-mode');\n    }\n  }\n\n  option_1.update = update;\n  option_1.applyDarkMode = applyDarkMode; // 导出函数\n})(option || (option = {}));\n\n// 解析函数，将状态栏文本解析为结构化数据\nfunction parseStatusBarText(text) {\n  if (!text) return { categories: {} };\n\n  const lines = text.split('\\n').filter(line => line.trim() && !line.trim().startsWith('#'));\n  const result = { categories: {} };\n\n  lines.forEach(line => {\n    const match = line.match(/\\[(.*?)\\|(.*?)::(.*)\\]/);\n    if (!match) return;\n\n    const category = match[1].trim();\n    const key = match[2].trim();\n    const valueString = match[3].trim();\n\n    // 解析值，按 | 分隔多个值，按 @ 分隔值的组成部分\n    const values = valueString.split('|').map(v => v.trim());\n    const processedValues = values.map(value => {\n      if (value.includes('@')) {\n        return value.split('@').map(v => v.trim());\n      }\n      return value;\n    });\n\n    // 按分类整理数据\n    if (!result.categories[category]) {\n      result.categories[category] = [];\n    }\n\n    result.categories[category].push({\n      key: key,\n      values: processedValues,\n      originalLine: line,\n    });\n  });\n\n  return result;\n}\n\n// 检查值是否为空\nfunction isEmpty(value) {\n  if (value == null) return true;\n  if (Array.isArray(value)) return value.length === 0;\n  if (typeof value === 'object') return Object.keys(value).length === 0;\n  return String(value).trim() === '';\n}\n\n// 渲染函数，用于生成状态栏HTML\nvar render;\n(function (render_1) {\n  let style = null;\n\n  // 创建百分比进度条\n  function createProgressBar(value, max, color) {\n    const percentage = max > 0 ? Math.min(100, Math.max(0, (value / max) * 100)) : 0;\n    return `\n      <div class=\"status-progress-container\">\n        <div class=\"status-progress-bar\" style=\"width: ${percentage}%; background-color: ${color}\"></div>\n      </div>\n    `;\n  }\n\n  // 渲染场景与时间（ST）条目\n  function renderSceneTimeItem(item) {\n    const { key, values } = item;\n\n    if (key === '时间') {\n      return `<span class=\"status-time\">${values.flat().join(' ')}</span>`;\n    } else if (key === '当前地点') {\n      return `<span class=\"status-location\">${values.flat().join(' ')}</span>`;\n    } else if (key === '天气') {\n      return `<span class=\"status-weather\">${values.flat().join(' ')}</span>`;\n    } else {\n      // 通用ST条目\n      return `<div class=\"status-item\">\n                <div class=\"status-header\">\n                  <span class=\"status-label\">${key}</span>\n                </div>\n                <div class=\"status-value\">${values.flat().join(' ')}</div>\n              </div>`;\n    }\n  }\n\n  // 渲染角色档案（CP）条目\n  function renderCharacterProfileItem(item) {\n    const { key, values } = item;\n    let icon = '';\n\n    switch (key) {\n      case '名字':\n        icon = '<i class=\"fa-solid fa-user fa-fw\"></i>';\n        break;\n      case '年龄':\n        icon = '<i class=\"fa-solid fa-cake-candles fa-fw\"></i>';\n        break;\n      case '身高':\n        icon = '<i class=\"fa-solid fa-ruler-vertical fa-fw\"></i>';\n        break;\n      case '三围':\n        icon = '<i class=\"fa-solid fa-ruler fa-fw\"></i>';\n        break;\n      case '特征':\n        icon = '<i class=\"fa-solid fa-fingerprint fa-fw\"></i>';\n        break;\n      case '永久性状态':\n        icon = '<i class=\"fa-solid fa-infinity fa-fw\"></i>';\n        break;\n      case '性知识':\n        icon = '<i class=\"fa-solid fa-book fa-fw\"></i>';\n        break;\n      case '身体外观':\n        icon = '<i class=\"fa-solid fa-eye fa-fw\"></i>';\n        break;\n      default:\n        icon = '<i class=\"fa-solid fa-circle-info fa-fw\"></i>';\n    }\n\n    // 处理多段值 (由@分隔)\n    let displayValue = '';\n    if (Array.isArray(values[0])) {\n      // 三围特殊处理\n      if (key === '三围') {\n        displayValue = values[0].join('，');\n      } else {\n        displayValue = values[0].join('，');\n      }\n    } else {\n      displayValue = values.join('，');\n    }\n\n    return `<div class=\"profile-item profile-${key.toLowerCase().replace(/\\s+/g, '-')}\">\n              <div class=\"profile-item-icon\">${icon}</div>\n              <div class=\"profile-item-content\">\n                <div class=\"profile-item-label\">${key}</div>\n                <div class=\"profile-item-value\">${displayValue}</div>\n              </div>\n            </div>`;\n  }\n\n  // 渲染资源与装备（CR）条目\n  function renderResourcesInventoryItem(item) {\n    const { key, values } = item;\n    let icon = '';\n\n    switch (key) {\n      case '现金':\n        icon = '<i class=\"fa-solid fa-coins fa-fw\"></i>';\n        let amount = values[0];\n        let change = values.length > 1 ? values[1] : '';\n        let reason = values.length > 2 ? values[2] : '';\n        let changeDisplay = '';\n\n        if (change && change !== '±0') {\n          changeDisplay = `<span class=\"status-change ${\n            change.startsWith('+') ? 'positive' : 'negative'\n          }\">${change}</span>`;\n        }\n\n        let reasonDisplay = '';\n        if (reason && reason !== '无变化') {\n          reasonDisplay = `<span class=\"cash-details\">(${reason})</span>`;\n        }\n\n        return `<div class=\"status-money\">\n                  ${icon} ${key}: <strong>${amount}</strong> ${changeDisplay} ${reasonDisplay}\n                </div>`;\n      case '道具物品':\n        icon = '<i class=\"fa-solid fa-toolbox fa-fw\"></i>';\n        // 处理多个物品，展示为标签\n        const items = Array.isArray(values[0]) ? values[0] : values;\n        const itemTags = items.map(item => `<span class=\"item-tag\">${item}</span>`).join(' ');\n        return `<div class=\"status-items\">\n                  ${icon} ${key}: ${itemTags}\n                </div>`;\n      case '永久佩戴':\n        icon = '<i class=\"fa-solid fa-shirt fa-fw\"></i>';\n        return `<div class=\"status-wearables\">\n                  ${icon} ${key}: ${values.flat().join('，')}\n                </div>`;\n      default:\n        icon = '<i class=\"fa-solid fa-box fa-fw\"></i>';\n        return `<div class=\"status-item\">\n                  <div class=\"status-header\">\n                    <span class=\"status-label\">${icon} ${key}</span>\n                  </div>\n                  <div class=\"status-value\">${values.flat().join('，')}</div>\n                </div>`;\n    }\n  }\n\n  // 渲染状态值（CV）条目\n  function renderVitalsGaugesItem(item) {\n    const { key, values } = item;\n\n    // 解析进度条相关值\n    let currentValue = 0;\n    let maxValue = 100;\n    let changeValue = '±0';\n    let reason = '无';\n    let description = '';\n\n    // 尝试解析第一个值（当前值/最大值）\n    if (values[0] && values[0].includes('@')) {\n      const [current, max] = values[0];\n      currentValue = parseInt(current) || 0;\n      maxValue = parseInt(max) || 100;\n    } else if (values[0]) {\n      currentValue = parseInt(values[0]) || 0;\n    }\n\n    // 获取变化值\n    if (values[1]) {\n      changeValue = values[1];\n    }\n\n    // 获取变化原因\n    if (values[2]) {\n      reason = values[2];\n    }\n\n    // 获取描述\n    if (values[3]) {\n      description = values[3];\n    }\n\n    // 统一使用低饱和蓝色\n    const color = '#7797b9';\n    let icon = '<i class=\"fa-solid fa-circle-info fa-fw\"></i>';\n\n    switch (key) {\n      case '疼痛':\n        icon = '<i class=\"fa-solid fa-face-grimace fa-fw\"></i>';\n        break;\n      case '创伤':\n        icon = '<i class=\"fa-solid fa-bandage fa-fw\"></i>';\n        break;\n      case '体力':\n        icon = '<i class=\"fa-solid fa-person-running fa-fw\"></i>';\n        break;\n      case '饥饿':\n      case '口渴':\n      case '尿意':\n      case '便意':\n      case '如厕需求':\n        if (key === '饥饿') icon = '<i class=\"fa-solid fa-utensils fa-fw\"></i>';\n        else if (key === '口渴') icon = '<i class=\"fa-solid fa-glass-water fa-fw\"></i>';\n        else if (key === '尿意') icon = '<i class=\"fa-solid fa-toilet fa-fw\"></i>';\n        else if (key === '便意') icon = '<i class=\"fa-solid fa-toilet-paper fa-fw\"></i>';\n        else if (key === '如厕需求') icon = '<i class=\"fa-solid fa-restroom fa-fw\"></i>';\n        break;\n      case '性欲':\n        icon = '<i class=\"fa-solid fa-heart fa-fw\"></i>';\n        break;\n      case '性快感':\n        icon = '<i class=\"fa-solid fa-fire fa-fw\"></i>';\n        break;\n      case '好感度':\n        icon = '<i class=\"fa-solid fa-heart fa-fw\"></i>';\n        break;\n      case '信任度':\n        icon = '<i class=\"fa-solid fa-handshake fa-fw\"></i>';\n        break;\n      case '堕落度':\n        icon = '<i class=\"fa-solid fa-mask fa-fw\"></i>';\n        break;\n      default:\n    }\n\n    // 变化显示\n    let changeDisplay = '';\n    if (changeValue && changeValue !== '±0') {\n      const isPositive = changeValue.startsWith('+');\n      changeDisplay = `<span class=\"status-change ${isPositive ? 'positive' : 'negative'}\">${changeValue}</span>`;\n    }\n\n    // 原因显示\n    let reasonDisplay = '';\n    if (reason && reason !== '无') {\n      reasonDisplay = `<span class=\"status-reason\">${reason}</span>`;\n    }\n\n    // 描述显示\n    let descriptionDisplay = '';\n    if (description && description.trim() !== '') {\n      descriptionDisplay = `<div class=\"status-description\">${description}</div>`;\n    }\n\n    return `<div class=\"status-item\" data-status-type=\"${key}\">\n              <div class=\"status-header\">\n                <span class=\"status-label\">${icon} ${key}</span>\n              </div>\n              ${createProgressBar(currentValue, maxValue, color)}\n              <div class=\"status-footer\">\n                <div class=\"status-details-row\">\n                  <span class=\"status-value\">${currentValue}/${maxValue}</span>\n                  ${changeDisplay} ${reasonDisplay}\n                </div>\n              </div>\n              ${descriptionDisplay}\n            </div>`;\n  }\n\n  // 渲染特定状态描述（CS）条目\n  function renderConditionDescriptorsItem(item) {\n    const { key, values } = item;\n\n    if (key === '状态') {\n      // 状态特殊处理为描述性文本框\n      return `<div class=\"condition-item condition-status\">\n                <div class=\"condition-item-label\">${key}</div>\n                <div class=\"condition-item-value\">${values.flat().join(' ')}</div>\n              </div>`;\n    } else {\n      return `<div class=\"condition-item\">\n                <div class=\"condition-item-label\">${key}</div>\n                <div class=\"condition-item-value\">${values.flat().join(' ')}</div>\n              </div>`;\n    }\n  }\n\n  // 渲染行为与事件计数（AE）条目\n  function renderActivityCountersItem(item) {\n    const { key, values } = item;\n\n    // 处理可能带有@的值，直接显示原始内容\n    let displayContent = '';\n\n    // 值的处理逻辑\n    if (values[0] && Array.isArray(values[0])) {\n      // 如果是数组（含有@分隔的值），直接显示\n      displayContent = values[0].join(' · '); // 使用中点符号分隔\n    } else {\n      // 单个值的情况\n      displayContent = values.flat().join(' ');\n    }\n\n    // 返回一行式布局\n    return `<div class=\"counter-item activity-count\">\n              <div class=\"counter-content\">\n                <span class=\"counter-label\">${key}:</span>\n                <span class=\"counter-value\">${displayContent}</span>\n              </div>\n            </div>`;\n  }\n\n  // 渲染世界与剧情动态（WP）条目\n  function renderWorldPlotItem(item) {\n    const { key, values } = item;\n\n    // 创建统一的区块标题\n    const headerTitle = `<div class=\"world-item-header\">${key}</div>`;\n\n    // 处理所有类型的值，统一格式\n    const processedValues = values\n      .map(value => {\n        if (Array.isArray(value)) {\n          // 处理用@分隔的项（在同一行显示，用\"-\"连接）\n          return `<li class=\"world-item-entry\">${value.join(' - ')}</li>`;\n        } else {\n          return `<li class=\"world-item-entry\">${value}</li>`;\n        }\n      })\n      .join('');\n\n    // 添加交互类标记\n    let itemClass = 'world-item';\n    let isInteractive = false;\n\n    // 根据设置决定是否所有WP条目都是可交互的\n    if (option.option?.wp_triggerable) {\n      itemClass += ' interactive';\n      isInteractive = true;\n    } else if (key === '剧情发展' || key === '可移动地点') {\n      // 保留原有的特定条目交互逻辑\n      itemClass += ' interactive';\n      isInteractive = true;\n    }\n\n    // 为一些特定条目添加额外的类\n    if (key === '当前主线剧情事件') {\n      itemClass += ' main-quest';\n    } else if (key === '即将发生的事件') {\n      itemClass += ' upcoming-events';\n    } else if (key === '世界新闻' || key === '周边事件') {\n      itemClass += ' news';\n      // 如果WP可触发设置关闭，保留原有逻辑\n      if (!option.option?.wp_triggerable) {\n        itemClass += ' interactive';\n        isInteractive = true;\n      }\n    } else if (key === '当前npc') {\n      itemClass += ' npcs';\n    } else if (key === '剧情发展信息') {\n      itemClass += ' plot-info';\n    }\n\n    return `<div class=\"${itemClass}\">\n              ${headerTitle}\n              <ul class=\"world-item-list${isInteractive ? ' interactive-list' : ''}\">\n                ${processedValues}\n              </ul>\n            </div>`;\n  }\n\n  // 渲染元信息（MI）条目\n  function renderMetaInfoItem(item) {\n    const { key, values } = item;\n\n    // 获取图标\n    let icon = '<i class=\"fa-solid fa-lightbulb fa-fw\"></i>';\n    if (key === '吐槽') {\n      icon = '<i class=\"fa-solid fa-comments fa-fw\"></i>';\n    } else if (key === '想法') {\n      icon = '<i class=\"fa-solid fa-brain fa-fw\"></i>';\n    }\n\n    // 创建区块标题\n    const headerTitle = `<div class=\"meta-item-header\">${icon} ${key}</div>`;\n\n    // 处理内容\n    const content = values.flat().join(' ');\n\n    // 确定类名\n    let itemClass = 'meta-item';\n    if (key === '想法') {\n      itemClass += ' meta-thoughts';\n    } else if (key === '吐槽') {\n      itemClass += ' meta-comments';\n    }\n\n    return `<div class=\"${itemClass}\">\n              ${headerTitle}\n              <div class=\"meta-item-content\">${content}</div>\n            </div>`;\n  }\n\n  // 添加渲染角色关系参数（RP）条目的函数\n  function renderRelationshipParameterItem(item) {\n    const { key, values } = item;\n\n    // 解析关系参数值\n    let currentValue = 0;\n    let maxValue = 100;\n    let changeValue = '±0';\n    let reason = '无';\n    let stage = '';\n\n    // 尝试解析第一个值（当前值/最大值）\n    if (values[0] && values[0].includes('@')) {\n      const [current, max] = values[0];\n      currentValue = parseInt(current) || 0;\n      maxValue = parseInt(max) || 100;\n    } else if (values[0]) {\n      currentValue = parseInt(values[0]) || 0;\n    }\n\n    // 获取变化值\n    if (values[1]) {\n      changeValue = values[1];\n    }\n\n    // 获取变化原因\n    if (values[2]) {\n      reason = values[2];\n    }\n\n    // 获取阶段描述\n    if (values[3]) {\n      stage = values[3];\n    }\n\n    // 统一使用莫兰迪蓝色\n    const color = '#7797b9';\n    let icon = '<i class=\"fa-solid fa-circle-info fa-fw\"></i>';\n\n    // 根据不同的关系参数类型设置不同图标\n    switch (key) {\n      case '好感度':\n        icon = '<i class=\"fa-solid fa-heart fa-fw\"></i>';\n        break;\n      case '信任度':\n        icon = '<i class=\"fa-solid fa-handshake fa-fw\"></i>';\n        break;\n      case '堕落度':\n        icon = '<i class=\"fa-solid fa-mask fa-fw\"></i>';\n        break;\n      case '支配度':\n        icon = '<i class=\"fa-solid fa-crown fa-fw\"></i>';\n        break;\n      case '依赖度':\n        icon = '<i class=\"fa-solid fa-link fa-fw\"></i>';\n        break;\n      case '羞耻度':\n        icon = '<i class=\"fa-solid fa-face-flushed fa-fw\"></i>';\n        break;\n      case '服从度':\n        icon = '<i class=\"fa-solid fa-gavel fa-fw\"></i>';\n        break;\n      case '声誉':\n        icon = '<i class=\"fa-solid fa-star fa-fw\"></i>';\n        break;\n      default:\n        icon = '<i class=\"fa-solid fa-sliders fa-fw\"></i>';\n    }\n\n    // 变化显示\n    let changeDisplay = '';\n    if (changeValue && changeValue !== '±0') {\n      const isPositive = changeValue.startsWith('+');\n      changeDisplay = `<span class=\"status-change ${isPositive ? 'positive' : 'negative'}\">${changeValue}</span>`;\n    }\n\n    // 原因显示\n    let reasonDisplay = '';\n    if (reason && reason !== '无') {\n      reasonDisplay = `<span class=\"status-reason\">${reason}</span>`;\n    }\n\n    // 阶段显示\n    let stageDisplay = '';\n    if (stage && stage.trim() !== '') {\n      stageDisplay = `<span class=\"relation-stage\">${stage}</span>`;\n    }\n\n    return `<div class=\"status-item relation-parameter\" data-parameter-type=\"${key}\">\n              <div class=\"status-header\">\n                <span class=\"status-label\">${icon} ${key}</span>\n                ${stageDisplay}\n              </div>\n              ${createProgressBar(currentValue, maxValue, color)}\n              <div class=\"status-footer\">\n                <div class=\"status-details-row\">\n                  <span class=\"status-value\">${currentValue}/${maxValue}</span>\n                  ${changeDisplay} ${reasonDisplay}\n                </div>\n              </div>\n            </div>`;\n  }\n\n  // 根据分类选择渲染函数\n  function renderItemByCategory(category, item) {\n    switch (category) {\n      case 'ST':\n        return renderSceneTimeItem(item);\n      case 'CP':\n        return renderCharacterProfileItem(item);\n      case 'CR':\n        return renderResourcesInventoryItem(item);\n      case 'CV':\n        return renderVitalsGaugesItem(item);\n      case 'CS':\n        return renderConditionDescriptorsItem(item);\n      case 'RP': // 添加RP渲染函数\n        return renderRelationshipParameterItem(item);\n      case 'AE':\n        return renderActivityCountersItem(item);\n      case 'WP':\n        return renderWorldPlotItem(item);\n      case 'MI':\n        return renderMetaInfoItem(item);\n      default:\n        // 通用渲染\n        return `<div class=\"status-item\">\n                  <div class=\"status-header\">\n                    <span class=\"status-label\">${item.key}</span>\n                  </div>\n                  <div class=\"status-value\">${item.values.flat().join(' ')}</div>\n                </div>`;\n    }\n  }\n\n  // 创建节标题\n  function createSectionTitle(category) {\n    const mapping = CATEGORY_MAPPING[category] || { name: category, icon: 'fa-circle-info' };\n    return `<div class=\"status-section-title\" data-category=\"${category}\">\n              <div class=\"status-section-toggle\">\n                <i class=\"fa-solid fa-chevron-down collapse-icon\"></i>\n              </div>\n              <i class=\"fa-solid ${mapping.icon} fa-fw status-section-icon\"></i> ${mapping.name}\n            </div>`;\n  }\n\n  // 加载样式\n  async function extract_style() {\n    // 这里可以从Lorebook中加载自定义样式\n    // 现在先使用默认样式\n    return default_style;\n  }\n\n  async function update() {\n    const old_style = style;\n    style = await extract_style();\n    return old_style !== style;\n  }\n  render_1.update = update;\n\n  // 提取状态栏元素\n  function extract_statusbar_element(text) {\n    try {\n      // 解析状态栏文本\n      const parsedData = parseStatusBarText(text);\n      if (isEmpty(parsedData.categories)) {\n        console.log('[状态栏] 解析结果为空，不渲染状态栏');\n        return null;\n      }\n\n      // 创建主容器\n      const $div = $('<div class=\"status-bar-render-container\">');\n\n      // 添加样式\n      if (style) {\n        $div.append(`<style>${style}</style>`);\n      }\n\n      // 创建状态栏容器\n      const container = document.createElement('div');\n      container.className = 'status-bar-container';\n\n      // 首先处理场景与时间 (ST)，显示在顶部\n      if (parsedData.categories['ST']) {\n        const topInfoRow = document.createElement('div');\n        topInfoRow.className = 'status-top-info';\n\n        parsedData.categories['ST'].forEach(item => {\n          if (['时间', '当前地点', '天气'].includes(item.key)) {\n            topInfoRow.innerHTML += renderItemByCategory('ST', item);\n          }\n        });\n\n        if (topInfoRow.innerHTML.trim() !== '') {\n          container.appendChild(topInfoRow);\n        }\n      }\n\n      // 按顺序处理其他分类，添加RP到categoryOrder中\n      const categoryOrder = ['CP', 'CR', 'CV', 'RP', 'CS', 'AE', 'WP', 'MI'];\n\n      // 处理剩余分类\n      categoryOrder.forEach(category => {\n        if (parsedData.categories[category] && parsedData.categories[category].length > 0) {\n          const section = document.createElement('div');\n          section.className = `status-section ${category.toLowerCase()}-section`;\n          section.innerHTML = createSectionTitle(category);\n\n          const contentDiv = document.createElement('div');\n          contentDiv.className = 'status-section-content';\n          if (!option.option.default_expanded) {\n            contentDiv.classList.add('collapsed');\n          }\n\n          parsedData.categories[category].forEach(item => {\n            contentDiv.innerHTML += renderItemByCategory(category, item);\n          });\n\n          section.appendChild(contentDiv);\n          container.appendChild(section);\n        }\n      });\n\n      // 处理未知分类\n      const knownCategories = ['ST', ...categoryOrder];\n      Object.keys(parsedData.categories).forEach(category => {\n        if (!knownCategories.includes(category) && parsedData.categories[category].length > 0) {\n          const section = document.createElement('div');\n          section.className = `status-section unknown-section`;\n          section.innerHTML = `<div class=\"status-section-title\" data-category=\"${category}\">\n                                <div class=\"status-section-toggle\">\n                                  <i class=\"fa-solid fa-chevron-down collapse-icon\"></i>\n                                </div>\n                                <i class=\"fa-solid fa-question fa-fw status-section-icon\"></i> ${category}\n                               </div>`;\n\n          const contentDiv = document.createElement('div');\n          contentDiv.className = 'status-section-content';\n          if (!option.option.default_expanded) {\n            contentDiv.classList.add('collapsed');\n          }\n\n          parsedData.categories[category].forEach(item => {\n            // 使用通用渲染\n            contentDiv.innerHTML += `<div class=\"status-item\">\n                                    <div class=\"status-header\">\n                                      <span class=\"status-label\">${item.key}</span>\n                                    </div>\n                                    <div class=\"status-value\">${item.values.flat().join(' ')}</div>\n                                  </div>`;\n          });\n\n          section.appendChild(contentDiv);\n          container.appendChild(section);\n        }\n      });\n\n      $div.append(container);\n      return $div[0];\n    } catch (error) {\n      console.error('[状态栏] 渲染状态栏时发生错误:', error);\n      return null;\n    }\n  }\n  render_1.extract_statusbar_element = extract_statusbar_element;\n})(render || (render = {}));\n\n// 渲染单条消息\nasync function renderOneMessage(message_id) {\n  try {\n    const message = (await getChatMessages(message_id))[0].message;\n    const match = message.match(status_regex);\n    if (!match) {\n      return;\n    }\n\n    const statusBarContent = match[1];\n\n    // 解析状态栏数据\n    const parsedData = parseStatusBarText(statusBarContent);\n\n    // 如果解析到了数据，保存到聊天变量\n    if (parsedData && Object.keys(parsedData.categories).length > 0) {\n      // 异步保存数据，不阻塞渲染流程\n      saveCharacterDataToVariables(parsedData).catch(err => {\n        console.error('[状态栏] 保存角色数据时出错:', err);\n      });\n    }\n\n    const $statusbar_element = render.extract_statusbar_element(statusBarContent);\n    const $mes_text = retrieveDisplayedMessage(message_id);\n\n    // 删除现有的状态栏\n    $mes_text.find('.status-bar-render-container').remove();\n\n    // 添加新的状态栏\n    if ($statusbar_element) {\n      $mes_text.append($statusbar_element);\n\n      // 添加事件处理，确保传入jQuery对象\n      attachEventHandlers($($statusbar_element));\n    }\n  } catch (error) {\n    console.error('[状态栏] 渲染消息时出错:', error);\n  }\n}\n\n// 渲染所有消息\nasync function renderAllMessages() {\n  $('#chat', window.parent.document)\n    .children(\".mes[is_user='false'][is_system='false']\")\n    .each((_index, node) => {\n      renderOneMessage(Number(node.getAttribute('mesid')));\n    });\n}\n\n// 附加事件处理器\nfunction attachEventHandlers($element) {\n  // 为剧情选项添加点击事件\n  $element.find('.plot-option-item, .world-item-entry').on('click', function () {\n    if ($(this).closest('.interactive-list').length > 0) {\n      const optionText = $(this).text().trim();\n      console.log('[状态栏] 选择选项:', optionText);\n\n      // WP可触发设置下，将内容直接填入发送框\n      if (option.option?.wp_triggerable && $(this).closest('.world-item').length > 0) {\n        console.log('[状态栏] 触发WP条目:', optionText);\n        triggerSlash(`/setinput ${optionText}`);\n        return;\n      }\n\n      // 原有的逻辑\n      triggerSlash(`/setinput ${optionText}`);\n    }\n  });\n\n  // 为地点选项添加点击事件\n  $element.find('.status-locations li').on('click', function () {\n    const locationText = $(this).text().trim();\n    console.log('[状态栏] 选择地点:', locationText);\n    triggerSlash(`/setinput {{User}}决定前往: ${locationText}`);\n  });\n\n  // 为新闻和周边事件添加点击事件\n  $element.find('.status-news li, .status-nearby-events li').on('click', function () {\n    const newsText = $(this).text().trim();\n    console.log('[状态栏] 关注事件:', newsText);\n\n    // WP可触发设置下，简化为直接填入文本\n    if (option.option?.wp_triggerable) {\n      triggerSlash(`/setinput ${newsText}`);\n    } else {\n      triggerSlash(`/setinput {{User}}对\"${newsText}\"表示关注`);\n    }\n  });\n\n  // 为折叠按钮添加点击事件\n  $element.find('.status-section-title').on('click', function () {\n    const $content = $(this).siblings('.status-section-content');\n    $content.toggleClass('collapsed');\n\n    // 更新折叠图标\n    const $icon = $(this).find('.collapse-icon');\n    if ($content.hasClass('collapsed')) {\n      $icon.removeClass('fa-chevron-down').addClass('fa-chevron-right');\n    } else {\n      $icon.removeClass('fa-chevron-right').addClass('fa-chevron-down');\n    }\n  });\n\n  // 初始化折叠图标状态\n  $element.find('.status-section-content').each(function () {\n    const $content = $(this);\n    const $icon = $content.siblings('.status-section-title').find('.collapse-icon');\n\n    if ($content.hasClass('collapsed')) {\n      $icon.removeClass('fa-chevron-down').addClass('fa-chevron-right');\n    } else {\n      $icon.removeClass('fa-chevron-right').addClass('fa-chevron-down');\n    }\n  });\n}\n\n// 错误捕获包装器\nfunction errorCatched(fn) {\n  return (...args) => {\n    try {\n      const result = fn(...args);\n      if (result instanceof Promise) {\n        return result.catch(error => {\n          console.error(`[状态栏] 错误:`, error);\n          triggerSlash(`/echo severity=error [状态栏]${error.stack ? error.stack : error.name + ': ' + error.message}`);\n        });\n      }\n      return result;\n    } catch (error) {\n      console.error(`[状态栏] 错误:`, error);\n      triggerSlash(`/echo severity=error [状态栏]${error.stack ? error.stack : error.name + ': ' + error.message}`);\n      return undefined;\n    }\n  };\n}\n\n// 创建菜单按钮函数\nfunction createMenuButton() {\n  try {\n    const parentDoc = window.parent.document;\n\n    // 检查按钮是否已存在\n    let $button = $(`#${BUTTON_ID}`, parentDoc);\n\n    // 如果按钮存在但不在扩展菜单中，删除它\n    if ($button.length > 0 && !$button.closest('#extensionsMenu').length) {\n      console.log('[状态栏] 移除旧按钮实例');\n      $button.remove();\n      $button = $(`#${BUTTON_ID}`, parentDoc);\n    }\n\n    // 如果按钮不存在，创建并插入\n    if ($button.length === 0) {\n      // 添加样式\n      addButtonStyles();\n\n      const buttonHtml = `\n        <div id=\"${BUTTON_ID}\" class=\"list-group-item flex-container flexGap5 interactable\" \n             title=\"${BUTTON_TOOLTIP}\" tabIndex=\"0\">\n          <i class=\"${BUTTON_ICON}\"></i>\n          <span>${BUTTON_TEXT}</span>\n        </div>\n      `;\n\n      const $extensionsMenu = $('#extensionsMenu', parentDoc);\n\n      if ($extensionsMenu.length) {\n        try {\n          $extensionsMenu.append(buttonHtml);\n          console.log('[状态栏] 按钮已插入扩展菜单');\n\n          // 绑定点击事件\n          $(parentDoc)\n            .off(`click.${BUTTON_ID}`)\n            .on(`click.${BUTTON_ID}`, `#${BUTTON_ID}`, event => {\n              event.preventDefault();\n              showStatusBarManager();\n            });\n        } catch (e) {\n          console.error('[状态栏] 无法将按钮插入扩展菜单', e);\n        }\n      } else {\n        console.warn('[状态栏] 未找到扩展菜单 (#extensionsMenu)');\n      }\n    }\n  } catch (error) {\n    console.error('[状态栏] 创建菜单按钮时出错:', error);\n  }\n}\n\n// 添加按钮样式\nfunction addButtonStyles() {\n  const parentDoc = window.parent.document;\n\n  if ($('#status-bar-manager-styles', parentDoc).length === 0) {\n    const styles = `\n      #${BUTTON_ID} { \n        cursor: pointer;\n      }\n      #${BUTTON_ID}.active {\n        background-color: #6a4a7e !important;\n        color: #fff !important;\n      }\n      #${BUTTON_ID}.active i {\n        color: #fff !important;\n      }\n      \n      .preset-item {\n        margin: 5px 0;\n        padding: 8px 12px;\n        background-color: #f5f5f5;\n        border-radius: 4px;\n        display: flex;\n        justify-content: space-between;\n        align-items: flex-start;\n        flex-wrap: wrap;\n        position: relative;\n      }\n      \n      .preset-item:hover {\n        background-color: #eaeaea;\n      }\n      \n      .dark-mode .preset-item {\n        background-color: #3a3a3a;\n        color: #ddd;\n      }\n      \n      .dark-mode .preset-item:hover {\n        background-color: #444;\n      }\n      \n      .preset-info {\n        flex: 1;\n        margin-right: 10px;\n      }\n      \n      .preset-actions {\n        display: flex;\n        gap: 8px;\n        z-index: 10;\n        position: relative;\n      }\n      \n      .preset-action-btn {\n        background: none;\n        border: none;\n        color: #666;\n        cursor: pointer;\n        padding: 2px 5px;\n        font-size: 14px;\n        border-radius: 3px;\n        transition: background-color 0.2s;\n        z-index: 15; /* 提高按钮z-index，确保可点击 */\n        position: relative;\n      }\n      \n      .preset-action-btn:hover {\n        background-color: rgba(0,0,0,0.1);\n      }\n      \n      .dark-mode .preset-action-btn {\n        color: #aaa;\n      }\n      \n      .dark-mode .preset-action-btn:hover {\n        background-color: rgba(255,255,255,0.1);\n      }\n      \n      .category-group {\n        margin-bottom: 15px;\n      }\n      \n      .category-title {\n        font-weight: 500;\n        margin-bottom: 8px;\n        display: flex;\n        align-items: center;\n        gap: 8px;\n      }\n      \n      .category-title i {\n        opacity: 0.7;\n      }\n      \n      .entry-list {\n        margin-left: 12px;\n      }\n      \n      .entry-item {\n        display: flex;\n        align-items: center;\n        padding: 4px 8px;\n        border-radius: 4px;\n        margin: 3px 0;\n      }\n      \n      .entry-item:hover {\n        background-color: rgba(0,0,0,0.05);\n      }\n      \n      .dark-mode .entry-item:hover {\n        background-color: rgba(255,255,255,0.05);\n      }\n      \n      .entry-checkbox {\n        margin-right: 8px;\n      }\n      \n      .tab-buttons {\n        display: flex;\n        margin-bottom: 15px;\n        border-bottom: 1px solid #ddd;\n      }\n      \n      .dark-mode .tab-buttons {\n        border-bottom-color: #444;\n      }\n      \n      .tab-button {\n        padding: 8px 15px;\n        background: none;\n        border: none;\n        border-bottom: 2px solid transparent;\n        cursor: pointer;\n        transition: all 0.2s;\n        margin-right: 10px;\n        color: #666;\n      }\n      \n      .tab-button.active {\n        border-bottom-color: #3a7bd5;\n        color: #3a7bd5;\n      }\n      \n      .dark-mode .tab-button {\n        color: #aaa;\n      }\n      \n      .dark-mode .tab-button.active {\n        border-bottom-color: #5a97e5;\n        color: #5a97e5;\n      }\n      \n      .tab-content {\n        display: none;\n      }\n      \n      .tab-content.active {\n        display: block;\n      }\n      \n      .preset-details {\n        width: 100%;\n        background-color: #444;\n        border-radius: 4px;\n        padding: 10px;\n        margin-top: 10px;\n        position: relative;\n        z-index: 5;\n      }\n      \n      .preset-entry-item {\n        display: flex;\n        align-items: center;\n        padding: 4px 8px;\n        margin: 2px 0;\n        border-radius: 3px;\n      }\n      \n      .preset-entry-item:hover {\n        background-color: rgba(0,0,0,0.15);\n      }\n      \n      .dark-mode .preset-entry-item:hover {\n        background-color: rgba(255,255,255,0.05);\n      }\n      \n      .preset-entry-checkbox {\n        margin-right: 8px;\n      }\n      \n      .preset-entry-category {\n        margin-top: 8px;\n        margin-bottom: 4px;\n        font-size: 12px;\n        font-weight: 500;\n        color: #ccc;\n        padding-left: 4px;\n        border-left: 2px solid #888;\n      }\n      \n      .dark-mode .preset-entry-category {\n        color: #ddd;\n        border-left-color: #aaa;\n      }\n      \n      .toggle-preset-details-btn {\n        z-index: 15; /* 设置z-index确保按钮可点击 */\n        position: relative;\n        background-color: #333 !important;\n        border-radius: 3px;\n        padding: 2px 6px !important;\n      }\n      \n      .toggle-preset-details-btn:hover {\n        color: #fff !important;\n        background-color: #444 !important;\n      }\n      \n      .preset-entries-list {\n        max-height: 300px;\n        overflow-y: auto;\n        padding-right: 5px;\n      }\n      \n      /* 角色数据相关样式 */\n      .character-data-container {\n        display: flex;\n        height: 65vh; /* 增加高度 */\n        border: 1px solid #444;\n        border-radius: 6px;\n        overflow: hidden;\n        margin-top: 10px;\n      }\n      \n      .character-data-sidebar {\n        width: 30%;\n        background-color: #2d2d2d;\n        border-right: 1px solid #444;\n        display: flex;\n        flex-direction: column;\n      }\n      \n      .sidebar-header {\n        padding: 12px 16px;\n        border-bottom: 1px solid #444;\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n      }\n      \n      .sidebar-header h4 {\n        margin: 0;\n        font-size: 15px;\n        color: #ddd;\n      }\n      \n      .refresh-btn {\n        width: 24px;\n        height: 24px;\n        background-color: #3a3a3a;\n        border-radius: 50%;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        cursor: pointer;\n        transition: all 0.2s;\n      }\n      \n      .refresh-btn:hover {\n        background-color: #4a4a4a;\n      }\n      \n      .refresh-btn i {\n        color: #aaa;\n      }\n      \n      .character-list {\n        flex: 1;\n        overflow-y: auto;\n        padding: 8px;\n      }\n      \n      .character-list-item {\n        padding: 10px 12px;\n        border-radius: 5px;\n        margin-bottom: 8px;\n        cursor: pointer;\n        transition: all 0.2s;\n        background-color: #333;\n        color: #ddd;\n      }\n      \n      .character-list-item:hover {\n        background-color: #3a3a3a;\n      }\n      \n      .character-list-item.active {\n        background-color: #3a7bd5;\n        color: #fff;\n      }\n      \n      .loading-text {\n        text-align: center;\n        color: #777;\n        padding: 20px 0;\n      }\n      \n      .character-data-content {\n        flex: 1;\n        padding: 16px;\n        background-color: #222;\n        overflow-y: auto;\n        max-height: 100%; /* 确保内容区域可以滚动 */\n      }\n      \n      .empty-state {\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        justify-content: center;\n        height: 100%;\n        color: #777;\n      }\n      \n      .empty-state p {\n        margin-top: 10px;\n        font-style: italic;\n      }\n      \n      .character-header {\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        padding-bottom: 12px;\n        margin-bottom: 16px;\n        border-bottom: 1px solid #444;\n      }\n      \n      .character-header h3 {\n        margin: 0;\n        font-size: 18px;\n        color: #ddd;\n      }\n      \n      .character-actions {\n        display: flex;\n        gap: 8px;\n      }\n      \n      .character-action-btn {\n        border: none;\n        padding: 6px 12px;\n        border-radius: 4px;\n        cursor: pointer;\n        font-size: 13px;\n        transition: all 0.2s;\n      }\n      \n      .save-btn {\n        background-color: #3a7bd5;\n        color: #fff;\n      }\n      \n      .save-btn:hover {\n        background-color: #4a8ce5;\n      }\n      \n      .delete-btn {\n        background-color: #9e3a3a;\n        color: #fff;\n      }\n      \n      .delete-btn:hover {\n        background-color: #ae4a4a;\n      }\n      \n      .character-section {\n        background-color: #2a2a2a;\n        border-radius: 6px;\n        padding: 12px 16px;\n        margin-bottom: 16px;\n        max-height: none; /* 移除最大高度限制 */\n        overflow: visible; /* 确保内容可见 */\n      }\n      \n      .character-section h4 {\n        margin: 0 0 12px 0;\n        font-size: 15px;\n        color: #bbb;\n      }\n      \n      .section-header {\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        margin-bottom: 12px;\n      }\n      \n      .add-param-btn {\n        border: none;\n        background-color: #40634e;\n        color: white;\n        padding: 4px 8px;\n        border-radius: 3px;\n        font-size: 12px;\n        cursor: pointer;\n      }\n      \n      .add-param-btn:hover {\n        background-color: #4d7a60;\n      }\n      \n      .character-fields {\n        display: grid;\n        grid-template-columns: 1fr 1fr;\n        gap: 12px;\n      }\n      \n      .character-field {\n        margin-bottom: 8px;\n      }\n      \n      .character-field label {\n        display: block;\n        margin-bottom: 5px;\n        color: #aaa;\n        font-size: 13px;\n      }\n      \n      .character-input, .character-textarea, .character-select {\n        width: 100%;\n        padding: 8px;\n        background-color: #333;\n        border: 1px solid #555;\n        color: #ddd;\n        border-radius: 4px;\n        font-size: 14px;\n      }\n      \n      .character-input:focus, .character-textarea:focus, .character-select:focus {\n        outline: none;\n        border-color: #3a7bd5;\n      }\n      \n      .character-textarea {\n        resize: vertical;\n      }\n      \n      .relationship-params-container {\n        display: grid;\n        grid-template-columns: 1fr;\n        gap: 12px;\n        max-height: none; /* 移除高度限制 */\n        overflow-y: visible; /* 允许内容溢出 */\n      }\n      \n      .relationship-param {\n        background-color: #333;\n        border-radius: 4px;\n        padding: 10px 14px;\n        position: relative;\n      }\n      \n      .param-header {\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        margin-bottom: 10px;\n      }\n      \n      .param-name {\n        font-weight: 500;\n        color: #ccc;\n      }\n      \n      .param-remove {\n        background: none;\n        border: none;\n        color: #999;\n        cursor: pointer;\n        padding: 2px 6px;\n        font-size: 14px;\n      }\n      \n      .param-remove:hover {\n        color: #e55;\n      }\n      \n      .param-fields {\n        display: grid;\n        grid-template-columns: 1fr 1fr;\n        gap: 10px;\n      }\n      \n      .character-no-data {\n        text-align: center;\n        padding: 20px;\n        color: #888;\n        font-style: italic;\n      }\n      \n      /* 确保弹窗可以滚动查看所有内容 */\n      #${POPUP_ID} {\n        max-height: 85vh;\n        overflow-y: auto;\n      }\n      \n      /* 确保角色参数列表能容纳更多内容 */\n      #relationship-params-container {\n        max-height: none;\n        padding-bottom: 10px;\n      }\n      \n      /* 调整输入框大小 */\n      .character-field input, \n      .character-field textarea {\n        box-sizing: border-box;\n        width: 100%;\n      }\n      \n      /* 修复输入框样式 */\n      .character-field {\n        margin-bottom: 12px;\n      }\n      \n      /* 确保内容区可以滚动 */\n      .tab-content {\n        overflow: visible;\n      }\n      \n      /* 设置参数表现的最大高度并添加滚动 */\n      #character-data-tab .relationship-params-container {\n        max-height: 350px;\n        overflow-y: auto;\n        padding-right: 5px;\n      }\n      \n      /* 应用更改按钮样式 */\n      .apply-changes-container {\n        margin-top: 20px;\n        padding: 15px;\n        background-color: rgba(64, 99, 78, 0.1);\n        border-radius: 6px;\n        text-align: center;\n      }\n      \n      #apply-entries-changes-btn {\n        background: #40634e;\n        color: white;\n        border: none;\n        padding: 8px 20px;\n        border-radius: 4px;\n        cursor: pointer;\n        font-size: 15px;\n        transition: all 0.2s;\n      }\n      \n      #apply-entries-changes-btn:hover {\n        background: #4d7a60;\n        transform: translateY(-2px);\n      }\n      \n      #apply-entries-changes-btn:disabled {\n        background: #304a3b;\n        cursor: not-allowed;\n        transform: none;\n      }\n      \n      .dark-mode #apply-entries-changes-btn {\n        background: #40634e;\n        color: white;\n      }\n      \n      .dark-mode #apply-entries-changes-btn:hover {\n        background: #4d7a60;\n      }\n      \n      .dark-mode #apply-entries-changes-btn:disabled {\n        background: #304a3b;\n        color: #aaa;\n      }\n      \n      .apply-changes-container p {\n        font-size: 12px;\n        color: #888;\n        margin-top: 8px;\n        font-style: italic;\n      }\n      \n      .dark-mode .apply-changes-container {\n        background-color: rgba(64, 99, 78, 0.15);\n      }\n      \n      .dark-mode .apply-changes-container p {\n        color: #aaa;\n      }\n    `;\n    $('head', parentDoc).append(`<style id=\"status-bar-manager-styles\">${styles}</style>`);\n  }\n}\n\n// 获取保存的预设\nfunction getSavedPresets() {\n  try {\n    const savedPresets = localStorage.getItem(PRESET_STORAGE_KEY);\n    // 确保返回的是数组\n    const presets = savedPresets ? JSON.parse(savedPresets) : [];\n\n    // 验证格式\n    if (!Array.isArray(presets)) {\n      console.error('[状态栏] 预设数据格式错误，重置为空数组');\n      return [];\n    }\n\n    return presets;\n  } catch (error) {\n    console.error('[状态栏] 获取配置失败:', error);\n    return [];\n  }\n}\n\n// 保存预设\nfunction savePreset(name, enabledEntries) {\n  try {\n    const presets = getSavedPresets();\n\n    // 确保enabledEntries中的UID是数字类型\n    const normalizedEntries = enabledEntries.map(uid => parseInt(uid));\n    console.log('[状态栏] 保存配置:', name, '包含启用条目:', normalizedEntries);\n\n    // 检查是否已经存在同名配置\n    const existingIndex = presets.findIndex(p => p.name === name);\n\n    if (existingIndex !== -1) {\n      // 更新现有配置\n      presets[existingIndex] = { name, enabledEntries: normalizedEntries, timestamp: Date.now() };\n    } else {\n      // 添加新配置，但确保不超过最大数量\n      if (presets.length >= MAX_PRESETS) {\n        alert(`已达到配置数量上限 (${MAX_PRESETS})，请先删除一些配置。`);\n        return false;\n      }\n      presets.push({ name, enabledEntries: normalizedEntries, timestamp: Date.now() });\n    }\n\n    localStorage.setItem(PRESET_STORAGE_KEY, JSON.stringify(presets));\n    return true;\n  } catch (error) {\n    console.error('[状态栏] 保存配置失败:', error);\n    return false;\n  }\n}\n\n// 删除预设\nfunction deletePreset(name) {\n  try {\n    const presets = getSavedPresets();\n\n    // 日志记录原始预设数量\n    console.log(`[状态栏] 删除前预设数量: ${presets.length}`);\n\n    // 确保name是字符串并进行严格比较\n    const exactName = String(name).trim();\n    const newPresets = presets.filter(p => String(p.name).trim() !== exactName);\n\n    // 日志记录过滤后预设数量\n    console.log(`[状态栏] 删除后预设数量: ${newPresets.length}`);\n\n    // 保存回本地存储\n    localStorage.setItem(PRESET_STORAGE_KEY, JSON.stringify(newPresets));\n\n    // 确认是否成功删除\n    const checkPresets = getSavedPresets();\n    const stillExists = checkPresets.some(p => String(p.name).trim() === exactName);\n    console.log(`[状态栏] 验证删除: ${stillExists ? '失败' : '成功'}`);\n\n    return !stillExists;\n  } catch (error) {\n    console.error('[状态栏] 删除配置失败:', error);\n    return false;\n  }\n}\n\n// 应用预设\nasync function applyPreset(preset) {\n  try {\n    console.log('[状态栏] 开始应用配置:', preset.name, '包含', preset.enabledEntries.length, '个启用的条目');\n\n    // 获取所有条目\n    const entries = await getLorebookEntries(lorebook_name);\n    console.log('[状态栏] 获取到世界书条目总数:', entries.length);\n\n    // 创建更新后的条目数组\n    const updatedEntries = [];\n    let modifiedCount = 0;\n\n    entries.forEach(entry => {\n      // 创建条目的副本\n      const updatedEntry = { ...entry };\n\n      // 忽略设置条目\n      if (entry.comment.startsWith('设置-')) {\n        updatedEntries.push(updatedEntry);\n        return;\n      }\n\n      // 检查条目是否在预设中启用 (确保使用数字类型比较)\n      const entryUid = parseInt(entry.uid);\n      const shouldBeEnabled = preset.enabledEntries.includes(entryUid);\n\n      // 只有在启用状态需要改变时才修改\n      if (entry.enabled !== shouldBeEnabled) {\n        updatedEntry.enabled = shouldBeEnabled;\n        modifiedCount++;\n        console.log(`[状态栏] 条目状态变更: \"${entry.comment}\" (UID: ${entry.uid}) ${entry.enabled ? '禁用' : '启用'}`);\n      }\n\n      updatedEntries.push(updatedEntry);\n    });\n\n    console.log(`[状态栏] 将更新 ${modifiedCount} 个条目的状态`);\n\n    if (modifiedCount > 0) {\n      // 更新世界书 - 确保每个条目都有uid\n      await setLorebookEntries(lorebook_name, updatedEntries);\n      console.log('[状态栏] 世界书更新成功');\n    } else {\n      console.log('[状态栏] 没有条目需要更新，预设可能已经应用');\n    }\n\n    return true;\n  } catch (error) {\n    console.error('[状态栏] 应用配置失败:', error);\n    return false;\n  }\n}\n\n// 显示状态栏管理器弹窗\nasync function showStatusBarManager() {\n  try {\n    // 获取状态栏世界书的所有条目\n    const entries = await getLorebookEntries(lorebook_name);\n\n    // 对条目进行排序处理\n    entries.sort((a, b) => {\n      // 首先检查是否设置条目，如果是，放到最后\n      if (a.comment.startsWith('设置-') && !b.comment.startsWith('设置-')) return 1;\n      if (!a.comment.startsWith('设置-') && b.comment.startsWith('设置-')) return -1;\n\n      // 尝试使用display_index排序\n      if (a.display_index !== undefined && b.display_index !== undefined) {\n        return a.display_index - b.display_index;\n      }\n\n      // 如果没有display_index，则按注释文本排序\n      return a.comment.localeCompare(b.comment, 'zh-CN');\n    });\n\n    // 按类别分组条目，忽略设置条目\n    const entriesByCategory = entries\n      .filter(entry => !entry.comment.startsWith('设置-'))\n      .reduce((acc, entry) => {\n        // 尝试从注释中提取类别，格式如: [ST|时间] 的 ST 部分\n        let category = 'Other';\n        const categoryMatch = entry.comment.match(/\\[(\\w+)\\|/);\n        if (categoryMatch) {\n          category = categoryMatch[1];\n        }\n\n        if (!acc[category]) {\n          acc[category] = [];\n        }\n        acc[category].push(entry);\n        return acc;\n      }, {});\n\n    // 按类别优先级排序\n    const categoryOrder = ['ST', 'CP', 'CR', 'CV', 'RP', 'CS', 'AE', 'WP', 'MI', 'Other'];\n    const sortedEntriesByCategory = {};\n\n    // 按照预定义顺序填充分类\n    categoryOrder.forEach(category => {\n      if (entriesByCategory[category] && entriesByCategory[category].length > 0) {\n        sortedEntriesByCategory[category] = entriesByCategory[category];\n      }\n    });\n\n    // 添加任何其他未在预定义顺序中的分类\n    Object.keys(entriesByCategory).forEach(category => {\n      if (!sortedEntriesByCategory[category]) {\n        sortedEntriesByCategory[category] = entriesByCategory[category];\n      }\n    });\n\n    // 获取保存的预设\n    const savedPresets = getSavedPresets();\n\n    // 创建弹窗\n    createStatusBarManagerPopup(sortedEntriesByCategory, savedPresets);\n  } catch (error) {\n    console.error('[状态栏] 显示状态栏管理器失败:', error);\n  }\n}\n\n// 创建状态栏管理器弹窗\nfunction createStatusBarManagerPopup(entriesByCategory, presets) {\n  // 清理已有弹窗\n  $(`#${POPUP_ID}`, window.parent.document).remove();\n  $(`#${POPUP_ID}-overlay`, window.parent.document).remove();\n\n  // 确保entriesByCategory和presets存在\n  entriesByCategory = entriesByCategory || {};\n  presets = presets || [];\n\n  // 确保presets是数组\n  if (!Array.isArray(presets)) {\n    console.warn('[状态栏] 预设数据不是数组，已重置为空数组');\n    presets = [];\n  }\n\n  // 检查预设内容完整性\n  presets = presets.filter(preset => {\n    if (!preset || typeof preset !== 'object' || !preset.name) {\n      console.warn('[状态栏] 发现无效预设，将被过滤:', preset);\n      return false;\n    }\n    // 确保enabledEntries是数组\n    if (!Array.isArray(preset.enabledEntries)) {\n      console.warn(`[状态栏] 预设 \"${preset.name}\" 的enabledEntries不是数组，已修复`);\n      preset.enabledEntries = [];\n    }\n    return true;\n  });\n\n  // 构建内容\n  const popupContent = `\n    <div style=\"display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #444;\">\n      <h3 style=\"margin: 0; color: #e0e0e0; font-weight: 500; font-size: 18px;\">状态栏管理器</h3>\n      <div>\n        <button id=\"close-${POPUP_ID}\" style=\"background: transparent; border: none; color: #aaa; cursor: pointer; font-size: 20px; padding: 0; margin: 0; transition: color 0.2s; vertical-align: middle;\">&times;</button>\n      </div>\n    </div>\n    \n    <div class=\"tab-buttons\">\n      <button class=\"tab-button active\" data-tab=\"entries\">条目管理</button>\n      <button class=\"tab-button\" data-tab=\"presets\">配置管理</button>\n      <button class=\"tab-button\" data-tab=\"character-data\">角色数据</button>\n    </div>\n    \n    <div id=\"${POPUP_ID}-content\" style=\"max-height: 60vh; overflow-y: auto; font-size: 14px; color: #bbb; scrollbar-width: thin; scrollbar-color: #666 #333; padding-bottom: 10px;\">\n      <div class=\"tab-content active\" id=\"entries-tab\">\n        <div style=\"margin-bottom: 15px;\">\n          <button id=\"save-entries-btn\" style=\"background: #3a7bd5; border: none; color: #fff; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-right: 10px;\">保存为配置</button>\n          <button id=\"toggle-all-btn\" style=\"background: #555; border: none; color: #ddd; padding: 6px 12px; border-radius: 4px; cursor: pointer;\">全选/取消全选</button>\n        </div>\n        \n        ${\n          Object.entries(entriesByCategory).length > 0\n            ? Object.entries(entriesByCategory)\n                .map(([category, categoryEntries]) => {\n                  // 获取类别图标\n                  const categoryInfo = CATEGORY_MAPPING[category] || { name: category, icon: 'fa-circle-info' };\n\n                  return `\n              <div class=\"category-group\" data-category=\"${category}\">\n                <div class=\"category-title\">\n                  <i class=\"fa-solid ${categoryInfo.icon}\"></i>\n                  <span>${categoryInfo.name || category}</span>\n                </div>\n                <div class=\"entry-list\">\n                  ${\n                    Array.isArray(categoryEntries)\n                      ? categoryEntries\n                          .map(\n                            entry => `\n                      <div class=\"entry-item\">\n                        <input type=\"checkbox\" class=\"entry-checkbox\" id=\"entry-${entry.uid}\" \n                          data-uid=\"${entry.uid}\" data-comment=\"${entry.comment}\" ${entry.enabled ? 'checked' : ''}>\n                        <label for=\"entry-${entry.uid}\">${entry.comment}</label>\n                      </div>\n                    `,\n                          )\n                          .join('')\n                      : '<div class=\"entry-item\">没有条目数据</div>'\n                  }\n                </div>\n              </div>\n            `;\n                })\n                .join('')\n            : '<div class=\"empty-state\" style=\"text-align: center; padding: 20px; color: #777;\">没有找到条目</div>'\n        }\n        \n        <!-- 添加应用按钮 -->\n        <div class=\"apply-changes-container\" style=\"margin-top: 20px; padding-top: 15px; border-top: 1px solid #444; text-align: center;\">\n          <button id=\"apply-entries-changes-btn\" style=\"background: #40634e; border: none; color: #fff; padding: 8px 20px; border-radius: 4px; cursor: pointer; font-size: 15px;\">\n            <i class=\"fa-solid fa-check\"></i> 应用更改\n          </button>\n          <p style=\"font-size: 12px; color: #888; margin-top: 8px;\">\n            点击复选框后需点击此按钮保存更改，避免频繁更新导致卡顿\n          </p>\n        </div>\n      </div>\n      \n      <div class=\"tab-content\" id=\"presets-tab\">\n        ${\n          !Array.isArray(presets) || presets.length === 0\n            ? '<p style=\"font-style: italic; color: #999; text-align: center; margin: 20px 0;\">尚未保存任何配置</p>'\n            : `\n            <div style=\"margin-bottom: 10px; font-weight: 500;\">\n              已保存的配置 (${presets.length}/${MAX_PRESETS})\n            </div>\n            ${presets\n              .map(\n                preset => `\n              <div class=\"preset-item\" data-name=\"${preset.name}\">\n                <div class=\"preset-info\">\n                  <div style=\"font-weight: 500; display: flex; align-items: center; justify-content: space-between;\">\n                    ${preset.name}\n                    <button class=\"toggle-preset-details-btn\" style=\"background: none; border: none; color: #aaa; cursor: pointer; padding: 0 5px;\">\n                      <i class=\"fa-solid fa-chevron-down\"></i>\n                    </button>\n                  </div>\n                  <div style=\"font-size: 12px; color: #888;\">\n                    启用条目: ${Array.isArray(preset.enabledEntries) ? preset.enabledEntries.length : 0} 个，\n                    创建: ${new Date(preset.timestamp || Date.now()).toLocaleString()}\n                  </div>\n                </div>\n                <div class=\"preset-actions\">\n                  <button class=\"preset-action-btn apply-preset-btn\" data-name=\"${preset.name}\">\n                    <i class=\"fa-solid fa-check\"></i> 应用\n                  </button>\n                  <button class=\"preset-action-btn delete-preset-btn\" data-name=\"${preset.name}\">\n                    <i class=\"fa-solid fa-trash\"></i>\n                  </button>\n                </div>\n                <div class=\"preset-details\" style=\"display: none; margin-top: 10px; border-top: 1px solid #444; padding-top: 10px;\">\n                  <p style=\"margin: 5px 0; font-size: 12px; color: #888;\">点击展开时加载...</p>\n                </div>\n              </div>\n            `,\n              )\n              .join('')}\n          `\n        }\n      </div>\n\n      <div class=\"tab-content\" id=\"character-data-tab\">\n        <div class=\"character-data-container\">\n          <div class=\"character-data-sidebar\">\n            <div class=\"sidebar-header\">\n              <h4>保存的角色</h4>\n              <div class=\"refresh-btn\" id=\"refresh-character-data-btn\">\n                <i class=\"fa-solid fa-rotate\"></i>\n              </div>\n            </div>\n            <div class=\"character-list\" id=\"character-data-list\">\n              <p class=\"loading-text\">加载中...</p>\n            </div>\n          </div>\n          <div class=\"character-data-content\">\n            <div class=\"empty-state\" id=\"character-data-empty-state\">\n              <i class=\"fa-solid fa-user-slash fa-2x\"></i>\n              <p>请从左侧选择一个角色</p>\n            </div>\n            <div class=\"character-detail\" id=\"character-data-detail\" style=\"display: none;\">\n              <div class=\"character-header\">\n                <h3 id=\"character-name\">角色名称</h3>\n                <div class=\"character-actions\">\n                  <button id=\"save-character-data-btn\" class=\"character-action-btn save-btn\">\n                    <i class=\"fa-solid fa-save\"></i> 保存\n                  </button>\n                  <button id=\"delete-character-data-btn\" class=\"character-action-btn delete-btn\">\n                    <i class=\"fa-solid fa-trash\"></i> 删除\n                  </button>\n                </div>\n              </div>\n              <div class=\"character-sections\">\n                <div class=\"character-section\">\n                  <h4>基本信息</h4>\n                  <div class=\"character-fields basic-info-fields\">\n                    <div class=\"character-field\">\n                      <label for=\"character-age\">年龄</label>\n                      <input type=\"text\" id=\"character-age\" class=\"character-input\">\n                    </div>\n                    <div class=\"character-field\">\n                      <label for=\"character-height\">身高</label>\n                      <input type=\"text\" id=\"character-height\" class=\"character-input\">\n                    </div>\n                    <div class=\"character-field\">\n                      <label for=\"character-traits\">特征</label>\n                      <textarea id=\"character-traits\" class=\"character-textarea\" rows=\"2\"></textarea>\n                    </div>\n                    <div class=\"character-field\">\n                      <label for=\"character-permanent\">永久性状态</label>\n                      <textarea id=\"character-permanent\" class=\"character-textarea\" rows=\"2\"></textarea>\n                    </div>\n                  </div>\n                </div>\n                <div class=\"character-section\">\n                  <div class=\"section-header\">\n                    <h4>关系参数</h4>\n                    <button id=\"add-param-btn\" class=\"add-param-btn\">\n                      <i class=\"fa-solid fa-plus\"></i> 添加参数\n                    </button>\n                  </div>\n                  <div id=\"relationship-params-container\" class=\"relationship-params-container\">\n                    <!-- 动态加载关系参数 -->\n                  </div>\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n    \n    <div style=\"display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; border-top: 1px solid #444; padding-top: 15px;\">\n      <button id=\"cancel-${POPUP_ID}\" style=\"background: #444; border: none; color: #ddd; cursor: pointer; font-size: 14px; padding: 8px 15px; border-radius: 4px; transition: background-color 0.2s;\">关闭</button>\n    </div>\n  `;\n\n  // 创建弹窗\n  createPopup(popupContent);\n\n  // 绑定事件处理\n  initStatusBarManagerEvents();\n}\n\n// 初始化弹窗事件处理\nfunction initStatusBarManagerEvents() {\n  const parentDoc = window.parent.document;\n  const namespace = '.statusBarManager'; // 定义命名空间\n\n  // 确保移除旧的监听器，以防万一（虽然createPopup时会调用closePopup）\n  $(parentDoc).off(namespace);\n\n  // 标签切换事件\n  $(parentDoc).on(`click${namespace}`, '.tab-button', function () {\n    const tab = $(this).data('tab');\n    $('.tab-button', parentDoc).removeClass('active');\n    $(this).addClass('active');\n    $('.tab-content', parentDoc).removeClass('active');\n    $(`#${tab}-tab`, parentDoc).addClass('active');\n\n    if (tab === 'character-data') {\n      loadCharacterDataList();\n    }\n  });\n\n  // 全选/取消全选按钮事件\n  $(parentDoc).on(`click${namespace}`, '#toggle-all-btn', function () {\n    const $checkboxes = $('.entry-checkbox', parentDoc);\n    const allChecked = $checkboxes.length === $checkboxes.filter(':checked').length;\n    $checkboxes.prop('checked', !allChecked);\n  });\n\n  // 复选框变更事件\n  $(parentDoc).on(`change${namespace}`, '.entry-checkbox', function () {\n    console.log(\n      `[状态栏] 复选框状态变更: UID ${$(this).data('uid')}, 状态: ${$(this).prop('checked') ? '选中' : '未选中'}`,\n    );\n  });\n\n  // 应用更改按钮事件\n  $(parentDoc).on(`click${namespace}`, '#apply-entries-changes-btn', async function () {\n    // ... (代码保持不变)\n    const $btn = $(this);\n    const originalText = $btn.html();\n\n    try {\n      $btn.html('<i class=\"fa-solid fa-spinner fa-spin\"></i> 正在应用...');\n      $btn.prop('disabled', true);\n\n      const entries = await getLorebookEntries(lorebook_name);\n      const checkboxStates = {};\n      $('.entry-checkbox', parentDoc).each(function () {\n        const uid = parseInt($(this).data('uid'));\n        const isEnabled = $(this).prop('checked');\n        checkboxStates[uid] = isEnabled;\n      });\n\n      let updateCount = 0;\n      const updatedEntries = entries.map(entry => {\n        if (entry.comment.startsWith('设置-')) return entry;\n        const uid = parseInt(entry.uid);\n        const newState = checkboxStates[uid];\n        if (newState !== undefined && entry.enabled !== newState) {\n          updateCount++;\n          return { ...entry, enabled: newState };\n        }\n        return entry;\n      });\n\n      if (updateCount > 0) {\n        await setLorebookEntries(lorebook_name, updatedEntries);\n        $btn.html('<i class=\"fa-solid fa-check\"></i> 已应用');\n        setTimeout(() => {\n          $btn.html(originalText);\n          $btn.prop('disabled', false);\n        }, 2000);\n        console.log(`[状态栏] 已批量更新 ${updateCount} 个条目的状态`);\n      } else {\n        $btn.html('<i class=\"fa-solid fa-check\"></i> 无变更');\n        setTimeout(() => {\n          $btn.html(originalText);\n          $btn.prop('disabled', false);\n        }, 2000);\n        console.log('[状态栏] 没有条目需要更新');\n      }\n    } catch (error) {\n      console.error('[状态栏] 应用更改失败:', error);\n      $btn.html('<i class=\"fa-solid fa-times\"></i> 应用失败');\n      setTimeout(() => {\n        $btn.html(originalText);\n        $btn.prop('disabled', false);\n      }, 2000);\n      alert(`应用更改失败: ${error.message}`);\n    }\n  });\n\n  // 保存为配置按钮事件\n  $(parentDoc).on(`click${namespace}`, '#save-entries-btn', function () {\n    // ... (代码保持不变)\n    const name = prompt('请输入配置名称:');\n    if (!name) return;\n    const enabledEntries = [];\n    $('.entry-checkbox:checked', parentDoc).each(function () {\n      enabledEntries.push(parseInt($(this).data('uid')));\n    });\n    if (savePreset(name, enabledEntries)) {\n      alert(`配置 \"${name}\" 已保存。`);\n      closePopup();\n      showStatusBarManager();\n    }\n  });\n\n  // 应用配置按钮事件\n  $(parentDoc).on(`click${namespace}`, '.apply-preset-btn', async function () {\n    // ... (代码保持不变)\n    const presetName = $(this).data('name');\n    const presets = getSavedPresets();\n    const preset = presets.find(p => String(p.name).trim() === String(presetName).trim());\n    if (preset) {\n      if (!Array.isArray(preset.enabledEntries)) {\n        alert('配置格式错误，无法应用');\n        return;\n      }\n      if (confirm(`确定要应用配置 \"${presetName}\" 吗？`)) {\n        $(this).html('<i class=\"fa-solid fa-spinner fa-spin\"></i> 应用中...').prop('disabled', true);\n        try {\n          const success = await applyPreset(preset);\n          if (success) {\n            alert(`配置 \"${presetName}\" 已应用。`);\n            closePopup();\n            await renderAllMessages();\n          } else {\n            $(this).html('<i class=\"fa-solid fa-check\"></i> 应用').prop('disabled', false);\n            alert('应用配置失败，请重试。');\n          }\n        } catch (error) {\n          $(this).html('<i class=\"fa-solid fa-check\"></i> 应用').prop('disabled', false);\n          alert('应用配置时发生错误: ' + error.message);\n        }\n      }\n    } else {\n      alert(`找不到配置 \"${presetName}\"`);\n    }\n  });\n\n  // 删除配置按钮事件\n  $(parentDoc).on(`click${namespace}`, '.delete-preset-btn', function (e) {\n    // ... (代码保持不变)\n    e.preventDefault();\n    e.stopPropagation();\n    const presetName = $(this).data('name');\n    if (confirm(`确定要删除配置 \"${presetName}\" 吗？`)) {\n      try {\n        if (deletePreset(presetName)) {\n          $(`.preset-item[data-name=\"${presetName}\"]`, parentDoc).remove();\n          if ($('.preset-item', parentDoc).length === 0) {\n            $('#presets-tab', parentDoc).html(\n              '<p style=\"font-style: italic; color: #999; text-align: center; margin: 20px 0;\">尚未保存任何配置</p>',\n            );\n          }\n        } else {\n          alert('删除配置失败，请重试。');\n        }\n      } catch (error) {\n        alert(`删除配置时发生错误: ${error.message}`);\n      }\n    }\n  });\n\n  // 展开/折叠详情按钮事件\n  $(parentDoc).on(`click${namespace}`, '.toggle-preset-details-btn', function (e) {\n    e.preventDefault();\n    e.stopPropagation();\n    const $btn = $(this);\n    const $icon = $btn.find('i');\n    const $presetItem = $btn.closest('.preset-item');\n    const $detailsSection = $presetItem.find('.preset-details');\n    const presetName = $presetItem.data('name');\n\n    $detailsSection.toggle();\n\n    if ($detailsSection.is(':visible')) {\n      $icon.removeClass('fa-chevron-down').addClass('fa-chevron-up');\n      $presetItem.attr('data-expanded', 'true');\n      console.log(`[状态栏] 预设详情已展开: \"${presetName}\"`);\n      $detailsSection.html(\n        '<p style=\"text-align: center; margin: 15px 0;\"><i class=\"fa-solid fa-spinner fa-spin\"></i> 加载条目中...</p>',\n      );\n      loadPresetDetails(presetName, $detailsSection);\n    } else {\n      $icon.removeClass('fa-chevron-up').addClass('fa-chevron-down');\n      $presetItem.removeAttr('data-expanded');\n      console.log(`[状态栏] 预设详情已折叠: \"${presetName}\"`);\n    }\n  });\n\n  // 配置条目复选框变更事件\n  $(parentDoc).on(`change${namespace}`, '.preset-entry-checkbox', function () {\n    // ... (代码保持不变)\n    const uid = parseInt($(this).data('uid'));\n    const presetName = $(this).data('preset');\n    const isEnabled = $(this).prop('checked');\n    const presets = getSavedPresets();\n    const presetIndex = presets.findIndex(p => String(p.name).trim() === String(presetName).trim());\n    if (presetIndex === -1) {\n      alert(`无法更新配置: 找不到配置 \"${presetName}\"`);\n      return;\n    }\n    const updatedPreset = { ...presets[presetIndex] };\n    if (!Array.isArray(updatedPreset.enabledEntries)) updatedPreset.enabledEntries = [];\n    if (isEnabled) {\n      if (!updatedPreset.enabledEntries.includes(uid)) updatedPreset.enabledEntries.push(uid);\n    } else {\n      updatedPreset.enabledEntries = updatedPreset.enabledEntries.filter(id => id !== uid);\n    }\n    updatedPreset.timestamp = Date.now();\n    presets[presetIndex] = updatedPreset;\n    try {\n      localStorage.setItem(PRESET_STORAGE_KEY, JSON.stringify(presets));\n      const $presetItem = $(this).closest('.preset-item');\n      $presetItem\n        .find('.preset-info div:nth-child(2)')\n        .text(\n          `启用条目: ${updatedPreset.enabledEntries.length} 个，创建: ${new Date(\n            updatedPreset.timestamp,\n          ).toLocaleString()}`,\n        );\n      console.log(`[状态栏] 配置 \"${presetName}\" 已更新，条目 ${uid} ${isEnabled ? '添加' : '移除'}`);\n    } catch (error) {\n      alert(`更新配置失败: ${error.message}`);\n      $(this).prop('checked', !isEnabled);\n    }\n  });\n\n  // 角色数据相关事件处理 (也使用命名空间)\n  initCharacterDataTabEvents(namespace); // 重命名调用\n}\n\n// 初始化角色数据相关事件处理 - 重命名函数定义\nfunction initCharacterDataTabEvents(namespace) {\n  // 接受命名空间作为参数\n  const parentDoc = window.parent.document;\n\n  // 刷新按钮事件\n  $(parentDoc).on(`click${namespace}`, '#refresh-character-data-btn', function () {\n    loadCharacterDataList();\n  });\n\n  // 角色列表项点击事件\n  $(parentDoc).on(`click${namespace}`, '.character-list-item', function () {\n    const characterName = $(this).data('name');\n    $('.character-list-item', parentDoc).removeClass('active');\n    $(this).addClass('active');\n    loadCharacterDetail(characterName);\n  });\n\n  // 添加参数按钮事件\n  $(parentDoc).on(`click${namespace}`, '#add-param-btn', function () {\n    addEmptyRelationshipParam();\n  });\n\n  // 删除参数按钮事件\n  $(parentDoc).on(`click${namespace}`, '.param-remove', function () {\n    $(this).closest('.relationship-param').remove();\n  });\n\n  // 保存角色数据按钮事件\n  $(parentDoc).on(`click${namespace}`, '#save-character-data-btn', function () {\n    saveCharacterDetailChanges();\n  });\n\n  // 删除角色数据按钮事件\n  $(parentDoc).on(`click${namespace}`, '#delete-character-data-btn', function () {\n    const characterName = $('#character-name', parentDoc).text();\n    if (confirm(`确定要删除角色 \"${characterName}\" 的数据吗？此操作不可撤销。`)) {\n      deleteCharacterData(characterName);\n    }\n  });\n}\n\n// 关闭弹窗函数\nfunction closePopup() {\n  const parentDoc = window.parent.document;\n  const namespace = '.statusBarManager'; // 使用相同的命名空间\n\n  // 移除所有使用该命名空间的事件监听\n  $(parentDoc).off(namespace);\n\n  // 移除DOM元素\n  $(`#${POPUP_ID}`, parentDoc).remove();\n  $(`#${POPUP_ID}-overlay`, parentDoc).remove();\n  $(`#${POPUP_ID}-animation-style`, parentDoc.head).remove();\n}\n\n// 新增异步加载预设详情函数\nasync function loadPresetDetails(presetName, $detailsSection) {\n  try {\n    console.log(`[状态栏] 开始加载预设详情: \"${presetName}\"`);\n\n    // 获取配置\n    const presets = getSavedPresets();\n    const preset = presets.find(p => String(p.name).trim() === String(presetName).trim());\n\n    if (!preset) {\n      $detailsSection.html('<p style=\"color: #f55; margin: 10px 0;\">无法加载配置详情: 配置不存在</p>');\n      return;\n    }\n\n    // 确保enabledEntries是数组\n    if (!Array.isArray(preset.enabledEntries)) {\n      preset.enabledEntries = [];\n      console.warn(`[状态栏] 预设 \"${presetName}\" 的enabledEntries不是数组，已重置为空数组`);\n    }\n\n    // 获取所有条目\n    const entries = await getLorebookEntries(lorebook_name);\n    console.log(`[状态栏] 获取Lorebook条目成功，总数: ${entries.length}`);\n\n    // 先对条目进行排序 - 优先使用display_index，其次使用comment\n    entries.sort((a, b) => {\n      // 首先检查是否设置条目，如果是，放到最后\n      if (a.comment.startsWith('设置-') && !b.comment.startsWith('设置-')) return 1;\n      if (!a.comment.startsWith('设置-') && b.comment.startsWith('设置-')) return -1;\n\n      // 尝试使用display_index排序\n      if (a.display_index !== undefined && b.display_index !== undefined) {\n        return a.display_index - b.display_index;\n      }\n\n      // 如果没有display_index，则按注释文本排序\n      return a.comment.localeCompare(b.comment, 'zh-CN');\n    });\n\n    // 过滤并按类别分组条目\n    const entriesByCategory = {};\n    entries.forEach(entry => {\n      if (entry.comment.startsWith('设置-')) return; // 忽略设置条目\n\n      // 尝试从注释中提取类别，格式如: [ST|时间] 的 ST 部分\n      let category = 'Other';\n      const categoryMatch = entry.comment.match(/\\[(\\w+)\\|/);\n      if (categoryMatch) {\n        category = categoryMatch[1];\n      }\n\n      if (!entriesByCategory[category]) {\n        entriesByCategory[category] = [];\n      }\n\n      // 检查条目是否在配置中启用\n      const isEnabled = preset.enabledEntries.includes(parseInt(entry.uid));\n      entriesByCategory[category].push({\n        ...entry,\n        isInPreset: isEnabled,\n      });\n    });\n\n    // 按类别优先级排序\n    const categoryOrder = ['ST', 'CP', 'CR', 'CV', 'RP', 'CS', 'AE', 'WP', 'MI', 'Other'];\n    const sortedCategories = Object.keys(entriesByCategory).sort((a, b) => {\n      const indexA = categoryOrder.indexOf(a);\n      const indexB = categoryOrder.indexOf(b);\n      return (indexA === -1 ? 999 : indexA) - (indexB === -1 ? 999 : indexB);\n    });\n\n    // 构建条目列表HTML\n    let detailsHtml = '';\n    sortedCategories.forEach(category => {\n      // 获取类别友好名称\n      const categoryInfo = CATEGORY_MAPPING[category] || { name: category, icon: 'fa-circle-info' };\n      const categoryEntries = entriesByCategory[category];\n\n      detailsHtml += `\n        <div class=\"preset-entry-category\">\n          <i class=\"fa-solid ${categoryInfo.icon}\" style=\"margin-right: 5px; opacity: 0.7;\"></i>\n          ${categoryInfo.name || category} (${categoryEntries.length})\n        </div>\n      `;\n\n      // 条目列表\n      categoryEntries.forEach(entry => {\n        detailsHtml += `\n          <div class=\"preset-entry-item\">\n            <input type=\"checkbox\" class=\"preset-entry-checkbox\" id=\"preset-entry-${presetName}-${entry.uid}\" \n              data-uid=\"${entry.uid}\" data-preset=\"${presetName}\" ${entry.isInPreset ? 'checked' : ''}>\n            <label for=\"preset-entry-${presetName}-${entry.uid}\" style=\"font-size: 13px;\">${entry.comment}</label>\n          </div>\n        `;\n      });\n    });\n\n    // 更新详情区域\n    if (detailsHtml) {\n      $detailsSection.html(`\n        <div style=\"margin-bottom: 10px;\">\n          <div class=\"preset-summary-info\">\n            <div style=\"font-size: 13px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;\">\n              <span>点击复选框可以调整该配置中的条目:</span>\n              <span class=\"preset-count-info\">${preset.enabledEntries.length}个启用 / ${\n        entries.length - getLorebookSettingsEntriesCount(entries)\n      }个条目</span>\n            </div>\n          </div>\n          <div class=\"preset-entries-list\">${detailsHtml}</div>\n        </div>\n      `);\n    } else {\n      $detailsSection.html('<p style=\"color: #888; margin: 10px 0; font-style: italic;\">此配置不包含任何条目</p>');\n    }\n\n    console.log(`[状态栏] 预设详情加载完成: \"${presetName}\"`);\n  } catch (error) {\n    console.error('[状态栏] 加载配置详情失败:', error);\n    $detailsSection.html(`<p style=\"color: #f55; margin: 10px 0;\">加载失败: ${error.message}</p>`);\n  }\n}\n\n// 获取设置条目数量的辅助函数\nfunction getLorebookSettingsEntriesCount(entries) {\n  return entries.filter(entry => entry.comment.startsWith('设置-')).length;\n}\n\n// 创建弹窗函数\nfunction createPopup(content) {\n  const parentDoc = window.parent.document;\n\n  // 创建遮罩层\n  const $overlay = $('<div></div>')\n    .attr('id', `${POPUP_ID}-overlay`)\n    .css({\n      position: 'fixed',\n      top: 0,\n      left: 0,\n      right: 0,\n      bottom: 0,\n      backgroundColor: 'rgba(0, 0, 0, 0.5)',\n      zIndex: 1000,\n      backdropFilter: 'blur(2px)',\n    })\n    .on('click', function (e) {\n      if (e.target === this) {\n        closePopup();\n      }\n    });\n\n  // 创建弹窗\n  const $popup = $('<div></div>')\n    .attr('id', POPUP_ID)\n    .css({\n      position: 'fixed',\n      top: '70px',\n      left: '50%',\n      transform: 'translateX(-50%)',\n      width: '700px',\n      maxWidth: '90%',\n      maxHeight: '85vh', // 增加最大高度\n      background: '#262626',\n      color: '#e0e0e0',\n      border: 'none',\n      borderRadius: '8px',\n      boxShadow: '0 15px 30px rgba(0, 0, 0, 0.6)',\n      padding: '20px',\n      zIndex: 1001,\n      boxSizing: 'border-box',\n      overflow: 'hidden',\n      display: 'flex',\n      flexDirection: 'column', // 使用弹性布局\n      fontFamily: 'system-ui, -apple-system, sans-serif',\n      animation: 'fadeIn 0.2s ease-out',\n    })\n    .html(content);\n\n  // 动画样式\n  const styleElement = document.createElement('style');\n  styleElement.id = `${POPUP_ID}-animation-style`;\n  styleElement.textContent = `\n    @keyframes fadeIn {\n      from { opacity: 0; transform: translateX(-50%) translateY(-10px) scale(0.98); }\n      to { opacity: 1; transform: translateX(-50%) translateY(0) scale(1); }\n    }\n  `;\n\n  // 添加到DOM\n  parentDoc.head.appendChild(styleElement);\n  $('body', parentDoc).append($overlay).append($popup);\n\n  // 绑定关闭按钮事件\n  $(`#close-${POPUP_ID}, #cancel-${POPUP_ID}`, parentDoc).on('click', closePopup);\n}\n\n// 初始化\n$(async () => {\n  try {\n    // 更新设置\n    await errorCatched(option.update)();\n    await errorCatched(render.update)();\n\n    // 使用设置的初始化延迟\n    const initDelay = option.option?.init_delay || 0;\n    if (initDelay > 0) {\n      console.log(`[状态栏] 将在${initDelay}毫秒后初始化渲染`);\n      setTimeout(() => {\n        errorCatched(renderAllMessages)();\n      }, initDelay);\n    } else {\n      await errorCatched(renderAllMessages)();\n    }\n\n    // 注册事件监听\n    eventOn(tavern_events.CHARACTER_MESSAGE_RENDERED, errorCatched(renderOneMessage));\n    eventOn(tavern_events.MESSAGE_UPDATED, errorCatched(renderOneMessage));\n    eventOn(tavern_events.MESSAGE_SWIPED, errorCatched(renderOneMessage));\n    eventOn(tavern_events.MESSAGE_DELETED, errorCatched(renderAllMessages));\n\n    // 监听APP_READY事件，用于创建菜单按钮\n    eventOn(tavern_events.APP_READY, errorCatched(createMenuButton));\n\n    // 监听世界书更新事件\n    eventOn(\n      tavern_events.WORLDINFO_UPDATED,\n      errorCatched(async lorebook => {\n        if (lorebook !== lorebook_name) {\n          return;\n        }\n\n        console.log('[状态栏] 检测到世界书更新:', lorebook);\n        const optionChanged = await option.update();\n        const styleChanged = await render.update();\n\n        if (optionChanged || styleChanged) {\n          console.log('[状态栏] 设置或样式已变更，重新渲染所有消息');\n          await renderAllMessages();\n        }\n      }),\n    );\n\n    // 创建菜单按钮\n    createMenuButton();\n\n    console.log('[状态栏] 已加载');\n  } catch (error) {\n    console.error('[状态栏] 加载失败:', error);\n  }\n});\n\n// 默认样式\nconst default_style = `\n/* 导入Clear Han Serif字体 */\n@import url('https://fontsapi.zeoseven.com/79/main/result.css');\n\n/* 页面基本样式优化 */\n.status-bar-container {\n  font-family: 'Clear Han Serif', 'Microsoft YaHei', sans-serif;\n  font-weight: normal;\n  color: #565656;\n  max-width: 100%;\n  width: 100%;\n  margin: 0 auto;\n  padding: 15px 10px;\n  background-color: rgba(245, 245, 245, 0.95);\n  border-radius: 12px;\n  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);\n  overflow: hidden;\n  position: relative;\n  box-sizing: border-box;\n  animation: fadeIn 0.6s ease-out forwards;\n}\n\n@keyframes fadeIn {\n  from {\n    opacity: 0;\n    transform: translateY(20px);\n  }\n  to {\n    opacity: 1;\n    transform: translateY(0);\n  }\n}\n\n/* 暗色模式适配 */\n.dark-mode .status-bar-container {\n  background-color: #2a2a2a;\n  color: #d8d8d8;\n  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.35);\n  border: 1px solid #444;\n}\n\n/* 区块通用样式 - 扁平化设计 */\n.status-section {\n  margin-bottom: 12px;\n  padding: 10px;\n  background-color: rgba(255, 255, 255, 0.5);\n  border-radius: 8px;\n  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.03);\n  position: relative;\n  overflow: hidden;\n  transition: all 0.3s ease;\n}\n\n.status-section:hover {\n  transform: translateY(-2px);\n  box-shadow: 0 3px 6px rgba(0, 0, 0, 0.03);\n}\n\n.dark-mode .status-section {\n  background-color: #333;\n  border: 1px solid #444;\n  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);\n}\n\n.dark-mode .status-section:hover {\n  box-shadow: 0 3px 6px rgba(0, 0, 0, 0.06);\n}\n\n/* 区块标题 - 改进样式 */\n.status-section-title {\n  font-size: 16.5px;\n  font-weight: 500;\n  margin-bottom: 10px;\n  padding-bottom: 8px;\n  border-bottom: 1px solid rgba(210, 210, 210, 0.5);\n  color: #5d6c85;\n  position: relative;\n  display: flex;\n  align-items: center;\n  letter-spacing: 0.5px;\n  cursor: pointer;\n  user-select: none;\n}\n\n.status-section-title::after {\n  content: '';\n  position: absolute;\n  bottom: -1px;\n  left: 0;\n  width: 40px;\n  height: 2.5px;\n  background: linear-gradient(to right, #a6b3c9, #8a98b0);\n  border-radius: 2px;\n  transition: width 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);\n}\n\n.status-section:hover .status-section-title::after {\n  width: 60px;\n}\n\n.status-section-toggle {\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  width: 18px;\n  height: 18px;\n  margin-right: 8px;\n  border-radius: 3px;\n  background-color: rgba(166, 179, 201, 0.1);\n  transition: all 0.2s ease;\n}\n\n.status-section-title:hover .status-section-toggle {\n  background-color: rgba(166, 179, 201, 0.2);\n}\n\n.collapse-icon {\n  font-size: 12px;\n  color: #8795a8;\n  transition: transform 0.3s ease;\n}\n\n.status-section-content {\n  overflow: hidden;\n  transition: max-height 0.3s ease, opacity 0.3s ease, margin-top 0.3s ease;\n  opacity: 1;\n  max-height: 2000px; /* 足够高以容纳内容 */\n}\n\n.status-section-content.collapsed {\n  max-height: 0;\n  opacity: 0;\n  margin-top: 0;\n  pointer-events: none;\n}\n\n.dark-mode .status-section-title {\n  color: #a6b3c9;\n  border-bottom-color: rgba(100, 105, 115, 0.5);\n}\n\n.dark-mode .status-section-title::after {\n  background: #7d8ca3;\n}\n\n.dark-mode .status-section-toggle {\n  background-color: rgba(120, 130, 150, 0.2);\n}\n\n.dark-mode .status-section-title:hover .status-section-toggle {\n  background-color: rgba(120, 130, 150, 0.3);\n}\n\n.dark-mode .collapse-icon {\n  color: #7d8ca3;\n}\n\n/* 顶部信息行 - 调整为更紧凑的布局 */\n.status-top-info {\n  display: flex;\n  justify-content: flex-start;\n  flex-wrap: wrap;\n  gap: 8px;\n  padding: 8px 0;\n  margin-bottom: 10px;\n  font-size: 14px;\n  color: #6b7c93;\n  border-bottom: 1px solid rgba(210, 210, 210, 0.3);\n  padding-bottom: 15px;\n}\n\n.dark-mode .status-top-info {\n  color: #a6b3c9;\n}\n\n/* 时间、地点、天气样式 - 更加醒目 */\n.status-time,\n.status-location,\n.status-weather {\n  padding: 4px 10px;\n  background-color: rgba(235, 238, 241, 0.7);\n  border-radius: 6px;\n  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);\n  transition: all 0.2s ease;\n  font-weight: normal;\n}\n\n.status-time:hover,\n.status-location:hover,\n.status-weather:hover {\n  transform: translateY(-2px);\n  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.03);\n}\n\n.status-time::before {\n  content: '🕒 ';\n}\n\n.status-location::before {\n  content: '📍 ';\n}\n\n.status-weather::before {\n  content: '🌤️ ';\n}\n\n.dark-mode .status-time,\n.dark-mode .status-location,\n.dark-mode .status-weather {\n  background-color: rgba(70, 75, 85, 0.5);\n}\n\n/* 角色档案新样式 - 分条简约 */\n.profile-item {\n  display: flex;\n  align-items: center;\n  margin: 10px 0;\n  padding: 8px 12px;\n  background-color: rgba(246, 248, 250, 0.7);\n  border-radius: 8px;\n  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);\n  transition: all 0.3s ease;\n}\n\n.profile-item:hover {\n  transform: translateY(-2px);\n  background-color: rgba(255, 255, 255, 0.9);\n  box-shadow: 0 3px 6px rgba(0, 0, 0, 0.06);\n}\n\n.profile-item-icon {\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  width: 36px;\n  height: 36px;\n  background-color: rgba(166, 179, 201, 0.15);\n  border-radius: 50%;\n  margin-right: 12px;\n  color: #566A80;\n  flex-shrink: 0;\n}\n\n.profile-item-content {\n  flex: 1;\n}\n\n.profile-item-label {\n  font-size: 14px;\n  color: #8795a8;\n  margin-bottom: 2px;\n}\n\n.profile-item-value {\n  font-size: 15px;\n  font-weight: normal;\n  color: #566a80;\n  line-height: 1.5;\n}\n\n/* 特殊档案项样式 */\n.profile-名字 {\n  background-color: rgba(166, 179, 201, 0.15);\n}\n\n.profile-特征 .profile-item-value,\n.profile-身体外观 .profile-item-value {\n  line-height: 1.6;\n}\n\n.dark-mode .profile-item {\n  background-color: rgba(60, 65, 75, 0.6);\n  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);\n}\n\n.dark-mode .profile-item:hover {\n  background-color: rgba(70, 75, 85, 0.8);\n  box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);\n}\n\n.dark-mode .profile-item-icon {\n  background-color: rgba(120, 130, 150, 0.2);\n  color: #a6b3c9;\n}\n\n.dark-mode .profile-item-label {\n  color: #8a99af;\n}\n\n.dark-mode .profile-item-value {\n  color: #bfd2eb;\n}\n\n.dark-mode .profile-名字 {\n  background-color: rgba(120, 130, 150, 0.25);\n}\n\n/* 保留原有角色信息样式以兼容其他部分 */\n.status-name,\n.status-age,\n.status-height,\n.status-measures,\n.status-traits,\n.status-appearance,\n.status-state,\n.status-permanent,\n.status-money,\n.status-items,\n.status-wearables {\n  margin: 5px 0;\n  line-height: 1.6;\n  padding: 4px 6px;\n  border-radius: 4px;\n  background-color: rgba(235, 238, 241, 0.5);\n  transition: all 0.2s ease;\n}\n\n.status-name:hover,\n.status-age:hover,\n.status-height:hover,\n.status-measures:hover,\n.status-traits:hover,\n.status-appearance:hover,\n.status-state:hover,\n.status-permanent:hover,\n.status-money:hover,\n.status-items:hover,\n.status-wearables:hover {\n  background-color: rgba(235, 238, 241, 0.8);\n}\n\n.dark-mode .status-name,\n.dark-mode .status-age,\n.dark-mode .status-height,\n.dark-mode .status-measures,\n.dark-mode .status-traits,\n.dark-mode .status-appearance,\n.dark-mode .status-state,\n.dark-mode .status-permanent,\n.dark-mode .status-money,\n.dark-mode .status-items,\n.dark-mode .status-wearables {\n  background-color: rgba(70, 75, 85, 0.3);\n}\n\n.dark-mode .status-name:hover,\n.dark-mode .status-age:hover,\n.dark-mode .status-height:hover,\n.dark-mode .status-measures:hover,\n.dark-mode .status-traits:hover,\n.dark-mode .status-appearance:hover,\n.dark-mode .status-state:hover,\n.dark-mode .status-permanent:hover,\n.dark-mode .status-money:hover,\n.dark-mode .status-items:hover,\n.dark-mode .status-wearables:hover {\n  background-color: rgba(70, 75, 85, 0.5);\n}\n\n/* 进度条容器 - 优化视觉效果 */\n.status-progress-container {\n  height: 8px;\n  background-color: rgba(230, 233, 237, 0.6);\n  border-radius: 6px;\n  overflow: hidden;\n  margin: 10px 0;\n  position: relative;\n  box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.04);\n}\n\n.dark-mode .status-progress-container {\n  background-color: rgba(70, 75, 85, 0.4);\n  box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.04);\n}\n\n/* 进度条填充 - 改进动画和统一颜色 */\n.status-progress-bar {\n  height: 100%;\n  border-radius: 6px;\n  transition: width 0.6s cubic-bezier(0.165, 0.84, 0.44, 1);\n  background-image: linear-gradient(to right, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.2));\n  background-size: 200% 100%;\n}\n\n/* 状态项样式 - 增强交互效果 */\n.status-item {\n  margin-bottom: 14px;\n  padding: 10px;\n  background-color: rgba(235, 238, 241, 0.4);\n  border-radius: 10px;\n  transition: all 0.3s ease;\n  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.02);\n}\n\n.status-item:hover {\n  background-color: rgba(235, 238, 241, 0.65);\n  transform: translateY(-2px);\n  box-shadow: 0 3px 8px rgba(0, 0, 0, 0.04);\n}\n\n.dark-mode .status-item {\n  background-color: rgba(65, 70, 80, 0.3);\n}\n\n.dark-mode .status-item:hover {\n  background-color: rgba(70, 75, 85, 0.4);\n}\n\n/* 状态项头部 */\n.status-header {\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  margin-bottom: 4px;\n}\n\n/* 状态项标签 */\n.status-label {\n  font-weight: normal;\n  font-size: 14px;\n  color: #6b7c93;\n}\n\n.dark-mode .status-label {\n  color: #a6b3c9;\n}\n\n/* 状态项尾部 - 单行布局 */\n.status-footer {\n  display: flex;\n  flex-direction: column;\n  align-items: flex-start;\n  font-size: 12px;\n  color: #8795a8;\n  margin-top: 4px;\n  width: 100%;\n}\n\n.status-details-row {\n  display: flex;\n  align-items: center;\n  flex-wrap: wrap;\n  gap: 6px;\n  width: 100%;\n}\n\n/* 状态值样式 */\n.status-value {\n  font-weight: normal;\n  font-size: 14px;\n  color: #566a80;\n  background-color: rgba(235, 238, 241, 0.7);\n  padding: 3px 8px;\n  border-radius: 4px;\n  display: inline-block;\n  margin-right: 4px;\n}\n\n.dark-mode .status-footer {\n  color: #8a99af;\n}\n\n.dark-mode .status-value {\n  color: #a6b3c9;\n  background-color: rgba(70, 75, 85, 0.3);\n}\n\n/* 变化指示器 - 莫兰迪色系 */\n.status-change {\n  font-size: 12px;\n  font-weight: 500;\n  display: inline-block;\n  padding: 1px 5px;\n  border-radius: 4px;\n  white-space: nowrap;\n}\n\n.status-change.positive {\n  color: #6e8b74;\n  background-color: rgba(110, 139, 116, 0.1);\n}\n\n.status-change.negative {\n  color: #c98a7d;\n  background-color: rgba(201, 138, 125, 0.1);\n}\n\n.dark-mode .status-change.positive {\n  color: #8caa92;\n  background-color: rgba(140, 170, 146, 0.15);\n}\n\n.dark-mode .status-change.negative {\n  color: #daa99e;\n  background-color: rgba(218, 169, 158, 0.15);\n}\n\n/* 描述文本 - 确保显示 */\n.status-description {\n  font-style: italic;\n  color: #6b7c93;\n  font-size: 14px;\n  display: block;\n  margin: 12px 0 4px 0;\n  padding: 10px 12px;\n  background-color: rgba(235, 238, 241, 0.7);\n  border-radius: 6px;\n  line-height: 1.6;\n  width: 100%;\n  box-sizing: border-box;\n  overflow-wrap: break-word;\n  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.03);\n}\n\n.status-description:before {\n  content: '\"';\n  font-size: 18px;\n  margin-right: 2px;\n  opacity: 0.7;\n}\n\n.status-description:after {\n  content: '\"';\n  font-size: 18px;\n  margin-left: 2px;\n  opacity: 0.7;\n}\n\n.dark-mode .status-description {\n  color: #a6b3c9;\n  background-color: rgba(70, 75, 85, 0.4);\n  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);\n}\n\n/* 社交状态信息 - 扁平化设计，移除左侧色条 */\n.status-relation,\n.status-trust,\n.status-corruption {\n  padding: 8px;\n  margin: 6px 0;\n  border-radius: 6px;\n  background-color: rgba(235, 238, 241, 0.6);\n  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.02);\n  transition: all 0.3s ease;\n  position: relative;\n  z-index: 1;\n}\n\n.status-relation:hover,\n.status-trust:hover,\n.status-corruption:hover {\n  background-color: rgba(235, 238, 241, 0.8);\n  transform: translateY(-2px);\n  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.03);\n}\n\n.status-relation strong {\n  color: #af8e9f;\n}\n\n.status-trust strong {\n  color: #8ca5a3;\n}\n\n.status-corruption strong {\n  color: #b79a9a;\n}\n\n.dark-mode .status-relation,\n.dark-mode .status-trust,\n.dark-mode .status-corruption {\n  background-color: rgba(70, 75, 85, 0.3);\n  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);\n}\n\n.dark-mode .status-relation:hover,\n.dark-mode .status-trust:hover,\n.dark-mode .status-corruption:hover {\n  background-color: rgba(70, 75, 85, 0.5);\n  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.06);\n}\n\n.dark-mode .status-relation strong {\n  color: #c1a2b3;\n}\n\n.dark-mode .status-trust strong {\n  color: #a0b9b7;\n}\n\n.dark-mode .status-corruption strong {\n  color: #c9aeae;\n}\n\n/* 原因文本样式 */\n.status-reason {\n  font-style: italic;\n  color: #8795a8;\n  font-size: 12px;\n  padding: 2px 5px;\n  background-color: rgba(235, 238, 241, 0.5);\n  border-radius: 3px;\n  white-space: nowrap;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  max-width: 100%;\n}\n\n.dark-mode .status-reason {\n  color: #8a99af;\n  background-color: rgba(70, 75, 85, 0.2);\n}\n\n/* 想法样式 - 莫兰迪色系 */\n.status-thoughts {\n  padding: 12px 15px;\n  background-color: rgba(235, 238, 241, 0.7);\n  border-radius: 8px;\n  font-size: 14px;\n  color: #6b7c93;\n  margin: 8px 0;\n  line-height: 1.5;\n  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.02);\n  position: relative;\n  transition: all 0.3s ease;\n  font-style: italic;\n}\n\n.status-thoughts:hover {\n  transform: translateY(-2px);\n  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.03);\n  background-color: rgba(235, 238, 241, 0.9);\n}\n\n.dark-mode .status-thoughts {\n  background-color: rgba(70, 75, 85, 0.4);\n  color: #a6b3c9;\n  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);\n}\n\n.dark-mode .status-thoughts:hover {\n  background-color: rgba(70, 75, 85, 0.6);\n  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.06);\n}\n\n/* 选项列表 */\n.status-options-list {\n  margin-top: 12px;\n  position: relative;\n}\n\n/* 物品标签 - 莫兰迪色系 */\n.item-tag {\n  display: inline-block;\n  padding: 3px 10px;\n  background-color: rgba(235, 238, 241, 0.6);\n  border-radius: 4px;\n  margin: 3px;\n  font-size: 12px;\n  box-shadow: 0 1px 1px rgba(0, 0, 0, 0.01);\n  transition: all 0.2s ease;\n  position: relative;\n  z-index: 1;\n  color: #6b7c93;\n}\n\n.item-tag:hover {\n  transform: translateY(-2px);\n  box-shadow: 0 2px 3px rgba(0, 0, 0, 0.02);\n  background-color: rgba(235, 238, 241, 0.8);\n}\n\n.dark-mode .item-tag {\n  background-color: rgba(70, 75, 85, 0.3);\n  color: #a6b3c9;\n}\n\n.dark-mode .item-tag:hover {\n  background-color: rgba(70, 75, 85, 0.5);\n}\n\n/* 世界信息项目 - 扁平化分离设计 */\n.status-news,\n.status-nearby-events,\n.status-locations,\n.status-npc,\n.status-comment,\n.status-main-quest,\n.status-upcoming-events,\n.status-plot-details {\n  margin: 4px 0 8px 0;\n  padding: 12px;\n  background-color: #ffffff;\n  border: 1px solid #e2e8f0;\n  border-radius: 6px;\n  transition: all 0.3s ease;\n}\n\n.status-news:hover,\n.status-nearby-events:hover,\n.status-locations:hover,\n.status-npc:hover,\n.status-comment:hover,\n.status-main-quest:hover,\n.status-upcoming-events:hover,\n.status-plot-details:hover {\n  background-color: #f8f9fa;\n  border-color: #cbd5e0;\n  transform: translateY(-2px);\n}\n\n.status-news strong,\n.status-nearby-events strong,\n.status-locations strong,\n.status-npc strong,\n.status-comment strong,\n.status-main-quest strong,\n.status-upcoming-events strong,\n.status-plot-details strong {\n  color: #6b7c93;\n  display: block;\n  margin-bottom: 4px;\n  padding-bottom: 4px;\n  border-bottom: 1px solid rgba(210, 210, 210, 0.5);\n  font-weight: normal;\n}\n\n.status-news ul,\n.status-nearby-events ul,\n.status-locations ul,\n.status-plot-details ul,\n.status-upcoming-events ul {\n  margin: 2px 0 5px 0;\n  padding-left: 10px;\n  list-style-type: none;\n}\n\n.status-news li,\n.status-nearby-events li,\n.status-locations li,\n.status-plot-details li,\n.status-upcoming-events li {\n  padding: 8px 12px;\n  margin-bottom: 5px;\n  border-radius: 8px;\n  background-color: rgba(249, 250, 251, 0.8);\n  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);\n  transition: all 0.2s ease;\n  cursor: pointer;\n  display: flex;\n  align-items: center;\n}\n\n.status-news li:hover,\n.status-nearby-events li:hover,\n.status-locations li:hover,\n.status-plot-details li:hover,\n.status-upcoming-events li:hover {\n  background-color: rgba(255, 255, 255, 0.95);\n  transform: scale(1.02);\n  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);\n}\n\n.status-news li:active,\n.status-nearby-events li:active,\n.status-locations li:active,\n.status-plot-details li:active,\n.status-upcoming-events li:active {\n  transform: translateY(1px);\n  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);\n}\n\n.dark-mode .status-news,\n.dark-mode .status-nearby-events,\n.dark-mode .status-locations,\n.dark-mode .status-npc,\n.dark-mode .status-comment,\n.dark-mode .status-main-quest,\n.dark-mode .status-upcoming-events,\n.dark-mode .status-plot-details {\n  background-color: rgba(60, 60, 65, 0.8);\n  border-color: #4a5568;\n}\n\n.dark-mode .status-news:hover,\n.dark-mode .status-nearby-events:hover,\n.dark-mode .status-locations:hover,\n.dark-mode .status-npc:hover,\n.dark-mode .status-comment:hover,\n.dark-mode .status-main-quest:hover,\n.dark-mode .status-upcoming-events:hover,\n.dark-mode .status-plot-details:hover {\n  background-color: rgba(70, 70, 75, 0.9);\n  border-color: #718096;\n}\n\n.dark-mode .status-news strong,\n.dark-mode .status-nearby-events strong,\n.dark-mode .status-locations strong,\n.dark-mode .status-npc strong,\n.dark-mode .status-comment strong,\n.dark-mode .status-main-quest strong,\n.dark-mode .status-upcoming-events strong,\n.dark-mode .status-plot-details strong {\n  color: #bfd2eb;\n  border-bottom: 1px solid rgba(180, 200, 225, 0.4);\n}\n\n.dark-mode .status-news li,\n.dark-mode .status-nearby-events li,\n.dark-mode .status-locations li,\n.dark-mode .status-plot-details li,\n.dark-mode .status-upcoming-events li {\n  background-color: rgba(85, 85, 90, 0.9);\n  color: #ffffff;\n  text-shadow: 0 1px 1px rgba(0, 0, 0, 0.2);\n  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);\n}\n\n.dark-mode .status-news li:hover,\n.dark-mode .status-nearby-events li:hover,\n.dark-mode .status-locations li:hover,\n.dark-mode .status-plot-details li:hover,\n.dark-mode .status-upcoming-events li:hover {\n  background-color: rgba(95, 95, 100, 0.95);\n  transform: scale(1.02);\n  box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);\n}\n\n.dark-mode .status-news li:active,\n.dark-mode .status-nearby-events li:active,\n.dark-mode .status-locations li:active,\n.dark-mode .status-plot-details li:active,\n.dark-mode .status-upcoming-events li:active {\n  background-color: rgba(105, 105, 110, 1);\n  color: #ffffff;\n}\n\n/* 剧情选项样式 */\n.plot-options-list {\n  list-style: none;\n  padding: 0;\n  margin: 5px 0;\n}\n\n.plot-option-item {\n  padding: 8px 12px;\n  margin-bottom: 6px;\n  background-color: rgba(235, 238, 241, 0.8);\n  border-radius: 6px;\n  cursor: pointer;\n  transition: all 0.25s ease;\n  font-size: 14.5px;\n  position: relative;\n  border-left: none;\n  display: flex;\n  align-items: center;\n}\n\n.plot-option-item:hover {\n  background-color: rgba(220, 225, 230, 1);\n  transform: scale(1.02);\n  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);\n  border-left-color: transparent;\n  padding-left: 12px;\n}\n\n.plot-option-item:active {\n  transform: scale(0.98);\n  background-color: rgba(210, 215, 220, 1);\n}\n\n.dark-mode .plot-option-item {\n  background-color: rgba(70, 75, 85, 0.5);\n  border-left: none;\n}\n\n.dark-mode .plot-option-item:hover {\n  background-color: rgba(75, 80, 90, 0.7);\n  transform: scale(1.02);\n  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);\n  border-left-color: transparent;\n}\n\n.dark-mode .plot-option-item:active {\n  transform: scale(0.98);\n  background-color: rgba(80, 85, 95, 0.8);\n}\n\n/* 实体器官状态 */\n.status-sexual-organs {\n  margin: 8px 0;\n  padding: 10px 12px;\n  background-color: rgba(235, 238, 241, 0.5);\n  border-radius: 6px;\n  line-height: 1.6;\n  font-size: 14px;\n}\n\n.dark-mode .status-sexual-organs {\n  background-color: rgba(70, 75, 85, 0.3);\n}\n\n/* 空状态提示 */\n.status-empty {\n  padding: 12px;\n  text-align: center;\n  color: #8795a8;\n  font-style: italic;\n  margin: 8px 0;\n  background-color: rgba(235, 238, 241, 0.4);\n  border-radius: 6px;\n  transition: all 0.3s ease;\n}\n\n.status-empty:hover {\n  background-color: rgba(235, 238, 241, 0.6);\n}\n\n.dark-mode .status-empty {\n  color: #8a99af;\n  background-color: rgba(70, 75, 85, 0.2);\n}\n\n.dark-mode .status-empty:hover {\n  background-color: rgba(70, 75, 85, 0.3);\n}\n\n/* 标题图标 */\n.status-section-icon {\n  margin-right: 8px;\n  font-size: 1em;\n  color: #a6b3c9;\n  opacity: 0.8;\n}\n\n.dark-mode .status-section-icon {\n  color: #7d8ca3;\n}\n\n/* 新增现金详情样式 */\n.cash-details {\n  font-size: 12px;\n  color: #8795a8;\n  margin-left: 5px;\n  font-style: italic;\n}\n\n.dark-mode .cash-details {\n  color: #8a99af;\n}\n\n/* 响应式布局 */\n@media (max-width: 767px) {\n  .status-bar-container {\n    padding: 12px 10px;\n  }\n\n  .status-top-info {\n    padding: 8px 0;\n    margin-bottom: 12px;\n    gap: 6px;\n  }\n\n  .status-time,\n  .status-location,\n  .status-weather {\n    padding: 5px 10px;\n    font-size: 13px;\n  }\n\n  .status-section {\n    padding: 12px;\n    margin-bottom: 14px;\n  }\n}\n\n/* 特定状态描述新样式 */\n.condition-item {\n  margin: 10px 0;\n  padding: 0;\n  background-color: rgba(235, 238, 241, 0.4); /* 统一与状态值相同的底色 */\n  border-radius: 8px;\n  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);\n  transition: all 0.3s ease;\n  overflow: hidden;\n}\n\n.condition-item:hover {\n  transform: translateY(-2px);\n  background-color: rgba(235, 238, 241, 0.65); /* 悬停状态与状态值保持一致 */\n  box-shadow: 0 3px 6px rgba(0, 0, 0, 0.06);\n}\n\n.condition-item-label {\n  padding: 8px 12px;\n  font-size: 14px;\n  color: #6b7c93;\n  background-color: rgba(235, 238, 241, 0.6);\n  border-bottom: 1px solid rgba(225, 230, 235, 0.6);\n  font-weight: 500;\n}\n\n.condition-item-value {\n  padding: 10px 12px;\n  font-size: 14.5px;\n  color: #566a80;\n  line-height: 1.5;\n  background-color: rgba(235, 238, 241, 0.4); /* 统一与状态值相同的底色 */\n  border-radius: 0 0 8px 8px;\n}\n\n/* 暗色模式适配 */\n.dark-mode .condition-item {\n  background-color: rgba(65, 70, 80, 0.3); /* 统一与状态值相同的暗色底色 */\n  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);\n}\n\n.dark-mode .condition-item:hover {\n  background-color: rgba(70, 75, 85, 0.4); /* 悬停状态与状态值保持一致 */\n  box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);\n}\n\n.dark-mode .condition-item-label {\n  background-color: rgba(55, 60, 70, 0.8);\n  color: #a6b3c9;\n  border-bottom-color: rgba(70, 75, 85, 0.6);\n}\n\n.dark-mode .condition-item-value {\n  color: #bfd2eb;\n  background-color: rgba(65, 70, 80, 0.3); /* 统一与状态值相同的暗色底色 */\n}\n\n/* 保留原有状态样式以兼容其他部分 */\n.status-state {\n  margin: 5px 0;\n  line-height: 1.6;\n  padding: 4px 6px;\n  border-radius: 4px;\n  background-color: rgba(235, 238, 241, 0.5);\n  transition: all 0.2s ease;\n}\n\n.status-state:hover {\n  background-color: rgba(235, 238, 241, 0.8);\n}\n\n.dark-mode .status-state {\n  background-color: rgba(70, 75, 85, 0.3);\n}\n\n.dark-mode .status-state:hover {\n  background-color: rgba(70, 75, 85, 0.5);\n}\n\n/* 行为与事件计数新样式 - 紧凑数据展示风格 */\n.counter-item {\n  margin: 8px 0;\n  padding: 10px 12px;\n  border-radius: 6px;\n  overflow: hidden;\n  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);\n  background-color: rgba(235, 238, 241, 0.4);\n  transition: all 0.2s ease;\n}\n\n.counter-item:hover {\n  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);\n  transform: translateY(-1px);\n  background-color: rgba(235, 238, 241, 0.65);\n}\n\n.counter-content {\n  display: flex;\n  align-items: center;\n  flex-wrap: wrap;\n  gap: 8px;\n}\n\n.counter-label {\n  font-weight: 500;\n  color: #6b7c93;\n  font-size: 14px;\n}\n\n.counter-value {\n  color: #566a80;\n  font-size: 14px;\n}\n\n/* 暗色模式适配 */\n.dark-mode .counter-item {\n  background-color: rgba(65, 70, 80, 0.3);\n  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);\n}\n\n.dark-mode .counter-item:hover {\n  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);\n  background-color: rgba(70, 75, 85, 0.4);\n}\n\n.dark-mode .counter-label {\n  color: #a6b3c9;\n}\n\n.dark-mode .counter-value {\n  color: #bfd2eb;\n}\n\n/* 数据表格式布局 */\n.counter-data-container {\n  display: flex;\n  flex-direction: column;\n  width: 100%;\n}\n\n.counter-data-row {\n  display: flex;\n  border-bottom: 1px solid rgba(230, 235, 240, 0.5);\n}\n\n.counter-data-row:last-child {\n  border-bottom: none;\n}\n\n.counter-data-cell {\n  padding: 8px 10px;\n  width: 30%;\n  background-color: rgba(235, 240, 245, 0.4);\n  color: #8795a8;\n  font-size: 14px;\n  text-align: center;\n  border-right: 1px solid rgba(230, 235, 240, 0.5);\n}\n\n.counter-data-value {\n  padding: 8px 10px;\n  width: 70%;\n  font-size: 15px;\n  color: #566a80;\n  text-align: center;\n  font-weight: 500;\n}\n\n/* 特殊类型样式 */\n.fluid-level .counter-value {\n  color: #3a8dbd;\n  font-size: 16px;\n}\n\n.activity-count .counter-header {\n  background-color: rgba(220, 230, 240, 0.6);\n}\n\n/* 暗色模式适配 */\n.dark-mode .counter-item {\n  background-color: rgba(65, 70, 80, 0.3); /* 统一与状态值相同的暗色底色 */\n  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);\n}\n\n.dark-mode .counter-item:hover {\n  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);\n  background-color: rgba(70, 75, 85, 0.4); /* 悬停状态与状态值保持一致 */\n}\n\n.dark-mode .counter-header {\n  background-color: rgba(65, 70, 80, 0.4); /* 调整为与其他头部一致 */\n  color: #a6b3c9;\n  border-bottom-color: rgba(70, 75, 85, 0.6);\n}\n\n.dark-mode .counter-value,\n.dark-mode .counter-value-single {\n  color: #bfd2eb;\n}\n\n.dark-mode .counter-data-cell {\n  background-color: rgba(60, 65, 75, 0.5);\n  color: #8a99af;\n  border-right-color: rgba(70, 75, 85, 0.5);\n}\n\n.dark-mode .counter-data-value {\n  color: #bfd2eb;\n}\n\n.dark-mode .counter-data-row {\n  border-bottom-color: rgba(70, 75, 85, 0.4);\n}\n\n.dark-mode .fluid-level .counter-value {\n  color: #5aa7d7;\n}\n\n/* 保留原有样式以兼容其他部分 */\n.status-sex-acts,\n.status-fluid-levels {\n  margin: 5px 0;\n  line-height: 1.6;\n  padding: 4px 6px;\n  border-radius: 4px;\n  background-color: rgba(235, 238, 241, 0.5);\n  transition: all 0.2s ease;\n}\n\n.status-sex-acts:hover,\n.status-fluid-levels:hover {\n  background-color: rgba(235, 238, 241, 0.8);\n}\n\n.dark-mode .status-sex-acts,\n.dark-mode .status-fluid-levels {\n  background-color: rgba(70, 75, 85, 0.3);\n}\n\n.dark-mode .status-sex-acts:hover,\n.dark-mode .status-fluid-levels:hover {\n  background-color: rgba(70, 75, 85, 0.5);\n}\n\n/* 世界与剧情动态统一样式 */\n.world-item {\n  margin: 10px 0;\n  border-radius: 8px;\n  overflow: hidden;\n  background-color: rgba(235, 238, 241, 0.4); /* 统一与状态值相同的底色 */\n  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);\n  transition: all 0.25s ease;\n}\n\n.world-item:hover {\n  transform: translateY(-2px);\n  box-shadow: 0 3px 8px rgba(0, 0, 0, 0.06);\n  background-color: rgba(235, 238, 241, 0.65); /* 悬停状态与状态值保持一致 */\n}\n\n.world-item-header {\n  padding: 10px 12px;\n  font-size: 15px;\n  color: #566a80;\n  background-color: rgba(235, 238, 241, 0.6);\n  border-bottom: 1px solid rgba(210, 215, 220, 0.5);\n  font-weight: 500;\n}\n\n.world-item-list {\n  list-style: none;\n  margin: 0;\n  padding: 0;\n}\n\n.world-item-entry {\n  padding: 8px 12px;\n  border-bottom: 1px solid rgba(235, 240, 245, 0.7);\n  font-size: 14px;\n  color: #566a80;\n  line-height: 1.5;\n  background-color: rgba(235, 238, 241, 0.4); /* 统一与状态值相同的底色 */\n}\n\n.world-item-entry:last-child {\n  border-bottom: none;\n}\n\n/* 交互式列表项 */\n.interactive-list .world-item-entry {\n  cursor: pointer;\n  transition: all 0.2s ease;\n  position: relative;\n  padding-left: 15px;\n}\n\n.interactive-list .world-item-entry:before {\n  content: '';\n  position: absolute;\n  left: 5px;\n  top: 50%;\n  width: 4px;\n  height: 4px;\n  border-radius: 50%;\n  background-color: #a6b3c9;\n  opacity: 0.7;\n  transform: translateY(-50%);\n  transition: all 0.2s ease;\n}\n\n.interactive-list .world-item-entry:hover {\n  background-color: rgba(235, 238, 241, 0.7); /* 悬停状态与状态值保持一致 */\n  padding-left: 18px;\n}\n\n.interactive-list .world-item-entry:hover:before {\n  left: 8px;\n  background-color: #566a80;\n  opacity: 1;\n}\n\n/* 特殊类型样式 */\n.world-item.main-quest .world-item-header {\n  background-color: rgba(166, 179, 201, 0.25);\n  color: #4d5b70;\n}\n\n.world-item.upcoming-events .world-item-header {\n  background-color: rgba(166, 179, 201, 0.15);\n}\n\n.world-item.news .world-item-header {\n  background-color: rgba(200, 210, 220, 0.5);\n}\n\n.world-item.npcs .world-item-header {\n  background-color: rgba(180, 190, 210, 0.3);\n}\n\n/* 暗色模式适配 */\n.dark-mode .world-item {\n  background-color: rgba(65, 70, 80, 0.3); /* 统一与状态值相同的暗色底色 */\n  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);\n}\n\n.dark-mode .world-item:hover {\n  box-shadow: 0 3px 8px rgba(0, 0, 0, 0.25);\n  background-color: rgba(70, 75, 85, 0.4); /* 悬停状态与状态值保持一致 */\n}\n\n.dark-mode .world-item-header {\n  background-color: rgba(65, 70, 80, 0.4); /* 调整为与其他头部一致 */\n  color: #a6b3c9;\n  border-bottom-color: rgba(70, 75, 85, 0.6);\n}\n\n.dark-mode .world-item-entry {\n  color: #bfd2eb;\n  border-bottom-color: rgba(70, 75, 85, 0.4);\n  background-color: rgba(65, 70, 80, 0.3); /* 统一与状态值相同的暗色底色 */\n}\n\n.dark-mode .interactive-list .world-item-entry:before {\n  background-color: #7d8ca3;\n}\n\n.dark-mode .interactive-list .world-item-entry:hover {\n  background-color: rgba(70, 75, 85, 0.5); /* 悬停状态与状态值保持一致 */\n}\n\n.dark-mode .interactive-list .world-item-entry:hover:before {\n  background-color: #a6b3c9;\n}\n\n.dark-mode .world-item.main-quest .world-item-header {\n  background-color: rgba(70, 80, 100, 0.6);\n  color: #a6b3c9;\n}\n\n.dark-mode .world-item.upcoming-events .world-item-header {\n  background-color: rgba(70, 80, 95, 0.5);\n}\n\n.dark-mode .world-item.news .world-item-header {\n  background-color: rgba(65, 75, 90, 0.6);\n}\n\n.dark-mode .world-item.npcs .world-item-header {\n  background-color: rgba(60, 70, 85, 0.5);\n}\n\n/* 保留原有样式以兼容其他部分 */\n.status-news,\n.status-nearby-events,\n.status-locations,\n.status-npc,\n.status-main-quest,\n.status-upcoming-events,\n.status-plot-details {\n  margin: 4px 0 8px 0;\n  padding: 12px;\n  background-color: #ffffff;\n  border: 1px solid #e2e8f0;\n  border-radius: 6px;\n  transition: all 0.3s ease;\n}\n\n/* 元信息统一样式 */\n.meta-item {\n  margin: 10px 0;\n  border-radius: 8px;\n  overflow: hidden;\n  background-color: rgba(235, 238, 241, 0.4); /* 统一与状态值相同的底色 */\n  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);\n  transition: all 0.3s ease;\n}\n\n.meta-item:hover {\n  transform: translateY(-2px);\n  box-shadow: 0 3px 6px rgba(0, 0, 0, 0.06);\n  background-color: rgba(235, 238, 241, 0.65); /* 悬停状态与状态值保持一致 */\n}\n\n.meta-item-header {\n  padding: 8px 12px;\n  font-size: 15px;\n  color: #566a80;\n  background-color: rgba(235, 238, 241, 0.6);\n  border-bottom: 1px solid rgba(220, 225, 230, 0.6);\n  font-weight: 500;\n}\n\n.meta-item-content {\n  padding: 12px 15px;\n  font-size: 14.5px;\n  color: #566a80;\n  line-height: 1.6;\n  background-color: rgba(235, 238, 241, 0.4); /* 统一与状态值相同的底色 */\n}\n\n.meta-comments .meta-item-header {\n  background-color: rgba(235, 238, 241, 0.6); /* 统一与其他头部一致 */\n}\n\n.meta-comments .meta-item-content {\n  background-color: rgba(235, 238, 241, 0.4); /* 统一与状态值相同的底色 */\n}\n\n/* 暗色模式适配 */\n.dark-mode .meta-item {\n  background-color: rgba(65, 70, 80, 0.3); /* 统一与状态值相同的暗色底色 */\n  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);\n}\n\n.dark-mode .meta-item:hover {\n  box-shadow: 0 3px 8px rgba(0, 0, 0, 0.25);\n  background-color: rgba(70, 75, 85, 0.4); /* 悬停状态与状态值保持一致 */\n}\n\n.dark-mode .meta-item-header {\n  background-color: rgba(65, 70, 80, 0.4); /* 调整为与其他头部一致 */\n  color: #a6b3c9;\n  border-bottom-color: rgba(70, 75, 85, 0.6);\n}\n\n.dark-mode .meta-item-content {\n  color: #bfd2eb;\n  background-color: rgba(65, 70, 80, 0.3); /* 统一与状态值相同的暗色底色 */\n}\n\n.dark-mode .meta-comments .meta-item-header {\n  background-color: rgba(65, 70, 80, 0.4); /* 统一与其他头部一致 */\n}\n\n.dark-mode .meta-comments .meta-item-content {\n  background-color: rgba(65, 70, 80, 0.3); /* 统一与状态值相同的暗色底色 */\n}\n\n/* 关系参数样式 */\n.relation-parameter {\n  margin-bottom: 14px;\n  padding: 10px;\n  background-color: rgba(235, 238, 241, 0.4);\n  border-radius: 10px;\n  transition: all 0.3s ease;\n  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.02);\n}\n\n.relation-parameter:hover {\n  background-color: rgba(235, 238, 241, 0.65);\n  transform: translateY(-2px);\n  box-shadow: 0 3px 8px rgba(0, 0, 0, 0.04);\n}\n\n.relation-stage {\n  background-color: rgba(119, 151, 185, 0.15);\n  color: #566a80;\n  padding: 2px 6px;\n  border-radius: 4px;\n  font-size: 12px;\n  font-weight: normal;\n  margin-left: 10px;\n}\n\n.dark-mode .relation-parameter {\n  background-color: rgba(65, 70, 80, 0.3);\n}\n\n.dark-mode .relation-parameter:hover {\n  background-color: rgba(70, 75, 85, 0.4);\n}\n\n.dark-mode .relation-stage {\n  color: #a6b3c9;\n  background-color: rgba(119, 151, 185, 0.10);\n}\n\n/* 角色数据样式 */\n.character-data-container {\n  display: flex;\n  height: 65vh; /* 增加高度 */\n  border: 1px solid #444;\n  border-radius: 6px;\n  overflow: hidden;\n  margin-top: 10px;\n}\n\n.character-data-sidebar {\n  width: 30%;\n  background-color: #2d2d2d;\n  border-right: 1px solid #444;\n  display: flex;\n  flex-direction: column;\n}\n\n.sidebar-header {\n  padding: 12px 16px;\n  border-bottom: 1px solid #444;\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n}\n\n.sidebar-header h4 {\n  margin: 0;\n  font-size: 15px;\n  color: #ddd;\n}\n\n.refresh-btn {\n  width: 24px;\n  height: 24px;\n  background-color: #3a3a3a;\n  border-radius: 50%;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  cursor: pointer;\n  transition: all 0.2s;\n}\n\n.refresh-btn:hover {\n  background-color: #4a4a4a;\n}\n\n.character-list {\n  flex: 1;\n  overflow-y: auto;\n  padding: 8px;\n}\n\n.character-list-item {\n  padding: 10px 12px;\n  border-radius: 5px;\n  margin-bottom: 8px;\n  cursor: pointer;\n  transition: all 0.2s;\n  background-color: #333;\n}\n\n.character-list-item:hover {\n  background-color: #3a3a3a;\n}\n\n.character-list-item.active {\n  background-color: #3a7bd5;\n}\n\n.loading-text {\n  text-align: center;\n  color: #777;\n  padding: 20px 0;\n}\n\n.character-data-content {\n  flex: 1;\n  padding: 16px;\n  background-color: #222;\n  overflow-y: auto;\n  max-height: 100%; /* 确保内容区域可以滚动 */\n}\n\n.empty-state {\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n  justify-content: center;\n  height: 100%;\n  color: #777;\n}\n\n.empty-state p {\n  margin-top: 10px;\n  font-style: italic;\n}\n\n.character-header {\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  padding-bottom: 12px;\n  margin-bottom: 16px;\n  border-bottom: 1px solid #444;\n}\n\n.character-header h3 {\n  margin: 0;\n  font-size: 18px;\n  color: #ddd;\n}\n\n.character-actions {\n  display: flex;\n  gap: 8px;\n}\n\n.character-action-btn {\n  border: none;\n  padding: 6px 12px;\n  border-radius: 4px;\n  cursor: pointer;\n  font-size: 13px;\n  transition: all 0.2s;\n}\n\n.save-btn {\n  background-color: #3a7bd5;\n  color: #fff;\n}\n\n.save-btn:hover {\n  background-color: #4a8ce5;\n}\n\n.delete-btn {\n  background-color: #9e3a3a;\n  color: #fff;\n}\n\n.delete-btn:hover {\n  background-color: #ae4a4a;\n}\n\n.character-section {\n  background-color: #2a2a2a;\n  border-radius: 6px;\n  padding: 12px 16px;\n  margin-bottom: 16px;\n  max-height: none; /* 移除最大高度限制 */\n  overflow: visible; /* 确保内容可见 */\n}\n\n.character-section h4 {\n  margin: 0 0 12px 0;\n  font-size: 15px;\n  color: #bbb;\n}\n\n.section-header {\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  margin-bottom: 12px;\n}\n\n.add-param-btn {\n  border: none;\n  background-color: #40634e;\n  color: white;\n  padding: 4px 8px;\n  border-radius: 3px;\n  font-size: 12px;\n  cursor: pointer;\n}\n\n.add-param-btn:hover {\n  background-color: #4d7a60;\n}\n\n.character-fields {\n  display: grid;\n  grid-template-columns: 1fr 1fr;\n  gap: 12px;\n}\n\n.character-field {\n  margin-bottom: 8px;\n}\n\n.character-field label {\n  display: block;\n  margin-bottom: 5px;\n  color: #aaa;\n  font-size: 13px;\n}\n\n.character-input, .character-textarea, .character-select {\n  width: 100%;\n  padding: 8px;\n  background-color: #333;\n  border: 1px solid #555;\n  color: #ddd;\n  border-radius: 4px;\n  font-size: 14px;\n}\n\n.character-input:focus, .character-textarea:focus, .character-select:focus {\n  outline: none;\n  border-color: #3a7bd5;\n}\n\n.character-textarea {\n  resize: vertical;\n}\n\n.relationship-params-container {\n  display: grid;\n  grid-template-columns: 1fr;\n  gap: 12px;\n  max-height: none; /* 移除高度限制 */\n  overflow-y: visible; /* 允许内容溢出 */\n}\n\n.relationship-param {\n  background-color: #333;\n  border-radius: 4px;\n  padding: 10px 14px;\n  position: relative;\n}\n\n.param-header {\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  margin-bottom: 10px;\n}\n\n.param-name {\n  font-weight: 500;\n  color: #ccc;\n}\n\n.param-remove {\n  background: none;\n  border: none;\n  color: #999;\n  cursor: pointer;\n  padding: 2px 6px;\n  font-size: 14px;\n}\n\n.param-remove:hover {\n  color: #e55;\n}\n\n.param-fields {\n  display: grid;\n  grid-template-columns: 1fr 1fr;\n  gap: 10px;\n}\n\n.character-no-data {\n  text-align: center;\n  padding: 20px;\n  color: #888;\n  font-style: italic;\n}\n\n/* 确保内容区可以滚动 */\n.tab-content {\n  overflow: visible;\n}\n\n/* 设置参数表现的最大高度并添加滚动 */\n#character-data-tab .relationship-params-container {\n  max-height: 350px;\n  overflow-y: auto;\n  padding-right: 5px;\n}\n`;\n\n// 添加数据持久化功能\n// 保存角色关系参数和基本信息到聊天变量中\nasync function saveCharacterDataToVariables(parsedData) {\n  try {\n    // 首先获取角色名称，这是必需的\n    let characterName = '';\n    if (parsedData.categories['CP']) {\n      const nameItem = parsedData.categories['CP'].find(item => item.key === '名字');\n      if (nameItem && nameItem.values && nameItem.values.length > 0) {\n        characterName = nameItem.values[0];\n\n        // 如果名字是数组（含@分隔），取第一个元素\n        if (Array.isArray(characterName)) {\n          characterName = characterName[0];\n        }\n      }\n    }\n\n    // 如果没有找到角色名，不进行保存\n    if (!characterName) {\n      console.warn('[状态栏] 未找到角色名，无法保存角色数据');\n      return;\n    }\n\n    // 构建要保存的角色数据对象\n    let characterData = {};\n\n    // 1. 保存基本信息 (年龄、身高、特征、永久性状态)\n    if (parsedData.categories['CP']) {\n      const basicInfo = {};\n\n      // 保存年龄\n      const ageItem = parsedData.categories['CP'].find(item => item.key === '年龄');\n      if (ageItem && ageItem.values && ageItem.values.length > 0) {\n        basicInfo.age = ageItem.values[0];\n      }\n\n      // 保存身高\n      const heightItem = parsedData.categories['CP'].find(item => item.key === '身高');\n      if (heightItem && heightItem.values && heightItem.values.length > 0) {\n        basicInfo.height = heightItem.values[0];\n      }\n\n      // 保存特征\n      const traitsItem = parsedData.categories['CP'].find(item => item.key === '特征');\n      if (traitsItem && traitsItem.values && traitsItem.values.length > 0) {\n        basicInfo.traits = traitsItem.values[0];\n      }\n\n      // 保存永久性状态\n      const permanentItem = parsedData.categories['CP'].find(item => item.key === '永久性状态');\n      if (permanentItem && permanentItem.values && permanentItem.values.length > 0) {\n        basicInfo.permanent = permanentItem.values[0];\n      }\n\n      characterData.basicInfo = basicInfo;\n    }\n\n    // 2. 保存角色关系参数 (RP类别)\n    if (parsedData.categories['RP']) {\n      const relationshipParameters = {};\n\n      // 遍历所有关系参数\n      parsedData.categories['RP'].forEach(item => {\n        // 只存储键、当前值、最大值和阶段\n        const paramData = {\n          key: item.key,\n          currentValue: 0,\n          maxValue: 100,\n          stage: '',\n        };\n\n        // 解析当前值和最大值\n        if (item.values[0]) {\n          if (Array.isArray(item.values[0])) {\n            // 如果是数组（含@分隔）\n            const [current, max] = item.values[0];\n            paramData.currentValue = parseInt(current) || 0;\n            paramData.maxValue = parseInt(max) || 100;\n          } else {\n            // 如果是单个值\n            paramData.currentValue = parseInt(item.values[0]) || 0;\n          }\n        }\n\n        // 保存阶段 (values[3])\n        if (item.values.length > 3) {\n          paramData.stage = item.values[3];\n        }\n\n        // 存储参数\n        relationshipParameters[item.key] = paramData;\n      });\n\n      characterData.relationshipParameters = relationshipParameters;\n    }\n\n    // 3. 使用聊天变量API保存数据\n    const chatVariables = getVariables({ type: 'chat' });\n\n    // 创建或更新角色数据存储\n    if (!chatVariables.characterData) {\n      chatVariables.characterData = {};\n    }\n\n    // 保存/更新当前角色的数据\n    chatVariables.characterData[characterName] = characterData;\n\n    // 保存回聊天变量\n    await replaceVariables(chatVariables, { type: 'chat' });\n\n    console.log(`[状态栏] 成功保存角色 \"${characterName}\" 的数据到聊天变量`);\n  } catch (error) {\n    console.error('[状态栏] 保存角色数据到聊天变量时出错:', error);\n  }\n}\n\n// 初始化角色数据相关事件处理\nfunction initCharacterDataEvents() {\n  const parentDoc = window.parent.document;\n\n  // 刷新按钮事件\n  $(parentDoc).on('click', '#refresh-character-data-btn', function () {\n    loadCharacterDataList();\n  });\n\n  // 角色列表项点击事件\n  $(parentDoc).on('click', '.character-list-item', function () {\n    const characterName = $(this).data('name');\n    $('.character-list-item', parentDoc).removeClass('active');\n    $(this).addClass('active');\n    loadCharacterDetail(characterName);\n  });\n\n  // 添加参数按钮事件\n  $(parentDoc).on('click', '#add-param-btn', function () {\n    addEmptyRelationshipParam();\n  });\n\n  // 删除参数按钮事件\n  $(parentDoc).on('click', '.param-remove', function () {\n    $(this).closest('.relationship-param').remove();\n  });\n\n  // 保存角色数据按钮事件\n  $(parentDoc).on('click', '#save-character-data-btn', function () {\n    saveCharacterDetailChanges();\n  });\n\n  // 删除角色数据按钮事件\n  $(parentDoc).on('click', '#delete-character-data-btn', function () {\n    const characterName = $('#character-name', parentDoc).text();\n    if (confirm(`确定要删除角色 \"${characterName}\" 的数据吗？此操作不可撤销。`)) {\n      deleteCharacterData(characterName);\n    }\n  });\n}\n\n// 加载角色数据列表\nasync function loadCharacterDataList() {\n  try {\n    const parentDoc = window.parent.document;\n    const $characterList = $('#character-data-list', parentDoc);\n\n    // 显示加载中\n    $characterList.html('<p class=\"loading-text\">加载中...</p>');\n\n    // 从聊天变量中获取角色数据\n    const chatVariables = getVariables({ type: 'chat' });\n    const characterData = chatVariables.characterData || {};\n\n    // 更新列表\n    if (Object.keys(characterData).length === 0) {\n      $characterList.html('<p class=\"character-no-data\">暂无保存的角色数据</p>');\n      $('#character-data-empty-state', parentDoc).show();\n      $('#character-data-detail', parentDoc).hide();\n      return;\n    }\n\n    // 生成角色列表HTML\n    let listHtml = '';\n    Object.keys(characterData).forEach(name => {\n      listHtml += `<div class=\"character-list-item\" data-name=\"${name}\">${name}</div>`;\n    });\n\n    $characterList.html(listHtml);\n  } catch (error) {\n    console.error('[状态栏] 加载角色数据列表失败:', error);\n    const parentDoc = window.parent.document;\n    $('#character-data-list', parentDoc).html('<p class=\"character-no-data\">加载失败，请重试</p>');\n  }\n}\n\n// 加载角色详情\nasync function loadCharacterDetail(characterName) {\n  try {\n    const parentDoc = window.parent.document;\n\n    // 从聊天变量中获取角色数据\n    const chatVariables = getVariables({ type: 'chat' });\n    const characterData = chatVariables.characterData || {};\n    const charData = characterData[characterName];\n\n    if (!charData) {\n      console.error(`[状态栏] 未找到角色 \"${characterName}\" 的数据`);\n      return;\n    }\n\n    // 显示详情面板，隐藏空状态\n    $('#character-data-empty-state', parentDoc).hide();\n    $('#character-data-detail', parentDoc).show();\n\n    // 设置角色名\n    $('#character-name', parentDoc).text(characterName);\n\n    // 填充基本信息\n    $('#character-age', parentDoc).val(charData.basicInfo?.age || '');\n    $('#character-height', parentDoc).val(charData.basicInfo?.height || '');\n\n    // 处理特征和永久性状态，可能是字符串或数组\n    let traits = charData.basicInfo?.traits || '';\n    if (Array.isArray(traits)) {\n      traits = traits.join('@');\n    }\n\n    let permanent = charData.basicInfo?.permanent || '';\n    if (Array.isArray(permanent)) {\n      permanent = permanent.join('@');\n    }\n\n    $('#character-traits', parentDoc).val(traits);\n    $('#character-permanent', parentDoc).val(permanent);\n\n    // 渲染关系参数\n    renderRelationshipParams(charData.relationshipParameters);\n  } catch (error) {\n    console.error('[状态栏] 加载角色详情失败:', error);\n  }\n}\n\n// 渲染关系参数\nfunction renderRelationshipParams(params) {\n  const parentDoc = window.parent.document;\n  const $container = $('#relationship-params-container', parentDoc);\n\n  // 清空容器\n  $container.empty();\n\n  if (!params || Object.keys(params).length === 0) {\n    $container.html('<p class=\"character-no-data\">暂无关系参数</p>');\n    return;\n  }\n\n  // 遍历所有参数并渲染\n  Object.values(params).forEach(param => {\n    $container.append(createRelationshipParamHTML(param.key, param.currentValue, param.maxValue, param.stage));\n  });\n}\n\n// 创建关系参数HTML\nfunction createRelationshipParamHTML(key, currentValue, maxValue, stage) {\n  return `\n    <div class=\"relationship-param\" data-key=\"${key}\">\n      <div class=\"param-header\">\n        <div class=\"param-name\">${key}</div>\n        <button class=\"param-remove\"><i class=\"fa-solid fa-times\"></i></button>\n      </div>\n      <div class=\"param-fields\">\n        <div class=\"character-field\">\n          <label>参数名称</label>\n          <input type=\"text\" class=\"character-input param-key\" value=\"${key || ''}\">\n        </div>\n        <div class=\"character-field\">\n          <label>阶段描述</label>\n          <input type=\"text\" class=\"character-input param-stage\" value=\"${stage || ''}\">\n        </div>\n        <div class=\"character-field\">\n          <label>当前值</label>\n          <input type=\"number\" class=\"character-input param-current\" min=\"0\" max=\"100\" value=\"${currentValue || 0}\">\n        </div>\n        <div class=\"character-field\">\n          <label>最大值</label>\n          <input type=\"number\" class=\"character-input param-max\" min=\"1\" max=\"100\" value=\"${maxValue || 100}\">\n        </div>\n      </div>\n    </div>\n  `;\n}\n\n// 添加空的关系参数\nfunction addEmptyRelationshipParam() {\n  const parentDoc = window.parent.document;\n  const $container = $('#relationship-params-container', parentDoc);\n\n  // 如果容器中有\"暂无关系参数\"的提示，则移除\n  const $noData = $container.find('.character-no-data');\n  if ($noData.length > 0) {\n    $noData.remove();\n  }\n\n  // 添加一个空的参数表单\n  $container.append(createRelationshipParamHTML('新参数', 0, 100, ''));\n}\n\n// 保存角色详情更改\nasync function saveCharacterDetailChanges() {\n  try {\n    const parentDoc = window.parent.document;\n    const characterName = $('#character-name', parentDoc).text();\n\n    // 从聊天变量中获取现有角色数据\n    const chatVariables = getVariables({ type: 'chat' });\n    if (!chatVariables.characterData) {\n      chatVariables.characterData = {};\n    }\n\n    // 准备新的角色数据对象\n    const characterData = {\n      basicInfo: {\n        age: $('#character-age', parentDoc).val(),\n        height: $('#character-height', parentDoc).val(),\n        traits: $('#character-traits', parentDoc).val(),\n        permanent: $('#character-permanent', parentDoc).val(),\n      },\n      relationshipParameters: {},\n    };\n\n    // 收集所有关系参数\n    $('.relationship-param', parentDoc).each(function () {\n      const $param = $(this);\n      const key = $param.find('.param-key').val();\n\n      // 如果参数名为空，跳过\n      if (!key || key.trim() === '') {\n        return;\n      }\n\n      const currentValue = parseInt($param.find('.param-current').val()) || 0;\n      const maxValue = parseInt($param.find('.param-max').val()) || 100;\n      const stage = $param.find('.param-stage').val() || '';\n\n      characterData.relationshipParameters[key] = {\n        key,\n        currentValue,\n        maxValue,\n        stage,\n      };\n    });\n\n    // 更新聊天变量中的角色数据\n    chatVariables.characterData[characterName] = characterData;\n    await replaceVariables(chatVariables, { type: 'chat' });\n\n    // 显示保存成功提示\n    const $saveBtn = $('#save-character-data-btn', parentDoc);\n    const originalText = $saveBtn.html();\n    $saveBtn.html('<i class=\"fa-solid fa-check\"></i> 已保存');\n    setTimeout(() => {\n      $saveBtn.html(originalText);\n    }, 2000);\n\n    console.log(`[状态栏] 成功更新角色 \"${characterName}\" 的数据`);\n  } catch (error) {\n    console.error('[状态栏] 保存角色详情失败:', error);\n    alert(`保存失败: ${error.message}`);\n  }\n}\n\n// 删除角色数据\nasync function deleteCharacterData(characterName) {\n  try {\n    const parentDoc = window.parent.document;\n\n    // 从聊天变量中获取角色数据\n    const chatVariables = getVariables({ type: 'chat' });\n\n    if (!chatVariables.characterData || !chatVariables.characterData[characterName]) {\n      console.warn(`[状态栏] 未找到角色 \"${characterName}\" 的数据，无需删除`);\n      return;\n    }\n\n    // 删除指定角色的数据\n    delete chatVariables.characterData[characterName];\n    await replaceVariables(chatVariables, { type: 'chat' });\n\n    // 刷新角色列表并重置详情视图\n    loadCharacterDataList();\n    $('#character-data-empty-state', parentDoc).show();\n    $('#character-data-detail', parentDoc).hide();\n\n    console.log(`[状态栏] 成功删除角色 \"${characterName}\" 的数据`);\n  } catch (error) {\n    console.error('[状态栏] 删除角色数据失败:', error);\n    alert(`删除失败: ${error.message}`);\n  }\n}\n\n// 添加缺失的函数定义 - 更新单个条目状态\nasync function updateEntryState(uid, isEnabled) {\n  try {\n    // 获取所有条目\n    const entries = await getLorebookEntries(lorebook_name);\n\n    // 找到对应UID的条目\n    const entryIndex = entries.findIndex(entry => parseInt(entry.uid) === parseInt(uid));\n\n    // 如果找不到条目，抛出错误\n    if (entryIndex === -1) {\n      throw new Error(`找不到UID为${uid}的条目`);\n    }\n\n    // 创建条目的副本\n    const updatedEntry = { ...entries[entryIndex] };\n\n    // 更新启用状态\n    updatedEntry.enabled = isEnabled;\n\n    // 更新条目\n    entries[entryIndex] = updatedEntry;\n\n    // 保存回Lorebook\n    await setLorebookEntries(lorebook_name, entries);\n\n    console.log(`[状态栏] 条目 ${uid} 的状态已更新为 ${isEnabled ? '启用' : '禁用'}`);\n    return true;\n  } catch (error) {\n    console.error(`[状态栏] 更新条目状态失败:`, error);\n    throw error;\n  }\n}\n\n// 批量更新所有条目状态\nasync function updateAllEntriesState(isEnabled) {\n  try {\n    // 获取所有条目\n    const entries = await getLorebookEntries(lorebook_name);\n\n    // 过滤出非设置条目\n    const regularEntries = entries.filter(entry => !entry.comment.startsWith('设置-'));\n\n    // 更新所有条目状态\n    let updatedCount = 0;\n    const updatedEntries = entries.map(entry => {\n      // 忽略设置条目\n      if (entry.comment.startsWith('设置-')) {\n        return entry;\n      }\n\n      // 只有在状态需要变更时才修改\n      if (entry.enabled !== isEnabled) {\n        updatedCount++;\n        return { ...entry, enabled: isEnabled };\n      }\n\n      return entry;\n    });\n\n    // 如果有条目需要更新\n    if (updatedCount > 0) {\n      await setLorebookEntries(lorebook_name, updatedEntries);\n      console.log(`[状态栏] 已${isEnabled ? '启用' : '禁用'} ${updatedCount} 个条目`);\n    } else {\n      console.log(`[状态栏] 所有条目已经是${isEnabled ? '启用' : '禁用'}状态，无需更新`);\n    }\n\n    return true;\n  } catch (error) {\n    console.error(`[状态栏] 批量更新条目状态失败:`, error);\n    throw error;\n  }\n}\n",
  "info": "",
  "buttons": []
}