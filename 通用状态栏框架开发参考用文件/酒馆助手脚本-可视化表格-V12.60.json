{
  "type": "script",
  "enabled": false,
  "name": "可视化表格-V12.60",
  "id": "23d2c9d1-bc25-468d-81c6-cf6bf30fc807",
  "content": "(function () {\n    'use strict';\n    \n    const SCRIPT_ID = 'acu_visualizer_ui_v20_pagination';\n    const STORAGE_KEY_TABLE_ORDER = 'acu_table_order';\n    const STORAGE_KEY_ACTION_ORDER = 'acu_action_order';\n    const STORAGE_KEY_ACTIVE_TAB = 'acu_active_tab';\n    const STORAGE_KEY_UI_CONFIG = 'acu_ui_config_v18';\n    const STORAGE_KEY_LAST_SNAPSHOT = 'acu_data_snapshot_v18_5'; \n    const STORAGE_KEY_UI_COLLAPSE = 'acu_ui_collapse_state';\n    const STORAGE_KEY_TABLE_HEIGHTS = 'acu_table_heights';\n    const STORAGE_KEY_REVERSE_TABLES = 'acu_reverse_tables';\n    const STORAGE_KEY_HIDDEN_TABLES = 'acu_hidden_tables';\n    const STORAGE_KEY_TABLE_STYLES = 'acu_table_styles';\n    const TAB_DASHBOARD = 'acu_tab_dashboard_home';\n\n    let isInitialized = false;\n    let isSaving = false;\n    let isEditingOrder = false;\n    let currentDiffMap = new Set();\n    let pendingDeletes = new Set();\n    let observer = null;\n    let isCollapsed = localStorage.getItem(STORAGE_KEY_UI_COLLAPSE) === 'true';\n    let globalScrollTop = 0;\n    let currentPage = 1;\n    let currentSearchTerm = '';\n    \n    let hideOptionsUntilUpdate = false;\n    let lastOptionDataCheck = '';\n\n    const UpdateController = {\n        _suppressNext: false,\n        _resetTimer: null,\n        runSilently: async (action) => {\n            UpdateController._suppressNext = true;\n            try {\n                await action();\n            } catch (e) {\n                UpdateController._suppressNext = false;\n                console.error(e);\n            }\n            setTimeout(() => { UpdateController._suppressNext = false; }, 2000);\n        },\n        handleUpdate: () => {\n            if (UpdateController._suppressNext) {\n                clearTimeout(UpdateController._resetTimer);\n                UpdateController._resetTimer = setTimeout(() => {\n                    UpdateController._suppressNext = false; \n                }, 500);\n                return;\n            }\n            if (isEditingOrder) return;\n            renderInterface();\n        }\n    };\n\n    const DEFAULT_CONFIG = {\n        theme: 'modern',\n        fontFamily: 'default',\n        cardWidth: 280,\n        fontSize: 13,\n        optionFontSize: 13,\n        itemsPerPage: 20, \n        highlightNew: false,\n        highlightColor: 'orange',\n        layout: 'vertical',\n        limitLongText: false,\n        showDashboard: true,\n        customTitleColor: false,\n        titleColor: 'orange',\n        gridColumns: 0,\n        showOptionPanel: true,\n        clickOptionToAutoSend: false\n    };\n\n    const THEMES = [\n        { id: 'retro', name: '复古羊皮' },\n        { id: 'dark', name: '极夜深空' },\n        { id: 'modern', name: '现代清爽' },\n        { id: 'forest', name: '森之物语' },\n        { id: 'ocean', name: '深海幽蓝' },\n        { id: 'cyber', name: '赛博霓虹' },\n        { id: 'purple', name: '梦幻浅紫' }\n    ];\n\n    const FONTS = [\n        { id: 'default', name: '系统默认', val: `'Segoe UI', 'Microsoft YaHei', sans-serif` },\n        { id: 'serif', name: '宋体', val: `'SimSun', 'Songti SC', serif` },\n        { id: 'kaiti', name: '楷体', val: `'KaiTi', '楷体', 'STKaiti', serif` },\n        { id: 'mono', name: '等宽', val: `'Consolas', 'Monaco', monospace` },\n        { id: 'round', name: '幼圆', val: `'Microsoft YaHei UI', 'Yuanti SC', 'YouYuan', sans-serif` },\n        { id: 'lisu', name: '隶书', val: `'LiSu', 'Lisu', serif` },\n        { id: 'fangsong', name: '仿宋', val: `'FangSong', 'STFangsong', serif` },\n        { id: 'hei', name: '黑体', val: `'SimHei', 'Heiti SC', sans-serif` }\n    ];\n\n    const HIGHLIGHT_COLORS = {\n        orange: { main: '#d35400', bg: 'rgba(211, 84, 0, 0.1)', name: '活力橙' },\n        red:    { main: '#e91e63', bg: 'rgba(233, 30, 99, 0.1)', name: '绯红' },\n        blue:   { main: '#2196f3', bg: 'rgba(33, 150, 243, 0.1)', name: '海蓝' },\n        green:  { main: '#27ae60', bg: 'rgba(39, 174, 96, 0.1)', name: '翠绿' },\n        purple: { main: '#9b59b6', bg: 'rgba(155, 89, 182, 0.1)', name: '梦幻紫' },\n        cyan:   { main: '#00bcd4', bg: 'rgba(0, 188, 212, 0.1)', name: '青空蓝' },\n        teal:   { main: '#1abc9c', bg: 'rgba(26, 188, 156, 0.1)', name: '青绿' },\n        indigo: { main: '#3f51b5', bg: 'rgba(63, 81, 181, 0.1)', name: '靛蓝' }\n    };\n\n    const getCore = () => {\n        const w = window.parent || window;\n        return {\n            $: window.jQuery || w.jQuery,\n            getDB: () => w.AutoCardUpdaterAPI || window.AutoCardUpdaterAPI\n        };\n    };\n\n    const getIconForTableName = (name) => {\n        if (!name) return 'fa-table';\n        const n = name.toLowerCase();\n        if (n.includes('主角') || n.includes('角色')) return 'fa-user-circle';\n        if (n.includes('通用') || n.includes('全局') || n.includes('世界') || n.includes('设定')) return 'fa-globe-asia';\n        if (n.includes('装备') || n.includes('背包')) return 'fa-briefcase';\n        if (n.includes('技能') || n.includes('武魂') || n.includes('功法')) return 'fa-dragon';\n        if (n.includes('关系') || n.includes('周边') || n.includes('npc') || n.includes('人物')) return 'fa-user-friends';\n        if (n.includes('任务') || n.includes('日志')) return 'fa-scroll';\n        if (n.includes('地点') || n.includes('位置')) return 'fa-map-marker-alt';\n        if (n.includes('总结') || n.includes('大纲')) return 'fa-book-reader';\n        return 'fa-table';\n    };\n\n    const getBadgeStyle = (text) => {\n        if (!text) return '';\n        const str = String(text).trim();\n        if (/^[0-9]+%?$/.test(str) || /^Lv\\.?\\d+$/.test(str)) return 'acu-badge-green';\n        if (['是','否','有','无','死亡','存活','男','女','未知'].includes(str)) return 'acu-badge-neutral';\n        return '';\n    };\n\n    const getActiveTabState = () => { try { return JSON.parse(localStorage.getItem(STORAGE_KEY_ACTIVE_TAB)); } catch (e) { return null; } };\n    const saveActiveTabState = (tableName) => { try { localStorage.setItem(STORAGE_KEY_ACTIVE_TAB, JSON.stringify(tableName)); } catch (e) { console.error(e); } };\n    const getSavedTableOrder = () => { try { return JSON.parse(localStorage.getItem(STORAGE_KEY_TABLE_ORDER)); } catch (e) { return null; } };\n    const saveTableOrder = (tableNames) => { try { localStorage.setItem(STORAGE_KEY_TABLE_ORDER, JSON.stringify(tableNames)); } catch (e) { console.error(e); } };\n    const getSavedActionOrder = () => { try { return JSON.parse(localStorage.getItem(STORAGE_KEY_ACTION_ORDER)); } catch (e) { return null; } };\n    const saveActionOrder = (list) => { try { localStorage.setItem(STORAGE_KEY_ACTION_ORDER, JSON.stringify(list)); } catch (e) { console.error(e); } };\n    const getConfig = () => { try { const saved = JSON.parse(localStorage.getItem(STORAGE_KEY_UI_CONFIG)); return { ...DEFAULT_CONFIG, ...saved }; } catch (e) { return DEFAULT_CONFIG; } };\n    const saveConfig = (newConfig) => { const current = getConfig(); const merged = { ...current, ...newConfig }; try { localStorage.setItem(STORAGE_KEY_UI_CONFIG, JSON.stringify(merged)); } catch (e) { console.error(e); } applyConfigStyles(merged); };\n    \n    const getTableHeights = () => { try { return JSON.parse(localStorage.getItem(STORAGE_KEY_TABLE_HEIGHTS)) || {}; } catch (e) { return {}; } };\n    const saveTableHeights = (heights) => { try { localStorage.setItem(STORAGE_KEY_TABLE_HEIGHTS, JSON.stringify(heights)); } catch (e) { console.error(e); } };\n\n    const getTableStyles = () => { try { return JSON.parse(localStorage.getItem(STORAGE_KEY_TABLE_STYLES)) || {}; } catch (e) { return {}; } };\n    const saveTableStyles = (styles) => { try { localStorage.setItem(STORAGE_KEY_TABLE_STYLES, JSON.stringify(styles)); } catch (e) { console.error(e); } };\n\n    const getReverseOrderTables = () => { try { return JSON.parse(localStorage.getItem(STORAGE_KEY_REVERSE_TABLES)) || []; } catch (e) { return []; } };\n    const saveReverseOrderTables = (list) => { try { localStorage.setItem(STORAGE_KEY_REVERSE_TABLES, JSON.stringify(list)); } catch (e) { console.error(e); } };\n\n    const getHiddenTables = () => { try { return JSON.parse(localStorage.getItem(STORAGE_KEY_HIDDEN_TABLES)) || []; } catch (e) { return []; } };\n    const saveHiddenTables = (list) => { try { localStorage.setItem(STORAGE_KEY_HIDDEN_TABLES, JSON.stringify(list)); } catch (e) { console.error(e); } };\n\n    const loadSnapshot = () => { try { return JSON.parse(localStorage.getItem(STORAGE_KEY_LAST_SNAPSHOT)); } catch (e) { return null; } };\n    const saveSnapshot = (data) => { try { localStorage.setItem(STORAGE_KEY_LAST_SNAPSHOT, JSON.stringify(data)); } catch (e) { console.error(e); } };\n\n    const generateDiffMap = (currentData) => {\n        const lastData = loadSnapshot();\n        const diffSet = new Set();\n        if (!lastData) return diffSet;\n        for (const sheetId in currentData) {\n            const newSheet = currentData[sheetId];\n            const oldSheet = lastData[sheetId];\n            if (!newSheet || !newSheet.name) continue;\n            const tableName = newSheet.name;\n            if (!oldSheet) {\n                if (newSheet.content) {\n                     newSheet.content.forEach((row, rIdx) => { if (rIdx > 0) diffSet.add(`${tableName}-row-${rIdx-1}`); });\n                }\n                continue;\n            }\n            const newRows = newSheet.content || [];\n            const oldRows = oldSheet.content || [];\n            newRows.forEach((row, rIdx) => {\n                if (rIdx === 0) return; \n                const oldRow = oldRows[rIdx];\n                if (!oldRow) { diffSet.add(`${tableName}-row-${rIdx-1}`); } else {\n                    row.forEach((cell, cIdx) => {\n                        if (cIdx === 0) return; \n                        const oldCell = oldRow[cIdx];\n                        if (String(cell) !== String(oldCell)) { diffSet.add(`${tableName}-${rIdx-1}-${cIdx}`); }\n                    });\n                }\n            });\n        }\n        return diffSet;\n    };\n\n    const applyConfigStyles = (config) => {\n        const { $ } = getCore();\n        if (!$) return;\n        const $wrapper = $('.acu-wrapper');\n        const $embedded = $('.acu-embedded-options-container .acu-option-panel');\n        const fontVal = FONTS.find(f => f.id === config.fontFamily)?.val || FONTS[0].val;\n        $('#acu-dynamic-font').remove();\n        $('head').append(`\n            <style id=\"acu-dynamic-font\">\n                .acu-wrapper, .acu-edit-dialog, .acu-cell-menu, .acu-nav-container, .acu-data-card, .acu-panel-title, .acu-settings-label, .acu-checkbox-label, .acu-btn-block, .acu-nav-btn, .acu-dash-card, .acu-quick-view-card, .acu-option-panel, .acu-opt-btn, .acu-opt-header, .acu-nice-select, .acu-edit-dialog select, .acu-edit-dialog input, .acu-edit-dialog textarea {\n                    font-family: ${fontVal} !important;\n                }\n            </style>\n        `);\n        \n        const colorVal = HIGHLIGHT_COLORS[config.highlightColor] || HIGHLIGHT_COLORS.orange;\n        const titleColorVal = config.customTitleColor ? (HIGHLIGHT_COLORS[config.titleColor] || HIGHLIGHT_COLORS.orange).main : 'var(--acu-text-main)';\n        const gridCols = config.gridColumns > 0 ? `repeat(${config.gridColumns}, 1fr)` : 'repeat(auto-fill, minmax(110px, 1fr))';\n        \n        const cssProps = { \n            '--acu-card-width': `${config.cardWidth}px`, \n            '--acu-font-size': `${config.fontSize}px`,\n            '--acu-opt-font-size': `${config.optionFontSize || 13}px`,\n            '--acu-highlight': colorVal.main,\n            '--acu-highlight-bg': colorVal.bg,\n            '--acu-accent': colorVal.main,\n            '--acu-title-color': titleColorVal,\n            '--acu-nav-cols': gridCols\n        };\n        \n        if ($wrapper.length) {\n            $wrapper.removeClass(THEMES.map(t => `acu-theme-${t.id}`).join(' '));\n            $wrapper.addClass(`acu-theme-${config.theme}`);\n            $wrapper.css(cssProps);\n            const $display = $('.acu-data-display');\n            $display.removeClass('acu-layout-vertical acu-layout-horizontal').addClass(`acu-layout-${config.layout}`);\n        }\n\n        if ($embedded.length) {\n             $embedded.removeClass(THEMES.map(t => `acu-theme-${t.id}`).join(' '));\n             $embedded.addClass(`acu-theme-${config.theme}`);\n             $embedded.css(cssProps);\n        }\n    };\n\n    const addStyles = () => {\n        const { $ } = getCore();\n        if (!$) return;\n        $(`#${SCRIPT_ID}-styles`).remove();\n        const styles = `\n            <style id=\"${SCRIPT_ID}-styles\">\n                .acu-wrapper { --acu-highlight: #d35400; --acu-highlight-bg: rgba(211, 84, 0, 0.1); --acu-title-color: var(--acu-text-main); z-index: 20000; }\n                .acu-theme-retro { --acu-bg-nav: #e6e2d3; --acu-bg-panel: #e6e2d3; --acu-border: #bfb29e; --acu-text-main: #5e4b35; --acu-text-sub: #888; --acu-btn-bg: #d6ccbc; --acu-btn-hover: #cbbba8; --acu-btn-active-bg: #8d7b6f; --acu-btn-active-text: #fdfaf5; --acu-table-head: #efebe4; --acu-table-hover: #f0ebe0; --acu-shadow: rgba(0,0,0,0.1); --acu-menu-bg: #fff; --acu-menu-text: #333; --acu-card-bg: #fffef9; --acu-badge-bg: #efebe4; --acu-input-bg: rgba(255,255,255,0.5); --acu-overlay-bg: rgba(94, 75, 53, 0.4); }\n                .acu-theme-dark { --acu-bg-nav: rgba(30, 30, 30, 0.95); --acu-bg-panel: rgba(25, 25, 25, 0.95); --acu-border: #555; --acu-text-main: #eee; --acu-text-sub: #aaa; --acu-btn-bg: #3a3a3a; --acu-btn-hover: #4a4a4a; --acu-btn-active-bg: #6a5acd; --acu-btn-active-text: #fff; --acu-table-head: rgba(40, 40, 40, 0.9); --acu-table-hover: rgba(58, 58, 58, 0.5); --acu-shadow: rgba(0,0,0,0.6); --acu-card-bg: rgba(35, 35, 35, 0.9); --acu-badge-bg: #3a3f4b; --acu-menu-bg: #333; --acu-menu-text: #eee; --acu-input-bg: rgba(0,0,0,0.3); --acu-overlay-bg: rgba(0,0,0,0.75); }\n                .acu-theme-modern { --acu-bg-nav: #ffffff; --acu-bg-panel: #f8f9fa; --acu-border: #dee2e6; --acu-text-main: #333; --acu-text-sub: #6c757d; --acu-btn-bg: #e9ecef; --acu-btn-hover: #dee2e6; --acu-btn-active-bg: #0d6efd; --acu-btn-active-text: #fff; --acu-table-head: #f8f9fa; --acu-table-hover: #e9ecef; --acu-shadow: rgba(0,0,0,0.08); --acu-card-bg: #ffffff; --acu-badge-bg: #f1f3f5; --acu-menu-bg: #fff; --acu-menu-text: #333; --acu-input-bg: #ffffff; --acu-overlay-bg: rgba(0,0,0,0.3); }\n                .acu-theme-forest { --acu-bg-nav: #e8f5e9; --acu-bg-panel: #e8f5e9; --acu-border: #a5d6a7; --acu-text-main: #1b5e20; --acu-text-sub: #4caf50; --acu-btn-bg: #c8e6c9; --acu-btn-hover: #a5d6a7; --acu-btn-active-bg: #2e7d32; --acu-btn-active-text: #fff; --acu-table-head: #dcedc8; --acu-table-hover: #f1f8e9; --acu-shadow: rgba(0,0,0,0.1); --acu-card-bg: #ffffff; --acu-badge-bg: #dcedc8; --acu-menu-bg: #fff; --acu-menu-text: #2e7d32; --acu-input-bg: rgba(255,255,255,0.7); --acu-overlay-bg: rgba(27, 94, 32, 0.2); }\n                .acu-theme-ocean { --acu-bg-nav: #f0f9ff; --acu-bg-panel: #f0f9ff; --acu-border: #bae6fd; --acu-text-main: #0369a1; --acu-text-sub: #38bdf8; --acu-btn-bg: #e0f2fe; --acu-btn-hover: #bae6fd; --acu-btn-active-bg: #0ea5e9; --acu-btn-active-text: #fff; --acu-table-head: #e0f2fe; --acu-table-hover: #f0f9ff; --acu-shadow: rgba(3, 105, 161, 0.15); --acu-card-bg: #ffffff; --acu-badge-bg: #e0f2fe; --acu-menu-bg: #fff; --acu-menu-text: #0369a1; --acu-input-bg: rgba(255,255,255,0.75); --acu-overlay-bg: rgba(3, 105, 161, 0.2); }\n                .acu-theme-cyber { --acu-bg-nav: #050505; --acu-bg-panel: #0a0a0a; --acu-border: #444; --acu-text-main: #00ffcc; --acu-text-sub: #ff00ff; --acu-btn-bg: #1f1f1f; --acu-btn-hover: #333; --acu-btn-active-bg: #ff00ff; --acu-btn-active-text: #fff; --acu-table-head: #111; --acu-table-hover: #1a1a1a; --acu-shadow: 0 0 10px rgba(0,255,204,0.3); --acu-card-bg: #050505; --acu-badge-bg: #222; --acu-menu-bg: #111; --acu-menu-text: #00ffcc; --acu-input-bg: #111; --acu-overlay-bg: rgba(0,0,0,0.85); }\n                .acu-theme-purple { --acu-bg-nav: #f3e5f5; --acu-bg-panel: #f3e5f5; --acu-border: #ce93d8; --acu-text-main: #4a148c; --acu-text-sub: #ab47bc; --acu-btn-bg: #e1bee7; --acu-btn-hover: #d1c4e9; --acu-btn-active-bg: #8e24aa; --acu-btn-active-text: #fff; --acu-table-head: #f3e5f5; --acu-table-hover: #ede7f6; --acu-shadow: rgba(0,0,0,0.1); --acu-card-bg: #ffffff; --acu-badge-bg: #f3e5f5; --acu-menu-bg: #fff; --acu-menu-text: #4a148c; --acu-input-bg: rgba(255,255,255,0.6); --acu-overlay-bg: rgba(74, 20, 140, 0.25); }\n\n                .acu-wrapper { position: relative; width: 100%; margin: 15px 0; z-index: 20000; display: flex; flex-direction: column; contain: layout; }\n                .acu-nav-container { display: flex; gap: 0; padding: 12px; background: var(--acu-bg-nav); border: 1px solid var(--acu-border); border-radius: 14px; box-shadow: 0 4px 15px var(--acu-shadow); position: relative; z-index: 20001; backdrop-filter: blur(5px); flex-direction: column; }\n                .acu-nav-tabs-area { display: grid; grid-template-columns: var(--acu-nav-cols, repeat(auto-fill, minmax(110px, 1fr))); gap: 6px; width: 100%; }\n                .acu-nav-separator { width: 100%; height: 1px; border-top: 1px dashed var(--acu-border); margin: 12px 0 8px 0; opacity: 0.6; }\n                .acu-nav-actions-area { display: flex; gap: 6px; width: 100%; justify-content: center; align-items: center; background: transparent; padding-top: 4px; }\n                .acu-nav-btn { width: 100%; display: flex; align-items: center; justify-content: center; gap: 6px; padding: 6px 3px; border: 1px solid transparent; border-radius: 8px; background: var(--acu-btn-bg); color: var(--acu-text-main); font-weight: 600; font-size: 13px; cursor: pointer; transition: all 0.2s ease; user-select: none; text-align: center; white-space: nowrap; overflow: hidden; }\n                .acu-nav-btn span { overflow: hidden; text-overflow: ellipsis; }\n                .acu-nav-btn:hover { background: var(--acu-btn-hover); transform: translateY(-2px); }\n                .acu-nav-btn.active { background: var(--acu-btn-active-bg); color: var(--acu-btn-active-text); box-shadow: 0 2px 6px rgba(0,0,0,0.15); }\n                .acu-action-btn { flex: 1; height: 36px; display: flex; align-items: center; justify-content: center; background: var(--acu-btn-bg); border-radius: 8px; color: var(--acu-text-sub); cursor: pointer; border: 1px solid transparent; transition: all 0.2s; font-size: 16px; }\n                .acu-action-btn:hover { background: var(--acu-btn-hover); color: var(--acu-text-main); transform: scale(1.1); border-color: var(--acu-border); }\n                #acu-btn-save-global:hover { background: var(--acu-btn-active-bg); color: var(--acu-btn-active-text); }\n\n                .acu-option-panel { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; padding: 8px; background: var(--acu-bg-nav); border: 1px solid var(--acu-border); border-radius: 12px; margin-bottom: 8px; backdrop-filter: blur(5px); width: 100%; box-sizing: border-box; z-index: 20001; contain: layout style; transition: opacity 0.15s ease-out; opacity: 1; }\n                .acu-opt-btn { background: var(--acu-btn-bg); border: 1px solid var(--acu-border); padding: 8px 15px; border-radius: 8px; cursor: pointer; color: var(--acu-text-main); font-size: var(--acu-opt-font-size); transition: all 0.2s; font-weight: 500; user-select: none; text-align: left; width: 100%; overflow: hidden; white-space: pre-wrap; word-break: break-word; min-height: 38px; display: flex; align-items: center; }\n                .acu-opt-btn:focus { outline: none; scroll-margin: 0; }\n                .acu-opt-btn:hover { background: var(--acu-highlight); color: #fff; transform: translateY(-2px); border-color: var(--acu-highlight); box-shadow: 0 4px 10px var(--acu-highlight-bg); }\n                .acu-opt-btn:active { transform: translateY(0); opacity: 0.8; }\n                .acu-opt-header { grid-column: 1 / -1; text-align: center; font-size: 12px; font-weight: bold; color: var(--acu-title-color); padding: 2px 0; border-bottom: 1px dashed var(--acu-border); margin-bottom: 4px; opacity: 0.9; }\n\n                .acu-data-display { position: absolute; bottom: calc(100% + 12px); left: 0; right: 0; max-height: 95vh; height: auto; background: var(--acu-bg-panel); border: 1px solid var(--acu-border); border-radius: 12px; box-shadow: 0 12px 40px var(--acu-shadow); display: none; flex-direction: column; z-index: 20002; animation: popUp 0.25s cubic-bezier(0.34, 1.56, 0.64, 1); backdrop-filter: blur(8px); }\n                .acu-data-display.visible { display: flex; }\n                .acu-no-anim { animation: none !important; transform: none !important; }\n                @keyframes popUp { from { opacity: 0; transform: translateY(15px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }\n\n                .acu-wrapper *:focus { scroll-margin: 0 !important; scroll-padding: 0 !important; outline: none !important; }\n                .acu-nav-btn, .acu-action-btn, .acu-opt-btn, .acu-page-btn, .acu-close-btn, .acu-btn-block, .acu-dialog-btn, .acu-dash-interactive, .acu-grid-item, .acu-full-item, .acu-inline-item, .acu-editable-title, .acu-tab-btn, .acu-close-pill, .acu-cell-menu-item { -webkit-tap-highlight-color: transparent; }\n                .acu-data-display { contain: layout style; }\n                .acu-data-display:not(.visible) { visibility: hidden; pointer-events: none; position: absolute; }\n\n                .acu-panel-header { flex: 0 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; background: var(--acu-table-head); border-bottom: 1px solid var(--acu-border); border-radius: 12px 12px 0 0; }\n                .acu-panel-title { font-weight: bold; color: var(--acu-text-main); display: flex; align-items: center; gap: 8px; white-space: nowrap; font-size: 15px; }\n                .acu-header-actions { display: flex; align-items: center; gap: 10px; }\n                .acu-search-wrapper { position: relative; display: flex; align-items: center; }\n                .acu-search-input { background: var(--acu-btn-bg); border: 1px solid var(--acu-border); color: var(--acu-text-main); padding: 5px 10px 5px 26px; border-radius: 16px; font-size: 12px; width: 100px; transition: all 0.2s; }\n                .acu-search-input:focus { width: 140px; outline: none; border-color: var(--acu-highlight); background: var(--acu-input-bg); }\n                .acu-search-icon { position: absolute; left: 10px; font-size: 10px; color: var(--acu-text-sub); pointer-events: none; }\n                .acu-close-btn { background: none; border: none; color: var(--acu-text-sub); cursor: pointer; font-size: 18px; padding: 0; width: 32px; height: 32px; display: inline-flex; align-items: center; justify-content: center; transition: all 0.2s; border-radius: 50%; } .acu-close-btn:hover { color: #e74c3c; background-color: var(--acu-table-hover); }\n                \n                .acu-panel-content { flex: 1; padding: 15px; padding-bottom: 10px; background: transparent; scrollbar-width: thin; scrollbar-color: var(--acu-text-sub) transparent; overflow-y: auto; overflow-x: hidden; }\n                .acu-panel-content::-webkit-scrollbar { width: 6px; height: 6px; }\n                .acu-panel-content::-webkit-scrollbar-thumb { background-color: var(--acu-text-sub); border-radius: 3px; }\n\n                .acu-panel-footer { flex: 0 0 auto; padding: 8px; border-top: 1px dashed var(--acu-border); background: var(--acu-table-head); display: flex; justify-content: center; align-items: center; gap: 5px; flex-wrap: wrap; }\n                .acu-page-btn { padding: 4px 10px; min-width: 32px; height: 28px; border-radius: 4px; border: 1px solid var(--acu-border); background: var(--acu-btn-bg); color: var(--acu-text-main); cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }\n                .acu-page-btn:hover:not(:disabled):not(.active) { background: var(--acu-btn-hover); color: var(--acu-text-main); transform: translateY(-1px); }\n                .acu-page-btn.active { background: var(--acu-btn-active-bg); color: var(--acu-btn-active-text); border-color: transparent; box-shadow: 0 2px 6px rgba(0,0,0,0.15); font-weight: bold; }\n                .acu-page-btn:disabled { opacity: 0.5; cursor: not-allowed; }\n                .acu-page-info { font-size: 12px; color: var(--acu-text-sub); margin: 0 10px; }\n\n                .acu-dash-container { display: grid; grid-template-columns: 1fr 2fr; gap: 16px; height: 100%; padding: 5px; overflow-y: auto; font-size: var(--acu-font-size); }\n                @media (max-width: 700px) { .acu-dash-container { grid-template-columns: 1fr; } }\n                .acu-dash-card { background: var(--acu-card-bg); border-radius: 12px; border: 1px solid var(--acu-border); padding: 16px; display: flex; flex-direction: column; gap: 12px; box-shadow: 0 4px 12px var(--acu-shadow); }\n                .acu-dash-title { font-size: 1.2em; font-weight: bold; color: var(--acu-highlight); border-bottom: 1px dashed var(--acu-border); padding-bottom: 8px; margin-bottom: 4px; display: flex; justify-content: space-between; align-items: center; }\n                .acu-dash-char-info { display: flex; flex-direction: column; gap: 10px; }\n                .acu-dash-stat-row { display: flex; justify-content: space-between; align-items: center; padding: 8px; background: var(--acu-btn-bg); border-radius: 8px; }\n                .acu-dash-stat-label { color: var(--acu-text-sub); font-size: 0.9em; }\n                .acu-dash-stat-val { color: var(--acu-text-main); font-weight: bold; font-size: 1.1em; }\n                .acu-dash-npc-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; max-height: 300px; overflow-y: auto; padding-right: 4px; scrollbar-width: thin; align-content: start; }\n                .acu-dash-npc-grid::-webkit-scrollbar { width: 4px; }\n                .acu-dash-npc-grid::-webkit-scrollbar-thumb { background: var(--acu-text-sub); border-radius: 2px; }\n                .acu-dash-npc-item { background: var(--acu-table-head); padding: 10px; border-radius: 8px; cursor: default; text-align: center; border: 1px solid transparent; transition: all 0.2s; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--acu-text-main); font-size: 1em; }\n                .acu-dash-npc-item:hover { border-color: var(--acu-highlight); color: var(--acu-highlight); background: var(--acu-btn-bg); }\n                .acu-dash-sub-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: auto; }\n                .acu-dash-list-item { padding: 6px 0; border-bottom: 1px solid var(--acu-border); color: var(--acu-text-sub); font-size: 1em; display: flex; align-items: center; gap: 6px; cursor: default; }\n                .acu-dash-list-item:hover { color: var(--acu-text-main); padding-left: 4px; }\n                .acu-dash-list-item i { font-size: 0.8em; color: var(--acu-highlight); }\n                \n                .acu-dash-interactive { cursor: pointer !important; position: relative; }\n                .acu-dash-interactive:hover::after { content: '\\\\f002'; font-family: 'Font Awesome 6 Free'; font-weight: 900; position: absolute; right: 5px; top: 50%; transform: translateY(-50%); opacity: 0.5; font-size: 10px; }\n                \n                .acu-tab-header { display: flex; gap: 5px; border-bottom: 1px solid var(--acu-border); margin-bottom: 10px; }\n                .acu-tab-btn { padding: 6px 12px; cursor: pointer; font-size: 13px; font-weight: bold; color: var(--acu-text-sub); border-bottom: 2px solid transparent; transition: all 0.2s; }\n                .acu-tab-btn:hover { color: var(--acu-text-main); background: var(--acu-table-hover); border-radius: 4px 4px 0 0; }\n                .acu-tab-btn.active { color: var(--acu-highlight); border-bottom-color: var(--acu-highlight); }\n                .acu-tab-pane { display: none; animation: fadeIn 0.3s; }\n                .acu-tab-pane.active { display: block; }\n                @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }\n\n                .acu-quick-view-overlay { position: fixed !important; top: 0; left: 0; right: 0; bottom: 0; width: 100vw; height: 100vh; background: var(--acu-overlay-bg) !important; z-index: 2147483648 !important; display: flex !important; justify-content: center !important; align-items: center !important; backdrop-filter: blur(4px); }\n                .acu-quick-view-card { background: var(--acu-card-bg); border-radius: 12px; border: 1px solid var(--acu-border); box-shadow: 0 15px 50px var(--acu-shadow); width: 90%; max-width: 450px; max-height: 80vh; display: flex; flex-direction: column; overflow: hidden; animation: popUp 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); color: var(--acu-text-main); }\n                .acu-quick-view-header { padding: 15px; background: var(--acu-table-head); border-bottom: 1px solid var(--acu-border); font-weight: bold; display: flex; justify-content: space-between; align-items: center; font-size: 1.1em; color: var(--acu-highlight); }\n                .acu-quick-view-body { padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; scrollbar-width: thin; }\n                .acu-quick-view-body::-webkit-scrollbar { width: 4px; }\n                .acu-quick-view-body::-webkit-scrollbar-thumb { background: var(--acu-text-sub); }\n\n                .acu-layout-vertical .acu-card-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 14px; }\n                .acu-layout-vertical .acu-data-card { flex: 0 0 var(--acu-card-width, 280px); width: var(--acu-card-width, 280px); }\n                .acu-layout-horizontal .acu-panel-content { display: block; white-space: nowrap; overflow-x: auto !important; overflow-y: hidden; }\n                .acu-layout-horizontal .acu-card-grid { display: inline-flex; flex-wrap: nowrap; gap: 14px; height: 100%; align-items: flex-start; padding-bottom: 10px; min-width: 100%; }\n                .acu-layout-horizontal .acu-data-card { flex: 0 0 var(--acu-card-width, 280px); width: var(--acu-card-width, 280px); max-height: 98%; overflow-y: auto; white-space: normal; }\n\n                .acu-data-card { background: var(--acu-card-bg); border: none; box-shadow: 0 2px 8px var(--acu-shadow); border-radius: 12px; transition: all 0.25s ease; display: flex; flex-direction: column; position: relative; }\n                .acu-layout-vertical .acu-data-card:hover { transform: translateY(-4px); box-shadow: 0 8px 25px var(--acu-shadow); z-index: 5; }\n                .acu-card-header { padding: 6px 10px; background: var(--acu-table-head); border-bottom: 1px dashed var(--acu-border); border-radius: 12px 12px 0 0; font-weight: bold; color: var(--acu-title-color); font-size: 14px; display: flex; justify-content: center; align-items: center; position: relative; flex: 0 0 auto; }\n                .acu-editable-title { cursor: pointer; border-bottom: 1px dashed transparent; transition: all 0.2s; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 15px; font-weight: 800; text-align: center; width: 100%; padding: 2px 5px; border-radius: 4px; }\n                .acu-editable-title:hover { background: var(--acu-table-hover); color: var(--acu-highlight); }\n                .acu-card-index { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: 10px; color: var(--acu-text-sub); font-weight: normal; background: var(--acu-badge-bg); padding: 1px 6px; border-radius: 8px; opacity: 0.8; }\n                .acu-card-body { padding: 0; display: flex; flex-direction: column; gap: 0; font-size: var(--acu-font-size, 13px); }\n                .acu-card-main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 12px; }\n                .acu-grid-item { display: flex; flex-direction: column; gap: 2px; padding: 4px 6px; border-radius: 6px; cursor: pointer; overflow: hidden; border: 1px solid var(--acu-border); background: rgba(0,0,0,0.02); }\n                .acu-grid-item:hover { background: var(--acu-table-hover); }\n                .acu-grid-label { font-size: var(--acu-font-size, 13px); color: var(--acu-title-color); font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }\n                .acu-grid-value { font-size: var(--acu-font-size, 13px); color: var(--acu-text-main); font-weight: 500; white-space: pre-wrap; word-break: break-word; line-height: 1.35; }\n                .acu-card-full-area { display: flex; flex-direction: column; gap: 0; padding: 0 12px 10px 12px; }\n                .acu-full-item { display: flex; flex-direction: column; gap: 2px; padding: 4px 6px; border-radius: 6px; border: 1px solid var(--acu-border); background: rgba(0,0,0,0.02); cursor: pointer; margin-top: 4px; }\n                .acu-full-item:hover { background: var(--acu-table-hover); }\n                .acu-full-label { font-size: var(--acu-font-size, 13px); color: var(--acu-title-color); font-weight: bold; }\n                .acu-full-value { font-size: var(--acu-font-size, 13px); color: var(--acu-text-main); line-height: 1.4; word-break: break-all; white-space: pre-wrap; max-height: var(--acu-text-max-height, 80px); overflow-y: var(--acu-text-overflow, auto); scrollbar-width: none; }\n                \n                .acu-inline-item { display: block; padding: 2px 8px; border-bottom: 1px dashed var(--acu-border); cursor: pointer; max-height: var(--acu-text-max-height, 80px); overflow-y: var(--acu-text-overflow, auto); scrollbar-width: none; }\n                .acu-inline-item:last-child { border-bottom: none; }\n                .acu-inline-item:hover { background: var(--acu-table-hover); }\n                .acu-inline-label { display: inline; color: var(--acu-title-color); font-weight: bold; font-size: var(--acu-font-size, 13px); line-height: 1.4; margin-right: 4px; }\n                .acu-inline-label::after { content: '：'; }\n                .acu-inline-value { display: inline; color: var(--acu-text-main); font-size: var(--acu-font-size, 13px); line-height: 1.4; word-break: break-word; white-space: pre-wrap; }\n                .acu-inline-value.acu-highlight-changed { display: inline; }\n\n                .acu-highlight-changed { color: var(--acu-highlight) !important; background-color: var(--acu-highlight-bg); border-radius: 4px; padding: 0 4px; font-weight: bold; animation: pulse-highlight 2s infinite; display: inline-block; }\n                .acu-badge-pending { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-15deg); width: 80px; height: 80px; border: 4px solid #e74c3c; border-radius: 50%; color: #e74c3c; font-size: 20px; font-weight: 900; display: flex; align-items: center; justify-content: center; z-index: 50; pointer-events: none; opacity: 0.6; box-shadow: inset 0 0 10px rgba(231, 76, 60, 0.2); background: rgba(255,255,255,0.1); }\n                @keyframes pulse-highlight { 0% { opacity: 0.7; } 50% { opacity: 1; } 100% { opacity: 0.7; } }\n                @keyframes acu-shake { 0% { transform: rotate(0deg); } 25% { transform: rotate(10deg); } 50% { transform: rotate(0deg); } 75% { transform: rotate(-10deg); } 100% { transform: rotate(0deg); } }\n                .acu-save-alert { animation: acu-shake 0.4s ease-in-out infinite; color: #fff !important; background-color: #e74c3c !important; text-shadow: 0 0 5px rgba(231, 76, 60, 0.5); border-color: #c0392b !important; }\n                \n                .acu-menu-backdrop { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: transparent; z-index: 2147483640; }\n                .acu-cell-menu { position: fixed !important; background-color: var(--acu-card-bg) !important; border: 1px solid var(--acu-border) !important; color: var(--acu-text-main) !important; box-shadow: 0 6px 20px var(--acu-shadow) !important; z-index: 2147483647 !important; border-radius: 8px; overflow: hidden; min-width: 150px; backdrop-filter: blur(5px); }\n                .acu-cell-menu-item { padding: 12px 16px; cursor: pointer; font-size: 14px; display: flex; gap: 12px; align-items: center; color: var(--acu-text-main); font-weight: 500; background: transparent; }\n                .acu-cell-menu-item:hover { background-color: var(--acu-table-hover); }\n                .acu-cell-menu-item#act-delete { color: #e74c3c; }\n                .acu-cell-menu-item#act-restore { color: #27ae60; }\n\n                .acu-edit-overlay { position: fixed !important; top: 0; left: 0; right: 0; bottom: 0; width: 100vw; height: 100vh; background: var(--acu-overlay-bg) !important; z-index: 2147483646 !important; display: flex !important; justify-content: center !important; align-items: center !important; backdrop-filter: blur(2px); }\n                .acu-edit-dialog { background-color: var(--acu-bg-panel) !important; width: 90%; max-width: 900px; max-height: 85vh; border-radius: 12px; display: flex; flex-direction: column; box-shadow: 0 15px 50px var(--acu-shadow); color: var(--acu-text-main) !important; border: 1px solid var(--acu-border); margin: auto !important; overflow: hidden; padding: 0; }\n                .acu-edit-title { flex: 0 0 auto; margin: 0; padding: 20px 24px; font-size: 16px; font-weight: bold; color: var(--acu-text-main); border-bottom: 1px solid var(--acu-border); }\n                .acu-settings-content { flex: 1; overflow-y: auto; padding: 20px 24px; display: flex; flex-direction: column; gap: 16px; }\n                .acu-edit-textarea { width: 100%; height: 500px; padding: 12px; border: 1px solid var(--acu-border); background-color: var(--acu-input-bg) !important; color: var(--acu-text-main) !important; border-radius: 6px; resize: vertical; box-sizing: border-box; font-size: 14px; line-height: 1.5; font-family: monospace; }\n                .acu-dialog-btns { flex: 0 0 auto; display: flex; justify-content: center; gap: 20px; padding: 16px 24px; border-top: 1px solid var(--acu-border); background: var(--acu-bg-panel); }\n                .acu-dialog-btn { background: none; border: none; cursor: pointer; font-size: 14px; font-weight: bold; display: flex; align-items: center; gap: 6px; color: var(--acu-text-sub); transition: color 0.2s; }\n                .acu-order-controls { display: none; width: 100%; text-align: center; background: var(--acu-table-head); padding: 5px; margin-bottom: 5px; border-radius: 4px; border: 1px dashed var(--acu-border); }\n                .acu-order-controls.visible { display: block; }\n                .acu-nav-container.editing-order .acu-nav-btn, .acu-nav-container.editing-order .acu-action-btn { border: 1px dashed #f0ad4e; cursor: grab; opacity: 0.8; }\n                .acu-divider { width: 1px; height: 18px; background: var(--acu-border); margin: 0 6px; }\n                .acu-nav-container.collapsed > *:not(#acu-btn-toggle):not(.acu-collapsed-text) { display: none !important; }\n                .acu-nav-container.collapsed { width: 100%; justify-content: center; cursor: pointer; padding: 8px 0; flex-direction: column; gap: 0; height: auto; }\n                .acu-nav-container.collapsed #acu-btn-toggle { background: transparent; border: none; width: 100%; pointer-events: none; height: 24px; }\n                .acu-collapsed-text { display: none; font-size: 12px; color: var(--acu-text-sub); margin-top: 2px; text-align: center; width: 100%; pointer-events: none; font-weight: bold; letter-spacing: 1px; }\n                .acu-nav-container.collapsed .acu-collapsed-text { display: block; }\n\n                .acu-height-control { display: flex; align-items: center; gap: 5px; margin-right: 10px; opacity: 0.8; transition: opacity 0.2s; }\n                .acu-height-input { width: 50px; background: var(--acu-btn-bg); border: 1px solid var(--acu-border); color: var(--acu-text-main); border-radius: 4px; padding: 2px 4px; font-size: 12px; text-align: center; height: 22px; -moz-appearance: textfield; }\n                .acu-height-drag-handle { cursor: ns-resize; padding: 5px; border-radius: 4px; transition: all 0.2s; color: var(--acu-text-sub); touch-action: none; }\n                .acu-height-drag-handle:hover, .acu-height-drag-handle.active { color: var(--acu-highlight); background: var(--acu-table-hover); }\n                .acu-slider { width: 100%; height: 4px; background: var(--acu-border); border-radius: 2px; outline: none; -webkit-appearance: none; }\n                .acu-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; background: var(--acu-text-main); border-radius: 50%; cursor: pointer; }\n                .acu-select { width: 100%; padding: 8px; background: var(--acu-input-bg); border: 1px solid var(--acu-border); color: var(--acu-text-main); border-radius: 4px; outline: none; text-align: center; }\n                .acu-btn-block { width: 100%; padding: 10px; background: var(--acu-table-head); color: var(--acu-text-main); border: 1px solid var(--acu-border); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 10px; }\n                .acu-color-options { display: flex; gap: 10px; }\n                .acu-color-opt { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: transform 0.2s; }\n                .acu-color-opt.selected { transform: scale(1.2); border-color: var(--acu-bg-panel); box-shadow: 0 0 0 2px var(--acu-text-main), 0 4px 8px rgba(0,0,0,0.3); }\n                .acu-checkbox-label { display: flex; align-items: center; gap: 8px; cursor: pointer; }\n                .acu-checkbox { margin: 0; }\n\n                #acu-latest-hint { display: none; width: 100%; text-align: center; background: #e3f2fd; color: #1565c0; padding: 5px; margin-bottom: 5px; border-radius: 4px; border: 1px dashed #90caf9; }\n                #acu-latest-hint.visible { display: block; }\n                .acu-nav-btn.latest-selected { border: 1px solid #2196f3; background: #e3f2fd; color: #1565c0; }\n                .acu-nav-btn.latest-selected::after { content: '\\\\f887'; font-family: 'Font Awesome 6 Free'; font-weight: 900; margin-left: 5px; }\n\n                .acu-switch { position: relative; display: inline-block; width: 40px; height: 22px; flex-shrink: 0; }\n                .acu-switch input { opacity: 0; width: 0; height: 0; }\n                .acu-switch-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .3s; border-radius: 22px; }\n                .acu-switch-slider:before { position: absolute; content: \"\"; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%; }\n                .acu-switch input:checked + .acu-switch-slider { background-color: var(--acu-highlight); opacity: 1; box-shadow: 0 0 5px var(--acu-btn-active-bg); filter: brightness(1.1); }\n                .acu-switch input:checked + .acu-switch-slider:before { transform: translateX(18px); }\n                .acu-settings-item.acu-flex-row { display: flex; justify-content: flex-start; align-items: center; gap: 15px; }\n                .acu-settings-item.acu-flex-row .acu-settings-label { margin-bottom: 0; }\n                .acu-settings-item.acu-flex-row .acu-select { width: 140px; padding: 4px; height: 30px; }\n                .acu-card-edit-field { margin-bottom: 10px; }\n                .acu-card-edit-label { display: block; font-size: 12px; color: var(--acu-highlight); font-weight: bold; margin-bottom: 4px; }\n                .acu-card-edit-input { width: 100%; min-height: 38px; padding: 8px; border: 1px solid var(--acu-border); background: var(--acu-input-bg); color: var(--acu-text-main); border-radius: 6px; resize: none; overflow-y: hidden; line-height: 1.4; font-family: inherit; font-size: 14px; box-sizing: border-box; }\n                .acu-card-edit-input:focus { border-color: var(--acu-highlight); outline: none; }\n                .acu-cell-menu-item#act-edit-card { color: var(--acu-highlight); }\n                .acu-cell-menu-item#act-insert { color: #2980b9; }\n                .acu-wrapper button:focus, .acu-edit-dialog button:focus, .acu-cell-menu button:focus { outline: none !important; }\n                \n                @media (max-width: 768px) {\n                    .acu-nav-btn {\n                        padding: 6px 2px !important;\n                        font-size: 12px !important;\n                        min-height: 32px !important;\n                    }\n                    .acu-nav-actions-area {\n                         padding-top: 2px !important;\n                         gap: 8px !important;\n                         display: flex !important;\n                         width: 100% !important;\n                    }\n                    .acu-action-btn {\n                         width: auto !important;\n                         flex: 1 !important;\n                         height: 40px !important;\n                         border-radius: 8px !important;\n                         background: var(--acu-btn-bg);\n                         margin: 0 !important;\n                    }\n                    .acu-option-panel {\n                         grid-template-columns: 1fr !important;\n                    }\n                    .acu-opt-btn {\n                         white-space: normal !important;\n                         height: auto !important;\n                    }\n                }\n            </style>\n        `;\n        $('head').append(styles);\n    };\n\n    const getTableData = () => { const api = getCore().getDB(); return api && api.exportTableAsJson ? api.exportTableAsJson() : null; };\n    \n    const updateSaveBtnState = () => {\n        const { $ } = getCore();\n        if (!$) return;\n        const $btn = $('#acu-btn-save-global');\n        if (pendingDeletes.size > 0) {\n            $btn.addClass('acu-save-alert');\n        } else {\n            $btn.removeClass('acu-save-alert');\n        }\n    };\n\n    const saveDataToDatabase = async (tableData, skipRender = false, commitDeletes = false) => {\n        if (isSaving) return false;\n        const { $ } = getCore();\n        const $saveBtn = $('#acu-btn-save-global');\n        let originalIcon = '';\n\n        const executeCoreSave = async () => {\n            isSaving = true;\n            \n            if (!tableData.mate) {\n                tableData.mate = { type: 'chatSheets', version: 1 };\n            }\n\n            const api = getCore().getDB();\n            if (!api?.importTableAsJson) console.warn(\"[ACU] API partial missing, attempting direct injection...\");\n            \n            if (commitDeletes && pendingDeletes.size > 0) {\n                 for (const sheetId in tableData) {\n                      const sheet = tableData[sheetId];\n                     if (!sheet || !sheet.name || !sheet.content) continue;\n                     const newContent = [sheet.content[0]];\n                     for (let i = 1; i < sheet.content.length; i++) {\n                         const realIdx = i - 1;\n                         if (!pendingDeletes.has(`${sheet.name}-row-${realIdx}`)) {\n                             newContent.push(sheet.content[i]);\n                          }\n                     }\n                     sheet.content = newContent;\n                 }\n            }\n\n            let injectedDirectly = false;\n            try {\n                let ST = window.SillyTavern || (window.parent ? window.parent.SillyTavern : null);\n                if (!ST && window.top && window.top.SillyTavern) ST = window.top.SillyTavern;\n                \n                let isolationKey = '';\n                const STORAGE_KEY_V5_SETTINGS = 'shujuku_v34_allSettings_v2';\n                try {\n                    let storage = window.localStorage;\n                    if (!storage.getItem(STORAGE_KEY_V5_SETTINGS) && window.parent) {\n                        try { storage = window.parent.localStorage; } catch(e){}\n                    }\n                    const settingsStr = storage.getItem(STORAGE_KEY_V5_SETTINGS);\n                    if (settingsStr) {\n                        const settings = JSON.parse(settingsStr);\n                        if (settings.dataIsolationEnabled && settings.dataIsolationCode) {\n                            isolationKey = settings.dataIsolationCode;\n                            console.log('[ACU-Fix] 检测到数据隔离 Key:', isolationKey);\n                        }\n                    }\n                } catch (e) { console.warn('[ACU-Fix] 读取设置失败:', e); }\n\n                if (ST && ST.chat && ST.chat.length > 0) {\n                    let targetMsg = null;\n                    for (let i = ST.chat.length - 1; i >= 0; i--) {\n                        if (!ST.chat[i].is_user) {\n                            targetMsg = ST.chat[i];\n                            break;\n                        }\n                    }\n                    \n                    if (targetMsg) {\n                        if (!targetMsg.TavernDB_ACU_IsolatedData) targetMsg.TavernDB_ACU_IsolatedData = {};\n                        if (!targetMsg.TavernDB_ACU_IsolatedData[isolationKey]) {\n                            targetMsg.TavernDB_ACU_IsolatedData[isolationKey] = {\n                                independentData: {},\n                                modifiedKeys: [],\n                                updateGroupKeys: []\n                            };\n                        }\n                        \n                        const tagData = targetMsg.TavernDB_ACU_IsolatedData[isolationKey];\n                        if (!tagData.independentData) tagData.independentData = {};\n                        \n                        const sheetsToSave = Object.keys(tableData).filter(k => k.startsWith('sheet_'));\n                        sheetsToSave.forEach(k => {\n                            tagData.independentData[k] = JSON.parse(JSON.stringify(tableData[k]));\n                        });\n                        \n                        const existingKeys = tagData.modifiedKeys || [];\n                        tagData.modifiedKeys = [...new Set([...existingKeys, ...sheetsToSave])];\n                        \n                        if (ST.saveChat) {\n                            await ST.saveChat();\n                            console.log('[ACU-Fix] 已通过 ST.saveChat 强制保存');\n                            injectedDirectly = true;\n                        }\n                    }\n                }\n            } catch (directErr) {\n                console.error('[ACU-Fix] 直接注入过程异常:', directErr);\n            }\n\n            let apiSuccess = false;\n            if (api && api.importTableAsJson) {\n                apiSuccess = await api.importTableAsJson(JSON.stringify(tableData));\n            }\n\n            return apiSuccess || injectedDirectly;\n        };\n\n        try {\n            if (!skipRender) {\n                originalIcon = $saveBtn.html();\n                $saveBtn.html('<i class=\"fa-solid fa-spinner fa-spin\"></i>').prop('disabled', true);\n            }\n            \n            await UpdateController.runSilently(executeCoreSave);\n            \n            if (!skipRender) {\n                if (window.toastr) window.toastr.success('保存成功！');\n                $('.acu-highlight-changed').removeClass('acu-highlight-changed');\n                currentDiffMap.clear();\n                if (commitDeletes) { pendingDeletes.clear(); updateSaveBtnState(); }\n                saveSnapshot(tableData);\n                renderInterface();\n            }\n            return true;\n        } catch (e) {\n            console.error(\"Save failed:\", e);\n            if (!skipRender && window.toastr) window.toastr.error('保存失败');\n            return false;\n        } finally {\n            isSaving = false;\n            if (!skipRender && $saveBtn.length) {\n                $saveBtn.html(originalIcon || '<i class=\"fa-solid fa-save\"></i>').prop('disabled', false);\n            }\n        }\n    };\n\n    const processJsonData = (json) => {\n        const tables = {};\n        if (!json || typeof json !== 'object') return {};\n        for (const sheetId in json) {\n            if (json[sheetId]?.name) {\n                 const sheet = json[sheetId];\n                tables[sheet.name] = { key: sheetId, headers: sheet.content[0] || [], rows: sheet.content.slice(1) };\n            }\n        }\n        return Object.keys(tables).length > 0 ? tables : null;\n    };\n    \n    const showSettingsModal = () => {\n        const { $ } = getCore();\n        $('.acu-edit-overlay').remove();\n        const config = getConfig();\n        const rawData = getTableData();\n        const allTableNames = rawData ? Object.keys(processJsonData(rawData)) : [];\n        const reversedTables = getReverseOrderTables();\n        const hiddenTables = getHiddenTables();\n        \n        const modalStyles = `\n        <style>\n            .acu-edit-overlay { \n                position: fixed !important; top: 0; left: 0; right: 0; bottom: 0; \n                background: rgba(0, 0, 0, 0.5) !important; \n                backdrop-filter: blur(3px); \n                z-index: 2147483647 !important; \n                display: flex !important; \n                align-items: center; justify-content: center;\n                opacity: 0; animation: acuFadeIn 0.2s forwards;\n            }\n            .acu-edit-dialog { \n                background-color: var(--acu-bg-panel) !important; \n                color: var(--acu-text-main) !important; \n                border: 1px solid var(--acu-border) !important; \n                display: flex; flex-direction: column;\n                box-shadow: 0 10px 50px rgba(0,0,0,0.3) !important;\n                transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);\n                overflow: hidden;\n            }\n            @media (min-width: 769px) {\n                .acu-edit-dialog { \n                    width: 60% !important; max-width: 800px !important; min-width: 400px;\n                    height: 70vh !important; max-height: 800px;\n                    border-radius: 16px !important;\n                    margin: auto !important;\n                }\n            }\n            @media (max-width: 768px) {\n                .acu-edit-overlay {\n                    display: block !important;\n                    height: 100vh !important;\n                    height: 100dvh !important;\n                }\n                .acu-edit-dialog {\n                    position: absolute !important;\n                    bottom: 0 !important;\n                    left: 0 !important;\n                    margin: 0 !important;\n                    width: 100% !important;\n                    max-width: 100% !important;\n                    height: 70vh !important;\n                    border-radius: 20px 20px 0 0 !important;\n                    animation: acuSlideUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);\n                    transform-origin: bottom center;\n                }\n            }\n            @keyframes acuFadeIn { from { opacity: 0; } to { opacity: 1; } }\n            @keyframes acuSlideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }\n            .acu-control-row {\n                display: flex; justify-content: space-between; align-items: center;\n                padding: 18px 0;\n                border-bottom: 1px dashed var(--acu-border);\n            }\n            .acu-control-row:last-child { border-bottom: none; }\n            .acu-label-col { display: flex; flex-direction: column; gap: 4px; max-width: 60%; }\n            .acu-label-main { font-size: 14px; font-weight: bold; color: var(--acu-text-main); }\n            .acu-label-sub { font-size: 11px; color: var(--acu-text-sub); }\n            .acu-input-col { width: 40%; display: flex; justify-content: flex-end; align-items: center; }\n\t\t\t.acu-switch {\n\t\t\t\tposition: relative; display: inline-block; width: 44px; height: 24px;\n\t\t\t}\n\t\t\t.acu-switch input { opacity: 0; width: 0; height: 0; }\n            .acu-slider-switch {\n                position: absolute; cursor: pointer;\n                top: 0; left: 0; right: 0; bottom: 0;\n                background-color: #e0e0e0;\n                transition: .4s; border-radius: 34px;\n                border: 1px solid rgba(0,0,0,0.15);\n                box-sizing: border-box;\n            }\n            .acu-slider-switch:before {\n                position: absolute; content: \"\";\n                height: 18px; width: 18px; left: 2px; bottom: 2px;\n                background-color: white; transition: .4s; border-radius: 50%;\n                box-shadow: 0 2px 4px rgba(0,0,0,0.2);\n            }\n\t\t\tinput:checked + .acu-slider-switch { background-color: var(--acu-btn-active-bg); border: 1px solid var(--acu-border); }\n\t\t\tinput:checked + .acu-slider-switch:before { transform: translateX(20px); }\n            .acu-sub-setting {\n                background: rgba(0,0,0,0.02);\n                padding-left: 20px !important;\n                display: none;\n            }\n            .acu-color-row {\n                display: flex; gap: 8px; justify-content: flex-end; flex-wrap: nowrap;\n            }\n            .acu-color-circle {\n                width: 22px; height: 22px; border-radius: 50%; cursor: pointer;\n                border: 2px solid transparent; transition: transform 0.2s;\n                position: relative;\n                flex-shrink: 0;\n            }\n            .acu-color-circle:hover { transform: scale(1.1); }\n            .acu-color-circle.selected {\n                border-color: var(--acu-text-main);\n                box-shadow: 0 2px 6px rgba(0,0,0,0.2);\n                transform: scale(1.15);\n            }\n            .acu-color-circle.selected::after {\n                content: ''; position: absolute; top: 50%; left: 50%;\n                width: 6px; height: 6px; background: var(--acu-text-main);\n                border-radius: 50%; transform: translate(-50%, -50%);\n                opacity: 0.7;\n            }\n            .acu-nice-select {\n                appearance: none; border: 1px solid var(--acu-border); background: var(--acu-btn-bg);\n                color: var(--acu-text-main); padding: 6px 24px 6px 10px; border-radius: 8px;\n                font-size: 13px; text-align: center; font-weight: bold; outline: none;\n                background-image: url(\"data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23999%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E\");\n                background-repeat: no-repeat; background-position: right 8px center; background-size: 10px;\n                min-width: 100px;\n            }\n            .acu-nice-slider { width: 100%; height: 6px; background: var(--acu-border); border-radius: 3px; outline: none; appearance: none; }\n            .acu-nice-slider::-webkit-slider-thumb { appearance: none; width: 20px; height: 20px; background: #fff; border: 2px solid var(--acu-highlight); border-radius: 50%; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }\n            .acu-settings-group { background: var(--acu-table-head); border-radius: 12px; padding: 0 15px; margin-bottom: 20px; border: 1px solid rgba(0,0,0,0.05); }\n            .acu-edit-header { padding: 15px 20px; border-bottom: 1px solid var(--acu-border); display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.02); }\n            .acu-close-pill {\n                background-color: var(--acu-text-main) !important;\n                color: var(--acu-bg-panel) !important;\n                border: none !important;\n                padding: 6px 20px;\n                border-radius: 20px;\n                font-weight: bold; font-size: 13px;\n                cursor: pointer;\n                box-shadow: 0 4px 10px var(--acu-highlight-bg);\n                transition: transform 0.2s, filter 0.2s;\n                display: inline-flex; align-items: center; justify-content: center;\n            }\n            .acu-close-pill:hover {\n                filter: brightness(0.85);\n                transform: scale(1.05);\n            }\n            .acu-btn-block {\n                width: 100%;\n                display: flex;\n                justify-content: center;\n                align-items: center;\n                background: var(--acu-btn-bg);\n                color: var(--acu-text-main);\n                border: 1px solid var(--acu-border);\n                border-radius: 8px;\n                cursor: pointer;\n                transition: background 0.2s;\n                text-align: center;\n            }\n            .acu-btn-block:hover {\n                background: var(--acu-btn-hover);\n            }\n            .acu-bottom-spacer {\n                height: 120px;\n                padding-bottom: 30px;\n                width: 100%; text-align: center;\n                color: var(--acu-text-sub); font-size: 10px;\n                display: flex; align-items: center; justify-content: center;\n                opacity: 0.5; flex-shrink: 0;\n            }\n\n            .acu-edit-overlay.acu-transparent-mode { background: transparent !important; backdrop-filter: none !important; }\n            .acu-edit-overlay.acu-transparent-mode .acu-edit-dialog { background: transparent !important; box-shadow: none !important; border: none !important; }\n            .acu-edit-overlay.acu-transparent-mode .acu-edit-dialog > *:not(.acu-settings-content) { opacity: 0; pointer-events: none; }\n            .acu-edit-overlay.acu-transparent-mode .acu-settings-group { background: transparent !important; border: none !important; }\n            .acu-edit-overlay.acu-transparent-mode .acu-control-row { opacity: 0; pointer-events: none; }\n            .acu-edit-overlay.acu-transparent-mode .acu-settings-content > div:not(.acu-settings-group) { opacity: 0; pointer-events: none; }\n            .acu-edit-overlay.acu-transparent-mode .acu-control-row.acu-active-control { opacity: 1; pointer-events: auto; background: var(--acu-bg-panel); border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); border: 1px solid var(--acu-border); }\n        </style>\n        `;\n\n        const dialog = $(`\n            <div class=\"acu-edit-overlay\">\n                ${modalStyles}\n                <div class=\"acu-edit-dialog acu-theme-${config.theme}\">\n                     <div class=\"acu-edit-header\">\n                        <span style=\"font-size:16px; font-weight:bold;\">设置选项</span>\n                        <button id=\"dlg-close\" class=\"acu-close-pill\">完成</button>\n                     </div>\n                    <div class=\"acu-settings-content\" style=\"flex: 1; overflow-y: auto; padding: 20px;\">\n                        \n                        <div style=\"font-size:12px; font-weight:bold; color:var(--acu-highlight); margin:0 0 8px 10px;\">外观与显示</div>\n                        <div class=\"acu-settings-group\">\n                            <div class=\"acu-control-row\">\n                                <div class=\"acu-label-col\"><span class=\"acu-label-main\">背景主题</span></div>\n                                <div class=\"acu-input-col\">\n                                    <select id=\"cfg-theme\" class=\"acu-nice-select\">\n                                        ${THEMES.map(t => `<option value=\"${t.id}\" ${t.id === config.theme ? 'selected' : ''}>${t.name}</option>`).join('')}\n                                    </select>\n                                </div>\n                            </div>\n                            <div class=\"acu-control-row\">\n                                <div class=\"acu-label-col\"><span class=\"acu-label-main\">页面布局</span></div>\n                                <div class=\"acu-input-col\">\n                                    <select id=\"cfg-layout\" class=\"acu-nice-select\">\n                                       <option value=\"vertical\" ${config.layout === 'vertical' ? 'selected' : ''}>竖向布局</option>\n                                        <option value=\"horizontal\" ${config.layout === 'horizontal' ? 'selected' : ''}>横向布局</option>\n                                    </select>\n                                </div>\n                            </div>\n                            <div class=\"acu-control-row\">\n                                <div class=\"acu-label-col\"><span class=\"acu-label-main\">字体设置</span></div>\n                                <div class=\"acu-input-col\">\n                                    <select id=\"cfg-font-family\" class=\"acu-nice-select\">\n                                        ${FONTS.map(f => `<option value=\"${f.id}\" ${f.id === config.fontFamily ? 'selected' : ''}>${f.name}</option>`).join('')}\n                                    </select>\n                                </div>\n                            </div>\n                            <div class=\"acu-control-row\">\n                                <div class=\"acu-label-col\"><span class=\"acu-label-main\">底部按钮列数</span></div>\n                                 <div class=\"acu-input-col\">\n                                     <select id=\"cfg-grid-cols\" class=\"acu-nice-select\">\n                                        <option value=\"0\" ${!config.gridColumns ? 'selected' : ''}>自动 (默认)</option>\n                                        <option value=\"2\" ${config.gridColumns == 2 ? 'selected' : ''}>2 列</option>\n                                        <option value=\"3\" ${config.gridColumns == 3 ? 'selected' : ''}>3 列</option>\n                                        <option value=\"4\" ${config.gridColumns == 4 ? 'selected' : ''}>4 列</option>\n                                    </select>\n                                </div>\n                            </div>\n                        </div>\n\n                        <div style=\"font-size:12px; font-weight:bold; color:var(--acu-highlight); margin:0 0 8px 10px;\">功能开关</div>\n                        <div class=\"acu-settings-group\">\n                             <div class=\"acu-control-row\">\n                                <div class=\"acu-label-col\"><span class=\"acu-label-main\">行动选项</span></div>\n                                <div class=\"acu-input-col\">\n                                    <label class=\"acu-switch\">\n                                        <input type=\"checkbox\" id=\"cfg-show-option\" ${config.showOptionPanel !== false ? 'checked' : ''}>\n                                        <span class=\"acu-slider-switch\"></span>\n                                    </label>\n                                </div>\n                            </div>\n                            <div class=\"acu-control-row acu-sub-setting\" id=\"row-auto-send\" style=\"display:${config.showOptionPanel !== false ? 'flex' : 'none'}\">\n                                <div class=\"acu-label-col\"><span class=\"acu-label-main\" style=\"font-size:13px\">点击选项直接发送</span></div>\n                                <div class=\"acu-input-col\">\n                                    <label class=\"acu-switch\">\n                                        <input type=\"checkbox\" id=\"cfg-auto-send\" ${config.clickOptionToAutoSend ? 'checked' : ''}>\n                                        <span class=\"acu-slider-switch\"></span>\n                                    </label>\n                                </div>\n                            </div>\n                            <div class=\"acu-control-row\">\n                                <div class=\"acu-label-col\"><span class=\"acu-label-main\">仪表盘显示</span></div>\n                                <div class=\"acu-input-col\">\n                                    <label class=\"acu-switch\">\n                                        <input type=\"checkbox\" id=\"cfg-show-dash\" ${config.showDashboard !== false ? 'checked' : ''}>\n                                        <span class=\"acu-slider-switch\"></span>\n                                    </label>\n                                </div>\n                            </div>\n                           <div class=\"acu-control-row\">\n                                <div class=\"acu-label-col\"><span class=\"acu-label-main\">长文本高度限制</span></div>\n                                <div class=\"acu-input-col\">\n                                    <label class=\"acu-switch\">\n                                        <input type=\"checkbox\" id=\"cfg-limit-height\" ${config.limitLongText !== false ? 'checked' : ''}>\n                                        <span class=\"acu-slider-switch\"></span>\n                                    </label>\n                                </div>\n                            </div>\n                            <div class=\"acu-control-row\">\n                                <div class=\"acu-label-col\"><span class=\"acu-label-main\">新增内容高亮</span></div>\n                                <div class=\"acu-input-col\">\n                                    <label class=\"acu-switch\">\n                                        <input type=\"checkbox\" id=\"cfg-new\" ${config.highlightNew ? 'checked' : ''}>\n                                        <span class=\"acu-slider-switch\"></span>\n                                    </label>\n                                </div>\n                            </div>\n                             <div class=\"acu-control-row acu-sub-setting\" id=\"row-highlight-color\" style=\"display:${config.highlightNew ? 'flex' : 'none'}\">\n                                <div class=\"acu-label-col\"><span class=\"acu-label-main\" style=\"font-size:13px\">选择高亮色</span></div>\n                                  <div class=\"acu-input-col\">\n                                      <div class=\"acu-color-row\" id=\"cfg-color-opts\">\n                                        ${Object.keys(HIGHLIGHT_COLORS).map(k => `<div class=\"acu-color-circle ${config.highlightColor === k ? 'selected' : ''}\" data-val=\"${k}\" data-type=\"highlight\" title=\"${HIGHLIGHT_COLORS[k].name}\" style=\"background-color:${HIGHLIGHT_COLORS[k].main}\"></div>`).join('')}\n                                      </div>\n                                </div>\n                            </div>\n                            <div class=\"acu-control-row\">\n                                <div class=\"acu-label-col\"><span class=\"acu-label-main\">标题颜色自定义</span></div>\n                                <div class=\"acu-input-col\">\n                                    <label class=\"acu-switch\">\n                                        <input type=\"checkbox\" id=\"cfg-custom-title\" ${config.customTitleColor ? 'checked' : ''}>\n                                        <span class=\"acu-slider-switch\"></span>\n                                    </label>\n                                </div>\n                            </div>\n                            <div class=\"acu-control-row acu-sub-setting\" id=\"row-title-color\" style=\"display:${config.customTitleColor ? 'flex' : 'none'}\">\n                                <div class=\"acu-label-col\"><span class=\"acu-label-main\" style=\"font-size:13px\">选择标题色</span></div>\n                                  <div class=\"acu-input-col\">\n                                      <div class=\"acu-color-row\" id=\"cfg-title-color-opts\">\n                                        ${Object.keys(HIGHLIGHT_COLORS).map(k => `<div class=\"acu-color-circle ${config.titleColor === k ? 'selected' : ''}\" data-val=\"${k}\" data-type=\"title\" title=\"${HIGHLIGHT_COLORS[k].name}\" style=\"background-color:${HIGHLIGHT_COLORS[k].main}\"></div>`).join('')}\n                                      </div>\n                                </div>\n                            </div>\n                        </div>\n\n                        <div style=\"font-size:12px; font-weight:bold; color:var(--acu-highlight); margin:0 0 8px 10px;\">尺寸调节</div>\n                        <div class=\"acu-settings-group\">\n                            <div class=\"acu-control-row\">\n                                <div class=\"acu-label-col\" style=\"width:160px; flex-shrink:0;\"><span class=\"acu-label-main\">卡片宽度 <span style=\"color:var(--acu-highlight); margin-left:5px; font-weight:bold;\" id=\"val-width\">${config.cardWidth}</span></span></div>\n                                <div class=\"acu-input-col\" style=\"flex:1; padding-left:20px;\">\n                                    <input type=\"range\" id=\"cfg-width\" class=\"acu-nice-slider\" min=\"220\" max=\"500\" step=\"10\" value=\"${config.cardWidth}\" style=\"width:100%\">\n                                </div>\n                            </div>\n                            <div class=\"acu-control-row\">\n                                <div class=\"acu-label-col\" style=\"width:160px; flex-shrink:0;\"><span class=\"acu-label-main\">字体大小 <span style=\"color:var(--acu-highlight); margin-left:5px; font-weight:bold;\" id=\"val-font\">${config.fontSize}</span></span></div>\n                                <div class=\"acu-input-col\" style=\"flex:1; padding-left:20px;\">\n                                    <input type=\"range\" id=\"cfg-font\" class=\"acu-nice-slider\" min=\"12\" max=\"20\" step=\"1\" value=\"${config.fontSize}\" style=\"width:100%\">\n                                </div>\n                            </div>\n                            <div class=\"acu-control-row\">\n                                <div class=\"acu-label-col\" style=\"width:160px; flex-shrink:0;\"><span class=\"acu-label-main\">选项字体大小 <span style=\"color:var(--acu-highlight); margin-left:5px; font-weight:bold;\" id=\"val-opt-font\">${config.optionFontSize || 13}</span></span></div>\n                                <div class=\"acu-input-col\" style=\"flex:1; padding-left:20px;\">\n                                    <input type=\"range\" id=\"cfg-opt-font\" class=\"acu-nice-slider\" min=\"12\" max=\"20\" step=\"1\" value=\"${config.optionFontSize || 13}\" style=\"width:100%\">\n                                </div>\n                            </div>\n                            <div class=\"acu-control-row\">\n                                <div class=\"acu-label-col\" style=\"width:160px; flex-shrink:0;\"><span class=\"acu-label-main\">每页显示 <span style=\"color:var(--acu-highlight); margin-left:5px; font-weight:bold;\" id=\"val-per-page\">${config.itemsPerPage || 20}</span></span></div>\n                                <div class=\"acu-input-col\" style=\"flex:1; padding-left:20px;\">\n                                    <input type=\"range\" id=\"cfg-per-page\" class=\"acu-nice-slider\" min=\"5\" max=\"100\" step=\"5\" value=\"${config.itemsPerPage || 20}\" style=\"width:100%\">\n                                </div>\n                            </div>\n                        </div>\n\n                        <div style=\"font-size:12px; font-weight:bold; color:var(--acu-highlight); margin:0 0 8px 10px;\">表格显示偏好 <span style=\"font-weight:normal; color:var(--acu-text-sub); margin-left:8px; font-size:11px;\">点击 <i class=\"fa-solid fa-eye\"></i> 切换显示/隐藏，开启 <i class=\"fa-solid fa-toggle-on\" style=\"color:var(--acu-highlight)\"></i> 启用倒序 (新内容在前)</span></div>\n                        <div class=\"acu-settings-group\" id=\"list-reverse-tables\" style=\"padding: 0;\">\n                            <div style=\"max-height: 200px; overflow-y: auto;\">\n                                ${allTableNames.length > 0 ? allTableNames.filter(n => !n.includes('选项')).map(name => `\n                                    <div class=\"acu-control-row\" style=\"padding: 10px 15px;\">\n                                        <div class=\"acu-label-col\" style=\"max-width:70%; display:flex; flex-direction:row; align-items:center; gap:8px;\">\n                                            <i class=\"fa-solid ${hiddenTables.includes(name) ? 'fa-eye-slash' : 'fa-eye'} acu-visibility-toggle\" data-table=\"${name}\" style=\"cursor:pointer; color:var(--acu-text-sub); width:20px; text-align:center; outline:none; -webkit-tap-highlight-color:transparent;\"></i>\n                                            <span class=\"acu-label-main\" style=\"font-weight:normal;\">${name}</span>\n                                        </div>\n                                        <div class=\"acu-input-col\">\n                                            <label class=\"acu-switch\">\n                                                <input type=\"checkbox\" class=\"acu-reverse-check\" value=\"${name}\" ${reversedTables.includes(name) ? 'checked' : ''}>\n                                                <span class=\"acu-slider-switch\"></span>\n                                            </label>\n                                        </div>\n                                    </div>\n                                `).join('') : '<div style=\"padding:20px; text-align:center; color:var(--acu-text-sub)\">暂无表格数据</div>'}\n                            </div>\n                        </div>\n\n                        <div style=\"display:flex; gap:10px; margin: 10px 0;\">\n                            <button class=\"acu-btn-block\" id=\"btn-enter-sort\" style=\"margin:0; flex:1; justify-content:center; font-weight:bold; padding:12px;\">进入表格排序模式</button>\n                        </div>\n                        <div class=\"acu-bottom-spacer\"></div>\n                    </div>\n                </div>\n            </div>\n        `);\n        $('body').append(dialog);\n        dialog.find('#cfg-theme').on('change', function() { \n              const newTheme = $(this).val();\n            const allThemes = THEMES.map(t => 'acu-theme-' + t.id).join(' ');\n            dialog.find('.acu-edit-dialog').removeClass(allThemes).addClass('acu-theme-' + newTheme);\n            saveConfig({ theme: newTheme });\n        });\n        dialog.find('#cfg-layout').on('change', function() { saveConfig({ layout: $(this).val() }); renderInterface(); });\n        dialog.find('#cfg-font-family').on('change', function() { saveConfig({ fontFamily: $(this).val() }); });\n        dialog.find('.acu-color-circle').on('click', function() {\n            const type = $(this).data('type');\n            $(this).siblings().removeClass('selected'); $(this).addClass('selected');\n            if (type === 'highlight') {\n                 saveConfig({ highlightColor: $(this).data('val') });\n            } else if (type === 'title') {\n                 saveConfig({ titleColor: $(this).data('val') });\n            }\n        });\n        \n        const setupSlider = (id) => {\n            const $el = dialog.find(id);\n            let autoOpened = false;\n            let transparencyTimer = null;\n            const end = (e) => {\n                if (transparencyTimer) { clearTimeout(transparencyTimer); transparencyTimer = null; }\n                dialog.removeClass('acu-transparent-mode');\n                $el.closest('.acu-control-row').removeClass('acu-active-control');\n                if (e && e.type !== 'change') {\n                     const nativeEvent = e.originalEvent || e;\n                     if (e.target && e.target.releasePointerCapture && nativeEvent.pointerId) {\n                         try { e.target.releasePointerCapture(nativeEvent.pointerId); } catch(err){}\n                     }\n                }\n                $el.off('pointerup pointercancel', end);\n                if (autoOpened) { closePanel(); autoOpened = false; }\n            };\n            $el.on('pointerdown', function(e) {\n                const nativeEvent = e.originalEvent || e;\n                if (this.setPointerCapture && nativeEvent.pointerId) {\n                     this.setPointerCapture(nativeEvent.pointerId);\n                }\n                if (!$('#acu-data-area').hasClass('visible')) {\n                    const $last = $('.acu-nav-btn[data-table]').not('[data-table=\\\"acu_tab_dashboard_home\\\"]').last();\n                    if($last.length) { $last.click(); autoOpened = true; }\n                } else { autoOpened = false; }\n                $(this).closest('.acu-control-row').addClass('acu-active-control');\n                transparencyTimer = setTimeout(() => { dialog.addClass('acu-transparent-mode'); }, 150);\n                $el.on('pointerup pointercancel', end);\n            });\n            $el.on('change', end);\n        };\n        \n        const setupOptionSlider = (id) => {\n            const $el = dialog.find(id);\n            let restoredTab = null;\n            let transparencyTimer = null;\n            const end = (e) => {\n                if (transparencyTimer) { clearTimeout(transparencyTimer); transparencyTimer = null; }\n                dialog.removeClass('acu-transparent-mode');\n                $el.closest('.acu-control-row').removeClass('acu-active-control');\n                if (e && e.type !== 'change') {\n                     const nativeEvent = e.originalEvent || e;\n                     if (e.target && e.target.releasePointerCapture && nativeEvent.pointerId) {\n                         try { e.target.releasePointerCapture(nativeEvent.pointerId); } catch(err){}\n                     }\n                }\n                $el.off('pointerup pointercancel', end);\n                if (restoredTab) { $(`.acu-nav-btn[data-table=\\\"${restoredTab}\\\"]`).click(); restoredTab = null; }\n            };\n            $el.on('pointerdown', function(e) {\n                const nativeEvent = e.originalEvent || e;\n                if (this.setPointerCapture && nativeEvent.pointerId) {\n                     this.setPointerCapture(nativeEvent.pointerId);\n                }\n                if ($('#acu-data-area').hasClass('visible')) {\n                    const $act = $('.acu-nav-btn.active');\n                    if($act.length) { restoredTab = $act.data('table'); closePanel(); }\n                }\n                $(this).closest('.acu-control-row').addClass('acu-active-control');\n                transparencyTimer = setTimeout(() => { dialog.addClass('acu-transparent-mode'); }, 150);\n                $el.on('pointerup pointercancel', end);\n            });\n            $el.on('change', end);\n        };\n\n        setupSlider('#cfg-width');\n        setupSlider('#cfg-font');\n        setupOptionSlider('#cfg-opt-font');\n\n        dialog.find('#cfg-width').on('input', function() { const val = $(this).val(); dialog.find('#val-width').text(val); saveConfig({ cardWidth: val }); });\n        dialog.find('#cfg-font').on('input', function() { const val = $(this).val(); dialog.find('#val-font').text(val); saveConfig({ fontSize: val }); });\n        dialog.find('#cfg-opt-font').on('input', function() { const val = $(this).val(); dialog.find('#val-opt-font').text(val); saveConfig({ optionFontSize: val }); });\n        dialog.find('#cfg-per-page').on('input', function() { const val = $(this).val(); dialog.find('#val-per-page').text(val); saveConfig({ itemsPerPage: parseInt(val) }); renderInterface(); });\n        dialog.find('#cfg-show-dash').on('change', function() { saveConfig({ showDashboard: $(this).is(':checked') }); renderInterface(); });\n        dialog.find('#cfg-show-option').on('change', function() { \n            const checked = $(this).is(':checked');\n            saveConfig({ showOptionPanel: checked }); \n            if(checked) dialog.find('#row-auto-send').slideDown(200).css('display', 'flex'); \n            else dialog.find('#row-auto-send').slideUp(200);\n            renderInterface(); \n        });\n        dialog.find('#cfg-auto-send').on('change', function() { saveConfig({ clickOptionToAutoSend: $(this).is(':checked') }); });\n        dialog.find('#cfg-new').on('change', function() { \n            const checked = $(this).is(':checked');\n            saveConfig({ highlightNew: checked }); \n            if(checked) dialog.find('#row-highlight-color').slideDown(200).css('display', 'flex'); else dialog.find('#row-highlight-color').slideUp(200);\n            renderInterface(); \n        });\n        dialog.find('#cfg-grid-cols').on('change', function () { saveConfig({ gridColumns: parseInt($(this).val()) }); renderInterface(); });\n        dialog.find('#cfg-limit-height').on('change', function() { saveConfig({ limitLongText: $(this).is(':checked') }); renderInterface(); });\n        dialog.find('#cfg-custom-title').on('change', function() { \n            const checked = $(this).is(':checked');\n            saveConfig({ customTitleColor: checked }); \n            if(checked) dialog.find('#row-title-color').slideDown(200).css('display', 'flex'); else dialog.find('#row-title-color').slideUp(200);\n        });\n        dialog.find('.acu-reverse-check').on('change', function() {\n            const tName = $(this).val();\n            const checked = $(this).is(':checked');\n            let currentList = getReverseOrderTables();\n            if (checked) { if (!currentList.includes(tName)) currentList.push(tName); }\n            else { currentList = currentList.filter(n => n !== tName); }\n            saveReverseOrderTables(currentList);\n            const activeTab = getActiveTabState();\n            if (activeTab === tName) renderInterface();\n        });\n        dialog.find('.acu-visibility-toggle').on('click', function() {\n            const tName = $(this).data('table');\n            let currentList = getHiddenTables();\n            if (currentList.includes(tName)) {\n                currentList = currentList.filter(n => n !== tName);\n                $(this).removeClass('fa-eye-slash').addClass('fa-eye');\n            } else {\n                currentList.push(tName);\n                $(this).removeClass('fa-eye').addClass('fa-eye-slash');\n            }\n            saveHiddenTables(currentList);\n            renderInterface();\n        });\n        dialog.find('#btn-enter-sort').click(() => { dialog.remove(); toggleOrderEditMode(); });\n        dialog.find('#dlg-close').click(() => { dialog.remove(); renderInterface(); });\n        dialog.on('click', function(e) { if ($(e.target).hasClass('acu-edit-overlay')) dialog.remove(); });\n    };\n\n    const injectIndependentOptions = (htmlContent, themeClass, cssVars) => {\n        const { $ } = getCore();\n        $('.acu-embedded-options-container').remove();\n        \n        const getTargetContainer = () => {\n            const $allMes = $('#chat .mes');\n            const $aiMes = $allMes.filter(function() {\n                const $this = $(this);\n                if ($this.attr('is_user') === 'true' || $this.attr('is_system') === 'true' || $this.hasClass('sys_mes')) return false;\n                if ($this.find('.name_text').text().trim() === 'System') return false; \n                if ($this.css('display') === 'none') return false;\n                return true;\n            });\n            if ($aiMes.length === 0) return null;\n            \n            const $targetMes = $aiMes.last();\n            const $targetBlock = $targetMes.find('.mes_block');\n            return $targetBlock.length ? $targetBlock : $targetMes;\n        };\n\n        const $target = getTargetContainer();\n        if ($target && $target.length) {\n            const $container = $('<div class=\"acu-embedded-options-container\" style=\"margin-top: 6px; width: 100%; clear: both;\"></div>');\n            const $panel = $(`<div class=\"acu-option-panel ${themeClass}\" style=\"display: grid; ${cssVars}\">` + htmlContent + `</div>`);\n            $container.append($panel);\n            $target.append($container);\n        }\n    };\n\n    const renderInterface = () => {\n        const { $ } = getCore();\n        if (!$) return;\n        try {\n             const $lastPanel = $('.acu-panel-content');\n            if ($lastPanel.length) { globalScrollTop = $lastPanel.scrollTop(); }\n\n            const rawData = getTableData() || {};\n            const allTables = processJsonData(rawData);\n            const tables = {};\n            const optionTables = [];\n            \n            const config = getConfig();\n            \n            if(allTables) {\n                 Object.keys(allTables).forEach(k => {\n                     if (k.includes('选项')) {\n                         if (config.showOptionPanel !== false) {\n                             optionTables.push(allTables[k]);\n                         }\n                     } else {\n                         tables[k] = allTables[k];\n                     }\n                 });\n            }\n            \n            currentDiffMap = generateDiffMap(rawData);\n            const savedOrder = getSavedTableOrder();\n            let orderedNames = Object.keys(tables);\n            if (savedOrder) orderedNames = savedOrder.filter(n => tables[n]).concat(orderedNames.filter(n => !savedOrder.includes(n)));\n            \n            const hiddenTables = getHiddenTables();\n            const showDash = config.showDashboard !== false;\n            const activeTab = getActiveTabState();\n            let currentTabName = activeTab;\n\n            if (isEditingOrder) currentTabName = null;\n\n            if (currentTabName === TAB_DASHBOARD && !showDash) currentTabName = null;\n            if (currentTabName && currentTabName !== TAB_DASHBOARD && !tables[currentTabName]) currentTabName = null;\n\n            const colorVal = HIGHLIGHT_COLORS[config.highlightColor] || HIGHLIGHT_COLORS.orange;\n            const titleColorVal = config.customTitleColor ? (HIGHLIGHT_COLORS[config.titleColor] || HIGHLIGHT_COLORS.orange).main : 'var(--acu-text-main)';\n            const showPanel = !isCollapsed && currentTabName !== null;\n            const tableHeights = getTableHeights();\n            let styleHeight = 'height:auto; max-height:500px;';\n            \n            if (currentTabName === TAB_DASHBOARD) {\n                const h = tableHeights[TAB_DASHBOARD];\n                styleHeight = h ? `height:${h}px; max-height:95vh;` : `height:60vh; max-height:95vh;`;\n            } else if (currentTabName && tables[currentTabName]) {\n                const h = tableHeights[currentTabName];\n                styleHeight = h ? `height:${h}px; max-height:95vh;` : `height:60vh; max-height:95vh;`;\n            }\n\n            const gridCols = config.gridColumns > 0 ? `repeat(${config.gridColumns}, 1fr)` : 'repeat(auto-fill, minmax(110px, 1fr))';\n            \n            const isAlreadyVisible = $('#acu-data-area').hasClass('visible');\n\n            const actionBtns = {\n                'acu-btn-save-global': `<button class=\"acu-action-btn\" id=\"acu-btn-save-global\" title=\"保存所有修改\"><i class=\"fa-solid fa-save\"></i></button>`,\n                'acu-btn-open-native': `<button class=\"acu-action-btn\" id=\"acu-btn-open-native\" title=\"打开原生编辑器\"><i class=\"fa-solid fa-external-link-alt\"></i></button>`,\n                'acu-btn-manual-update': `<button class=\"acu-action-btn\" id=\"acu-btn-manual-update\" title=\"立即手动更新\"><i class=\"fa-solid fa-bolt\"></i></button>`,\n                'acu-btn-settings': `<button class=\"acu-action-btn\" id=\"acu-btn-settings\" title=\"全能设置\"><i class=\"fa-solid fa-cog\"></i></button>`,\n                'acu-btn-toggle': `<button class=\"acu-action-btn\" id=\"acu-btn-toggle\" title=\"${isCollapsed ? '展开' : '收起'}\"><i class=\"fa-solid ${isCollapsed ? 'fa-chevron-up' : 'fa-chevron-down'}\"></i></button>`\n            };\n            \n            const savedActionOrder = getSavedActionOrder() || Object.keys(actionBtns);\n            let finalActionOrder = savedActionOrder.filter(k => actionBtns[k]);\n            Object.keys(actionBtns).forEach(k => { if (!finalActionOrder.includes(k)) finalActionOrder.push(k); });\n            \n            let navActionsHtml = '';\n            finalActionOrder.forEach(k => { navActionsHtml += actionBtns[k]; });\n\n            const orderControlsHtml = isEditingOrder \n                ? `<div class=\"acu-order-controls visible\" id=\"acu-order-hint\" style=\"display:flex;justify-content:space-between;align-items:center\"><span><i class=\"fa-solid fa-arrows-alt\"></i> 拖动调整顺序</span><div><button id=\"acu-btn-cancel-mode\" style=\"margin-right:5px;cursor:pointer;background:rgba(255,255,255,0.2);border:none;padding:3px 8px;border-radius:4px;color:inherit\">取消</button><button id=\"acu-btn-save-mode\" style=\"cursor:pointer;background:var(--acu-highlight);border:none;padding:3px 8px;border-radius:4px;color:#fff;font-weight:bold\">保存</button></div></div>`\n                : `<div class=\"acu-order-controls\" id=\"acu-order-hint\"></div>`;\n\n            let contentHtml = '';\n            if (currentTabName === TAB_DASHBOARD && showDash) {\n                try {\n                    contentHtml = renderDashboard(tables);\n                } catch (e) {\n                     console.error(\"Dashboard Render Error:\", e);\n                    contentHtml = `<div style=\"padding:20px\">仪表盘加载错误: ${e.message}</div>`;\n                }\n            } else if (currentTabName && tables[currentTabName]) {\n                contentHtml = renderTableContent(tables[currentTabName], currentTabName);\n              }\n\n            const currentOptionStr = JSON.stringify(optionTables);\n            if (currentOptionStr !== lastOptionDataCheck) {\n                hideOptionsUntilUpdate = false;\n                lastOptionDataCheck = currentOptionStr;\n            }\n\n            let optionBtnContent = '';\n            if (optionTables.length > 0 && !hideOptionsUntilUpdate) {\n                let buttonsHtml = `<div class=\"acu-opt-header\">行动选项</div>`;\n                let hasBtns = false;\n                optionTables.forEach(table => {\n                    if(table.rows) {\n                         table.rows.forEach(row => {\n                              row.forEach((cell, idx) => {\n                                   if(idx > 0 && cell) {\n                                       buttonsHtml += `<button class=\"acu-opt-btn\" data-val=\"${encodeURIComponent(cell)}\">${cell}</button>`;\n                                       hasBtns = true;\n                                   }\n                              });\n                         });\n                    }\n                });\n                if (hasBtns) {\n                    optionBtnContent = buttonsHtml;\n                }\n            }\n\n            const cssVars = `--acu-card-width:${config.cardWidth}px; --acu-font-size:${config.fontSize}px; --acu-opt-font-size:${config.optionFontSize || 13}px; --acu-highlight:${colorVal.main}; --acu-highlight-bg:${colorVal.bg}; --acu-accent:${colorVal.main}; --acu-title-color:${titleColorVal}; --acu-nav-cols:${gridCols}; --acu-text-max-height:${config.limitLongText!==false?'80px':'none'}; --acu-text-overflow:${config.limitLongText!==false?'auto':'visible'}`;\n            \n            let html = `\n                <div class=\"acu-wrapper acu-theme-${config.theme}\" style=\"${cssVars}\">\n                    <div class=\"acu-data-display acu-layout-${config.layout} ${showPanel ? 'visible' : ''} ${isAlreadyVisible ? 'acu-no-anim' : ''}\" id=\"acu-data-area\" style=\"${styleHeight}\">\n                        ${contentHtml}\n                    </div>\n                    <div class=\"acu-nav-container ${isCollapsed ? 'collapsed' : ''} ${isEditingOrder ? 'editing-order' : ''}\" id=\"acu-nav-bar\">\n                        ${orderControlsHtml}\n                        <div class=\"acu-nav-tabs-area\">\n                            ${showDash ? `<button class=\"acu-nav-btn ${currentTabName === TAB_DASHBOARD ? 'active' : ''}\" data-table=\"${TAB_DASHBOARD}\"><i class=\"fa-solid fa-tachometer-alt\"></i><span>仪表盘</span></button>` : ''}\n            `;\n            orderedNames.forEach(name => {\n                if (hiddenTables.includes(name)) return;\n                const iconClass = getIconForTableName(name);\n                const isActive = currentTabName === name ? 'active' : '';\n                html += `<button class=\"acu-nav-btn ${isActive}\" data-table=\"${name}\"><i class=\"fa-solid ${iconClass}\"></i><span>${name}</span></button>`;\n              });\n            html += `   </div>\n                        <div class=\"acu-nav-separator\"></div>\n                        <div class=\"acu-nav-actions-area\">\n                            ${navActionsHtml}\n                        </div>\n                        <div class=\"acu-collapsed-text\">展开面板</div>\n                    </div>\n                </div>`;\n            insertHtmlToPage(html); \n\n            if (optionBtnContent) {\n                injectIndependentOptions(optionBtnContent, `acu-theme-${config.theme}`, cssVars);\n            } else {\n                $('.acu-embedded-options-container').remove();\n            }\n\n            bindEvents(tables);\n            if (globalScrollTop > 0) {\n                $('.acu-panel-content').scrollTop(globalScrollTop);\n            }\n            updateSaveBtnState();\n            if (isEditingOrder) initSortable();\n        } catch(e) { console.error(\"UI Render Error:\", e); }\n    };\n\n    const renderDashboard = (tables) => {\n        const charTableKey = Object.keys(tables).find(k => k.includes('主角') || k.includes('角色') || k.includes('属性'));\n        const charTable = charTableKey ? tables[charTableKey] : null;\n        \n        const globalTableKey = Object.keys(tables).find(k => k.includes('全局') || k.includes('通用') || k.includes('世界') || k.includes('设定'));\n        const globalTable = globalTableKey ? tables[globalTableKey] : null;\n\n        let relTable = null;\n        let relTableKey = '';\n        try {\n            relTableKey = Object.keys(tables).find(k => k.includes('重要人物'));\n              if (!relTableKey) {\n                relTableKey = Object.keys(tables).find(k => k.includes('关系') || k.includes('NPC') || k.includes('npc') || k.includes('好感'));\n            }\n            relTable = relTableKey ? tables[relTableKey] : null;\n        } catch(e) {}\n        \n        const taskTableKey = Object.keys(tables).find(k => k.includes('任务') || k.includes('日程') || k.includes('事项'));\n        const taskTable = taskTableKey ? tables[taskTableKey] : null;\n        const locTableKey = Object.keys(tables).find(k => k.includes('地点') || k.includes('位置') || k.includes('世界地图'));\n        const locTable = locTableKey ? tables[locTableKey] : null;\n        \n        const bagTableKey = Object.keys(tables).find(k => k.includes('背包') || k.includes('物品') || k.includes('库存') || k.includes('装备'));\n        const bagTable = bagTableKey ? tables[bagTableKey] : null;\n        \n        const skillTableKey = Object.keys(tables).find(k => k.includes('技能') || k.includes('武魂') || k.includes('功法') || k.includes('能力') || k.includes('招式'));\n        const skillTable = skillTableKey ? tables[skillTableKey] : null;\n\n        let html = `\n            <div class=\"acu-panel-header\">\n                <div class=\"acu-panel-title\"><i class=\"fa-solid fa-tachometer-alt\"></i> 主页 / 仪表盘</div>\n                <div class=\"acu-header-actions\">\n                    <div class=\"acu-height-control\">\n                         <i class=\"fa-solid fa-arrows-up-down acu-height-drag-handle\" data-table=\"${TAB_DASHBOARD}\" title=\"拖动调整高度 (双击顶部空白区域重置)\"></i>\n                    </div>\n                    <button class=\"acu-close-btn\" id=\"acu-btn-refresh\" title=\"刷新数据\" style=\"margin-right:5px\"><i class=\"fa-solid fa-sync-alt\"></i></button>\n                    <button class=\"acu-close-btn\" title=\"关闭\"><i class=\"fa-solid fa-times\"></i></button>\n                </div>\n            </div>\n            <div class=\"acu-panel-content\" style=\"overflow-y:auto\">\n                <div class=\"acu-dash-container\">\n                    <div class=\"acu-dash-col-left\" style=\"display:flex; flex-direction:column; gap:16px\">\n        `;\n\n        if (globalTable && globalTable.rows && globalTable.rows.length > 0) {\n              html += `<div class=\"acu-dash-card\">\n                        <div class=\"acu-dash-title\">当前位置信息</div>\n                        <div class=\"acu-dash-char-info\">`;\n            globalTable.rows.slice(0, 8).forEach(row => {\n                 if(row[1]) {\n                      html += `<div class=\"acu-dash-stat-row\" style=\"justify-content: flex-start; gap: 12px;\">\n                                <span class=\"acu-dash-stat-label\" style=\"min-width: 60px; text-align: left;\">${row[0]||'地点'}</span>\n                                <span class=\"acu-dash-stat-val\" style=\"text-align: left;\">${row[1]}</span>\n                              </div>`;\n                }\n            });\n              html += `   </div></div>`;\n        }\n\n        html += `       <div class=\"acu-dash-card\">\n                            <div class=\"acu-tab-header\">\n                                <div class=\"acu-tab-btn active\" data-target=\"dash-char\">主角状态</div>\n                                <div class=\"acu-tab-btn\" data-target=\"dash-bag\">背包物品</div>\n                                <div class=\"acu-tab-btn\" data-target=\"dash-skill\">技能列表</div>\n                            </div>\n                            <div class=\"acu-tab-content-container\">\n                                <div id=\"dash-char\" class=\"acu-tab-pane active\">\n                                    <div class=\"acu-dash-char-info\">\n           `;\n        \n        if (charTable && charTable.rows && charTable.rows.length > 0) {\n            const headers = charTable.headers || [];\n            const row = charTable.rows[0];\n            let charInfoHtml = '';\n            const targets = [{ keys: ['名'], label: '姓名' }, { keys: ['职', '身份'], label: '职业/身份' }, { keys: ['性', '龄'], label: '性别/年龄' }];\n            \n            const createRow = (label, val) => `<div class=\"acu-dash-stat-row\" style=\"justify-content: flex-start; gap: 12px;\"><span class=\"acu-dash-stat-label\" style=\"min-width: 60px; text-align: left;\">${label}</span><span class=\"acu-dash-stat-val\" style=\"text-align: left;\">${val}</span></div>`;\n\n            targets.forEach(t => {\n                const idx = headers.findIndex(h => t.keys.some(k => String(h || '').includes(k)));\n                if (idx > 0 && row[idx]) {\n                     charInfoHtml += createRow(t.label, row[idx]);\n                   }\n            });\n            if (!charInfoHtml) {\n                let count = 0;\n                row.forEach((cell, idx) => {\n                    if (idx > 0 && count < 3 && cell) { charInfoHtml += createRow(headers[idx] || '属性', cell); count++; }\n                });\n            }\n            html += charInfoHtml;\n        } else {\n             html += `<div style=\"text-align:center;color:var(--acu-text-sub);padding:20px\">未找到主角信息表</div>`;\n        }\n        \n        html += `               </div></div>\n                                <div id=\"dash-bag\" class=\"acu-tab-pane\">\n                                    <div class=\"acu-dash-npc-grid\">\n        `;\n\n         if (bagTable && bagTable.rows) {\n            bagTable.rows.slice(0, 20).forEach(row => {\n                if (row[1]) {\n                    const realIdx = bagTable.rows.indexOf(row);\n                    html += `<div class=\"acu-dash-npc-item acu-dash-interactive\" data-tname=\"${bagTableKey}\" data-row=\"${realIdx}\">${row[1]}</div>`;\n                }\n            });\n        } else { html += `<div style=\"text-align:center;color:var(--acu-text-sub);padding:20px\">未找到背包表</div>`; }\n        \n        html += `                   </div></div>\n                                <div id=\"dash-skill\" class=\"acu-tab-pane\">\n                                    <div class=\"acu-dash-npc-grid\">\n        `;\n        \n        if (skillTable && skillTable.rows) {\n             skillTable.rows.slice(0, 20).forEach(row => {\n                if (row[1]) {\n                    const realIdx = skillTable.rows.indexOf(row);\n                    html += `<div class=\"acu-dash-npc-item acu-dash-interactive\" data-tname=\"${skillTableKey}\" data-row=\"${realIdx}\"><i class=\"fa-solid fa-dragon\"></i> ${row[1]}</div>`;\n                }\n            });\n        } else { html += `<div style=\"text-align:center;color:var(--acu-text-sub);padding:20px\">未找到技能表</div>`; }\n\n        html += `           </div></div></div></div></div>\n                    <div class=\"acu-dash-col-right\" style=\"display:flex;flex-direction:column;gap:16px\">\n                         <div class=\"acu-dash-card\" style=\"flex:0 0 auto\">\n                            <div class=\"acu-dash-title\"><span>NPC</span></div>\n                            <div class=\"acu-dash-npc-grid\">\n        `;\n        \n          if (relTable && relTable.rows) {\n            let nameIdx = 1;\n            const headers = relTable.headers || [];\n            if (headers.map(h => String(h||'')).join('').includes('名')) {\n                nameIdx = headers.findIndex(h => String(h||'').includes('名'));\n                if (nameIdx < 0) nameIdx = 1;\n               }\n            relTable.rows.forEach((row, rIdx) => {\n                const name = row[nameIdx] || row[1] || 'Unknown';\n                const realIdx = relTable.rows.indexOf(row);\n                html += `<div class=\"acu-dash-npc-item acu-dash-interactive\" data-tname=\"${relTableKey}\" data-row=\"${realIdx}\">${name}</div>`;\n            });\n        } else { html += `<div style=\"grid-column:1/-1;text-align:center;color:var(--acu-text-sub)\">未找到“重要人物表”</div>`; }\n\n        html += `           </div></div>\n                        <div class=\"acu-dash-sub-grid\" style=\"flex:1\">\n                             <div class=\"acu-dash-card\"><div class=\"acu-dash-title\">任务列表</div><div style=\"display:flex;flex-direction:column;gap:5px\">\n        `;\n        if (taskTable && taskTable.rows) {\n            taskTable.rows.slice(0, 5).forEach((row, rIdx) => {\n                const realIdx = taskTable.rows.indexOf(row);\n                html += `<div class=\"acu-dash-list-item acu-dash-interactive\" data-tname=\"${taskTableKey}\" data-row=\"${realIdx}\"><i class=\"fa-solid fa-caret-right\"></i> ${row[1]||'任务'}</div>`;\n            });\n        }\n        else { html += `<div style=\"color:var(--acu-text-sub);font-size:12px\">未找到任务表</div>`; }\n        \n        html += `               </div></div>\n                             <div class=\"acu-dash-card\"><div class=\"acu-dash-title\">重要地点</div><div style=\"display:flex;flex-direction:column;gap:5px\">\n        `;\n        if (locTable && locTable.rows) {\n            locTable.rows.slice(0, 5).forEach((row, rIdx) => {\n                const realIdx = locTable.rows.indexOf(row);\n                html += `<div class=\"acu-dash-list-item acu-dash-interactive\" data-tname=\"${locTableKey}\" data-row=\"${realIdx}\"><i class=\"fa-solid fa-map-pin\"></i> ${row[1]||'地点'}</div>`;\n            });\n        }\n        else { html += `<div style=\"color:var(--acu-text-sub);font-size:12px\">未找到地点表</div>`; }\n\n        html += `               </div></div></div></div></div></div>`;\n        return html;\n    };\n\n    const insertHtmlToPage = (html) => {\n        const { $ } = getCore();\n        const $chat = $('#chat');\n        const $oldWrapper = $('.acu-wrapper');\n        \n        if ($oldWrapper.length) {\n            $oldWrapper.replaceWith(html);\n        } else {\n            if ($chat.length) { $chat.append(html); } else { $('body').append(html); }\n        }\n\n        if (observer) observer.disconnect();\n        observer = new MutationObserver((mutations) => {\n            const $chat = $('#chat');\n            if ($chat.length) {\n                const children = $chat.children();\n                const lastChild = children.last()[0];\n                const wrapper = $('.acu-wrapper')[0];\n                if (wrapper && lastChild && lastChild !== wrapper) {\n                    if ($(lastChild).hasClass('mes') || $(lastChild).hasClass('message-body')) {\n                        $chat.append(wrapper);\n                    }\n                }\n            }\n        });\n        if ($chat.length) { observer.observe($chat[0], { childList: true }); }\n    };\n\n    const renderTableContent = (tableData, tableName) => {\n        if (!tableData || !tableData.rows.length) return `<div class=\"acu-panel-header\"><div class=\"acu-panel-title\"><i class=\"fa-solid ${getIconForTableName(tableName)}\"></i> ${tableName}</div><button class=\"acu-close-btn\" title=\"关闭\"><i class=\"fa-solid fa-times\"></i></button></div><div class=\"acu-panel-content\"><div style=\"text-align:center;color:var(--acu-text-sub);padding:20px;\">暂无数据</div></div>`;\n        \n        const headers = tableData.headers.slice(1);\n        let titleColIndex = 1;const codeIdx = tableData.headers.findIndex(h => h && (String(h).includes('编码') || String(h).includes('索引')));if (codeIdx > 0) titleColIndex = codeIdx;\n        \n        const config = getConfig();\n        const itemsPerPage = config.itemsPerPage || 20;\n        \n        const savedStyles = getTableStyles();\n        const currentStyle = savedStyles[tableName] || 'list';\n        const isListMode = currentStyle === 'list';\n\n        const checkRowChanged = (realIdx, row) => {\n            if (currentDiffMap.has(`${tableName}-row-${realIdx}`)) return true;\n            if (pendingDeletes.has(`${tableName}-row-${realIdx}`)) return true;\n            for (let c = 1; c < row.length; c++) {\n                if (currentDiffMap.has(`${tableName}-${realIdx}-${c}`)) return true;\n            }\n            return false;\n        };\n\n        let processedRows = tableData.rows.map((row, index) => ({\n            data: row,\n            originalIndex: index,\n            hasChange: checkRowChanged(index, row)\n        }));\n\n        if (currentSearchTerm) {\n               processedRows = processedRows.filter(item => item.data.some(cell => String(cell).toLowerCase().includes(currentSearchTerm)));\n        }\n\n        const reverseTables = getReverseOrderTables();\n        const isReversed = reverseTables.includes(tableName);\n        const isSortModified = true;\n        \n        processedRows.sort((a, b) => {\n            if (isSortModified) {\n                if (a.hasChange && !b.hasChange) return -1;\n                if (!a.hasChange && b.hasChange) return 1;\n            }\n            if (isReversed) {\n                return b.originalIndex - a.originalIndex;\n            } else {\n                return a.originalIndex - b.originalIndex;\n            }\n        });\n\n        const displayTotal = processedRows.length;\n        const totalPages = Math.ceil(displayTotal / itemsPerPage) || 1;\n        const displayPages = Math.ceil(displayTotal / itemsPerPage) || 1;\n        \n        if (currentPage > totalPages) currentPage = 1;\n        if (currentPage < 1) currentPage = 1;\n        \n        const startIdx = (currentPage - 1) * itemsPerPage;\n        const endIdx = startIdx + itemsPerPage;\n        const slicedRows = processedRows.slice(startIdx, endIdx);\n\n        let html = `\n            <div class=\"acu-panel-header\">\n                  <div class=\"acu-panel-title\">\n                    <i class=\"fa-solid ${getIconForTableName(tableName)}\"></i> \n                    ${tableName} \n                    <span style=\"font-size:12px;color:var(--acu-text-sub);font-weight:normal;margin-left:5px\">\n                        (${displayTotal}项)\n                    </span>\n                </div>\n                <div class=\"acu-header-actions\">\n                  <button class=\"acu-action-btn\" id=\"acu-btn-switch-style\" data-table=\"${tableName}\" title=\"切换视图 (当前: ${isListMode?'单列':'双列'})\" style=\"width:28px;height:28px;margin-right:6px;font-size:14px;background:transparent;border:none;color:var(--acu-text-main);cursor:pointer;\">\n                        <i class=\"fa-solid ${isListMode ? 'fa-list' : 'fa-th-large'}\"></i>\n                    </button>\n                  <div class=\"acu-height-control\">\n                        <i class=\"fa-solid fa-arrows-up-down acu-height-drag-handle\" data-table=\"${tableName}\" title=\"拖动调整高度 (双击顶部空白区域重置)\"></i>\n                    </div>\n                     <div class=\"acu-search-wrapper\">\n                        <i class=\"fa-solid fa-search acu-search-icon\"></i>\n                        <input type=\"text\" class=\"acu-search-input\" placeholder=\"搜索...\" value=\"${currentSearchTerm}\" />\n                    </div>\n                   <button class=\"acu-close-btn\" id=\"acu-btn-refresh\" title=\"刷新数据\" style=\"margin-right:5px\"><i class=\"fa-solid fa-sync-alt\"></i></button>\n                   <button class=\"acu-close-btn\" title=\"关闭\"><i class=\"fa-solid fa-times\"></i></button>\n                </div>\n            </div>\n            <div class=\"acu-panel-content\">\n                <div class=\"acu-card-grid\">`;\n\n        slicedRows.forEach((item) => {\n            const row = item.data;\n            const realIndex = item.originalIndex;\n             const cardTitle = row[titleColIndex] || '未命名';\n            const showDefaultIndex = (titleColIndex === 1);\n            const isRowNew = currentDiffMap.has(`${tableName}-row-${realIndex}`);\n            const isPendingDelete = pendingDeletes.has(`${tableName}-row-${realIndex}`);\n            const rowClass = isRowNew && config.highlightNew ? 'acu-highlight-changed' : '';\n\n            html += `<div class=\"acu-data-card\">\n                        ${isPendingDelete ? '<div class=\"acu-badge-pending\">待删除</div>' : ''}\n                        <div class=\"acu-card-header\">\n                            <span class=\"acu-card-index\">${showDefaultIndex ? '#' + (realIndex + 1) : ''}</span>\n                            <span class=\"acu-cell acu-editable-title\" data-key=\"${tableData.key}\" data-tname=\"${tableName}\" data-row=\"${realIndex}\" data-col=\"${titleColIndex}\" data-val=\"${encodeURIComponent(cardTitle)}\" title=\"点击编辑标题\">${cardTitle}</span>\n                        </div>\n                        <div class=\"acu-card-body\">`;\n            let gridHtml = ''; let fullHtml = '';\n            row.forEach((cell, cIdx) => {\n                if (cIdx > 0 && cIdx !== titleColIndex) {\n                    const headerName = headers[cIdx - 1] || `属性${cIdx}`;\n                    const cellStr = String(cell);\n                    const displayCell = cellStr.trim();\n                    if (displayCell === 'auto_merged') return;\n                    const badgeStyle = getBadgeStyle(displayCell);\n                    const isCellChanged = currentDiffMap.has(`${tableName}-${realIndex}-${cIdx}`);\n                    const cellHighlight = isCellChanged && config.highlightNew ? 'acu-highlight-changed' : '';\n                    const dataAttrs = `data-key=\"${tableData.key}\" data-tname=\"${tableName}\" data-row=\"${realIndex}\" data-col=\"${cIdx}\" data-val=\"${encodeURIComponent(cell)}\"`;\n                    const contentHtml = badgeStyle ? `<span class=\"acu-badge ${badgeStyle}\">${displayCell}</span>` : displayCell;\n\n                    if (isListMode) {\n                         fullHtml += `<div class=\"acu-cell acu-inline-item\" ${dataAttrs}><div class=\"acu-inline-label\">${headerName}</div><div class=\"acu-inline-value ${cellHighlight}\">${contentHtml}</div></div>`;\n                    } else {\n                         if (codeIdx > 0) {\n                             fullHtml += `<div class=\"acu-cell acu-full-item\" ${dataAttrs}><div class=\"acu-full-label\">${headerName}</div><div class=\"acu-full-value ${cellHighlight}\">${displayCell}</div></div>`;\n                         } else {\n                            if (cellStr.length > 50) {\n                                fullHtml += `<div class=\"acu-cell acu-full-item\" ${dataAttrs}><div class=\"acu-full-label\">${headerName}</div><div class=\"acu-full-value ${cellHighlight}\">${displayCell}</div></div>`;\n                            }\n                            else {\n                                gridHtml += `<div class=\"acu-cell acu-grid-item\" ${dataAttrs}><div class=\"acu-grid-label\">${headerName}</div><div class=\"acu-grid-value ${cellHighlight}\">${contentHtml}</div></div>`;\n                            }\n                         }\n                    }\n                }\n            });\n            if (gridHtml) html += `<div class=\"acu-card-main-grid\">${gridHtml}</div>`;\n            if (fullHtml) html += `<div class=\"acu-card-full-area\">${fullHtml}</div>`;\n            html += `   </div></div>`;\n        });\n        html += `</div></div>`;\n        if (displayPages > 1) {\n             html += `<div class=\"acu-panel-footer\"><button class=\"acu-page-btn\" data-page=\"${currentPage - 1}\" ${currentPage===1?'disabled':''}><i class=\"fa-solid fa-angle-left\"></i></button>`;\n             const range = [];\n             if (displayPages <= 7) { for (let i = 1; i <= displayPages; i++) range.push(i); }\n             else { if (currentPage <= 4) range.push(1, 2, 3, 4, 5, '...', displayPages); else if (currentPage >= displayPages - 3) range.push(1, '...', displayPages - 4, displayPages - 3, displayPages - 2, displayPages - 1, displayPages); else range.push(1, '...', currentPage - 1, currentPage, currentPage + 1, '...', displayPages); }\n             range.forEach(p => { if (p === '...') html += `<span class=\"acu-page-info\">...</span>`; else html += `<button class=\"acu-page-btn ${p === currentPage ? 'active' : ''}\" data-page=\"${p}\">${p}</button>`; });\n             html += `<button class=\"acu-page-btn\" data-page=\"${currentPage + 1}\" ${currentPage===displayPages?'disabled':''}><i class=\"fa-solid fa-angle-right\"></i></button></div>`;\n        }\n        return html;\n    };\n\n    const closePanel = () => {\n        const { $ } = getCore();\n        if (!$) return;\n\n        const $chat = $('#chat');\n        const config = getConfig();\n        const currentScroll = $chat.length ? $chat.scrollTop() : 0;\n\n        $('#acu-data-area').removeClass('visible');\n        $('.acu-nav-btn').removeClass('active');\n        saveActiveTabState(null);\n        pendingDeletes.clear();\n        updateSaveBtnState();\n\n        if ($chat.length) {\n            setTimeout(() => {\n                 $chat.scrollTop(currentScroll);\n            }, 10);\n        }\n    };\n\n    const bindEvents = (tables) => {\n        const { $ } = getCore();\n        const stopSelectors = '.acu-data-display, .acu-nav-container, .acu-wrapper, .acu-edit-overlay, .acu-quick-view-overlay, .acu-cell-menu';\n        $('body').off('wheel touchstart touchmove touchend click', stopSelectors).on('wheel touchstart touchmove touchend click', stopSelectors, function(e) {\n            e.stopPropagation();\n        });\n        \n        $('body').off('click.acu_autoclose').on('click.acu_autoclose', function(e) {\n            if (isEditingOrder) return;\n            \n            if (!$('#acu-data-area').hasClass('visible')) return;\n\n            const $target = $(e.target);\n            \n            if ($target.closest('.acu-wrapper').length) return;\n\n            if ($target.closest('.acu-cell-menu').length) return;\n            if ($target.closest('.acu-edit-overlay').length) return;\n            if ($target.closest('.acu-popup-overlay').length) return;\n            if ($target.closest('.acu-quick-view-overlay').length) return;\n            \n            if ($target.closest('#send_textarea, #send_but, #send_form, .bottom_bar_container').length) return;\n            if ($target.is('input, textarea') || $target.prop('isContentEditable')) return;\n\n            closePanel();\n        });\n\n        const switchTab = (tableName) => {\n            currentPage = 1;\n            currentSearchTerm = '';\n            globalScrollTop = 0;\n            \n            if (tableName === TAB_DASHBOARD) {\n                $('#acu-data-area').html(renderDashboard(tables)).addClass('visible');\n                const h = getTableHeights()[TAB_DASHBOARD];\n                $('#acu-data-area').css({height: h ? h + 'px' : '60vh', maxHeight: '95vh'});\n                bindDataAreaEvents();\n            } else if (tables[tableName]) {\n                $('#acu-data-area').html(renderTableContent(tables[tableName], tableName)).addClass('visible');\n                const h = getTableHeights()[tableName];\n                $('#acu-data-area').css({height: h ? h + 'px' : '60vh', maxHeight: '95vh'});\n                bindDataAreaEvents();\n            }\n            $('.acu-nav-btn').removeClass('active');\n            $(`.acu-nav-btn[data-table=\"${tableName}\"]`).addClass('active');\n            saveActiveTabState(tableName);\n            bindDataAreaEvents();\n          };\n\n        $('.acu-nav-btn').off('click').on('click', function(e) {\n            e.stopPropagation(); \n            if (isEditingOrder) return;\n            const tableName = $(this).data('table');\n            if ($(this).hasClass('active')) { closePanel(); } else { switchTab(tableName); }\n        });\n        \n        const bindDynamicContentEvents = () => {\n            $('.acu-cell').off('click').on('click', function(e) { e.stopPropagation(); showCellMenu(e, this); });\n             $('.acu-dash-interactive').off('click').on('click', function(e) {\n                e.stopPropagation();\n                const tableName = $(this).data('tname');\n                const rowIdx = $(this).data('row');\n                if (tableName && tables[tableName]) {\n                     const table = tables[tableName];\n                     const row = table.rows[rowIdx];\n                     if (row) showQuickView(row, table.headers, tableName);\n                }\n            });\n            $('.acu-tab-btn').off('click').on('click', function(e) {\n                 e.stopPropagation();\n                 const target = $(this).data('target');\n                 $('.acu-tab-btn').removeClass('active');\n                 $(this).addClass('active');\n                 $('.acu-tab-pane').removeClass('active');\n                 $(`#${target}`).addClass('active');\n            });\n            $('.acu-page-btn').off('click').on('click', function(e) {\n                e.stopPropagation();\n                if ($(this).hasClass('disabled') || $(this).attr('disabled') || $(this).hasClass('active')) return;\n                const p = parseInt($(this).data('page'));\n                if (!p) return;\n                currentPage = p;\n                globalScrollTop = 0;\n                const tableName = $('.acu-nav-btn.active').data('table');\n                if (tableName && tables[tableName]) {\n                    $('#acu-data-area').html(renderTableContent(tables[tableName], tableName));\n                    bindDataAreaEvents();\n                }\n            });\n        };\n        \n        const bindDataAreaEvents = () => {\n            $('.acu-close-btn').off('click').on('click', function(e) { e.stopPropagation(); closePanel(); });\n            \n            $('.acu-search-input').off('input').on('input', function() {\n                currentSearchTerm = $(this).val().toLowerCase();\n                currentPage = 1;\n                globalScrollTop = 0;\n                 const tableName = $('.acu-nav-btn.active').data('table');\n                if (tableName && tables[tableName]) {\n                     const fullHtml = renderTableContent(tables[tableName], tableName);\n                     const $temp = $('<div>').html(fullHtml);\n                     \n                     $('.acu-panel-content').html($temp.find('.acu-panel-content').html());\n                     $('.acu-panel-title').html($temp.find('.acu-panel-title').html());\n                     \n                     bindDynamicContentEvents(); \n               }\n             });\n\n            $('.acu-height-drag-handle').off('pointerdown').on('pointerdown', function(e) {\n                if (e.button !== 0) return;\n                e.preventDefault(); e.stopPropagation();\n                const handle = this;\n                handle.setPointerCapture(e.pointerId);\n                $(handle).addClass('active');\n                const $panel = $('#acu-data-area');\n                const startHeight = $panel.height();\n                const startY = e.clientY;\n                const tableName = $(handle).data('table');\n                \n                handle.onpointermove = function(moveE) {\n                    const dy = moveE.clientY - startY;\n                    let newHeight = startHeight - dy;\n                    if (newHeight < 200) newHeight = 200;\n                    if (newHeight > 1500) newHeight = 1500;\n                    $panel.css('height', newHeight + 'px');\n                };\n                handle.onpointerup = function(upE) {\n                    $(handle).removeClass('active');\n                    handle.releasePointerCapture(upE.pointerId);\n                    handle.onpointermove = null;\n                    handle.onpointerup = null;\n                    if (tableName) {\n                         const h = parseInt($panel.css('height'));\n                         const heights = getTableHeights();\n                         heights[tableName] = h;\n                         saveTableHeights(heights);\n                    }\n                };\n            });\n            \n            $('.acu-panel-header').off('dblclick').on('dblclick', function(e) {\n                if ($(e.target).closest('button, input, .acu-height-drag-handle, .acu-search-wrapper').length) return;\n                e.preventDefault(); e.stopPropagation();\n                \n                const activeBtn = $('.acu-nav-btn.active');\n                const tableName = activeBtn.data('table');\n                \n                if (tableName) {\n                     const heights = getTableHeights();\n                     delete heights[tableName];\n                     saveTableHeights(heights);\n                     if (window.toastr) window.toastr.info('已重置为默认高度');\n                     \n                     if (tableName === TAB_DASHBOARD) {\n                         $('#acu-data-area').css({height: '60vh', maxHeight: '95vh'});\n                     } else {\n                         $('#acu-data-area').css({height: '60vh', maxHeight: '95vh'});\n                     }\n                }\n            });\n            \n            $('#acu-btn-switch-style').off('click').on('click', function(e) {\n                e.preventDefault(); e.stopPropagation();\n                const tableName = $(this).data('table');\n                const styles = getTableStyles();\n                const current = styles[tableName] || 'list';\n                styles[tableName] = current === 'grid' ? 'list' : 'grid';\n                saveTableStyles(styles);\n                \n                 if (tableName && tables[tableName]) {\n                     const fullHtml = renderTableContent(tables[tableName], tableName);\n                     const $temp = $('<div>').html(fullHtml);\n                     $('.acu-panel-content').html($temp.find('.acu-panel-content').html());\n                     $('.acu-panel-header').replaceWith($temp.find('.acu-panel-header'));\n                     bindDataAreaEvents(); \n               }\n            });\n\n            $('#acu-btn-refresh').off('click').on('click', (e) => { e.stopPropagation(); renderInterface(); if (window.toastr) window.toastr.info('已刷新'); });\n              \n              bindDynamicContentEvents();\n        };\n\n        const toggleUI = () => { isCollapsed = !isCollapsed; localStorage.setItem(STORAGE_KEY_UI_COLLAPSE, isCollapsed); renderInterface(); };\n        $('#acu-btn-toggle').off('click').on('click', (e) => { e.stopPropagation(); toggleUI(); });\n        if (isCollapsed) { $('.acu-nav-container').off('click').on('click', (e) => { e.stopPropagation(); toggleUI(); }); }\n        \n        $('#acu-btn-settings').off('click').on('click', (e) => { e.stopPropagation(); if (isEditingOrder) { toggleOrderEditMode(); } else { showSettingsModal(); } });\n        $('#acu-btn-cancel-mode').off('click').on('click', (e) => { e.stopPropagation(); isEditingOrder = false; renderInterface(); });\n        $('#acu-btn-save-mode').off('click').on('click', (e) => { e.stopPropagation(); toggleOrderEditMode(); });\n        $('#acu-btn-save-global').off('click').on('click', async function(e) { e.stopPropagation(); const rawData = getTableData(); if (rawData) await saveDataToDatabase(rawData, false, true); });\n        $('#acu-btn-open-native').off('click').on('click', function(e) {\n            e.preventDefault(); e.stopPropagation();\n            const api = getCore().getDB();\n            if (api && api.openVisualizer) api.openVisualizer();\n            else if (window.toastr) window.toastr.error('无法调用原生编辑器 API');\n        });\n        $('#acu-btn-manual-update').off('click').on('click', async function(e) {\n            e.preventDefault(); e.stopPropagation();\n            const api = getCore().getDB();\n            if (api && api.manualUpdate) {\n                await api.manualUpdate();\n            } else if (window.toastr) window.toastr.error('无法调用数据库更新接口');\n        });\n\n        $('#send_but').off('click.acu_opt_hide').on('click.acu_opt_hide', function() {\n             hideOptionsUntilUpdate = true;\n             $('.acu-embedded-options-container').hide();\n        });\n        $('#send_textarea').off('keydown.acu_opt_hide').on('keydown.acu_opt_hide', function(e) {\n             if (e.key === 'Enter' && !e.shiftKey) {\n                 hideOptionsUntilUpdate = true;\n                 $('.acu-embedded-options-container').hide();\n             }\n        });\n        \n        $('.acu-opt-btn').on('click', function(e) {\n             e.preventDefault(); e.stopPropagation();\n             $(this).blur();\n             const val = decodeURIComponent($(this).data('val'));\n             const config = getConfig();\n             \n             let win = window.parent || window;\n             let parentDoc = win.document;\n             let ta = parentDoc.getElementById('send_textarea');\n\n             if(ta) {\n                 ta.value = (ta.value || '') + val;\n                 ta.dispatchEvent(new Event('input', { bubbles: true }));\n                 ta.dispatchEvent(new Event('change', { bubbles: true }));\n                 if (!config.clickOptionToAutoSend) ta.focus();\n                 \n                 if (config.clickOptionToAutoSend) {\n                     hideOptionsUntilUpdate = true;\n                     $('.acu-embedded-options-container').hide();\n                 \n                     if (win.SillyTavern && win.SillyTavern.getContext) {\n                         const context = win.SillyTavern.getContext();\n                         if(context && context.generate) {\n                             context.generate();\n                             return;\n                         }\n                     }\n                     const sendBtn = parentDoc.getElementById('send_but');\n                     if(sendBtn) sendBtn.click();\n                 }\n             }\n        });\n\n        bindDataAreaEvents();\n    };\n    \n    const showQuickView = (row, headers, tableName) => {\n        const { $ } = getCore();\n        const config = getConfig();\n        $('.acu-quick-view-overlay').remove();\n        const codeIdx = headers.findIndex(h => h && (String(h).includes('编码') || String(h).includes('索引')));\n        const savedStyles = getTableStyles();\n        const currentStyle = savedStyles[tableName] || 'list';\n\n        let gridHtml = ''; let fullHtml = '';\n        row.forEach((cell, cIdx) => {\n             if (cIdx > 0) {\n                const headerName = headers[cIdx] || `属性${cIdx}`;\n                const cellStr = String(cell);\n                const displayCell = cellStr.trim();\n                if (displayCell === 'auto_merged') return;\n                const badgeStyle = getBadgeStyle(displayCell);\n                const contentHtml = badgeStyle ? `<span class=\"acu-badge ${badgeStyle}\">${displayCell}</span>` : displayCell;\n                \n                if (currentStyle === 'list' || codeIdx > 0) {\n                     fullHtml += `<div class=\"acu-cell acu-inline-item\" style=\"cursor:default\"><div class=\"acu-inline-label\">${headerName}</div><div class=\"acu-inline-value\">${contentHtml}</div></div>`;\n                } else {\n                     if (cellStr.length > 50) {\n                        fullHtml += `<div class=\"acu-cell acu-full-item\" style=\"cursor:default\"><div class=\"acu-full-label\">${headerName}</div><div class=\"acu-full-value\">${displayCell}</div></div>`;\n                     } else {\n                        gridHtml += `<div class=\"acu-cell acu-grid-item\" style=\"cursor:default\"><div class=\"acu-grid-label\">${headerName}</div><div class=\"acu-grid-value\">${contentHtml}</div></div>`;\n                     }\n                }\n             }\n        });\n        \n        const html = `\n            <div class=\"acu-quick-view-overlay\">\n                <div class=\"acu-quick-view-card acu-theme-${config.theme}\">\n                     <div class=\"acu-quick-view-header\">\n                        <span><i class=\"fa-solid ${getIconForTableName(tableName)}\"></i> ${row[1] || '详情'}</span>\n                        <button class=\"acu-close-btn\" id=\"qv-close\"><i class=\"fa-solid fa-times\"></i></button>\n                     </div>\n                     <div class=\"acu-quick-view-body\">\n                          ${gridHtml ? `<div class=\"acu-card-main-grid\">${gridHtml}</div>` : ''}\n                          ${fullHtml ? `<div class=\"acu-card-full-area\">${fullHtml}</div>` : ''}\n                     </div>\n                </div>\n            </div>\n        `;\n        $('body').append(html);\n        \n        const close = () => $('.acu-quick-view-overlay').remove();\n        $('#qv-close').click(close);\n        $('.acu-quick-view-overlay').click((e) => {\n             if ($(e.target).hasClass('acu-quick-view-overlay')) close();\n        });\n    };\n\n    const toggleOrderEditMode = () => {\n        if (isEditingOrder) {\n            const { $ } = getCore();\n            const newOrder = []; \n            $('.acu-nav-tabs-area .acu-nav-btn').each(function() { const t = $(this).data('table'); if(t && t!==TAB_DASHBOARD) newOrder.push(t); });\n            saveTableOrder(newOrder);\n            const newActionOrder = [];\n            $('.acu-nav-actions-area .acu-action-btn').each(function() { if(this.id) newActionOrder.push(this.id); });\n            saveActionOrder(newActionOrder);\n            isEditingOrder = false;\n        } else {\n            isEditingOrder = true;\n        }\n        renderInterface();\n    };\n\n    const initSortable = () => {\n        const { $ } = getCore();\n        let dragSrcEl = null;\n\n        const setup = (selector) => {\n             const $items = $(selector);\n             $items.attr('draggable', true);\n             \n             $items.off('dragstart').on('dragstart', function(e) { \n                 dragSrcEl = this;\n                 e.originalEvent.dataTransfer.effectAllowed = 'move';\n                 $(this).css('opacity', '0.5'); \n             });\n             \n             $items.off('dragend').on('dragend', function() { \n                 $(this).css('opacity', '1'); \n                 dragSrcEl = null;\n             });\n             \n             $items.off('dragover').on('dragover', function(e) { \n                 if(e.preventDefault) e.preventDefault(); \n                 return false; \n             });\n             \n             $items.off('drop').on('drop', function(e) {\n                if(e.stopPropagation) e.stopPropagation();\n                if (dragSrcEl !== this && $(dragSrcEl).parent()[0] === $(this).parent()[0]) {\n                    const $siblings = $(this).parent().children();\n                    const srcIdx = $siblings.index(dragSrcEl);\n                    const targetIdx = $siblings.index(this);\n                    if (srcIdx < targetIdx) $(this).after(dragSrcEl);\n                    else $(this).before(dragSrcEl);\n                }\n                return false;\n            });\n        };\n\n        setup('.acu-nav-tabs-area .acu-nav-btn');\n        setup('.acu-nav-actions-area .acu-action-btn');\n    };\n\n    const showCellMenu = (e, cell) => {\n        const { $ } = getCore();\n        $('.acu-cell-menu, .acu-menu-backdrop').remove();\n        const backdrop = $('<div class=\"acu-menu-backdrop\"></div>');\n        $('body').append(backdrop);\n        const rowIdx = parseInt($(cell).data('row'));\n        const colIdx = parseInt($(cell).data('col'));\n        const tableKey = $(cell).data('key');\n        const tableName = $(cell).data('tname');\n        const content = decodeURIComponent($(cell).data('val'));\n        const config = getConfig();\n        \n        const deleteKey = `${tableName}-row-${rowIdx}`;\n        const isPending = pendingDeletes.has(deleteKey);\n\n        const menu = $(`\n            <div class=\"acu-cell-menu acu-theme-${config.theme}\">\n                <div class=\"acu-cell-menu-item\" id=\"act-edit\"><i class=\"fa-solid fa-pen\"></i> 编辑内容</div>\n                <div class=\"acu-cell-menu-item\" id=\"act-edit-card\"><i class=\"fa-solid fa-edit\"></i> 整体编辑</div>\n                <div class=\"acu-cell-menu-item\" id=\"act-insert\" style=\"color:#2980b9\"><i class=\"fa-solid fa-plus\"></i> 插入新行</div>\n                \n                ${isPending \n                    ? `<div class=\"acu-cell-menu-item\" id=\"act-restore\"><i class=\"fa-solid fa-undo\"></i> 整行恢复</div>` \n                    : `<div class=\"acu-cell-menu-item\" id=\"act-delete\"><i class=\"fa-solid fa-trash\"></i> 删除整行</div>`\n                }\n                <div class=\"acu-cell-menu-item\" id=\"act-close\"><i class=\"fa-solid fa-times\"></i> 关闭菜单</div>\n            </div>\n        `);\n        $('body').append(menu);\n        const mWidth = menu.outerWidth();\n        const mHeight = menu.outerHeight();\n        const winWidth = $(window).width();\n        const winHeight = $(window).height();\n\n        let left = e.clientX + 5;\n        let top = e.clientY + 5;\n\n        if (left + mWidth > winWidth) {\n            left = e.clientX - mWidth - 5;\n        }\n\n        if (top + mHeight > winHeight) {\n            top = e.clientY - mHeight - 5;\n        }\n        \n        if (left < 0) left = 0;\n        if (top < 0) top = 0;\n\n        menu.css({ top: top + 'px', left: left + 'px' });\n        const closeAll = () => { menu.remove(); backdrop.remove(); };\n        backdrop.on('click', function(e) { e.stopPropagation(); closeAll(); });\n        menu.find('#act-close').click(closeAll);\n        \n        \n        \n        menu.find('#act-delete').click(() => {\n            pendingDeletes.add(deleteKey);\n            const $card = $(cell).closest('.acu-data-card');\n            if ($card.length && $card.find('.acu-badge-pending').length === 0) {\n                $card.append('<div class=\"acu-badge-pending\">待删除</div>');\n            }\n            updateSaveBtnState();\n            closeAll();\n        });\n        \n        menu.find('#act-restore').click(() => {\n            pendingDeletes.delete(deleteKey);\n            const $card = $(cell).closest('.acu-data-card');\n            $card.find('.acu-badge-pending').remove();\n            updateSaveBtnState();\n            closeAll();\n        });\n\n        menu.find('#act-edit').click(() => { \n            closeAll();\n            showEditDialog(content, async (newVal) => { \n                const $cell = $(cell);\n                $cell.attr('data-val', encodeURIComponent(newVal));\n                $cell.data('val', encodeURIComponent(newVal));\n\n                let $displayTarget = $cell;\n                if ($cell.hasClass('acu-grid-item')) $displayTarget = $cell.find('.acu-grid-value');\n                else if ($cell.hasClass('acu-full-item')) $displayTarget = $cell.find('.acu-full-value');\n                else if ($cell.hasClass('acu-inline-item')) $displayTarget = $cell.find('.acu-inline-value');\n                else if ($cell.hasClass('acu-editable-title')) $displayTarget = $cell;\n\n                const badgeStyle = getBadgeStyle(newVal);\n                if (badgeStyle && !$cell.hasClass('acu-editable-title')) {\n                     $displayTarget.html(`<span class=\"acu-badge ${badgeStyle}\">${newVal}</span>`);\n                } else {\n                     $displayTarget.text(newVal);\n                }\n                $displayTarget.addClass('acu-highlight-changed');\n\n                const rawData = getTableData();\n                if (rawData && rawData[tableKey]?.content[rowIdx + 1]) { \n                      rawData[tableKey].content[rowIdx + 1][colIdx] = newVal;\n                    await saveDataToDatabase(rawData, true);\n                } \n            });\n        });\n        menu.find('#act-insert').click(async () => {\n            closeAll();\n            const rawData = getTableData();\n            if (rawData && rawData[tableKey]?.content) {\n                const sheet = rawData[tableKey];\n                const colCount = sheet.content[0] ? sheet.content[0].length : 2;\n                const newRow = new Array(colCount).fill('');\n                if (colCount > 0) newRow[0] = String(sheet.content.length);\n                sheet.content.splice(rowIdx + 2, 0, newRow);\n                if (window.toastr) window.toastr.info('正在插入新行...');\n                await saveDataToDatabase(rawData, false, true);\n            }\n        });\n\n        menu.find('#act-edit-card').click(() => {\n            closeAll();\n            const rawData = getTableData();\n            if (rawData && rawData[tableKey]) {\n                const headers = rawData[tableKey].content[0];\n                const row = rawData[tableKey].content[rowIdx + 1];\n                if (row) {\n                    showCardEditModal(row, headers, tableName, rowIdx, tableKey);\n                }\n            }\n        });\n    };\n\n    const showCardEditModal = (row, headers, tableName, rowIndex, tableKey) => {\n        const { $ } = getCore();\n        const config = getConfig();\n        const rawData = getTableData();\n        let displayRow = row;\n        if (rawData && rawData[tableKey] && rawData[tableKey].content[rowIndex + 1]) {\n            displayRow = rawData[tableKey].content[rowIndex + 1];\n        }\n\n        const inputsHtml = displayRow.map((cell, idx) => {\n            if (idx === 0) return '';\n            const headerName = headers[idx] || `Column ${idx}`;\n            const val = cell || '';\n            return `\n                <div class=\"acu-card-edit-field\">\n                    <label class=\"acu-card-edit-label\">${headerName}</label>\n                    <textarea class=\"acu-card-edit-input\" data-col=\"${idx}\" spellcheck=\"false\">${val}</textarea>\n                </div>`;\n        }).join('');\n\n        const dialog = $(`\n            <div class=\"acu-edit-overlay\">\n                <div class=\"acu-edit-dialog acu-theme-${config.theme}\">\n                    <div class=\"acu-edit-title\">整体编辑 (#${rowIndex + 1})</div>\n                    <div class=\"acu-settings-content\" style=\"flex:1; overflow-y:auto;\">\n                        ${inputsHtml}\n                    </div>\n                     <div class=\"acu-dialog-btns\">\n                        <button class=\"acu-dialog-btn\" id=\"dlg-card-cancel\"><i class=\"fa-solid fa-times\"></i> 取消</button>\n                        <button class=\"acu-dialog-btn acu-btn-confirm\" id=\"dlg-card-save\" style=\"color:var(--acu-highlight)\"><i class=\"fa-solid fa-check\"></i> 保存</button>\n                    </div>\n                </div>\n            </div>\n        `);\n        $('body').append(dialog);\n\n        dialog.find('textarea').each(function () {\n            this.style.height = 'auto';\n            this.style.height = (this.scrollHeight + 2) + 'px';\n        }).on('input', function () {\n            this.style.height = 'auto';\n            this.style.height = (this.scrollHeight + 2) + 'px';\n        });\n\n        const closeDialog = () => dialog.remove();\n        dialog.find('#dlg-card-cancel').click(closeDialog);\n\n        dialog.find('#dlg-card-save').click(async () => {\n            const currentData = getTableData(); \n            if (currentData && currentData[tableKey]) {\n                const currentRow = currentData[tableKey].content[rowIndex + 1];\n                let hasChanges = false;\n                dialog.find('textarea').each(function () {\n                    const colIdx = parseInt($(this).data('col'));\n                    const newVal = $(this).val();\n                    if (String(currentRow[colIdx]) !== String(newVal)) {\n                        hasChanges = true;\n                        currentRow[colIdx] = newVal;\n                    }\n                });\n                if (hasChanges) {\n                    await saveDataToDatabase(currentData, false);\n                }\n            }\n            closeDialog();\n        });\n        dialog.on('click', function(e) { if ($(e.target).hasClass('acu-edit-overlay')) closeDialog(); });\n    };\n\n    const showEditDialog = (content, onSave) => {\n        const { $ } = getCore();\n        const config = getConfig();\n        const dialog = $(`\n            <div class=\"acu-edit-overlay\">\n                <div class=\"acu-edit-dialog acu-theme-${config.theme}\">\n                    <div class=\"acu-edit-title\">编辑单元格内容</div>\n                    <textarea class=\"acu-edit-textarea\">${content}</textarea>\n                     <div class=\"acu-dialog-btns\">\n                        <button class=\"acu-dialog-btn\" id=\"dlg-cancel\"><i class=\"fa-solid fa-times\"></i> 取消</button>\n                        <button class=\"acu-dialog-btn acu-btn-confirm\" id=\"dlg-save\"><i class=\"fa-solid fa-check\"></i> 保存</button>\n                    </div>\n                </div>\n            </div>\n        `);\n        $('body').append(dialog);\n        const closeDialog = () => dialog.remove();\n        dialog.find('#dlg-cancel').click(closeDialog);\n        dialog.find('#dlg-save').click(() => { onSave(dialog.find('textarea').val()); closeDialog(); });\n        dialog.on('click', function(e) { if ($(e.target).hasClass('acu-edit-overlay')) closeDialog(); });\n    };\n\n    const init = () => {\n        if (isInitialized) return;\n        addStyles();\n        const loop = () => {\n             const { $ } = getCore();\n             if (getCore().getDB()?.exportTableAsJson && $) {\n                  renderInterface();\n                 const api = getCore().getDB();\n                 if (api.registerTableUpdateCallback) {\n                     api.registerTableUpdateCallback(UpdateController.handleUpdate);\n                     if (api.registerTableFillStartCallback) { api.registerTableFillStartCallback(() => { const c = api.exportTableAsJson(); if (c) saveSnapshot(c); }); }\n                 }\n                 isInitialized = true;\n             } else setTimeout(loop, 1000);\n        };\n        loop();\n    };\n    const { $ } = getCore();\n    if ($) $(document).ready(init); else window.addEventListener('load', init);\n})();",
  "info": "可视化表格-V12.60",
  "button": {
    "enabled": true,
    "buttons": []
  },
  "data": {}
}