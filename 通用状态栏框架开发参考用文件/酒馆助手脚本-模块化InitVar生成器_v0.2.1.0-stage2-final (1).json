{
  "type": "script",
  "enabled": false,
  "name": "模块化InitVar生成器_v0.2.1.0-stage2-final",
  "id": "18c2e228-c3c7-4f4b-a97e-394ff7df28c7",
  "content": "(() => {\n    'use strict';\n\n    // --- 全局常量 ---\n    const SCRIPT_VERSION = 'v0.2.1.0-stage2-final';\n    const LOREBOOK_NAME = '[InitVar生成]';\n    const START_TAG_COMMENT = '<InitVar>';\n    const END_TAG_COMMENT = '</InitVar>';\n    const TARGET_ENTRY_COMMENT = '[InitVar]';\n    const BUTTON_ID = 'initvar-compiler-button';\n    const BUTTON_ICON = 'fa-solid fa-file-code';\n    const BUTTON_TEXT = '[InitVar] 编译器';\n    const BUTTON_TOOLTIP = '左键: 打开编译器 | Shift+左键: 直接注入 | Ctrl/Cmd+左键: 直接复制';\n    const POPUP_ID = 'initvar-compiler-popup';\n    const STYLE_ID = 'initvar-compiler-style';\n    const DEBUG = true;\n    const instanceId = `initvar_compiler_instance_${new Date().toISOString()}_${Math.random()}`;\n\n    // --- 状态变量 ---\n    let uiState = {\n        isPopupOpen: false,\n        isCompiling: false,\n        lastCompiledJson: null,\n        lastCompiledResult: null,\n        sourceHash: null,\n        showDebugLogs: false,\n        activeTheme: 'dark_cool', // 'smart', 'light_warm', 'dark_cool'\n        // Compiler States\n        compilerSortBy: 'order',\n        compilerSortDirection: 'asc',\n        autoScrollLogs: true,\n        \n        // --- v0.2.0 新增状态 ---\n        activeTab: 'compiler',\n        compilerLorebook: LOREBOOK_NAME,\n        managerLorebook: LOREBOOK_NAME,\n        managerEntries: [], // memoryEntry[]\n        isManagerLoading: false,\n        managerHasUnsavedChanges: false,\n        managerSortBy: 'order',\n        managerSortDirection: 'asc',\n        // --- v0.2.1 新增状态 ---\n        managerInstantEditMode: false,\n    };\n\n    // --- 辅助函数 ---\n    const escapeHtml = (str) => String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\"/g, '&quot;').replace(/'/g, '&#039;');\n    \n    const ensureNumericUID = (uid) => {\n        if (typeof uid === 'number') return uid;\n        if (typeof uid === 'string') {\n            if (uid.startsWith('temp_')) return uid;\n            return parseInt(uid, 10);\n        }\n        return -1;\n    };\n    \n    const logManagerAction = (action, details) => {\n        if (!DEBUG) return;\n        console.group(`[InitVar管理器] 操作: ${action}`);\n        if (details.count !== undefined) console.log(`- 数量: ${details.count}`);\n        if (details.uids) console.log(`- UIDs:`, details.uids);\n        if (details.sourceUids) console.log(`- 源 UIDs:`, details.sourceUids);\n        if (details.tempUids) console.log(`- 临时 UIDs:`, details.tempUids);\n        if (details.target) console.log(`- 目标字段: ${details.target}`);\n        if (details.value) console.log(`- 值: ${details.value}`);\n        if (details.newState !== undefined) console.log(`- 新状态: ${details.newState}`);\n        console.groupEnd();\n    };\n\n\n    async function compileAndInject() {\n        if (DEBUG) console.group(`[InitVar生成器 ${SCRIPT_VERSION}] 开始一键编译并注入`);\n        try {\n            const { result, logs, debugLogs } = await compile();\n            if (DEBUG) {\n                logs.forEach(log => console[log.type === 'error' ? 'error' : 'log'](log.message));\n                if (uiState.showDebugLogs) debugLogs.forEach(log => console.log(log.message));\n            }\n            await inject(result);\n        } catch (error) {\n            console.error(`[InitVar生成器 ${SCRIPT_VERSION}] 一键操作失败:`, error.error || error);\n            if (error.logs) error.logs.forEach(log => console.error(log.message));\n            toastr.error((error.error?.message || error.message), '编译失败');\n        } finally {\n            if (DEBUG) console.groupEnd();\n        }\n    }\n    \n    async function compileAndCopy() {\n        if (DEBUG) console.group(`[InitVar生成器 ${SCRIPT_VERSION}] 开始一键编译并复制`);\n        try {\n            const { json, logs, debugLogs } = await compile();\n            if (DEBUG) {\n                logs.forEach(log => console[log.type === 'error' ? 'error' : 'log'](log.message));\n                if (uiState.showDebugLogs) debugLogs.forEach(log => console.log(log.message));\n            }\n            await copyToClipboard(json);\n        } catch (error) {\n            console.error(`[InitVar生成器 ${SCRIPT_VERSION}] 一键操作失败:`, error.error || error);\n            if (error.logs) error.logs.forEach(log => console.error(log.message));\n            toastr.error((error.error?.message || error.message), '编译失败');\n        } finally {\n            if (DEBUG) console.groupEnd();\n        }\n    }\n\n    async function compile() {\n        const logs = [];\n        const debugLogs = [];\n        const log = (type, message) => logs.push({ type, message });\n\n        const originalConsoleLog = console.log;\n        if (DEBUG) {\n            console.log = (...args) => {\n                const message = args.map(arg => typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)).join(' ');\n                debugLogs.push({ type: 'debug', message });\n                originalConsoleLog.apply(console, args);\n            };\n        }\n\n        try {\n            log('info', `[INFO] 开始编译 (${SCRIPT_VERSION})...`);\n            log('info', '[INFO] 阶段 1/3: 读取世界书条目...');\n            const allEntries = await TavernHelper.getWorldbook(uiState.compilerLorebook);\n            if (!allEntries) throw new Error(`无法读取世界书 \"${uiState.compilerLorebook}\"。请确认该世界书存在。`);\n            \n            const adaptedForCompiler = allEntries.map((entry, index) => ({\n                uid: entry.uid,\n                comment: entry.name,\n                content: entry.content,\n                order: entry.position?.order ?? 0,\n                display_index: index,\n            }));\n\n            const relevantEntries = getRelevantEntries(adaptedForCompiler);\n            log('info', `[INFO] 找到 ${relevantEntries.length} 个相关条目。`);\n\n            log('info', '[INFO] 阶段 2/3: 构建抽象语法树 (AST)...');\n            const ast = buildAst(relevantEntries);\n            log('success', '[SUCCESS] AST 构建完成。');\n\n            log('info', '[INFO] 阶段 3/3: 生成JSON...');\n            const compiledJsonResult = convertAstToJson(ast);\n            log('success', '[SUCCESS] JSON 生成成功！');\n            \n            const compiledJsonString = JSON.stringify(compiledJsonResult, null, 2);\n\n            return { json: compiledJsonString, result: compiledJsonResult, logs, debugLogs };\n        } catch (error) {\n            log('error', `[ERROR] 编译失败: ${error.message}`);\n            console.error(`[InitVar生成器 ${SCRIPT_VERSION}] 编译逻辑失败:`, error);\n            throw { error, logs, debugLogs };\n        } finally {\n            if (DEBUG) {\n                console.log = originalConsoleLog;\n            }\n        }\n    }\n    \n    async function inject(compiledJson) {\n         try {\n            await injectResult(compiledJson);\n            toastr.success(`成功将结果注入到 \"${TARGET_ENTRY_COMMENT}\" 条目！`, `[InitVar] 注入成功`);\n        } catch (error) {\n            console.error(`[InitVar生成器 ${SCRIPT_VERSION}] 注入失败:`, error);\n            toastr.error(error.message, '注入失败');\n            throw error;\n        }\n    }\n\n    async function copyToClipboard(text) {\n        const parentDoc = window.parent.document;\n        const textarea = parentDoc.createElement('textarea');\n        try {\n            textarea.style.position = 'fixed';\n            textarea.style.top = '-9999px';\n            textarea.style.left = '-9999px';\n            textarea.style.opacity = '0';\n            textarea.value = text;\n            parentDoc.body.appendChild(textarea);\n            textarea.select();\n            textarea.setSelectionRange(0, 999999);\n            let success = false;\n            try {\n                success = parentDoc.execCommand('copy');\n            } catch (err) {\n                console.error('execCommand a-pi 失败:', err);\n                success = false;\n            }\n            if (success) {\n                toastr.success('已成功将结果复制到剪贴板！');\n            } else {\n                throw new Error('浏览器拒绝了复制命令。');\n            }\n        } catch (error) {\n            console.error('无法复制到剪贴板:', error);\n            toastr.error('复制到剪贴板失败。可能是浏览器安全策略导致。', '复制失败');\n        } finally {\n            if (parentDoc.body.contains(textarea)) {\n                parentDoc.body.removeChild(textarea);\n            }\n        }\n    }\n    \n    async function _calculateSourceHash() {\n        try {\n            const allEntries = await TavernHelper.getWorldbook(uiState.compilerLorebook);\n            const adaptedForCompiler = allEntries.map((entry, index) => ({\n                uid: entry.uid,\n                comment: entry.name,\n                content: entry.content,\n                order: entry.position?.order ?? 0,\n                display_index: index,\n            }));\n            const relevantEntries = getRelevantEntries(adaptedForCompiler);\n            return relevantEntries.map(e => `${e.uid}:${e.comment}:${e.content}`).join('|');\n        } catch (error) {\n            console.error(\"计算源哈希值时出错:\", error);\n            return Math.random().toString();\n        }\n    }\n\n    function getRelevantEntries(allEntries) {\n        const sortKey = uiState.compilerSortBy;\n        const direction = uiState.compilerSortDirection === 'asc' ? 1 : -1;\n        \n        allEntries.sort((a, b) => {\n            const primarySort = (a[sortKey] || 0) - (b[sortKey] || 0);\n            const secondarySort = (a.uid || 0) - (b.uid || 0);\n            return (primarySort || secondarySort) * direction;\n        });\n\n        const startIndex = allEntries.findIndex(entry => entry.comment === START_TAG_COMMENT);\n        const endIndex = allEntries.findIndex(entry => entry.comment === END_TAG_COMMENT);\n        if (startIndex === -1) throw new Error(`未在世界书 \"${uiState.compilerLorebook}\" 中找到起始标签 \"${START_TAG_COMMENT}\"。`);\n        if (endIndex === -1) throw new Error(`未在世界书 \"${uiState.compilerLorebook}\" 中找到结束标签 \"${END_TAG_COMMENT}\"。`);\n        if (endIndex < startIndex) throw new Error(`结束标签 \"${END_TAG_COMMENT}\" 出现在起始标签 \"${START_TAG_COMMENT}\" 之前。`);\n        return allEntries.slice(startIndex + 1, endIndex);\n    }\n\n    function parseEntryContent(entry) {\n        const { comment, content, uid, order } = entry;\n        if (!content || content.trim() === '') {\n            return null;\n        }\n        try {\n            return (new Function(`return ${content}`))();\n        } catch (e) {\n            throw new Error(`条目 \"${comment.trim()}\" (uid: ${uid}, order: ${order}) 的内容不是有效的JavaScript对象/数组格式: ${e.message}`);\n        }\n    }\n\n    function buildAst(entries) {\n        const rootNode = { type: 'root', name: '#ROOT#', children: [] };\n        let currentNode = rootNode;\n        console.group('[buildAst] 开始构建AST');\n\n        for (const entry of entries) {\n            const comment = entry.comment.trim();\n            console.log(`[buildAst] 处理条目: \"${comment}\" (order: ${entry.order}), 当前节点: \"${currentNode.name}\"`);\n            \n            const tagMatch = comment.match(/^<(\\/?)([^>]+)>$/);\n            if (tagMatch) {\n                const isClosingTag = !!tagMatch[1];\n                const tagName = tagMatch[2];\n                if (isClosingTag) {\n                    if (!currentNode.parent || currentNode.name !== tagName) throw new Error(`标签不匹配 (uid: ${entry.uid}, order: ${entry.order}): 期望</${currentNode.name}>, 得到</${tagName}>`);\n                    console.log(`[buildAst] -> 闭合 </${tagName}>. 上移至 \"${currentNode.parent.name}\"`);\n                    currentNode = currentNode.parent;\n                } else {\n                    const newNode = { type: 'tag', name: tagName, children: [], parent: currentNode, metaNode: null };\n                    const parsedContent = parseEntryContent(entry);\n                    if (parsedContent) {\n                        if (!Array.isArray(parsedContent)) throw new Error(`带值标签 \"${comment}\" (uid: ${entry.uid}, order: ${entry.order}) 的 content 必须是数组格式`);\n                        newNode.value = parsedContent;\n                        console.log(`[buildAst] -> 识别为带值对象标签 <${tagName}>`);\n                    } else {\n                        console.log(`[buildAst] -> 识别为容器标签 <${tagName}>`);\n                    }\n                    currentNode.children.push(newNode);\n                    currentNode = newNode;\n                }\n            } else {\n                const parsedContent = parseEntryContent(entry);\n                if (parsedContent === null) {\n                    console.warn(`[buildAst] 警告: 键值对条目 \"${comment}\" (uid: ${entry.uid}, order: ${entry.order}) 的 content 为空，将被忽略。`);\n                    continue;\n                }\n                const newNode = { type: 'item', name: comment, value: parsedContent, parent: currentNode, metaNode: null };\n                currentNode.children.push(newNode);\n                console.log(`[buildAst] -> 添加键值对 \"${comment}\" 到 \"${currentNode.name}\"`);\n            }\n        }\n        \n        function associateMeta(node) {\n            for (let i = 0; i < node.children.length; i++) {\n                const child = node.children[i];\n                if (child.type === 'tag' && child.name === 'meta') {\n                    const prevChild = i > 0 ? node.children[i - 1] : null;\n                    const targetNode = prevChild && prevChild.type !== 'tag' ? prevChild : node;\n                    targetNode.metaNode = child;\n                    console.log(`[buildAst] 关联 meta 到 \"${targetNode.name}\"`);\n                }\n                if (child.children) associateMeta(child);\n            }\n            node.children = node.children.filter(c => c.name !== 'meta');\n        }\n        associateMeta(rootNode);\n\n        if (currentNode !== rootNode) throw new Error(`解析结束，但标签 <${currentNode.name}> 未闭合。`);\n        console.groupEnd();\n        return rootNode;\n    }\n\n    function convertAstToJson(astRoot) {\n        \n        function applyMeta(target, metaData, itemName) {\n            console.log(`[applyMeta] 应用 meta 到 \"${itemName}\"`, { metaData });\n            const isExtensibleValue = metaData.extensible_value === true;\n            delete metaData.extensible_value;\n            const templateData = metaData.template;\n            delete metaData.template;\n\n            if (isExtensibleValue) {\n                if (!Array.isArray(target)) throw new Error(`\"extensible_value\" 所修饰的条目 \"${itemName}\" 的值必须是数组。`);\n                if (target[0] === null || target[0] === undefined) target[0] = [];\n                if (!Array.isArray(target[0])) throw new Error(`\"extensible_value\" 所修饰的条目 \"${itemName}\" 的值数组的第一个元素必须是数组或null。`);\n                if (!target[0].includes(\"$__META_EXTENSIBLE__$\")) {\n                    target[0].unshift(\"$__META_EXTENSIBLE__$\");\n                }\n                console.log(`[applyMeta] -> \"extensible_value\" 已应用到 \"${itemName}\"`);\n            }\n\n            if (Object.keys(metaData).length > 0 || templateData) {\n                if(typeof target !== 'object' || target === null || Array.isArray(target)) throw new Error(`无法将 $meta 附加到非对象值上。目标: \"${itemName}\"`);\n                target.$meta = metaData;\n                if (templateData) target.$meta.template = templateData;\n                console.log(`[applyMeta] -> \"$meta\" 已附加到 \"${itemName}\"`, target.$meta);\n            }\n        }\n\n        function buildObject(node) {\n            console.log(`[buildObject] 进入节点: ${node.name}`);\n            let obj = {};\n\n            if (node.metaNode) {\n                const metaData = buildObject(node.metaNode);\n                applyMeta(obj, metaData, node.name);\n            }\n\n            for (const child of node.children) {\n                if (child.value !== undefined && child.type === 'tag') {\n                    const filledObject = buildObject(child);\n                    const finalValue = [...child.value];\n                    finalValue[0] = filledObject;\n                    if(child.metaNode) {\n                        const metaData = buildObject(child.metaNode);\n                        applyMeta(filledObject, metaData, child.name);\n                    }\n                    obj[child.name] = finalValue;\n                } else if (child.type === 'item') {\n                    obj[child.name] = child.value;\n                     if(child.metaNode) {\n                        const metaData = buildObject(child.metaNode);\n                        applyMeta(obj[child.name], metaData, child.name);\n                    }\n                } else if (child.type === 'tag') {\n                    obj[child.name] = buildObject(child);\n                }\n            }\n            console.log(`[buildObject] 退出节点: ${node.name}, 生成对象:`, obj);\n            return obj;\n        }\n\n        return buildObject(astRoot);\n    }\n\n    async function injectResult(compiledJson) {\n        let updateOccurred = false;\n        await TavernHelper.updateLorebookEntriesWith(uiState.compilerLorebook, async (entries) => {\n            const targetEntry = entries.find(entry => entry.comment === TARGET_ENTRY_COMMENT);\n            if (!targetEntry) throw new Error(`未在世界书 \"${uiState.compilerLorebook}\" 中找到用于注入的目标条目 \"${TARGET_ENTRY_COMMENT}\"。`);\n            const newContent = JSON.stringify(compiledJson, null, 2);\n            if (targetEntry.content !== newContent) {\n                targetEntry.content = newContent;\n                updateOccurred = true;\n            }\n            return entries;\n        });\n        if (!updateOccurred) {\n            toastr.info('编译结果与现有内容相同，未进行更新。', '无需注入');\n        }\n    }\n\n    function createCompilerButton() {\n        try {\n            const parentDoc = window.parent.document;\n            const $button = $(`#${BUTTON_ID}`, parentDoc);\n\n            if ($button.length === 0) {\n                const buttonHtml = `\n                    <div id=\"${BUTTON_ID}\" class=\"list-group-item flex-container flexGap5 interactable\" title=\"${BUTTON_TOOLTIP}\">\n                        <i class=\"${BUTTON_ICON}\"></i>\n                        <span>${BUTTON_TEXT}</span>\n                    </div>\n                `;\n                const $extensionsMenu = $('#extensionsMenu', parentDoc);\n                if ($extensionsMenu.length) {\n                   $extensionsMenu.append(buttonHtml);\n                }\n            }\n            $(parentDoc)\n                .off(`click.${BUTTON_ID}`)\n                .on(`click.${BUTTON_ID}`, `#${BUTTON_ID}`, (event) => {\n                    if (event.shiftKey) {\n                        compileAndInject();\n                    } else if (event.ctrlKey || event.metaKey) {\n                        compileAndCopy();\n                    } else {\n                        showCompilerPopup();\n                    }\n                });\n             console.log(`[InitVar生成器 ${SCRIPT_VERSION}] 编译器按钮已成功初始化。`);\n        } catch (error) {\n            console.error(`[InitVar生成器 ${SCRIPT_VERSION}] 创建菜单按钮时出错:`, error);\n        }\n    }\n\n    // --- v0.2.0: UI & Lifecycle ---\n    \n    function getPopupStyle() {\n        const baseStyle = `\n            #${POPUP_ID} {\n                position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;\n                z-index: 10000;\n                display: flex; align-items: center; justify-content: center;\n                --level-color-1: #8ab4f8; \n                --level-color-2: #81c995; \n                --level-color-3: #fdd663; \n                --level-color-4: #f28b82;\n                --meta-border-color: var(--level-color-2);\n                --template-border-color: var(--level-color-3);\n            }\n            #${POPUP_ID} .popup-content {\n                border-radius: 12px;\n                width: 90vw; max-width: 1400px; height: 85vh;\n                display: flex; flex-direction: column;\n                box-shadow: 0 5px 25px rgba(0, 0, 0, 0.3);\n                overflow: hidden;\n            }\n            #${POPUP_ID} .popup-header {\n                padding: 5px 15px;\n                font-weight: bold; font-size: 1.1em;\n                display: grid; grid-template-columns: 1fr auto 1fr;\n                align-items: center;\n                flex-shrink: 0;\n                position: relative;\n                user-select: none;\n            }\n            #${POPUP_ID} .header-nav, #${POPUP_ID} .header-close { display: flex; }\n            #${POPUP_ID} .header-close { justify-content: flex-end; }\n            #${POPUP_ID} .header-title { text-align: center; }\n            #${POPUP_ID} .popup-header .header-icon-btn { background-color: transparent !important; border: none; font-size: 1.2em; cursor: pointer; padding: 5px; opacity: 0.8; }\n            #${POPUP_ID} .header-icon-btn:hover { opacity: 1; }\n            #${POPUP_ID} .close-btn { cursor: pointer; opacity: 0.7; transition: opacity 0.2s; }\n            #${POPUP_ID} .close-btn:hover { opacity: 1; }\n\n            #${POPUP_ID} .nav-menu {\n                position: absolute; top: calc(100%); left: 10px;\n                min-width: 140px;\n                border-radius: 8px;\n                padding: 8px;\n                box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n                opacity: 0;\n                transform: translateY(-10px);\n                transition: opacity 0.2s ease, transform 0.2s ease;\n                pointer-events: none;\n                z-index: 10002;\n            }\n            #${POPUP_ID} .nav-menu.visible { opacity: 1; transform: translateY(0); pointer-events: auto; }\n            #${POPUP_ID} .nav-item { padding: 10px 12px; border-radius: 6px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }\n            #${POPUP_ID} .nav-item.active { font-weight: bold; }\n            #${POPUP_ID} .nav-submenu {\n                position: absolute; left: 100%;\n                display: none;\n                min-width: 120px;\n                padding: 8px;\n                border-radius: 8px;\n                box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n            }\n            #${POPUP_ID} .nav-item.has-submenu.submenu-visible .nav-submenu { display: block; }\n            #${POPUP_ID} .nav-sub-item { padding: 8px 12px; border-radius: 6px; cursor: pointer; }\n\n            #${POPUP_ID} .popup-body-container { flex-grow: 1; min-height: 0; position: relative; }\n            #${POPUP_ID} .tab-content { display: none; height: 100%; }\n            #${POPUP_ID} .tab-content.active { display: flex; flex-direction: column; } /* Use flex for panel layout */\n            \n            #${POPUP_ID} .compiler-content-wrapper, #${POPUP_ID} .manager-content-wrapper {\n                 height: 100%; box-sizing: border-box; display: flex; flex-direction: column;\n            }\n             #${POPUP_ID} .compiler-content-wrapper {\n                padding: 15px;\n                display: grid;\n                grid-template-columns: 2fr 3fr;\n                grid-template-rows: auto 1fr;\n                gap: 15px;\n            }\n\n            #${POPUP_ID} .panel {\n                border-radius: 8px; padding: 15px;\n                display: flex; flex-direction: column;\n                min-height: 0;\n            }\n            #${POPUP_ID} .control-panel { position: relative; padding-bottom: 25px; /* Space for drawer toggle */ }\n            #${POPUP_ID} .panel-main-controls { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }\n\n            #${POPUP_ID} .panel-drawer-content {\n                padding-top: 10px;\n                max-height: 0;\n                overflow: hidden;\n                transition: max-height 0.35s ease-in-out;\n                display: flex; flex-direction: column; gap: 5px;\n            }\n            #${POPUP_ID} .control-panel.drawer-expanded .panel-drawer-content { max-height: 500px; }\n            #${POPUP_ID} .panel-drawer-toggle {\n                position: absolute; bottom: 0; left: 50%;\n                transform: translateX(-50%);\n                width: 50px; height: 20px;\n                border-radius: 10px 10px 0 0;\n                display: flex; align-items: center; justify-content: center;\n                cursor: pointer;\n                opacity: 0.7;\n            }\n            #${POPUP_ID} .panel-drawer-toggle:hover { opacity: 1; }\n            #${POPUP_ID} .panel-drawer-toggle i { transition: transform 0.3s; }\n            #${POPUP_ID} .control-panel.drawer-expanded .panel-drawer-toggle i { transform: rotate(180deg); }\n\n            #${POPUP_ID} .log-panel { grid-area: 2 / 1 / 3 / 2; }\n            #${POPUP_ID} .preview-panel { grid-area: 1 / 2 / 3 / 3; }\n            #${POPUP_ID} .panel-title { font-weight: bold; opacity: 0.8; margin: 0; flex-shrink: 0; }\n            #${POPUP_ID} .panel-header-flex { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-shrink: 0;}\n            #${POPUP_ID} .control-buttons { display: flex; gap: 4px; flex-wrap: wrap; }\n            #${POPUP_ID} button {\n                padding: 8px 12px; border-radius: 5px; cursor: pointer;\n                font-weight: 500; transition: all 0.2s; border: 1px solid transparent;\n            }\n            #${POPUP_ID} button:hover:not(:disabled) { filter: brightness(1.2); }\n            #${POPUP_ID} button:disabled { opacity: 0.5; cursor: not-allowed; }\n            #${POPUP_ID} #initvar-copy-btn {\n                padding: 0; width: 28px; height: 28px;\n                font-size: 0.9em; display: flex; align-items: center; justify-content: center;\n                opacity: 0.6;\n            }\n            #${POPUP_ID} textarea, #${POPUP_ID} .log-content {\n                width: 100%; height: 100%;\n                flex-grow: 1; resize: none;\n                padding: 10px; border-radius: 5px;\n                font-family: monospace; font-size: 0.9em;\n            }\n            #${POPUP_ID} .log-content { overflow-y: auto; }\n            #${POPUP_ID} .log-content p { margin: 0 0 5px 0; padding: 2px 6px; border-radius: 4px; white-space: pre-wrap; word-break: break-word; font-weight: bold;}\n            #${POPUP_ID} .log-content .log-debug { opacity: 0.7; font-size: 0.9em; font-weight: normal; }\n            #${POPUP_ID} .settings-row { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 5px;}\n            #${POPUP_ID} .log-controls, #${POPUP_ID} .sort-options { display: flex; align-items: center; gap: 3px; }\n            #${POPUP_ID} label { display: flex; align-items: center; gap: 2px; font-size: 0.9em; opacity: 0.9;}\n            #${POPUP_ID} .sort-divider { border-left: 1px solid; height: 16px; opacity: 0.3; }\n            \n            #${POPUP_ID} .lorebook-control-row { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; flex-grow: 1; }\n            #${POPUP_ID} .lorebook-control-row label, #${POPUP_ID} .lorebook-control-row .sync-btn { flex-shrink: 0; }\n            #${POPUP_ID} .custom-select { position: relative; flex: 1; min-width: 80px; }\n            #${POPUP_ID} .custom-select-input { width: 100%; box-sizing: border-box; cursor: pointer; padding-right: 25px; }\n            #${POPUP_ID} .custom-select-options { position: absolute; top: 100%; left: 0; right: 0; max-height: 200px; overflow-y: auto; z-index: 10001; border-radius: 0 0 6px 6px; display: none; }\n            #${POPUP_ID} .custom-select-option { padding: 8px 12px; cursor: pointer; }\n            #${POPUP_ID} .sync-btn { padding: 4px 8px; font-size: 1.2em; line-height: 1; flex-shrink: 0;}\n            \n            #${POPUP_ID} .manager-control-panel { flex-shrink: 0; margin: 15px; }\n            #${POPUP_ID} .manager-list-container { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; padding: 0 15px 15px; position: relative; }\n            #${POPUP_ID} .manager-list-container::before { content: ''; position: absolute; top: 0; left: 15px; right: 15px; height: 15px; background: linear-gradient(to bottom, rgba(0,0,0,0.1), transparent); opacity: 0; transition: opacity 0.2s; pointer-events: none; z-index: 10; }\n            #${POPUP_ID} .manager-list-container.scrolled::before { opacity: 1; }\n            #${POPUP_ID} .manager-list { flex-grow: 1; overflow-y: auto; padding-right: 5px; }\n            #${POPUP_ID} .manager-list-container .loading-spinner, #${POPUP_ID} .manager-list-container .empty-message { text-align: center; padding: 20px; opacity: 0.7; }\n            #${POPUP_ID} .manager-entry-card { display: flex; align-items: stretch; margin-bottom: 5px; }\n            #${POPUP_ID} .manager-entry-card.is-deleted { opacity: 0.5; text-decoration: line-through; pointer-events: none; }\n            #${POPUP_ID} .manager-entry-card.is-newly-created .card-main-content { animation: highlight-new 1.5s ease-out; }\n            #${POPUP_ID} .indent-guides { display: flex; flex-shrink: 0; }\n            #${POPUP_ID} .guide-line { width: 20px; position: relative; }\n            #${POPUP_ID} .guide-line::before { content: ''; position: absolute; top: -4px; height: calc(100% + 8px); left: 9px; width: 1px; opacity: 0.7;}\n            #${POPUP_ID} .card-main-content { display: flex; flex-direction: column; flex-grow: 1; border-radius: 6px; z-index: 1; position: relative; }\n            #${POPUP_ID} .card-main-content.is-container { border-left-width: 4px; border-left-style: solid; }\n            #${POPUP_ID} .card-header { display: grid; grid-template-columns: 1fr auto; gap: 15px; align-items: center; padding: 6px 10px; }\n            #${POPUP_ID} .card-header .header-left { grid-column: 1; display: flex; align-items: center; gap: 8px; min-width: 200px; }\n            #${POPUP_ID} .card-header .header-right { grid-column: 2; display: grid; grid-template-columns: auto auto auto; gap: 10px; align-items: center; }\n            #${POPUP_ID} .card-header .drag-handle { cursor: grab; opacity: 0.6; }\n            #${POPUP_ID} .card-header .expand-btn, #${POPUP_ID} .card-header .action-btn, #${POPUP_ID} .card-meta-row .info-stack .action-btn { background: none; border: none; opacity: 0.6; cursor: pointer; padding: 2px; }\n            #${POPUP_ID} .card-header .action-btn:hover, #${POPUP_ID} .card-header .expand-btn:hover, #${POPUP_ID} .card-meta-row .info-stack .action-btn:hover { opacity: 1; }\n            #${POPUP_ID} .card-header .comment-text { white-space: nowrap; overflow: auto; }\n            #${POPUP_ID} .order-display, #${POPUP_ID} .display-index-display, #${POPUP_ID} .uid-display { font-size: 0.8em; opacity: 0.7; white-space: nowrap; overflow-x: auto; }\n            #${POPUP_ID} .info-stack { display: flex; text-align: left; gap: 10px; }\n            #${POPUP_ID} .action-buttons { display: flex; gap: 4px; }\n            #${POPUP_ID} .order-display, #${POPUP_ID} .display-index-display { min-width: 60px; }\n            #${POPUP_ID} .uid-display { min-width: 60px; text-align: right; }\n            #${POPUP_ID} .uid-display.is-temp-uid { font-weight: bold; }\n            #${POPUP_ID} .manager-toggle-switch { position: relative; display: inline-block; width: 34px; height: 20px; flex-shrink: 0;}\n            #${POPUP_ID} .manager-toggle-switch input { opacity: 0; width: 0; height: 0; }\n            #${POPUP_ID} .manager-toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; border-radius: 20px; transition: .4s; }\n            #${POPUP_ID} .manager-toggle-slider:before { position: absolute; content: \"\"; height: 16px; width: 16px; left: 2px; bottom: 2px; border-radius: 50%; transition: transform 0.4s; }\n            #${POPUP_ID} .batch-actions-toolbar, #${POPUP_ID} .batch-modify-group { display: flex; align-items: center; gap: 4px; flex-wrap: wrap; }\n            #${POPUP_ID} .batch-actions-toolbar button { padding: 6px 10px; font-size: 0.9em; }\n            #${POPUP_ID} #batch-modify-input { width: 100px; text-align: center; }\n            #${POPUP_ID} #resort-btn.needs-resort { animation: pulse-glow 1.5s infinite; }\n            #${POPUP_ID} input[type=\"checkbox\"] { appearance: none; -webkit-appearance: none; width: 16px; height: 16px; border-radius: 3px; cursor: pointer; position: relative; flex-shrink: 0; }\n            #${POPUP_ID} input[type=\"checkbox\"]:checked::before { content: '\\\\2713'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 14px; font-weight: bold; }\n            #${POPUP_ID} .editable-field { display: flex; align-items: center; gap: 3px; justify-content: start; }\n            #${POPUP_ID} .inline-edit-input { width: 45px; text-align: center; padding: 2px 4px !important; font-size: 0.9em !important; height: auto !important; }\n            #${POPUP_ID} .card-meta-row { display: none; }\n\n            @keyframes highlight-new { from { background-color: rgba(138, 127, 255, 0.5); } to { background-color: transparent; } }\n            @keyframes pulse-glow { 0% { box-shadow: 0 0 0 0 rgba(138, 127, 255, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(138, 127, 255, 0); } 100% { box-shadow: 0 0 0 0 rgba(138, 127, 255, 0); } }\n\n            @media (max-width: 900px) {\n                #${POPUP_ID} .popup-content { width: 95vw; max-width: 1400px; height: 83vh; }\n                #${POPUP_ID} .compiler-content-wrapper {\n                    grid-template-columns: 1fr;\n                    grid-template-rows: auto 3fr 2fr;\n                    overflow-x: auto;\n                }\n                #${POPUP_ID} .control-panel { grid-area: 1 / 1 / 2 / 2; }\n                #${POPUP_ID} .preview-panel { grid-area: 2 / 1 / 3 / 2; }\n                #${POPUP_ID} .log-panel { grid-area: 3 / 1 / 4 / 2; }\n            }\n             @media (max-width: 768px) {\n                #${POPUP_ID} .panel-main-controls { flex-direction: column; align-items: stretch; }\n                #${POPUP_ID} .batch-actions-toolbar { justify-content: flex-start; }\n                #${POPUP_ID} .settings-row { justify-content: flex-start; }\n                #${POPUP_ID} .sort-options { flex-wrap: wrap; }\n\n                /* Card Layout responsive rules */\n                #${POPUP_ID} .card-header .header-right { gap: 0px; }\n                #${POPUP_ID} .card-header .header-right .info-stack,\n                #${POPUP_ID} .card-header .header-right .uid-display {\n                    display: none; /* Hide meta info from the first row on narrow screens */\n                }\n                #${POPUP_ID} .card-meta-row {\n                    display: flex;\n                    justify-content: space-between;\n                    align-items: center;\n                    border-top: 1px solid rgba(128, 128, 128, 0.2);\n                    padding: 1px 10px;\n                    overflow-x: auto;\n                    gap: 2px;\n                }\n                #${POPUP_ID} .card-meta-row .info-stack,\n                #${POPUP_ID} .card-meta-row .uid-display {\n                    flex-shrink: 0; /* Prevent meta info from shrinking */\n                }\n            }\n\n            /* --- v0.2.1 新增样式 --- */\n            #${POPUP_ID} .expand-btn i { transition: transform 0.3s; }\n            #${POPUP_ID} .expand-btn.is-expanded i { transform: rotate(180deg); }\n            #${POPUP_ID} .card-content-editor {\n                padding: 10px;\n                border-top: 1px solid rgba(128, 128, 128, 0.2);\n                display: flex;\n                flex-direction: column;\n                gap: 8px;\n            }\n            #${POPUP_ID} .card-content-editor label {\n                opacity: 0.8;\n                font-size: 0.85em;\n                font-weight: bold;\n            }\n            #${POPUP_ID} .card-content-editor textarea.content-editor-textarea {\n                min-height: 80px;\n                height: auto;\n                resize: vertical;\n                font-family: 'Source Code Pro', 'Courier New', monospace;\n            }\n            #${POPUP_ID} .card-content-editor input.keys-editor-input {\n                font-family: 'Source Code Pro', 'Courier New', monospace;\n            }\n            #${POPUP_ID} .inline-edit-input.comment-edit-input {\n                flex-grow: 1;\n                min-width: 100px;\n                text-align: left; important!\n            }\n            #${POPUP_ID} .comment-text-wrapper {\n                display: flex;\n                align-items: center;\n                gap: 5px;\n                flex-grow: 1;\n                min-width: 0; /* Fix flexbox overflow issue */\n            }\n            #${POPUP_ID} .comment-text-wrapper .comment-text {\n                flex-grow: 1;\n            }\n            #${POPUP_ID} .card-header .edit-comment-confirm-cancel-group {\n                display: flex;\n                gap: 4px;\n            }\n            /* --- v0.2.1-stage2 新增样式 --- */\n            #${POPUP_ID} .editable-field.is-duplicate-value span,\n            #${POPUP_ID} .editable-field.is-duplicate-value input {\n                font-weight: bold;\n                color: #f28b82; /* Use a theme color variable for better consistency later */\n                text-shadow: 0 0 5px rgba(242, 139, 130, 0.5);\n            }\n        `;\n\n        const smartTheme = `\n            #${POPUP_ID}.theme-smart { background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(2px); -webkit-backdrop-filter: blur(2px); }\n            #${POPUP_ID}.theme-smart .popup-content { background-color: var(--SmartThemeBlurTintColor, #FFFFFF); color: var(--SmartThemeBodyColor, #111111); border: 1px solid var(--grey5050a, rgba(128, 128, 128, 0.3)); }\n            #${POPUP_ID}.theme-smart .popup-header { border-bottom: 1px solid var(--grey5050a, rgba(128, 128, 128, 0.3)); }\n            #${POPUP_ID}.theme-smart .popup-header .header-icon-btn, #${POPUP_ID}.theme-smart .close-btn { color: var(--SmartThemeBodyColor); }\n            #${POPUP_ID}.theme-smart .nav-menu, #${POPUP_ID}.theme-smart .nav-submenu { background-color: var(--SmartThemeBlurTintColor); border: 1px solid var(--grey5050a); }\n            #${POPUP_ID}.theme-smart .nav-item:hover, #${POPUP_ID}.theme-smart .nav-sub-item:hover { background-color: var(--grey5020a); }\n            #${POPUP_ID}.theme-smart .nav-item.active { background-color: color-mix(in srgb, var(--SmartThemeQuoteColor) 20%, transparent); }\n            #${POPUP_ID}.theme-smart .panel { border: 1px solid var(--SmartThemeQuoteColor); background-color: var(--grey5020a, rgba(80, 80, 80, 0.1)); }\n            #${POPUP_ID}.theme-smart .panel-drawer-toggle { background-color: var(--grey5020a); }\n            #${POPUP_ID}.theme-smart button { background-color: var(--grey5020a, rgba(128, 128, 128, 0.2)); color: var(--SmartThemeBodyColor, #111111); }\n            #${POPUP_ID}.theme-smart button.primary { background-color: var(--SmartThemeQuoteColor, #3498db); color: #FFFFFF; border-color: var(--SmartThemeQuoteColor, #3498db); }\n            #${POPUP_ID}.theme-smart #initvar-quick-inject-btn { background-color: color-mix(in srgb, var(--SmartThemeQuoteColor) 85%, sienna 15%); color: white; }\n            #${POPUP_ID}.theme-smart #initvar-copy-btn { background-color: var(--grey5050a); }\n            #${POPUP_ID}.theme-smart textarea, #${POPUP_ID}.theme-smart .log-content, #${POPUP_ID}.theme-smart .custom-select-input, #${POPUP_ID}.theme-smart input[type=\"text\"], #${POPUP_ID}.theme-smart input[type=\"number\"], #${POPUP_ID}.theme-smart select { background-color: var(--grey5020a, rgba(125, 125, 125, 0.2)) !important; border: 1px solid var(--SmartThemeQuoteColor) !important; color: var(--SmartThemeBodyColor); border-radius: 4px; padding: 4px 6px; }\n            #${POPUP_ID}.theme-smart input[type=\"checkbox\"] { border-color: var(--SmartThemeQuoteColor) !important; }\n            #${POPUP_ID}.theme-smart input[type=\"checkbox\"]:checked::before { color: var(--SmartThemeQuoteColor) !important; }\n            #${POPUP_ID}.theme-smart input[type=\"text\"]:disabled, #${POPUP_ID}.theme-smart input[type=\"number\"]:disabled { background-color: var(--grey5050a) !important; color: var(--grey50) !important; }\n            #${POPUP_ID}.theme-smart .custom-select-options { background-color: var(--SmartThemeBlurTintColor, #FFFFFF); border: 1px solid var(--SmartThemeQuoteColor); border-top: none; }\n            #${POPUP_ID}.theme-smart .custom-select-option:hover { background-color: var(--grey5020a, rgba(125,125,125,0.2)); }\n            #${POPUP_ID}.theme-smart .log-content .log-success { color: color-mix(in srgb, #27ae60 90%, black); background-color: rgba(46, 204, 113, 0.15); }\n            #${POPUP_ID}.theme-smart .log-content .log-error { color: color-mix(in srgb, #c0392b 90%, black); background-color: rgba(231, 76, 60, 0.15); }\n            #${POPUP_ID}.theme-smart .guide-line::before { background-color: var(--level-color); }\n            #${POPUP_ID}.theme-smart .card-main-content { background-color: var(--grey5020a, rgba(80,80,80,0.1)); }\n            #${POPUP_ID}.theme-smart .card-main-content.is-container { border-left-color: rgba(from var(--SmartThemeQuoteColor) r g b / calc(0.9 - var(--depth) * 0.15)); }\n            #${POPUP_ID}.theme-smart .card-main-content.is-meta { border-left-color: var(--meta-border-color); }\n            #${POPUP_ID}.theme-smart .card-main-content.is-template { border-left-color: var(--template-border-color); }\n            #${POPUP_ID}.theme-smart .uid-display.is-temp-uid { color: var(--SmartThemeQuoteColor); }\n            #${POPUP_ID}.theme-smart .manager-toggle-slider { background-color: var(--grey5050a); }\n            #${POPUP_ID}.theme-smart .manager-toggle-slider:before { background-color: var(--SmartThemeBlurTintColor); }\n            #${POPUP_ID}.theme-smart input:checked + .manager-toggle-slider { background-color: var(--SmartThemeQuoteColor); }\n            #${POPUP_ID}.theme-smart input:checked + .manager-toggle-slider:before { transform: translateX(14px); }\n        `;\n\n        const lightTheme = `\n            #${POPUP_ID}.theme-light_warm { background-color: rgba(80, 50, 20, 0.3); backdrop-filter: blur(2px); -webkit-backdrop-filter: blur(2px); }\n            #${POPUP_ID}.theme-light_warm .popup-content { background-color: #FFFBF5; color: #4D3D3D; border: 1px solid #DCD1C0; }\n            #${POPUP_ID}.theme-light_warm .popup-header { border-bottom: 1px solid #DCD1C0; }\n            #${POPUP_ID}.theme-light_warm .popup-header .header-icon-btn, #${POPUP_ID}.theme-light_warm .close-btn { color: #4D3D3D; }\n            #${POPUP_ID}.theme-light_warm .nav-menu, #${POPUP_ID}.theme-light_warm .nav-submenu { background-color: #FFFBF5; border: 1px solid #DCD1C0; }\n            #${POPUP_ID}.theme-light_warm .nav-item:hover, #${POPUP_ID}.theme-light_warm .nav-sub-item:hover { background-color: rgba(255, 245, 230, 0.8); }\n            #${POPUP_ID}.theme-light_warm .nav-item.active { background-color: #F8F0E5; }\n            #${POPUP_ID}.theme-light_warm .panel { border: 1px solid #DCD1C0; background-color: rgba(255, 245, 230, 0.6); }\n            #${POPUP_ID}.theme-light_warm .panel-drawer-toggle { background-color: rgba(255, 245, 230, 0.8); }\n            #${POPUP_ID}.theme-light_warm button { background-color: rgba(120, 80, 50, 0.1); color: #4D3D3D; }\n            #${POPUP_ID}.theme-light_warm button.primary { background-color: #D99B66; color: #FFFFFF; border-color: #D99B66; }\n            #${POPUP_ID}.theme-light_warm #initvar-quick-inject-btn { background-color: color-mix(in srgb, #C0A080 85%, sienna 15%); color: white; }\n            #${POPUP_ID}.theme-light_warm #initvar-copy-btn { background-color: #DCD1C0; }\n            #${POPUP_ID}.theme-light_warm textarea, #${POPUP_ID}.theme-light_warm .log-content, #${POPUP_ID}.theme-light_warm .custom-select-input, #${POPUP_ID}.theme-light_warm input[type=\"text\"], #${POPUP_ID}.theme-light_warm input[type=\"number\"], #${POPUP_ID}.theme-light_warm select { background-color: #FDF6EC !important; border: 1px solid #DCD1C0 !important; color: #4D3D3D !important; border-radius: 4px; padding: 4px 6px; }\n            #${POPUP_ID}.theme-light_warm input[type=\"checkbox\"] { border-color: #C0A080 !important; }\n            #${POPUP_ID}.theme-light_warm input[type=\"checkbox\"]:checked::before { color: #C0A080 !important; }\n            #${POPUP_ID}.theme-light_warm input[type=\"text\"]:disabled, #${POPUP_ID}.theme-light_warm input[type=\"number\"]:disabled { background-color: #F8F0E5 !important; color: #9E8E8E !important; }\n            #${POPUP_ID}.theme-light_warm .custom-select-options { background-color: #FFFBF5; border: 1px solid #DCD1C0; border-top: none; }\n            #${POPUP_ID}.theme-light_warm .custom-select-option:hover { background-color: rgba(255, 245, 230, 0.8); }\n            #${POPUP_ID}.theme-light_warm .log-content .log-success { color: color-mix(in srgb, #1a6e2f 90%, black); background-color: rgba(40, 167, 69, 0.15); }\n            #${POPUP_ID}.theme-light_warm .log-content .log-error { color: color-mix(in srgb, #a12323 90%, black); background-color: rgba(220, 53, 69, 0.15); }\n            #${POPUP_ID}.theme-light_warm .guide-line::before { background-color: var(--level-color); }\n            #${POPUP_ID}.theme-light_warm .card-main-content { background-color: rgba(255, 245, 230, 0.6); }\n            #${POPUP_ID}.theme-light_warm .card-main-content.is-container { border-left-color: rgba(192, 160, 128, calc(0.9 - var(--depth) * 0.15)); }\n            #${POPUP_ID}.theme-light_warm .card-main-content.is-meta { border-left-color: var(--meta-border-color); }\n            #${POPUP_ID}.theme-light_warm .card-main-content.is-template { border-left-color: var(--template-border-color); }\n            #${POPUP_ID}.theme-light_warm .uid-display.is-temp-uid { color: #C0A080; }\n            #${POPUP_ID}.theme-light_warm .manager-toggle-slider { background-color: #DCD1C0; }\n            #${POPUP_ID}.theme-light_warm .manager-toggle-slider:before { background-color: #FFFBF5; }\n            #${POPUP_ID}.theme-light_warm input:checked + .manager-toggle-slider { background-color: #C0A080; }\n            #${POPUP_ID}.theme-light_warm input:checked + .manager-toggle-slider:before { transform: translateX(14px); }\n        `;\n\n        const darkTheme = `\n            #${POPUP_ID}.theme-dark_cool { background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(2px); -webkit-backdrop-filter: blur(2px); }\n            #${POPUP_ID}.theme-dark_cool .popup-content { background-color: #2C2C3E; color: #EAEAF0; border: 1px solid #4A4A68; }\n            #${POPUP_ID}.theme-dark_cool .popup-header { border-bottom: 1px solid #4A4A68; }\n            #${POPUP_ID}.theme-dark_cool .popup-header .header-icon-btn, #${POPUP_ID}.theme-dark_cool .close-btn { color: #EAEAF0; }\n            #${POPUP_ID}.theme-dark_cool .nav-menu, #${POPUP_ID}.theme-dark_cool .nav-submenu { background-color: #383850; border: 1px solid #4A4A68; }\n            #${POPUP_ID}.theme-dark_cool .nav-item:hover, #${POPUP_ID}.theme-dark_cool .nav-sub-item:hover { background-color: rgba(80, 80, 100, 0.8); }\n            #${POPUP_ID}.theme-dark_cool .nav-item.active { background-color: #4A4A68; }\n            #${POPUP_ID}.theme-dark_cool .panel { border: 1px solid #4A4A68; background-color: rgba(50, 50, 70, 0.5); }\n            #${POPUP_ID}.theme-dark_cool .panel-drawer-toggle { background-color: rgba(50, 50, 70, 0.8); }\n            #${POPUP_ID}.theme-dark_cool button { background-color: rgba(100, 100, 140, 0.3); color: #EAEAF0; }\n            #${POPUP_ID}.theme-dark_cool button.primary { background-color: #8A7FFF; color: #FFFFFF; border-color: #8A7FFF; }\n            #${POPUP_ID}.theme-dark_cool #initvar-quick-inject-btn { background-color: color-mix(in srgb, #8A7FFF 85%, sienna 15%); color: white; }\n            #${POPUP_ID}.theme-dark_cool #initvar-copy-btn { background-color: #4A4A68; }\n            #${POPUP_ID}.theme-dark_cool textarea, #${POPUP_ID}.theme-dark_cool .log-content, #${POPUP_ID}.theme-dark_cool .custom-select-input, #${POPUP_ID}.theme-dark_cool input[type=\"text\"], #${POPUP_ID}.theme-dark_cool input[type=\"number\"], #${POPUP_ID}.theme-dark_cool select { background-color: rgba(20, 20, 30, 0.5) !important; border: 1px solid #4A4A68 !important; color: #EAEAF0 !important; border-radius: 4px; padding: 4px 6px; }\n            #${POPUP_ID}.theme-dark_cool input[type=\"checkbox\"] { border-color: #8A7FFF !important; }\n            #${POPUP_ID}.theme-dark_cool input[type=\"checkbox\"]:checked::before { color: #8A7FFF !important; }\n            #${POPUP_ID}.theme-dark_cool input[type=\"text\"]:disabled, #${POPUP_ID}.theme-dark_cool input[type=\"number\"]:disabled { background-color: #222230 !important; color: #7A7A88 !important; }\n            #${POPUP_ID}.theme-dark_cool .custom-select-options { background-color: #2C2C3E; border: 1px solid #4A4A68; border-top: none; }\n            #${POPUP_ID}.theme-dark_cool .custom-select-option:hover { background-color: rgba(50, 50, 70, 0.8); }\n            #${POPUP_ID}.theme-dark_cool .log-content .log-success { color: #39FF14; background-color: rgba(57, 255, 20, 0.15); }\n            #${POPUP_ID}.theme-dark_cool .log-content .log-error { color: #FF2D2D; background-color: rgba(255, 45, 45, 0.15); }\n            #${POPUP_ID}.theme-dark_cool .guide-line::before { background-color: var(--level-color); }\n            #${POPUP_ID}.theme-dark_cool .card-main-content { background-color: rgba(50, 50, 70, 0.5); }\n            #${POPUP_ID}.theme-dark_cool .card-main-content.is-container { border-left-color: rgba(138, 127, 255, calc(0.9 - var(--depth) * 0.15)); }\n            #${POPUP_ID}.theme-dark_cool .card-main-content.is-meta { border-left-color: var(--meta-border-color); }\n            #${POPUP_ID}.theme-dark_cool .card-main-content.is-template { border-left-color: var(--template-border-color); }\n            #${POPUP_ID}.theme-dark_cool .uid-display.is-temp-uid { color: #8A7FFF; }\n            #${POPUP_ID}.theme-dark_cool .manager-toggle-slider { background-color: #4A4A68; }\n            #${POPUP_ID}.theme-dark_cool .manager-toggle-slider:before { background-color: #2C2C3E; }\n            #${POPUP_ID}.theme-dark_cool input:checked + .manager-toggle-slider { background-color: #8A7FFF; }\n            #${POPUP_ID}.theme-dark_cool input:checked + .manager-toggle-slider:before { transform: translateX(14px); }\n        `;\n\n        return baseStyle + smartTheme + lightTheme + darkTheme;\n    }\n\n    function getPopupHtml() {\n        const getSortOptionsHtml = (prefix, state) => `\n            <div class=\"sort-options\">\n                <label>排序:</label>\n                <label><input type=\"radio\" name=\"${prefix}_sort_by\" value=\"order\" ${state.sortBy === 'order' ? 'checked' : ''}>order</label>\n                <label><input type=\"radio\" name=\"${prefix}_sort_by\" value=\"display_index\" ${state.sortBy === 'display_index' ? 'checked' : ''}>display_index</label>\n                <div class=\"sort-divider\"></div>\n                <label><input type=\"radio\" name=\"${prefix}_sort_dir\" value=\"asc\" ${state.sortDirection === 'asc' ? 'checked' : ''}><i class=\"fa-solid fa-arrow-up-short-wide\" title=\"从小到大\"></i></label>\n                <label><input type=\"radio\" name=\"${prefix}_sort_dir\" value=\"desc\" ${state.sortDirection === 'desc' ? 'checked' : ''}><i class=\"fa-solid fa-arrow-down-wide-short\" title=\"从大到小\"></i></label>\n            </div>\n        `;\n\n        return `\n            <div class=\"popup-content\">\n                <div class=\"popup-header\">\n                    <div class=\"header-nav\">\n                        <button id=\"nav-btn\" class=\"header-icon-btn\" title=\"菜单\"><i class=\"fa-solid fa-bars\"></i></button>\n                        <div id=\"nav-menu\" class=\"nav-menu\">\n                            <div class=\"nav-item active\" data-tab=\"compiler\">编译器</div>\n                            <div class=\"nav-item\" data-tab=\"manager\">管理器</div>\n                            <div class=\"nav-item has-submenu\">\n                                <span>UI设定 <i class=\"fa-solid fa-chevron-right\" style=\"font-size: 0.8em;\"></i></span>\n                                <div class=\"nav-submenu\">\n                                    <div class=\"nav-sub-item\" data-theme=\"smart\">智能适应</div>\n                                    <div class=\"nav-sub-item\" data-theme=\"light_warm\">亮暖</div>\n                                    <div class=\"nav-sub-item\" data-theme=\"dark_cool\">暗冷</div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                    <span id=\"popup-title\" class=\"header-title\">${BUTTON_TEXT}</span>\n                    <div class=\"header-close\">\n                        <i id=\"initvar-popup-close\" class=\"fa-solid fa-times close-btn\" title=\"关闭\"></i>\n                    </div>\n                </div>\n                <div class=\"popup-body-container\">\n                    <div id=\"compiler-content\" class=\"tab-content active\">\n                        <div class=\"compiler-content-wrapper\">\n                             <div class=\"control-panel panel\">\n                                <div class=\"panel-main-controls\">\n                                     <div class=\"lorebook-control-row\">\n                                        <label>世界书:</label>\n                                        <div id=\"compiler-custom-select\" class=\"custom-select\"></div>\n                                        <button id=\"compiler-sync-btn\" class=\"sync-btn\" title=\"将管理器的世界书同步到此\">&#8644;</button>\n                                    </div>\n                                </div>\n                                <div class=\"panel-drawer-content\">\n                                    <div class=\"control-buttons\">\n                                        <button id=\"initvar-compile-btn\" class=\"primary\"><i class=\"fa-solid fa-cogs\"></i> 编译</button>\n                                        <button id=\"initvar-inject-btn\" disabled><i class=\"fa-solid fa-syringe\"></i> 注入</button>\n                                        <button id=\"initvar-quick-inject-btn\" title=\"直接编译并注入\"><i class=\"fa-solid fa-bolt\"></i></button>\n                                        <button id=\"initvar-reset-btn\" title=\"清空结果和日志\"><i class=\"fa-solid fa-eraser\"></i> 清空</button>\n                                    </div>\n                                    <div class=\"settings-row\">\n                                        ${getSortOptionsHtml('compiler', { sortBy: uiState.compilerSortBy, sortDirection: uiState.compilerSortDirection })}\n                                    </div>\n                                </div>\n                                <div class=\"panel-drawer-toggle\"><i class=\"fa-solid fa-caret-down\"></i></div>\n                            </div>\n                            <div class=\"preview-panel panel\">\n                                <div class=\"panel-header-flex\">\n                                    <p class=\"panel-title\">结果预览</p>\n                                    <button id=\"initvar-copy-btn\" title=\"浏览器可能因安全策略限制此功能\" disabled><i class=\"fa-solid fa-copy\"></i></button>\n                                </div>\n                                <textarea id=\"initvar-preview-area\" readonly>请点击“编译”按钮以生成[InitVar]预览...</textarea>\n                            </div>\n                            <div class=\"log-panel panel\">\n                                <div class=\"panel-header-flex\">\n                                    <p class=\"panel-title\">日志 (${SCRIPT_VERSION})</p>\n                                    <div class=\"log-controls\">\n                                        <label><input type=\"checkbox\" id=\"initvar-autoscroll-toggle\" ${uiState.autoScrollLogs ? 'checked' : ''}> 自动滚动</label>\n                                        <label><input type=\"checkbox\" id=\"initvar-debug-log-toggle\" ${uiState.showDebugLogs ? 'checked' : ''}> 显示调试</label>\n                                    </div>\n                                </div>\n                                <div id=\"initvar-log-area\" class=\"log-content\"></div>\n                            </div>\n                        </div>\n                    </div>\n                    <div id=\"manager-content\" class=\"tab-content\">\n                         <div class=\"manager-content-wrapper\">\n                            <div class=\"manager-control-panel control-panel panel\">\n                               <div class=\"panel-main-controls\">\n                                    <div class=\"lorebook-control-row\">\n                                        <label>世界书:</label>\n                                        <div id=\"manager-custom-select\" class=\"custom-select\"></div>\n                                        <button id=\"manager-sync-btn\" class=\"sync-btn\" title=\"将编译器的世界书同步到此\">&#8644;</button>\n                                    </div>\n\n                                    <div class=\"control-buttons\">\n\n                                        <button id=\"add-new-entry-btn\"><i class=\"fa-solid fa-plus\"></i> 新建条目</button>\n\n                                        <button id=\"reload-manager-btn\" title=\"从世界书重新加载所有条目，未保存的更改将丢失\"><i class=\"fa-solid fa-sync\"></i> 刷新</button>\n                                        <button id=\"resort-btn\"><i class=\"fa-solid fa-arrows-rotate\"></i> 重新排序</button>\n                                        <button id=\"save-manager-changes-btn\" class=\"primary\" disabled>保存更改</button>\n                                    </div>\n                                </div>\n                                <div class=\"panel-drawer-content\">\n                                    <div id=\"batch-actions-toolbar\" class=\"batch-actions-toolbar\">\n                                        <input type=\"checkbox\" id=\"select-all-checkbox\" title=\"全选/取消全选\">\n                                        <button id=\"batch-copy-btn\" disabled><i class=\"fa-solid fa-copy\"></i> 复制</button>\n                                        <button id=\"batch-delete-btn\" disabled><i class=\"fa-solid fa-trash\"></i> 删除</button>\n                                        <button id=\"batch-enable-btn\" disabled>启用</button>\n                                        <button id=\"batch-disable-btn\" disabled>禁用</button>\n                                        <div class=\"batch-modify-group\">\n                                            <select id=\"batch-modify-target\" disabled>\n                                                <option value=\"order\">Order</option>\n                                                <option value=\"display_index\">Display Index</option>\n                                                <option value=\"order_and_index\">Order & Index</option>\n                                            </select>\n                                            <input type=\"text\" id=\"batch-modify-input\" placeholder=\"+10, -10, =100\" title=\"输入 +n, -n, 或 =n 来修改\" disabled>\n                                            <button id=\"batch-apply-modify-btn\" disabled>应用</button>\n                                        </div>\n                                    </div>\n                                    <div class=\"settings-row\">\n                                        ${getSortOptionsHtml('manager', { sortBy: uiState.managerSortBy, sortDirection: uiState.managerSortDirection })}\n                                    </div>\n                                    <div class=\"settings-row\">\n                                        <label title=\"所有名称、order、idx都将直接显示为输入框，无需点击编辑按钮\"><input type=\"checkbox\" id=\"instant-edit-toggle\"> 开启即时编辑模式</label>\n                                    </div>\n                                    <div class=\"settings-row\">\n                                        <label>同步排序值:</label>\n                                        <div class=\"control-buttons\">\n                                            <button id=\"sync-order-to-idx-btn\" title=\"将所有条目的 order 值同步到 display_index\">order &rarr; idx</button>\n                                            <button id=\"sync-idx-to-order-btn\" title=\"将所有条目的 display_index 值同步到 order\">idx &rarr; order</button>\n                                        </div>\n                                    </div>\n                                </div>\n                               <div class=\"panel-drawer-toggle\"><i class=\"fa-solid fa-caret-down\"></i></div>\n                            </div>\n                            <div class=\"manager-list-container\">\n                                <div class=\"manager-list scrollable\"></div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    }\n    \n    // v0.2.0: 渲染与更新\n\n// --- v0.2.1 新增: 渲染单个卡片 ---\n    function renderSingleCard(entry, duplicateOrders, duplicateIdxs) {\n        const comment = (entry.comment || '').trim();\n        const isContainer = comment.includes('<');\n        const isMeta = comment === '<meta>' || comment === '</meta>';\n        const isTemplate = comment === '<template>' || comment === '</template>';\n        \n        let guidesHtml = '';\n        for (let i = 0; i < entry._ui.depth; i++) {\n            const colorVar = `--level-color-${(i % 4) + 1}`;\n            guidesHtml += `<div class=\"guide-line\" style=\"--level-color: var(${colorVar});\"></div>`;\n        }\n        const isOrderDuplicate = duplicateOrders.has(entry.order);\n        const isEditingOrder = uiState.managerInstantEditMode || entry._ui.isEditing.field === 'order';\n        const orderHtml = isEditingOrder ? `\n            <input type=\"number\" class=\"inline-edit-input order-edit-input ${isOrderDuplicate ? 'is-duplicate-value' : ''}\" value=\"${entry.order ?? 0}\" data-uid=\"${entry.uid}\" data-field=\"order\">\n        ` : `\n            <span>order: ${entry.order ?? 'N/A'}</span>\n            <button class=\"action-btn edit-value-btn\" title=\"编辑order\"><i class=\"fa-solid fa-pencil\"></i></button>\n        `;\n\n        const isIdxDuplicate = duplicateIdxs.has(entry.display_index);\n        const isEditingIdx = uiState.managerInstantEditMode || entry._ui.isEditing.field === 'display_index';\n        const idxHtml = isEditingIdx ? `\n            <input type=\"number\" class=\"inline-edit-input display-index-edit-input ${isIdxDuplicate ? 'is-duplicate-value' : ''}\" value=\"${entry.display_index ?? 0}\" data-uid=\"${entry.uid}\" data-field=\"display_index\">\n        ` : `\n            <span>idx: ${entry.display_index ?? 'N/A'}</span>\n            <button class=\"action-btn edit-value-btn\" title=\"编辑display_index\"><i class=\"fa-solid fa-pencil\"></i></button>\n        `;\n        \n        const getMetaInfoHtml = () => `\n            <div class=\"info-stack\">\n                <div class=\"order-display editable-field ${isOrderDuplicate ? 'is-duplicate-value' : ''}\" data-uid=\"${entry.uid}\" data-field=\"order\">\n                    ${orderHtml}\n                </div>\n                <div class=\"display-index-display editable-field ${isIdxDuplicate ? 'is-duplicate-value' : ''}\" data-uid=\"${entry.uid}\" data-field=\"display_index\">\n                    ${idxHtml}\n                </div>\n            </div>\n            <div class=\"uid-display ${typeof entry.uid === 'string' ? 'is-temp-uid' : ''}\">uid: ${typeof entry.uid === 'string' ? 'new' : entry.uid}</div>\n        `;\n\n        const isEditingComment = uiState.managerInstantEditMode || entry._ui.isEditing.field === 'comment';\n        const commentHtml = isEditingComment ? `\n            <input type=\"text\" class=\"inline-edit-input comment-edit-input\" value=\"${escapeHtml(entry.comment)}\" data-uid=\"${entry.uid}\" data-field=\"comment\">\n        ` : `\n            <span class=\"comment-text\">${escapeHtml(entry.comment)}</span>\n        `;\n\n        const commentActionHtml = isEditingComment ? (uiState.managerInstantEditMode ? '' : `\n            <div class=\"edit-comment-confirm-cancel-group\">\n                <button class=\"action-btn confirm-comment-btn\" title=\"确认\"><i class=\"fa-solid fa-check\"></i></button>\n                <button class=\"action-btn cancel-comment-btn\" title=\"取消\"><i class=\"fa-solid fa-times\"></i></button>\n            </div>\n        `) : `\n            <button class=\"action-btn edit-comment-btn\" title=\"编辑名称\"><i class=\"fa-solid fa-pencil\"></i></button>\n        `;\n        \n        const contentEditorHtml = entry._ui.isExpanded ? `\n            <div class=\"card-content-editor\">\n                <label>Content (内容):</label>\n                <textarea class=\"content-editor-textarea\" data-uid=\"${entry.uid}\">${escapeHtml(entry.content)}</textarea>\n                <label>Keys (关键字, 英文逗号分隔):</label>\n                <input type=\"text\" class=\"keys-editor-input\" value=\"${escapeHtml((entry._raw?.strategy?.keys ?? []).join(', '))}\" data-uid=\"${entry.uid}\">\n            </div>\n        ` : '';\n\n        return `\n            <div class=\"manager-entry-card ${entry._ui.isDeleted ? 'is-deleted' : ''} ${entry._ui.isNew ? 'is-newly-created' : ''}\" data-uid=\"${entry.uid}\">\n                <div class=\"indent-guides\">${guidesHtml}</div>\n                <div class=\"card-main-content ${isContainer ? 'is-container' : ''} ${isMeta ? 'is-meta' : ''} ${isTemplate ? 'is-template' : ''}\" style=\"--depth: ${entry._ui.depth};\">\n                    <div class=\"card-header\">\n                        <div class=\"header-left\">\n                            <div class=\"drag-handle\"><i class=\"fa-solid fa-grip-vertical\"></i></div>\n                            <input type=\"checkbox\" class=\"entry-select-checkbox\" data-uid=\"${entry.uid}\" ${entry._ui.isSelected ? 'checked' : ''}>\n                            <label class=\"manager-toggle-switch\">\n                                <input type=\"checkbox\" class=\"entry-enable-toggle\" data-uid=\"${entry.uid}\" ${entry.enabled ? 'checked' : ''}>\n                                <span class=\"manager-toggle-slider\"></span>\n                            </label>\n                            <button class=\"expand-btn ${entry._ui.isExpanded ? 'is-expanded' : ''}\" data-uid=\"${entry.uid}\" title=\"展开/折叠详细编辑\"><i class=\"fa-solid fa-chevron-down\"></i></button>\n                            <div class=\"comment-text-wrapper\" data-uid=\"${entry.uid}\" data-field=\"comment\">\n                                ${commentHtml}\n                                ${commentActionHtml}\n                            </div>\n                        </div>\n                        <div class=\"header-right\">\n                            ${getMetaInfoHtml()}\n                            <div class=\"action-buttons\">\n                                <button class=\"action-btn copy-entry-btn\" data-uid=\"${entry.uid}\" title=\"复制此条目\"><i class=\"fa-solid fa-copy\"></i></button>\n                                <button class=\"action-btn delete-entry-btn\" data-uid=\"${entry.uid}\" title=\"删除此条目\"><i class=\"fa-solid fa-trash\"></i></button>\n                            </div>\n                        </div>\n                    </div>\n                    <div class=\"card-meta-row\">\n                        ${getMetaInfoHtml()}\n                    </div>\n                    ${contentEditorHtml}\n                </div>\n            </div>\n        `;\n    }\n\n    // --- v0.2.1 新增: 更新单个卡片的 DOM ---\n    function updateSingleCardDOM(uid) {\n        const parentDoc = window.parent.document;\n        const entry = uiState.managerEntries.find(e => e.uid === uid);\n        if (entry) {\n            const $card = $(`.manager-entry-card[data-uid=\"${uid}\"]`, parentDoc);\n            if ($card.length) {\n                // --- v0.2.1-fix1: 重新计算重复值以提供上下文 ---\n                const orderCounts = new Map();\n                const idxCounts = new Map();\n                const visibleEntries = uiState.managerEntries.filter(e => !e._ui.isDeleted);\n                visibleEntries.forEach(e => {\n                    if (typeof e.order === 'number') orderCounts.set(e.order, (orderCounts.get(e.order) || 0) + 1);\n                    if (typeof e.display_index === 'number') idxCounts.set(e.display_index, (idxCounts.get(e.display_index) || 0) + 1);\n                });\n                const duplicateOrders = new Set([...orderCounts.entries()].filter(([, count]) => count > 1).map(([order]) => order));\n                const duplicateIdxs = new Set([...idxCounts.entries()].filter(([, count]) => count > 1).map(([idx]) => idx));\n                \n                const newHtml = renderSingleCard(entry, duplicateOrders, duplicateIdxs);\n                $card.replaceWith(newHtml);\n            }\n        }\n    }\n\n    function renderManagerList() {\n        const parentDoc = window.parent.document;\n        const $listContainer = $('#manager-content .manager-list', parentDoc);\n        \n        if (uiState.isManagerLoading) {\n            $listContainer.html('<div class=\"loading-spinner\"><i class=\"fa fa-spinner fa-spin\"></i> 正在加载条目...</div>');\n            return;\n        }\n        // --- v0.2.1-stage2 新增: 检测重复的 order 和 idx ---\n        const orderCounts = new Map();\n        const idxCounts = new Map();\n        const visibleEntries = uiState.managerEntries.filter(e => !e._ui.isDeleted);\n        visibleEntries.forEach(e => {\n            if (typeof e.order === 'number') {\n                orderCounts.set(e.order, (orderCounts.get(e.order) || 0) + 1);\n            }\n            if (typeof e.display_index === 'number') {\n                idxCounts.set(e.display_index, (idxCounts.get(e.display_index) || 0) + 1);\n            }\n        });\n        const duplicateOrders = new Set([...orderCounts.entries()].filter(([, count]) => count > 1).map(([order]) => order));\n        const duplicateIdxs = new Set([...idxCounts.entries()].filter(([, count]) => count > 1).map(([idx]) => idx));\n        \n        const fragment = parentDoc.createDocumentFragment();\n        uiState.managerEntries.forEach(entry => {\n            const cardHtml = renderSingleCard(entry, duplicateOrders, duplicateIdxs);\n            const cardElement = $(cardHtml)[0];\n            fragment.appendChild(cardElement);\n        });\n\n        $listContainer.empty().append(fragment);\n    }\n\n    function updatePopupUI(logs = [], debugLogs = []) {\n        if (!uiState.isPopupOpen) return;\n        const parentDoc = window.parent.document;\n        \n        // Update Nav Menu\n        $('.nav-item', parentDoc).removeClass('active');\n        $(`.nav-item[data-tab=\"${uiState.activeTab}\"]`, parentDoc).addClass('active');\n\n        $('.tab-content', parentDoc).removeClass('active');\n        $(`#${uiState.activeTab}-content`, parentDoc).addClass('active');\n        $('#popup-title', parentDoc).text(uiState.activeTab === 'compiler' ? '[InitVar] 编译器' : '[InitVar] 管理器');\n\n        const $compileBtn = $('#initvar-compile-btn', parentDoc);\n        $compileBtn.prop('disabled', uiState.isCompiling);\n        $compileBtn.html(uiState.isCompiling ? '<i class=\"fa fa-spinner fa-spin\"></i> 编译中...' : '<i class=\"fa-solid fa-cogs\"></i> 编译');\n        \n        const hasResult = uiState.lastCompiledJson !== null;\n        $('#initvar-inject-btn', parentDoc).prop('disabled', !hasResult || uiState.isCompiling);\n        $('#initvar-copy-btn', parentDoc).prop('disabled', !hasResult || uiState.isCompiling);\n        $('#initvar-preview-area', parentDoc).val(uiState.lastCompiledJson || '请点击“编译”按钮以生成[InitVar]预览...');\n        \n        let allLogs = [...logs];\n        if (uiState.showDebugLogs) {\n            allLogs = [...allLogs, ...debugLogs];\n        }\n        \n        const $logArea = $('#initvar-log-area', parentDoc);\n        if (allLogs.length > 0) {\n            $logArea.html(allLogs.map(log => `<p class=\"log-${log.type}\">${escapeHtml(log.message)}</p>`).join(''));\n            if(uiState.autoScrollLogs) {\n                $logArea.scrollTop($logArea[0].scrollHeight);\n            }\n        }\n        \n        if(uiState.activeTab === 'manager') {\n            updateToolbarState();\n        }\n    }\n    \n    function resetPopupState() {\n        uiState.lastCompiledJson = null;\n        uiState.lastCompiledResult = null;\n        const parentDoc = window.parent.document;\n        $('#initvar-log-area', parentDoc).empty();\n        $('#initvar-preview-area', parentDoc).val('请点击“编译”按钮以生成[InitVar]预览...');\n        updatePopupUI();\n    }\n    \n    function setTheme(themeName) {\n        const parentDoc = window.parent.document;\n        uiState.activeTheme = themeName;\n        localStorage.setItem('initVarCompilerTheme', themeName);\n        $(`#${POPUP_ID}`, parentDoc)\n            .removeClass('theme-smart theme-light_warm theme-dark_cool')\n            .addClass(`theme-${themeName}`);\n    }\n    \n    async function loadLorebookToMemory(lorebookName) {\n        uiState.isManagerLoading = true;\n        renderManagerList();\n\n        try {\n            const rawEntries = await TavernHelper.getWorldbook(lorebookName);\n            if (!rawEntries) throw new Error(`无法加载世界书: ${lorebookName}`);\n            \n            let adaptedEntries = rawEntries.map((entry, index) => ({\n                uid: ensureNumericUID(entry.uid),\n                comment: entry.name,\n                content: entry.content,\n                enabled: entry.enabled,\n                order: entry.position?.order ?? 0,\n                display_index: index, \n                _raw: entry,\n            }));\n            \n            const sortKey = uiState.managerSortBy;\n            const direction = uiState.managerSortDirection === 'asc' ? 1 : -1;\n            adaptedEntries.sort((a, b) => {\n                const aVal = typeof a[sortKey] === 'number' ? a[sortKey] : -1;\n                const bVal = typeof b[sortKey] === 'number' ? b[sortKey] : -1;\n                return (aVal - bVal) * direction;\n            });\n            \n            uiState.managerEntries = recalculateDepths(adaptedEntries).map(entry => ({\n                ...entry,\n                _ui: {\n                    isSelected: false,\n                    isDirty: false,\n                    isDeleted: false,\n                    isNew: false,\n                    depth: entry._ui.depth,\n                    isVisible: true,\n                    // --- v0.2.1 新增 ---\n                    isExpanded: false,\n                    isEditing: { field: null },\n                }\n            }));\n            \n            checkUnsavedChanges();\n        } catch (error) {\n            console.error(`[InitVar管理器] 加载世界书失败:`, error);\n            toastr.error(`加载世界书 \"${lorebookName}\" 失败: ${error.message}`, '加载失败');\n            uiState.managerEntries = [];\n        } finally {\n            uiState.isManagerLoading = false;\n            renderManagerList();\n            updateToolbarState();\n        }\n    }\n    \n    function checkUnsavedChanges() {\n        uiState.managerHasUnsavedChanges = uiState.managerEntries.some(e => e._ui.isDirty);\n        $('#save-manager-changes-btn', window.parent.document).prop('disabled', !uiState.managerHasUnsavedChanges);\n    }\n    \n    function updateToolbarState() {\n        const selectedCount = uiState.managerEntries.filter(e => e._ui.isSelected && !e._ui.isDeleted).length;\n        const totalVisibleCount = uiState.managerEntries.filter(e => !e._ui.isDeleted).length;\n        \n        const $toolbar = $('#batch-actions-toolbar', window.parent.document);\n        const $selectAll = $('#select-all-checkbox', window.parent.document);\n        \n        if (selectedCount > 0) {\n            $toolbar.find('button, select, input[type=\"text\"]').prop('disabled', false);\n        } else {\n            $toolbar.find('button, select, input[type=\"text\"]').prop('disabled', true);\n        }\n        \n        if (totalVisibleCount > 0 && selectedCount === totalVisibleCount) {\n            $selectAll.prop('checked', true).prop('indeterminate', false);\n        } else if (selectedCount > 0) {\n            $selectAll.prop('checked', false).prop('indeterminate', true);\n        } else {\n            $selectAll.prop('checked', false).prop('indeterminate', false);\n        }\n    }\n\n    function recalculateDepths(entries) {\n        const stack = [];\n        const visibleEntries = entries.filter(e => !e._ui?.isDeleted);\n        const entryMap = new Map(entries.map(e => [e.uid, e]));\n\n        visibleEntries.forEach(entry => {\n            const comment = (entry.comment || '').trim();\n            const tagMatch = comment.match(/^<(\\/?)([^>]+)>$/);\n\n            if (tagMatch) {\n                const isClosingTag = !!tagMatch[1];\n                const tagName = tagMatch[2];\n                if (isClosingTag) {\n                    if (stack.length > 0 && stack[stack.length - 1] === tagName) {\n                        stack.pop();\n                    }\n                }\n            }\n            \n            if (!entry._ui) entry._ui = {};\n            entry._ui.depth = stack.length;\n\n            if (tagMatch && !tagMatch[1]) {\n                stack.push(tagMatch[2]);\n            }\n        });\n\n        // Apply depths back to the original full array\n        entries.forEach(entry => {\n            const mappedEntry = entryMap.get(entry.uid);\n            if (mappedEntry && mappedEntry._ui) {\n                entry._ui = { ...entry._ui, ...mappedEntry._ui };\n            }\n        });\n\n        return entries;\n    }\n\n    function cleanEntriesForSave(entries) {\n        return entries\n            .filter(entry => !entry._ui.isDeleted)\n            .map(entry => {\n                const finalEntry = { ...entry._raw };\n                \n                finalEntry.name = entry.comment;\n                finalEntry.content = entry.content;\n                finalEntry.enabled = entry.enabled;\n                if (!finalEntry.position) finalEntry.position = {};\n                finalEntry.position.order = entry.order;\n                \n                if (entry._ui.isNew) {\n                    delete finalEntry.uid;\n                }\n                return finalEntry;\n            });\n    }\n    \n    async function saveManagerChanges() {\n        const parentDoc = window.parent.document;\n        const $btn = $('#save-manager-changes-btn', parentDoc);\n        $btn.prop('disabled', true).html('<i class=\"fa fa-spinner fa-spin\"></i> 保存中...');\n\n        try {\n            const entriesToSave = cleanEntriesForSave(uiState.managerEntries);\n            logManagerAction('保存到世界书', { count: entriesToSave.length });\n            await TavernHelper.replaceWorldbook(uiState.managerLorebook, entriesToSave);\n            toastr.success(`成功保存 ${entriesToSave.length} 个条目到 \"${uiState.managerLorebook}\"!`, '保存成功');\n            await loadLorebookToMemory(uiState.managerLorebook);\n        } catch (error) {\n            console.error('[InitVar管理器] 保存失败:', error);\n            toastr.error(`保存失败: ${error.message}`, '错误');\n            $btn.prop('disabled', false); // Re-enable on failure\n            checkUnsavedChanges();\n        } finally {\n            $btn.html('保存更改');\n            // State is reset by loadLorebookToMemory on success\n        }\n    }\n\n\n    async function showCompilerPopup() {\n        const parentDoc = window.parent.document;\n        \n        // --- v0.2.1 新增: 退出编辑模式辅助函数 ---\n        const exitEditMode = (uid, save, $input) => {\n            const entry = uiState.managerEntries.find(e => e.uid === uid);\n            if (!entry) return;\n            \n            const field = entry._ui.isEditing.field;\n            if (!field) return;\n\n            if (save && $input) {\n                const newValue = $input.val();\n                if (entry[field] !== newValue) {\n                    entry[field] = newValue;\n                    entry._ui.isDirty = true;\n                    logManagerAction(`单条目修改 ${field}`, { uids: [uid], value: newValue });\n                    checkUnsavedChanges();\n                }\n            }\n            \n            entry._ui.isEditing.field = null;\n            updateSingleCardDOM(uid);\n        };\n\n        if ($(`#${POPUP_ID}`, parentDoc).length > 0) {\n            $(`#${POPUP_ID}`, parentDoc).css('display', 'flex');\n            uiState.isPopupOpen = true;\n            return;\n        }\n\n        uiState.isPopupOpen = true;\n        \n        $('head', parentDoc).append(`<style id=\"${STYLE_ID}\">${getPopupStyle()}</style>`);\n        $('body', parentDoc).append(`<div id=\"${POPUP_ID}\">${getPopupHtml()}</div>`);\n        \n        setTheme(uiState.activeTheme);\n        \n        const $popup = $(`#${POPUP_ID}`, parentDoc);\n\n        const closePopup = () => {\n            $popup.css('display', 'none');\n            uiState.isPopupOpen = false;\n        };\n        \n        $popup.on('click', (event) => { if (event.target.id === POPUP_ID) closePopup(); });\n        $('#initvar-popup-close', parentDoc).on('click', closePopup);\n        \n        try {\n            const lorebooks = await TavernHelper.getLorebooks();\n            const createCustomSelect = ($container, id, onChange) => {\n                const html = `\n                    <input type=\"text\" class=\"custom-select-input\" id=\"${id}-input\" placeholder=\"选择或搜索世界书...\">\n                    <div class=\"custom-select-options\" id=\"${id}-options\"></div>\n                `;\n                $container.html(html);\n\n                const $input = $(`#${id}-input`, parentDoc);\n                const $options = $(`#${id}-options`, parentDoc);\n\n                lorebooks.forEach(name => {\n                    $options.append(`<div class=\"custom-select-option\" data-value=\"${escapeHtml(name)}\">${escapeHtml(name)}</div>`);\n                });\n                \n                $input.on('click focus', (e) => {\n                    e.stopPropagation();\n                    $('.custom-select-options', parentDoc).hide();\n                    $options.show();\n                });\n                \n                $input.on('input', () => {\n                     const filter = $input.val().toLowerCase();\n                     $options.find('.custom-select-option').each(function() {\n                        const text = $(this).text().toLowerCase();\n                        $(this).toggle(text.includes(filter));\n                    });\n                });\n\n                $options.on('click', '.custom-select-option', function(e) {\n                    e.stopPropagation();\n                    const value = $(this).data('value');\n                    $input.val(value);\n                    $options.hide();\n                    onChange(value);\n                });\n                \n                const val = (value) => {\n                    if (value === undefined) return $input.val();\n                    $input.val(value);\n                    if ($input.is(':focus')) $input.blur();\n                };\n\n                return { val };\n            };\n            \n            const compilerSelect = createCustomSelect($('#compiler-custom-select', parentDoc), 'compiler-lorebook', (value) => {\n                uiState.compilerLorebook = value;\n            });\n            const managerSelect = createCustomSelect($('#manager-custom-select', parentDoc), 'manager-lorebook', async (value) => {\n                uiState.managerLorebook = value;\n                await loadLorebookToMemory(value);\n            });\n            \n            compilerSelect.val(uiState.compilerLorebook);\n            managerSelect.val(uiState.managerLorebook);\n            \n            await loadLorebookToMemory(uiState.managerLorebook);\n            \n            $('#compiler-sync-btn', parentDoc).on('click', (e) => {\n                e.preventDefault(); e.stopPropagation();\n                const newV = uiState.managerLorebook;\n                uiState.compilerLorebook = newV;\n                compilerSelect.val(newV);\n            });\n            $('#manager-sync-btn', parentDoc).on('click', async (e) => {\n                e.preventDefault(); e.stopPropagation();\n                const newV = uiState.compilerLorebook;\n                uiState.managerLorebook = newV;\n                managerSelect.val(newV);\n                await loadLorebookToMemory(newV);\n            });\n            \n             $('body', parentDoc).on('click', () => {\n                $('.custom-select-options', parentDoc).hide();\n                $('#nav-menu', parentDoc).removeClass('visible');\n             });\n\n            \n        } catch(e) {\n            toastr.error('加载世界书列表失败', '错误');\n            console.error('[InitVar] 加载世界书列表失败:', e);\n        }\n\n        $('#nav-btn', parentDoc).on('click', function(e) {\n            e.stopPropagation();\n            $('#nav-menu', parentDoc).toggleClass('visible');\n        });\n\n        $('#nav-menu', parentDoc).on('click', '.nav-item[data-tab]', function(e) {\n            e.stopPropagation();\n            uiState.activeTab = $(this).data('tab');\n            $('#nav-menu', parentDoc).removeClass('visible');\n            updatePopupUI();\n        });\n\n        $('#nav-menu', parentDoc).on('click', '.nav-item.has-submenu', function(e) {\n            e.stopPropagation();\n            $(this).toggleClass('submenu-visible');\n        });\n\n        $('#nav-menu', parentDoc).on('click', '.nav-sub-item[data-theme]', function(e) {\n            e.stopPropagation();\n            setTheme($(this).data('theme'));\n            $('#nav-menu', parentDoc).removeClass('visible');\n            $('.nav-item.has-submenu', parentDoc).removeClass('submenu-visible');\n        });\n\n        $('.panel-drawer-toggle', parentDoc).on('click', function() {\n            $(this).closest('.control-panel').toggleClass('drawer-expanded');\n        });\n\n        $('#initvar-compile-btn', parentDoc).on('click', (e) => {\n            e.preventDefault(); e.stopPropagation();\n            uiState.isCompiling = true;\n            uiState.lastCompiledJson = null;\n            uiState.lastCompiledResult = null;\n            updatePopupUI();\n\n            setTimeout(async () => {\n                $('#initvar-log-area', parentDoc).empty();\n                try {\n                    const result = await compile();\n                    uiState.lastCompiledJson = result.json;\n                    uiState.lastCompiledResult = result.result;\n                    uiState.sourceHash = await _calculateSourceHash();\n                    updatePopupUI(result.logs, result.debugLogs);\n                } catch (error) {\n                    updatePopupUI(error.logs, error.debugLogs);\n                } finally {\n                    uiState.isCompiling = false;\n                    updatePopupUI();\n                }\n            }, 0);\n        });\n\n        $('#initvar-inject-btn', parentDoc).on('click', async (e) => {\n            e.preventDefault(); e.stopPropagation();\n            if (!uiState.lastCompiledResult) return;\n            \n            const currentHash = await _calculateSourceHash();\n            if (currentHash !== uiState.sourceHash) {\n                const log = { type: 'error', message: '[ERROR] 注入失败：检测到世界书已更改，请重新编译。' };\n                resetPopupState();\n                updatePopupUI([log]);\n                return;\n            }\n\n            try {\n                await inject(uiState.lastCompiledResult);\n                updatePopupUI([{ type: 'success', message: '[SUCCESS] 成功注入到世界书！' }]);\n            } catch (error) {\n                updatePopupUI([{ type: 'error', message: `[ERROR] 注入失败: ${error.message}` }]);\n            }\n        });\n\n        $('#initvar-copy-btn', parentDoc).on('click', (e) => {\n            e.preventDefault(); e.stopPropagation();\n            if (uiState.lastCompiledJson) {\n                copyToClipboard(uiState.lastCompiledJson);\n            }\n        });\n        \n        $('#initvar-reset-btn', parentDoc).on('click', (e) => { e.preventDefault(); e.stopPropagation(); resetPopupState(); });\n        \n        $('input[name=\"compiler_sort_by\"], input[name=\"compiler_sort_dir\"]', parentDoc).on('change', function() {\n            uiState.compilerSortBy = $('input[name=\"compiler_sort_by\"]:checked', parentDoc).val();\n            uiState.compilerSortDirection = $('input[name=\"compiler_sort_dir\"]:checked', parentDoc).val();\n            localStorage.setItem('initVarCompilerSort', JSON.stringify({ sortBy: uiState.compilerSortBy, sortDirection: uiState.compilerSortDirection }));\n        });\n        \n        $('#initvar-autoscroll-toggle', parentDoc).on('change', function() {\n            uiState.autoScrollLogs = $(this).is(':checked');\n            localStorage.setItem('initVarCompilerAutoScroll', uiState.autoScrollLogs);\n        });\n        \n        $('#initvar-debug-log-toggle', parentDoc).on('change', function() {\n            uiState.showDebugLogs = $(this).is(':checked');\n            $('.log-debug', parentDoc).toggle(uiState.showDebugLogs);\n        });\n        \n        $('#initvar-quick-inject-btn', parentDoc).on('click', (e) => {\n             e.preventDefault(); e.stopPropagation();\n             compileAndInject();\n        });\n        \n        const $managerContent = $('#manager-content', parentDoc);\n        \n        $('#manager-content .manager-list', parentDoc).on('scroll', function() {\n            const $container = $('#manager-content .manager-list-container', parentDoc);\n            if (this.scrollTop > 0) {\n                $container.addClass('scrolled');\n            } else {\n                $container.removeClass('scrolled');\n            }\n        });\n\n        $managerContent.on('change', '#select-all-checkbox', function(e) {\n            e.preventDefault(); e.stopPropagation();\n            const isChecked = $(this).prop('checked');\n            uiState.managerEntries.forEach(entry => {\n                if (!entry._ui.isDeleted) entry._ui.isSelected = isChecked;\n            });\n            renderManagerList();\n            updateToolbarState();\n        });\n        \n        $managerContent.on('change', '.entry-select-checkbox', function(e) {\n            e.preventDefault(); e.stopPropagation();\n            const uid = ensureNumericUID($(this).data('uid'));\n            const entry = uiState.managerEntries.find(e => e.uid === uid);\n            if(entry) entry._ui.isSelected = $(this).prop('checked');\n            updateToolbarState();\n        });\n\n        $managerContent.on('change', '.entry-enable-toggle', function(e) {\n            e.preventDefault(); e.stopPropagation();\n            const uid = ensureNumericUID($(this).data('uid'));\n            const entry = uiState.managerEntries.find(e => e.uid === uid);\n            if (entry) {\n                const newState = $(this).prop('checked');\n                entry.enabled = newState;\n                entry._ui.isDirty = true;\n                logManagerAction('切换条目状态', { uids: [uid], newState: `enabled=${newState}` });\n                checkUnsavedChanges();\n            }\n        });\n        \n        $managerContent.on('click', '.copy-entry-btn', function(e) {\n            e.preventDefault(); e.stopPropagation();\n            const uid = ensureNumericUID($(this).data('uid'));\n            const entryIndex = uiState.managerEntries.findIndex(e => e.uid === uid);\n            \n            if (entryIndex > -1) {\n                const originalEntry = uiState.managerEntries[entryIndex];\n                \n                const visibleEntries = uiState.managerEntries.filter(e => !e._ui.isDeleted);\n                const maxOrder = visibleEntries.length > 0 ? Math.max(-1, ...visibleEntries.map(e => e.order || 0)) : -1;\n                const maxIdx = visibleEntries.length > 0 ? Math.max(-1, ...visibleEntries.map(e => e.display_index || 0)) : -1;\n\n                const newUid = `temp_${Date.now()}`;\n                const newEntry = {\n                    uid: newUid,\n                    comment: `${originalEntry.comment}_copy`,\n                    content: originalEntry.content,\n                    enabled: originalEntry.enabled,\n                    order: maxOrder + 1,\n                    display_index: maxIdx + 1,\n                    _raw: {\n                        uid: -1,\n                        name: `${originalEntry.comment}_copy`,\n                        content: originalEntry.content,\n                        enabled: originalEntry.enabled,\n                        strategy: JSON.parse(JSON.stringify(originalEntry._raw.strategy || { type: 'selective', keys: [] })),\n                        position: { type: 'after_character_definition', order: maxOrder + 1 },\n                        recursion: { prevent_incoming: false, prevent_outgoing: false, delay_until: null },\n                        effect: { sticky: null, cooldown: null, delay: null },\n                        probability: originalEntry._raw.probability || 100,\n                    },\n                    _ui: {\n                        isSelected: true, isDirty: true, isDeleted: false, isNew: true,\n                        depth: originalEntry._ui.depth, isVisible: true, isExpanded: false,\n                        isEditing: { field: null },\n                    }\n                };\n                \n                originalEntry._ui.isSelected = false;\n\n                uiState.managerEntries.splice(entryIndex + 1, 0, newEntry);\n                logManagerAction('内存内复制 (单个)', { sourceUids: [uid], tempUids: [newEntry.uid] });\n                \n                $('#resort-btn', parentDoc).addClass('needs-resort');\n                renderManagerList();\n                checkUnsavedChanges();\n                \n                const $newCard = $(`.manager-entry-card[data-uid=\"${newEntry.uid}\"]`, parentDoc);\n                if ($newCard.length) {\n                    $newCard[0].scrollIntoView({ behavior: 'smooth', block: 'center' });\n                }\n            }\n        });\n        \n        $managerContent.on('click', '.delete-entry-btn', function(e) {\n            e.preventDefault(); e.stopPropagation();\n            if (!confirm('确定要删除此条目吗？')) return;\n            const uid = ensureNumericUID($(this).data('uid'));\n            const entry = uiState.managerEntries.find(e => e.uid === uid);\n            if (entry) {\n                entry._ui.isDeleted = true;\n                entry._ui.isDirty = true;\n                entry._ui.isSelected = false;\n                logManagerAction('标记删除 (单个)', { uids: [uid] });\n                renderManagerList();\n                checkUnsavedChanges();\n            }\n        });\n\n        $('#batch-delete-btn', parentDoc).on('click', (e) => {\n            e.preventDefault(); e.stopPropagation();\n            const selectedEntries = uiState.managerEntries.filter(e => e._ui.isSelected && !e._ui.isDeleted);\n            if (selectedEntries.length === 0 || !confirm(`确定要删除选中的 ${selectedEntries.length} 个条目吗？`)) return;\n\n            const uidsToDelete = selectedEntries.map(e => e.uid);\n            selectedEntries.forEach(entry => {\n                entry._ui.isDeleted = true;\n                entry._ui.isDirty = true;\n                entry._ui.isSelected = false;\n            });\n            logManagerAction('批量标记删除', { count: uidsToDelete.length, uids: uidsToDelete });\n            renderManagerList();\n            checkUnsavedChanges();\n        });\n        \n        $('#batch-enable-btn, #batch-disable-btn', parentDoc).on('click', function(e) {\n             e.preventDefault(); e.stopPropagation();\n             const enable = $(this).attr('id') === 'batch-enable-btn';\n             const selectedUids = [];\n             uiState.managerEntries.forEach(entry => {\n                if (entry._ui.isSelected && !entry._ui.isDeleted) {\n                    entry.enabled = enable;\n                    entry._ui.isDirty = true;\n                    selectedUids.push(entry.uid);\n                }\n            });\n            logManagerAction(enable ? '批量启用' : '批量禁用', { count: selectedUids.length, uids: selectedUids });\n            renderManagerList();\n            checkUnsavedChanges();\n        });\n        \n        $('#batch-copy-btn', parentDoc).on('click', (e) => {\n            e.preventDefault(); e.stopPropagation();\n            const selectedEntries = uiState.managerEntries.filter(e => e._ui.isSelected && !e._ui.isDeleted);\n            if (selectedEntries.length === 0) return;\n\n            const sourceUids = selectedEntries.map(e => e.uid);\n            const tempUids = [];\n            \n            selectedEntries.forEach(entry => entry._ui.isSelected = false);\n            \n            // --- v0.2.1-fix1: 修正 order/idx 计算逻辑 ---\n            const visibleEntries = uiState.managerEntries.filter(e => !e._ui.isDeleted);\n            let maxOrder = visibleEntries.length > 0 ? Math.max(-1, ...visibleEntries.map(e => e.order || 0)) : -1;\n            let maxIdx = visibleEntries.length > 0 ? Math.max(-1, ...visibleEntries.map(e => e.display_index || 0)) : -1;\n\n            // 复制时按当前顺序，而不是反向\n            selectedEntries.forEach(originalEntry => {\n                 maxOrder++;\n                 maxIdx++;\n                 const newUid = `temp_${Date.now()}_${tempUids.length}`;\n                 const newEntry = {\n                    uid: newUid,\n                    comment: `${originalEntry.comment}_copy`,\n                    content: originalEntry.content,\n                    enabled: originalEntry.enabled,\n                    order: maxOrder,\n                    display_index: maxIdx,\n                    _raw: {\n                        uid: -1,\n                        name: `${originalEntry.comment}_copy`,\n                        content: originalEntry.content,\n                        enabled: originalEntry.enabled,\n                        strategy: JSON.parse(JSON.stringify(originalEntry._raw.strategy || { type: 'selective', keys: [] })),\n                        position: { type: 'after_character_definition', order: maxOrder },\n                        recursion: { prevent_incoming: false, prevent_outgoing: false, delay_until: null },\n                        effect: { sticky: null, cooldown: null, delay: null },\n                        probability: originalEntry._raw.probability || 100,\n                    },\n                    _ui: {\n                        isSelected: true, isDirty: true, isDeleted: false, isNew: true,\n                        depth: originalEntry._ui.depth, isVisible: true, isExpanded: false,\n                        isEditing: { field: null },\n                    }\n                 };\n                 tempUids.push(newUid);\n\n                // 插入到列表末尾以保证 order 连续性\n                uiState.managerEntries.push(newEntry);\n            });\n            \n            logManagerAction('内存内复制 (批量)', { count: sourceUids.length, sourceUids, tempUids });\n            $('#resort-btn', parentDoc).addClass('needs-resort');\n            renderManagerList();\n            checkUnsavedChanges();\n            \n            const $firstNew = $(`.manager-entry-card[data-uid=\"${tempUids[0]}\"]`, parentDoc);\n            if ($firstNew.length) {\n                $firstNew[0].scrollIntoView({ behavior: 'smooth', block: 'center' });\n            }\n        });\n        \n        $('#batch-apply-modify-btn', parentDoc).on('click', function(e) {\n            e.preventDefault(); e.stopPropagation();\n            \n            const target = $('#batch-modify-target', parentDoc).val();\n            const inputValue = $('#batch-modify-input', parentDoc).val().trim();\n            if (inputValue === '') return;\n            \n            let mode = 'add';\n            let valueStr = inputValue;\n            \n            if (inputValue.startsWith('=')) {\n                mode = 'set';\n                valueStr = inputValue.substring(1);\n            } else if (inputValue.startsWith('+')) {\n                mode = 'add';\n                valueStr = inputValue.substring(1);\n            } else if (inputValue.startsWith('-')) {\n                mode = 'subtract';\n                valueStr = inputValue.substring(1);\n            }\n            \n            const value = parseInt(valueStr, 10);\n            if (isNaN(value)) {\n                toastr.error('无效的数字输入。', '修改失败');\n                return;\n            }\n            \n            const selectedUids = [];\n            uiState.managerEntries.forEach(entry => {\n                if (entry._ui.isSelected && !entry._ui.isDeleted) {\n                    const applyChange = (field) => {\n                        switch (mode) {\n                            case 'set':\n                                entry[field] = value;\n                                break;\n                            case 'add':\n                                entry[field] = (entry[field] || 0) + value;\n                                break;\n                            case 'subtract':\n                                entry[field] = (entry[field] || 0) - value;\n                                break;\n                        }\n                    };\n\n                    if (target === 'order_and_index') {\n                        applyChange('order');\n                        applyChange('display_index');\n                    } else {\n                        applyChange(target);\n                    }\n                    entry._ui.isDirty = true;\n                    selectedUids.push(entry.uid);\n                }\n            });\n            \n            logManagerAction(`批量修改 ${target}`, { count: selectedUids.length, uids: selectedUids, value: inputValue });\n            renderManagerList();\n            checkUnsavedChanges();\n            $('#resort-btn', parentDoc).addClass('needs-resort');\n        });\n        \n        $('input[name=\"manager_sort_by\"], input[name=\"manager_sort_dir\"]', parentDoc).on('change', function() {\n            uiState.managerSortBy = $('input[name=\"manager_sort_by\"]:checked', parentDoc).val();\n            uiState.managerSortDirection = $('input[name=\"manager_sort_dir\"]:checked', parentDoc).val();\n        });\n\n        $('#resort-btn', parentDoc).on('click', (e) => {\n            e.preventDefault(); e.stopPropagation();\n            const sortKey = uiState.managerSortBy;\n            const direction = uiState.managerSortDirection === 'asc' ? 1 : -1;\n\n            uiState.managerEntries.sort((a, b) => {\n                const aVal = typeof a[sortKey] === 'number' ? a[sortKey] : -1;\n                const bVal = typeof b[sortKey] === 'number' ? b[sortKey] : -1;\n                return (aVal - bVal) * direction;\n            });\n            \n            uiState.managerEntries = recalculateDepths(uiState.managerEntries);\n\n            renderManagerList();\n            $(e.currentTarget).removeClass('needs-resort');\n        });\n        \n        $managerContent.on('click', '.edit-value-btn', function(e) {\n            e.preventDefault(); e.stopPropagation();\n            const $fieldContainer = $(this).closest('.editable-field');\n            const uid = ensureNumericUID($fieldContainer.data('uid'));\n            const field = $fieldContainer.data('field');\n            const entry = uiState.managerEntries.find(e => e.uid === uid);\n            \n            if (entry) {\n                const currentValue = entry[field] ?? '';\n                const editHtml = `\n                    <input type=\"number\" class=\"inline-edit-input\" value=\"${currentValue}\" data-original-value=\"${currentValue}\">\n                    <button class=\"action-btn confirm-edit-btn\" title=\"确认\"><i class=\"fa-solid fa-check\"></i></button>\n                    <button class=\"action-btn cancel-edit-btn\" title=\"取消\"><i class=\"fa-solid fa-times\"></i></button>\n                `;\n                $fieldContainer.html(editHtml);\n                $fieldContainer.find('.inline-edit-input').focus().select();\n            }\n        });\n\n        $managerContent.on('click', '.confirm-edit-btn', function(e) {\n            e.preventDefault(); e.stopPropagation();\n            const $fieldContainer = $(this).closest('.editable-field');\n            const $input = $fieldContainer.find('.inline-edit-input');\n            const uid = ensureNumericUID($fieldContainer.data('uid'));\n            const field = $fieldContainer.data('field');\n            const entry = uiState.managerEntries.find(e => e.uid === uid);\n\n            if (entry) {\n                const newValue = parseInt($input.val(), 10);\n                const originalValue = parseInt($input.data('original-value'), 10);\n                \n                if (!isNaN(newValue) && newValue !== originalValue) {\n                    entry[field] = newValue;\n                    entry._ui.isDirty = true;\n                    checkUnsavedChanges();\n                    logManagerAction(`单条目修改 ${field}`, { uids: [uid], value: newValue });\n                    $('#resort-btn', parentDoc).addClass('needs-resort');\n                }\n                renderManagerList();\n            }\n        });\n        \n        $managerContent.on('click', '.cancel-edit-btn', function(e) {\n            e.preventDefault(); e.stopPropagation();\n            renderManagerList();\n        });\n\n        // --- v0.2.1: 即时编辑模式切换 ---\n        $('#instant-edit-toggle', parentDoc).on('change', function() {\n            uiState.managerInstantEditMode = $(this).is(':checked');\n            // 退出所有显式编辑模式以避免冲突\n            uiState.managerEntries.forEach(entry => entry._ui.isEditing.field = null);\n            renderManagerList();\n        });\n\n        // --- v0.2.1: 展开/折叠详细编辑 ---\n        $managerContent.on('click', '.expand-btn', function(e) {\n            e.preventDefault(); e.stopPropagation();\n            const uid = ensureNumericUID($(this).data('uid'));\n            const entry = uiState.managerEntries.find(e => e.uid === uid);\n            if (entry) {\n                entry._ui.isExpanded = !entry._ui.isExpanded;\n                updateSingleCardDOM(uid);\n            }\n        });\n\n        // --- v0.2.1: content 和 keys 编辑 ---\n        $managerContent.on('change', '.content-editor-textarea', function(e) {\n            const uid = ensureNumericUID($(this).data('uid'));\n            const entry = uiState.managerEntries.find(e => e.uid === uid);\n            if (entry) {\n                const newValue = $(this).val();\n                if (entry.content !== newValue) {\n                    entry.content = newValue;\n                    entry._ui.isDirty = true;\n                    logManagerAction('修改 content', { uids: [uid] });\n                    checkUnsavedChanges();\n                }\n            }\n        });\n\n        $managerContent.on('change', '.keys-editor-input', function(e) {\n            const uid = ensureNumericUID($(this).data('uid'));\n            const entry = uiState.managerEntries.find(e => e.uid === uid);\n            if (entry) {\n                const newValue = $(this).val();\n                const newKeys = newValue.split(',').map(k => k.trim()).filter(Boolean);\n                \n                // 确保 _raw.strategy 存在\n                if (!entry._raw) entry._raw = {};\n                if (!entry._raw.strategy) entry._raw.strategy = {};\n                \n                entry._raw.strategy.keys = newKeys;\n                entry._ui.isDirty = true;\n                logManagerAction('修改 keys', { uids: [uid], value: newKeys });\n                checkUnsavedChanges();\n            }\n        });\n\n        // --- v0.2.1: comment 编辑 (显式) ---\n        $managerContent.on('click', '.edit-comment-btn', function(e) {\n            e.preventDefault(); e.stopPropagation();\n            const $wrapper = $(this).closest('.comment-text-wrapper');\n            const uid = ensureNumericUID($wrapper.data('uid'));\n            const entry = uiState.managerEntries.find(e => e.uid === uid);\n            if (entry) {\n                entry._ui.isEditing.field = 'comment';\n                updateSingleCardDOM(uid);\n                // 自动聚焦\n                const $input = $(`.manager-entry-card[data-uid=\"${uid}\"] .comment-edit-input`, parentDoc);\n                if ($input.length) $input.focus().select();\n            }\n        });\n\n        $managerContent.on('click', '.confirm-comment-btn', function(e) {\n            e.preventDefault(); e.stopPropagation();\n            const $wrapper = $(this).closest('.comment-text-wrapper');\n            const uid = ensureNumericUID($wrapper.data('uid'));\n            const $input = $wrapper.find('.comment-edit-input');\n            exitEditMode(uid, true, $input);\n        });\n\n        $managerContent.on('click', '.cancel-comment-btn', function(e) {\n            e.preventDefault(); e.stopPropagation();\n            const $wrapper = $(this).closest('.comment-text-wrapper');\n            const uid = ensureNumericUID($wrapper.data('uid'));\n            exitEditMode(uid, false);\n        });\n        \n        // --- v0.2.1: comment 和数值的输入框失焦/回车保存 ---\n        $managerContent.on('blur', '.inline-edit-input', function(e) {\n            const uid = ensureNumericUID($(this).data('uid'));\n            const field = $(this).data('field');\n            const entry = uiState.managerEntries.find(e => e.uid === uid);\n            \n            if (entry) {\n                if (uiState.managerInstantEditMode) {\n                    const newValue = $(this).val();\n                    if (field === 'order' || field === 'display_index') {\n                        const newNumValue = parseInt(newValue, 10);\n                        if (!isNaN(newNumValue) && entry[field] !== newNumValue) {\n                           entry[field] = newNumValue;\n                           entry._ui.isDirty = true;\n                           logManagerAction(`即时修改 ${field}`, { uids: [uid], value: newNumValue });\n                           checkUnsavedChanges();\n                           if (field === 'order') $('#resort-btn', parentDoc).addClass('needs-reorder');\n                        } else {\n                            // Revert if invalid\n                            $(this).val(entry[field] ?? '');\n                        }\n                    } else { // for comment\n                        if (entry[field] !== newValue) {\n                           entry[field] = newValue;\n                           entry._ui.isDirty = true;\n                           logManagerAction(`即时修改 ${field}`, { uids: [uid], value: newValue });\n                           checkUnsavedChanges();\n                        }\n                    }\n                } else {\n                    // In explicit mode, blur should probably cancel, but for now we do nothing\n                    // The confirm/cancel buttons handle the logic.\n                }\n            }\n        });\n\n        $managerContent.on('keydown', '.inline-edit-input', function(e) {\n            if (e.key === 'Enter') {\n                $(this).blur(); // Trigger the blur event to save\n            } else if (e.key === 'Escape') {\n                if (uiState.managerInstantEditMode) {\n                    const uid = ensureNumericUID($(this).data('uid'));\n                    const field = $(this).data('field');\n                    const entry = uiState.managerEntries.find(e => e.uid === uid);\n                    if (entry) $(this).val(entry[field] ?? ''); // Revert on escape\n                    $(this).blur();\n                } else {\n                     // For explicit edit mode, trigger cancel\n                    $(this).siblings('.cancel-comment-btn, .cancel-edit-btn').click();\n                }\n            }\n        });\n\n        // --- v0.2.1-stage2: 刷新按钮 ---\n        $('#reload-manager-btn', parentDoc).on('click', async (e) => {\n            e.preventDefault(); e.stopPropagation();\n            if (uiState.managerHasUnsavedChanges) {\n                if (!confirm('您有未保存的更改，刷新将会丢失这些更改。确定要继续吗？')) {\n                    return;\n                }\n            }\n            await loadLorebookToMemory(uiState.managerLorebook);\n        });\n\n        // --- v0.2.1-stage2: 新建条目 ---\n        $('#add-new-entry-btn', parentDoc).on('click', (e) => {\n            e.preventDefault(); e.stopPropagation();\n\n            const visibleEntries = uiState.managerEntries.filter(e => !e._ui.isDeleted);\n            const maxOrder = visibleEntries.length > 0\n                ? Math.max(-1, ...visibleEntries.map(e => e.order || 0))\n                : -1;\n            const newOrder = maxOrder + 1;\n            \n            const newEntry = {\n                uid: `temp_${Date.now()}`,\n                comment: '新条目',\n                content: '',\n                enabled: true,\n                order: newOrder,\n                display_index: visibleEntries.length,\n                _raw: {\n                    uid: -1,\n                    name: '新条目',\n                    content: '',\n                    enabled: true,\n                    strategy: { type: 'selective', keys: [] },\n                    position: { type: 'after_character_definition', order: newOrder },\n                    recursion: { prevent_incoming: false, prevent_outgoing: false, delay_until: null },\n                    effect: { sticky: null, cooldown: null, delay: null },\n                    probability: 100,\n                },\n                _ui: {\n                    isSelected: false, isDirty: true, isDeleted: false, isNew: true,\n                    depth: 0, isVisible: true, isExpanded: false,\n                    isEditing: { field: 'comment' }\n                }\n            };\n\n            uiState.managerEntries.push(newEntry);\n            logManagerAction('新建条目', { tempUids: [newEntry.uid] });\n            \n            renderManagerList();\n            checkUnsavedChanges();\n\n            const $newCard = $(`.manager-entry-card[data-uid=\"${newEntry.uid}\"]`, parentDoc);\n            if ($newCard.length) {\n                const list = $newCard.closest('.manager-list')[0];\n                list.scrollTop = list.scrollHeight;\n                setTimeout(() => {\n                     $newCard.find('.comment-edit-input').focus().select();\n                }, 100);\n            }\n        });\n\n        // --- v0.2.1-stage2: 同步排序值 ---\n        $('#sync-order-to-idx-btn, #sync-idx-to-order-btn', parentDoc).on('click', function(e) {\n            e.preventDefault(); e.stopPropagation();\n            const isOrderToIdx = $(this).attr('id') === 'sync-order-to-idx-btn';\n            const sourceKey = isOrderToIdx ? 'order' : 'display_index';\n            const targetKey = isOrderToIdx ? 'display_index' : 'order';\n            \n            let changedCount = 0;\n            uiState.managerEntries.forEach(entry => {\n                if (!entry._ui.isDeleted && entry[targetKey] !== entry[sourceKey]) {\n                    entry[targetKey] = entry[sourceKey];\n                    entry._ui.isDirty = true;\n                    changedCount++;\n                }\n            });\n\n            if (changedCount > 0) {\n                logManagerAction('同步排序值', { count: changedCount, value: `${sourceKey} -> ${targetKey}` });\n                renderManagerList();\n                checkUnsavedChanges();\n                 $('#resort-btn', parentDoc).addClass('needs-resort');\n            } else {\n                toastr.info('所有条目的排序值已同步，无需操作。');\n            }\n        });\n\n        $('#save-manager-changes-btn', parentDoc).on('click', (e) => {\n            e.preventDefault(); e.stopPropagation();\n            saveManagerChanges();\n        });\n\n        updatePopupUI();\n    }\n\n    function cleanup(instanceIdToClean) {\n        console.log(`[InitVar生成器] 正在为旧实例 ${instanceIdToClean} 卸载脚本并清理资源...`);\n        const parentDoc = window.parent.document;\n        $(`#${BUTTON_ID}`, parentDoc).remove();\n        $(`#${POPUP_ID}`, parentDoc).remove();\n        $(`#${STYLE_ID}`, parentDoc).remove();\n        $(parentDoc).off(`click.${BUTTON_ID}`);\n        \n        if (top.initVarCompilerState && top.initVarCompilerState.ownerId === instanceIdToClean) {\n            delete top.initVarCompilerState;\n        }\n        console.log(`[InitVar生成器] 实例 ${instanceIdToClean} 清理完成。`);\n    }\n\n    function initializeOrReclaim() {\n        if (top.initVarCompilerState && top.initVarCompilerState.ownerId && top.initVarCompilerState.ownerId !== instanceId) {\n            console.log(`[InitVar生成器] 检测到旧的脚本实例 (${top.initVarCompilerState.ownerId})，正在执行清理...`);\n            cleanup(top.initVarCompilerState.ownerId);\n        }\n        \n        const savedTheme = localStorage.getItem('initVarCompilerTheme');\n        if (savedTheme && ['smart', 'light_warm', 'dark_cool'].includes(savedTheme)) {\n            uiState.activeTheme = savedTheme;\n        }\n        const savedSort = JSON.parse(localStorage.getItem('initVarCompilerSort'));\n        if (savedSort) {\n            uiState.compilerSortBy = savedSort.sortBy || 'order';\n            uiState.compilerSortDirection = savedSort.sortDirection || 'asc';\n        }\n        const savedAutoScroll = localStorage.getItem('initVarCompilerAutoScroll');\n        if (savedAutoScroll !== null) {\n            uiState.autoScrollLogs = savedAutoScroll === 'true';\n        }\n        \n        top.initVarCompilerState = { ownerId: instanceId };\n        console.log(`[InitVar生成器] 当前实例 (${instanceId}) 已获取所有权。`);\n        createCompilerButton();\n    }\n    \n    // Initial load logic\n    (() => {\n        const parentDoc = window.parent.document;\n        if (parentDoc.readyState === 'complete' || parentDoc.readyState === 'interactive') {\n            initializeOrReclaim();\n        } else {\n            eventOn(tavern_events.APP_READY, initializeOrReclaim);\n        }\n    })();\n\n})();",
  "info": "# 模块化[InitVar]生成器\n**版本:** v0.2.1.0-stage2-final\n**作者:** omg & gemini\n\n---\n### 核心功能\n\n本脚本提供了一个集成的开发环境，旨在解放创作者，让您能够**可视化地、高效地**组织和管理用于 **MVU (Magical Variable Update)** 框架的复杂角色初始状态，而无需手动编写和维护庞大的JSON文件。\n\n它包含两大核心模块：\n\n*   **编译器:** 将您在世界书中用`<Tag>`语法（见“核心概念与用法”）定义的模块化条目，自动编译成一个单一的、结构化的`[InitVar]` JSON对象，并可一键注入回世界书。\n*   **管理器:** 一个强大的世界书编辑器，允许您在脚本界面内直接对条目进行创建、复制、删除、排序和批量修改，极大地提升了工作流效率。\n\n**优点:**\n*   **可视化:** 通过带有层级指示器的树状视图，让复杂的变量嵌套关系一目了然。\n*   **高效率:** 提供丰富的单条目及批量操作功能，告别在原生世界书界面中的繁琐操作。\n*   **模块化:** 像搭积木一样，通过组织简单的世界书条目来定义和组合不同的初始状态。\n*   **结构清晰:** 使用标签式的条目名称，让变量结构在编辑器中直观易懂。\n\n### v0.2.x: 集成式世界书管理器\n\n**版本 v0.2.x 是一次里程碑式的升级，将脚本从一个“编译器”进化为一个轻量级的“集成开发环境 (IDE)”，引入了全新的“管理器”模块。**\n\n*   **高级树状视图**: 管理器以卡片式布局展示世界书条目，并通过彩色的垂直导轨线和结构化边框，清晰地呈现`<Tag>`的嵌套层级关系。\n*   **自由选择世界书**: 编译器和管理器都配备了带搜索功能的下拉选择器，允许您自由选择并切换要操作的世界书，不再局限于固定名称。\n*   **强大的批量操作**:\n    *   通过复选框轻松选择多个条目。\n    *   对选中的条目进行批量复制（在同一世界书内）、批量删除、批量启用/禁用。\n    *   批量对选中条目的`order`或`display_index`进行增加或减少操作。\n*   **灵活的排序控制**: 您可以在管理器中自由选择按`order`或`display_index`对条目进行升序或降序排列，以最符合您习惯的方式查看和组织数据。\n*   **内存优先架构**: 所有的修改（复制、删除、排序等）都首先在内存中进行，UI会即时响应。只有当您点击“保存更改”时，所有变更才会通过一次高效的API调用同步回SillyTavern，确保了操作的流畅性和数据的安全性。\n*   **单条目快捷操作**: 每个条目卡片上都配备了独立的启用/禁用开关、复制和删除按钮，无需多选即可进行快速操作。\n\n### v0.1.x: 交互式编译环境\n\n**版本 v0.1.x 引入了一个交互式弹窗UI，将脚本从一键式工具升级为功能丰富的编译环境，提供了前所未有的透明度和可控性。**\n\n*   **编译预览**: 在将结果注入世界书之前，您可以在预览窗口中检查生成的完整JSON。\n*   **灵活的排序选项**: 在控制面板中，您可以自由选择按`order`或`display_index`为编译依据。\n*   **详细日志**: 集成的实时日志面板会详细展示编译过程的每一个步骤和潜在错误。\n*   **脏检查机制**: 如果您在编译后修改了源世界书，脚本会智能检测到变动，并阻止注入过时的结果。\n*   **多主题支持**: 内置三种主题（智能适应、亮暖、暗冷），您可以根据喜好自由切换。\n*   **快捷操作**: 支持通过`Shift` + 点击直接编译并注入，和`Ctrl/Cmd` + 点击进行编译并复制。\n\n### 使用场景\n\n**MVU (Magical Variable Update)** 是一个强大的变量管理框架，它允许角色状态（如好感度、任务进度、物品栏等）根据故事进展动态更新。而 `[InitVar]` 条目则是整个MVU系统的起点，它定义了所有变量的初始值和规则。\n\n随着角色设定的复杂化，手动维护一个巨大的 `[InitVar]` JSON内容会变得极其困难和枯燥。本脚本正是为了解决这一痛点而生，它提供了一种模块化、易于阅读和修改的方式来构建您的 `[InitVar]`。\n\n### 快速上手\n\n1.  **创建世界书:** 在SillyTavern中，创建一个用于存放模块化配置的世界书（例如 `[InitVar生成]`）。\n2.  **设置边界:** 在该世界书中，创建以下三个**禁用**的条目：\n    *   一个`comment`为 `[InitVar]` 的条目。这将是最终生成的JSON的存放处。\n    *   一个`comment`为 `<InitVar>` 的条目，作为您配置的开始。\n    *   一个`comment`为 `</InitVar>` 的条目，作为您配置的结束。\n3.  **定义结构:** 在`<InitVar>`和`</InitVar>`之间，通过创建新的世界书条目来定义您的变量结构（详见下文）。**请务必为所有条目设置 `order`**，以保证正确的解析顺序。\n4.  **编译与注入:** 点击SillyTavern主界面左侧扩展菜单中的“**`[InitVar]` 编译器**”按钮，打开交互式弹窗。在“编译器”标签页中选择您的世界书，点击“**编译**”生成预览，确认无误后点击“**注入**”。\n5.  **管理条目:** 切换到“管理器”标签页，选择您的世界书，即可在脚本内直接进行编辑和管理。\n\n---\n\n### 核心概念与用法\n\n#### A. 定义结构与键值对\n\n*   **使用标签 (`<Tag>`) 创建对象:**\n    通过成对的开放标签（如`<PlayerStats>`）和闭合标签（如`</PlayerStats>`）的`comment`，可以创建嵌套的对象结构。\n\n*   **创建键值对:**\n    任何`comment`不符合标签格式的条目，都会被视为一个键值对。\n    *   `comment`: 作为JSON的**键 (key)**。\n    *   `content`: 作为JSON的**值 (value)**。**`content`必须是严格的JSON数组格式**，通常为 `[\"初始值\", \"描述/规则\"]`。\n\n#### B. 【新】区分“容器对象”与“带值对象”\n\n为了解决MVU框架`template`功能的深层兼容性问题，并采纳社区推荐的更健壮的“对象模型”来处理动态列表，v0.0.19引入了新的语法：\n\n*   **容器对象 (普遍语法):** 开放标签条目**没有`content`**。\n    *   **`comment`:** `<Skills>`\n    *   **`content`:** (留空)\n    *   **作用:** 创建一个名为`Skills`的普通对象 `{}`，用于容纳后续的子条目。\n\n*   **带值对象 (新增语法):** 开放标签条目**有`content`**。\n    *   **`comment`:** `<道具物品>`\n    *   **`content`:** `[{}, \"描述...\"]` 或 `[null, \"描述...\"]`\n    *   **作用:** 创建一个名为`道具物品`的键，其值为一个数组。数组的第一个元素是一个**对象**，该对象将由`<道具物品>`标签内部的子条目填充；第二个元素是描述。这是处理动态列表的**推荐方式**。\n\n#### C. 使用`$meta`定义对象规则 (MVU beta功能)\n\n`$meta`是MVU beta的一个核心功能，用于定义对象的行为规则。可以通过一个`<meta>`块来为一个对象或条目添加`$meta`属性。\n\n*   **`extensible` (布尔值):**\n    *   `\"content\": true` - 允许动态添加/删除该对象的属性。\n    *   `\"content\": false` (默认) - 锁定该对象的结构。\n*   **`required` (字符串数组):**\n    *   在`extensible: true`时，定义该对象中哪些属性是“必需的”，防止它们被意外删除。\n*   **`template` (对象):**\n    *   为新添加到该对象的子对象提供一个默认的结构模板。当通过`_.assign`向该对象添加子对象时，新属性会自动继承`template`的结构。\n*   **`recursiveExtensible` (布尔值):**\n    *   `extensible: true`的穿透性版本，会将其可扩展性应用到所有子孙对象。\n\n#### D. 使用`$__META_EXTENSIBLE__$`定义可变数组 (MVU beta功能)\n\n`$__META_EXTENSIBLE__$`是MVU beta用于标记“可变数组”的特殊字符串。包含此字符串的数组，在故事中将被允许动态增删元素。**注意：此方法与`template`功能结合使用时可能存在BUG，推荐优先使用“带值对象”语法。**\n\n本脚本提供了一个语法糖来简化此操作：\n*   在要设为可变的数组条目（如`Items`）后紧跟一个`<meta>`块，并在其中创建一个`comment`为`extensible_value`、`content`为`true`的条目即可。编译器会自动将`\"$__META_EXTENSIBLE__$\"`字符串插入到目标数组中。\n\n（当然，更推荐直接在数组条目的`content`里为数组直接加入`\"$__META_EXTENSIBLE__$\"`。）\n\n---\n### 完整示例\n\n以下示例展示了如何结合使用新旧语法，特别是如何使用新的**“带值对象”**模型来创建一个健壮的、可扩展的物品栏。\n\n#### 配置 (在 `[InitVar生成]` 世界书中的条目)\n\n*在这个例子中，我们定义一个`CharacterSheet`。它的`Skills`部分是一个可扩展的**容器对象**，用于存放各种技能。而它的`Inventory`（物品栏）则是一个**带值对象**，其内部的对象是可扩展的，用于存放物品。*\n\n| order | comment                     | content                                     | 说明                                                       |\n|-------|-----------------------------|---------------------------------------------|------------------------------------------------------------|\n| `10`  | `<CharacterSheet>`          |                                             | **开始定义角色数据表对象**                                 |\n| `20`  | `<Skills>`                  |                                             | &nbsp;&nbsp;**↳ (容器对象)** 开始定义技能                   |\n| `21`  | `<meta>`                    |                                             | &nbsp;&nbsp;&nbsp;&nbsp;↳ 为`Skills`对象添加规则           |\n| `22`  | `extensible`                | `true`                                      | &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;↳ 允许动态学习新技能    |\n| `23`  | `</meta>`                   |                                             | &nbsp;&nbsp;&nbsp;&nbsp;↳ 结束`Skills`的规则定义         |\n| `24`  | `<Archery>`                 |                                             | &nbsp;&nbsp;&nbsp;&nbsp;↳ 定义一个具体的技能：Archery      |\n| `25`  | `rank`                      | `[5, \"技能等级\"]`                           | &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;↳ Archery等级为5        |\n| `26`  | `</Archery>`                |                                             | &nbsp;&nbsp;&nbsp;&nbsp;↳ 结束Archery技能定义              |\n| `29`  | `</Skills>`                 |                                             | &nbsp;&nbsp;**↳ 结束技能定义**                             |\n| `30`  | `<Inventory>`               | `[{}, \"玩家的物品栏\"]`                     | &nbsp;&nbsp;**↳ (带值对象)** 定义物品栏，值为 `[对象, 描述]` |\n| `31`  | `<meta>`                    |                                             | &nbsp;&nbsp;&nbsp;&nbsp;↳ **为物品栏内部的对象添加规则**     |\n| `32`  | `extensible`                | `true`                                      | &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;↳ 允许动态增删物品       |\n| `33`  | `</meta>`                   |                                             | &nbsp;&nbsp;&nbsp;&nbsp;↳ 结束物品栏内部对象的规则         |\n| `34`  | `Health Potion`             | `[3, \"恢复生命值的药水数量\"]`               | &nbsp;&nbsp;&nbsp;&nbsp;↳ 在物品栏内部对象中添加物品       |\n| `35`  | `Gold`                      | `[100, \"金币数量\"]`                         | &nbsp;&nbsp;&nbsp;&nbsp;↳ 在物品栏内部对象中添加金币       |\n| `39`  | `</Inventory>`              |                                             | &nbsp;&nbsp;**↳ 结束物品栏定义**                           |\n| `99`  | `</CharacterSheet>`         |                                             | **结束角色数据表对象**                                     |\n\n<br>\n\n---\n\n#### 结果 (点击编译器后，生成的`[InitVar]`条目内容)\n\n```json\n{\n  \"CharacterSheet\": {\n    \"Skills\": {\n      \"$meta\": {\n        \"extensible\": true\n      },\n      \"Archery\": {\n        \"rank\": [\n          5,\n          \"技能等级\"\n        ]\n      }\n    },\n    \"Inventory\": [\n      {\n        \"$meta\": {\n          \"extensible\": true\n        },\n        \"Health Potion\": [\n          3,\n          \"恢复生命值的药水数量\"\n        ],\n        \"Gold\": [\n          100,\n          \"金币数量\"\n        ]\n      },\n      \"玩家的物品栏\"\n    ]\n  }\n}\n```\n\n---\n### 注意事项\n*   所有键值对条目的`content`字段必须使用**严格的JSON格式**（例如，字符串必须用双引号`\"\"`，不能有尾随逗号）。\n*   请务必为世界书中的所有条目设置**`order`**，以保证正确的解析顺序。",
  "button": {
    "enabled": true,
    "buttons": []
  },
  "data": {}
}